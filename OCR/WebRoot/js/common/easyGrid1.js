$.fn.easyGrid=function(settings){function getDataDirty(e,t){for(var a={name:!0,color:null,spec:null,sku:!0,priceBefore:"0.00",deliveryQtyNow:0,unit:""},r=0;r<e.length;r++){var o=ComboBoxSources.getInfoMapByKey(settings.productSourceName.product,"name",e[r].productName);for(var i in a)if("spec"===i)null!=e[r].spec?e[r].descr=e[r].spec:(e[r].spec="",e[r].descr="");else if("prodAddId"===i)null!=e[r].photoAddId&&null!=e[r].photoAddId?e[r].photoId=e[r].photoAddId:e[r].photoId="";else if("color"===i)null!=e[r].color?e[r].color=e[r].color:e[r].color="";else if("deliveryQtyNow"==i)e[r].deliveryQty=0;else if("priceBefore"==i)e[r].priceBefore="NaN"===money(e[r].priceBefore,4,!0)?"0.00":money(e[r].priceBefore,4,!0);else if("unit"===i){if(o.multiUnitFlag){var n=null==o.prodContainerList?null:o.prodContainerList[0];null!=n&&""!=e[r][i]&&null!=e[r][i]&&e[r][i]!=n.unitName&&(e[r][i]=e[r][i]+"("+e[r].unitRate+n.unitName+")")}}else e[r][i]=o[i]}return e}var settings=void 0===settings?{}:settings;settings.ownerSettings.elementId=$(this)[0].id,$(this).attr({"data-id":settings.ownerSettings.elementId,"data-soOwnerId":settings.ownerSettings.soOwnerId,"data-name":settings.ownerSettings.userName});var gridSettings=$.extend(!0,{editable:!0,delBtn:!0},settings.gridSettings),productInfo=[],xsweight="kg";_global_settings.acOwner.productKgFlag&&(xsweight=_global_settings.acOwner.prodUnit[0].descr);var singleUnit=[];if(_global_settings.acOwner.productunitFlag)for(var vo=_global_settings.acOwner.ownerUnitTypeVO,i=0;i<vo.length;i++)vo[i].single&&singleUnit.push(vo[i].unitGroup[0]);var defaultrow=function(){return{name:"",id:null,printOfGoods:"",photoId:"",salesQty:"",purchasedQty:"",spec:"",descr:"",color:"",prodColourDescr:"",weight:"",totalCartons:"",eachCartons:"",qty:"",priceBefore:"",price3:"",price3_server:"",extent:"",breadth:"",altitude:"",tj:"",deliveiedQty:"",deliveryQtyNow:"",remark:"",dzid:"",rowweight:"",ysprice:"",dsprice:"",volume:"",yards:"",unit:"",unitRate:"",basicUnit:"",unitsFlag:"",unitRateqty:"",deliveryQtyAll:"",inventoryReducere:"",amountFormula:"",inventoryQtyFormula:"",discount:"",originalPrice:"",specId:"",colorId:""}},source=[defaultrow(),defaultrow(),defaultrow(),defaultrow(),defaultrow()],sourceType=null==settings.sourceType?"salePrice":settings.sourceType,iscopy=null!=settings.iscopy&&settings.iscopy,easyGridType=settings.easyGridType,modalNameMap={addSaleOrder_grid:"addSOProduct",editSaleOrder_grid:"editSOProduct",addPurchaseOrder_grid:"addPOProduct",editPurchaseOrder_grid:"editPOProduct"},modalName=modalNameMap[$(this).attr("id")],saleorbuy="",addoredit="",columntypeQtyText="",columntypedeliveiedQtyText="",columntypedeliveryQtyNowText="",qtyedit=!1,qtyNowVisible=!0;"costPrice"==sourceType?(saleorbuy="buy",columntypeQtyText="采购",null!=modalName&&modalName.indexOf("edit")>-1?(addoredit="edit",columntypedeliveiedQtyText="已收数量",columntypedeliveryQtyNowText="本次收货",qtyNowVisible=!1):(addoredit="add",columntypedeliveiedQtyText="收货数量")):(saleorbuy="sale",columntypeQtyText="销售",null!=modalName&&modalName.indexOf("edit")>-1?(addoredit="edit",columntypedeliveiedQtyText="送货数量",columntypedeliveryQtyNowText="本次送货",qtyNowVisible=!1):null!=modalName&&modalName.indexOf("add")>-1?(addoredit="add",columntypedeliveiedQtyText="送货数量"):(addoredit="view",columntypedeliveiedQtyText="送货数量"));var addbtn="",addspecbtn="",addunitbtn="",sendStartbtn="",sendRunbtn="",style="",productSourceName=null;gridSettings.delBtn?("costPrice"!=sourceType&&"salePrice"!=sourceType||(addunitbtn='<div class="col-sm-1 p-0 p-l-10 p-t-10 littleAdd addUnit" style="top: -4px;left: 20px;"><a href="javascript:void(0)" data="productunit" ><i class="icon-plus"></i></a></div>'),productSourceName="true"==_global_settings.acOwner.productNumberFlag?settings.productSourceName.productsInUse_Part:settings.productSourceName.productsInUse,settings.stop||(style="cursor: pointer;text-decoration: underline;color:#00B7EF;margin-top: -2px;",sendStartbtn='<a class="color-1193C5 hoverspan md-local-shipping " style="color:#00B7EF;margin:0;" title="一键'+columntypedeliveiedQtyText[0]+'货"></a>',sendRunbtn='<a class="color-1193C5 hoverspan md-local-shipping " style="color:#00B7EF;margin:0;" title="一键'+columntypedeliveiedQtyText[1]+'货"></a>'),addbtn="<i style='vertical-align: middle;padding-left:5px;' data-toggle='modal' data-target='#"+modalName+"' class='icon-plus addbtn' data-btn='biz:prod:create'>",addspecbtn="<i style='vertical-align: middle;padding-left:5px;' class='icon-plus addbtn addspecbtn' data-btn='biz:prod:create'>"):productSourceName="true"==_global_settings.acOwner.productNumberFlag?settings.productSourceName.product_Part:settings.productSourceName.product;var needRefresh=!1;if(void 0!==settings.source){if(0==settings.source.length)source=[defaultrow()];else{source=getDataDirty(settings.source);for(var i=0;i<source.length;i++)if(_global_settings.acOwner.ownerAttr.discountFlag){var a=source[i].priceBefore,b=void 0==source[i].originalPrice?a:source[i].originalPrice;source[i].priceBefore=b,source[i].originalPrice=a;var c=void 0==source[i].discount?1:source[i].discount;source[i].discount=100*c+"%"}(gridSettings.delBtn||iscopy)&&source.push(defaultrow())}needRefresh=!0}var table=$(this),columnsheight=20;settings.columns=[{text:"种类  ",datafield:"type",hidden:!0},{text:'产品<div id="'+table.attr("id")+'id" style="float:right;color:cornflowerblue;"></div>',datafield:"productName",columntype:"template",pk:!0,jqxSettings:{selectedIndex:0,source:productSourceName,displayMember:"name",valueMember:"name"},displayfield:"productName",width:"14%",initeditor:function(e,t,a,r,o){var i=table.jqxGrid("getrowdata",e),n=productSourceName.concat(prodArr),l=i.productName;n=sortData(n,l,"name"),a.comboBox({width:"14%",source:n,displayMember:"name",valueMember:"name"}).val(i.productName),timeOut(function(){a.jqxComboBox("open"),a.find("input").eq(0).focus().addClass("productName")},0)},geteditorvalue:function(e,t,a){return{label:a.find("input").val(),value:a.val()}},aggregatesrenderer:function(e,t,a){var r=table.jqxGrid("getcolumnaggregateddata","inventoryReducere",["sum"]).sum,o=money(r,4,!0),i="";return("add"==addoredit&&_global_settings.acOwner.ownerAttr.customFormulaFlag||("edit"==addoredit||"view"==addoredit)&&settings.order.customFormulaFlag)&&0!=o&&(i='<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;库存减少:'+o+"</div>"),i},enabletooltips:!gridSettings.delBtn},{text:"客户货号",datafield:"printOfGoods"},{text:"图片",datafield:"photoId",editable:!1,width:"60px",cellsrenderer:function(e,t,a,r,o,i){var n="",l=void 0==i.photoId||""==i.photoId?"":i.photoId;return""!=l&&(n=ctx+"/CXF/rs/SimpleAC/down/"+(new Base64).encode("toocr/order/downFile/"+l+"/"+settings.ownerSettings.soOwnerId+"/"+settings.ownerSettings.userName)),"<div style='background: white;text-align:center;margin: 3px;'>"+(n=""!=n?"<img width='48' height='32' src='"+n+"' data-id='"+l+"'>":'<input type="button" style="opacity: 0.99; position: absolute; top: 0%; left: 0%; padding: 0px; margin-top: 2px; margin-left: 2px; width: 96%; height: 36px;" value="请选择" role="button" class="jqx-rc-all jqx-button jqx-fill-state-normal addPhoto">')+"</div>"},enabletooltips:!1},{text:"货号   ",datafield:"sku",hidden:!0},{text:"规格型号",columntype:"template",hidden:!1,datafield:"spec",displayfield:"spec",width:"5%",jqxSettings:{displayMember:"descr",valueMember:"descr",width:"5%"},initeditor:function(e,t,a,r,o){var i=table.jqxGrid("getrowdata",e),n=table.attr("id"),l=$("#"+n).data().soownerid,d=$("#"+n).data().name,s=i.productName;if(null==s||""==s)a.comboBox({width:"auto",source:[],displayMember:"descr",valueMember:"descr"}),a.find("input").eq(0).focus().addClass("spec");else if(search(s,!0))if(1==_global_settings.acOwner.productSpeTypeFlag)Core.AjaxRequest({type:"GET",showWaiting:!1,async:!1,url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/searchOwnerSpec/"+l+"/"+d),callback:function(e){for(var t in e)e[t].descr=e[t].typeValue;var r=$.checkArr(e.concat(specArr));r=sortData(r,i.spec),a.comboBox({width:"auto",source:r,displayMember:"descr",valueMember:"descr"}).val(i.spec),timeOut(function(){a.jqxComboBox("open"),a.find("input").eq(0).focus().addClass("spec")},0)}});else{var c=sortData(specArr,i.spec);a.comboBox({width:"auto",source:c,displayMember:"descr",valueMember:"descr"}).val(i.spec),timeOut(function(){a.jqxComboBox("open"),a.find("input").eq(0).focus().addClass("spec")},0)}else{var u=ComboBoxSources.getInfoMapByKey(settings.productSourceName.product,"name",s);Core.AjaxRequest({type:"GET",showWaiting:!1,url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/productid/"+u.id+"/"+l+"/"+d),callback:function(e){var t=$.checkArr(e.prodSpecList.concat(specArr));t=sortData(t,i.spec),a.comboBox({width:"auto",source:t,displayMember:"descr",valueMember:"descr"}).val(i.spec),timeOut(function(){a.jqxComboBox("open"),a.find("input").eq(0).focus().addClass("spec")},0)}})}},geteditorvalue:function(e,t,a){return{label:a.find("input").val(),value:a.val()}}},{text:"颜色",datafield:"color",columntype:"template",displayfield:"color",hidden:!1,width:"5%",jqxSettings:{displayMember:"descr",valueMember:"descr",width:"5%"},initeditor:function(e,t,a,r,o){var i=table.jqxGrid("getrowdata",e),n=table.attr("id"),l=$("#"+n).data().soownerid,d=$("#"+n).data().name,s=i.productName;if(null==s||""==s)a.comboBox({width:"auto",source:[],displayMember:"descr",valueMember:"descr"}),a.find("input").eq(0).focus().addClass("color");else if(search(s,!0))1==_global_settings.acOwner.productCoLorTypeFlag?Core.AjaxRequest({type:"GET",showWaiting:!1,async:!1,url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/searchOwnerColor/"+l+"/"+d),callback:function(e){for(var t in e)e[t].descr=e[t].typeValue;var r=$.checkArr(e.concat(colorArr));r=sortData(r,i.color),a.comboBox({width:"auto",source:r,displayMember:"descr",valueMember:"descr"}).val(i.color),timeOut(function(){a.jqxComboBox("open"),a.find("input").eq(0).focus().addClass("color")},0)}}):(a.comboBox({width:"auto",source:colorArr,displayMember:"descr",valueMember:"descr"}).val(i.color),timeOut(function(){a.jqxComboBox("open"),a.find("input").eq(0).focus().addClass("color")},0));else{var c=ComboBoxSources.getInfoMapByKey(settings.productSourceName.product,"name",s);Core.AjaxRequest({type:"GET",showWaiting:!1,url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/productid/"+c.id+"/"+l+"/"+d),callback:function(e){var t=$.checkArr(e.prodColourList.concat(colorArr));t=sortData(t,i.color),a.comboBox({width:"auto",source:t,displayMember:"descr",valueMember:"descr"}).val(i.color),timeOut(function(){a.jqxComboBox("open"),a.find("input").eq(0).focus().addClass("color")},0)}})}},geteditorvalue:function(e,t,a){return{label:a.find("input").val(),value:a.val()}}},{text:"重量",datafield:"weight",cellsalign:"right",aggregates:["sum"],aggregatesrenderer:function(e,t,a){if("add"==addoredit&&_global_settings.acOwner.ownerAttr.customFormulaFlag||("edit"==addoredit||"view"==addoredit)&&settings.order.customFormulaFlag)return"";var r=table.jqxGrid("getcolumnaggregateddata","rowweight",["sum"]).sum;gridSettings.dellist&&(r=getgridcheckedsum("rowweight",table));return r="g"==xsweight?money(r/1e3,4,!0):money(r,4,!0),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">重量:'+(r+"kg")+"</div>"},width:"5%"},{text:"细码",datafield:"yards",hidden:!0,resizable:!0,width:"15%",cellsrenderer:function(e,t,a,r,o){},aggregates:[{"细码匹数":function(e,t,a,r){var o=null==r.yards?"":r.yards.toString();if(null!=o){var i=0;return gridSettings.dellist&&1!=r.waitdel||$.each(o.split(","),function(e,t){t.indexOf("*")>-1?i+=1*t.split("*")[0]:t>0&&(i+=1)}),money(e+i,4,!0)}return e},"损耗数量":function(aggregatedValue,currentValue,columnfield,row){var yards=null==row.yards?"":row.yards.toString(),unitRate=row.unitRate;null!=unitRate&&""!=unitRate||(unitRate=1);var sum=0;return null!=yards?(gridSettings.dellist&&1!=row.waitdel||$.each(yards.split(","),function(i,v){var abc=eval(v);abc<0&&(sum+=parseFloat(abc)*unitRate)}),money(aggregatedValue+sum,4,!0)):aggregatedValue}}],aggregatesrenderer:function(e,t,a){var r="";return $.each(e,function(e,t){0!=t&&(r+=e+":"+Math.abs(t)+"&nbsp;&nbsp;&nbsp;")}),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+r+"</div>"}},{text:"箱数",datafield:"totalCartons",width:"5%",cellsalign:"right",aggregates:["sum"],aggregatesrenderer:function(e,t,a){var r=table.jqxGrid("getcolumnaggregateddata","totalCartons",["sum"]).sum;return gridSettings.dellist&&(r=getgridcheckedsum("totalCartons",table)),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;总箱数:'+money(r,4,!0)+"</div>"}},{text:"每箱数量",datafield:"eachCartons",width:"6%",cellsalign:"right"},{text:"总数量",datafield:"qty",width:"5%",cellsalign:"right",pk:!0,aggregates:["sum"],aggregatesrenderer:function(e,t,a){var r=table.jqxGrid("getcolumnaggregateddata","unitRateqty",["sum"]).sum;return'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;总数量:'+("NaN"==money(r,4,!0)?"0.00":money(r,4,!0))+"</div>"},editable:qtyedit},{text:"单位"+addunitbtn,cellsalign:"left",columntype:"template",hidden:!0,datafield:"unitRate",displayfield:"unit",width:"5%",jqxSettings:{displayMember:"unitName",valueMember:"unitName",width:"5%"},initeditor:function(e,t,a,r,o){var i=table.jqxGrid("getrowdata",e),n=table.attr("id"),l=$("#"+n).data().soownerid,d=$("#"+n).data().name,s=i.productName,c=void 0==i.spec?"":i.spec,u=void 0==i.color?"":i.color;if(null==s||""==s)a.comboBox({width:"auto",source:[],displayMember:"unitName",valueMember:"unitName"});else{var g=ComboBoxSources.getInfoMapByKey(settings.productSourceName.product,"name",s);if(g.multiUnitFlag)Core.AjaxRequest({type:"GET",showWaiting:!1,url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/productid/"+g.id+"/"+l+"/"+d),callback:function(e){var t=e.inDataList,r=e.prodContainerList[0].unitName,o=[];if($.each(t,function(e,t){if(c==t.spec&&u==t.colour){var n=t.prodContainerList;$.each(n,function(e,t){t.unitName!=r&&(t._unitName=t.unitName,t.unitName=t.unitName+"("+t.rate+r+")")});var l=ComboBoxSources.getInfoMapByKey(n,"commonFlag",!0);o=sortData(n,i.unit,"unitName"),a.comboBox({width:"auto",source:o,displayMember:"unitName",valueMember:"unitName"}).val(l.unitName),timeOut(function(){a.jqxComboBox("open"),a.find("input").eq(0).focus()},0)}}),0==o.length){var n=e.prodContainerList;$.each(n,function(e,t){t.unitName!=r&&(t._unitName=t.unitName,t.unitName=t.unitName+"("+t.rate+r+")")}),o=sortData(n,i.unit,"unitName"),a.comboBox({width:"auto",source:o,displayMember:"unitName",valueMember:"unitName"}).val(i.unit),timeOut(function(){a.jqxComboBox("open"),a.find("input").eq(0).focus()},0)}}});else{var p=unitArr,m=singleUnit.concat(p);m=sortData(m,i.unit,"unitName"),a.comboBox({width:"auto",source:m,displayMember:"unitName",valueMember:"unitName"}).val(i.unit)}}timeOut(function(){a.jqxComboBox("open"),a.find("input").eq(0).focus()},0)},geteditorvalue:function(e,t,a){var r=a.jqxComboBox("getSelectedItem");return null!=r?{label:r.label,value:r.originalItem.rate}:{label:"",value:"1"}}},{text:"已采购",datafield:"purchasedQty",editable:!1,pk:!0,hidden:!0,cellsalign:"right"},{text:"销售数量",datafield:"salesQty",editable:!1,pk:!0,hidden:!0,cellsalign:"right"},{text:"单价 ",datafield:"priceBefore",pk:!0,cellsalign:"right"},{text:"折扣",datafield:"discount",pk:!0,cellsalign:"right",hidden:!_global_settings.acOwner.ownerAttr.discountFlag,cellsrenderer:function(e,t,a,r,o,i){}},{text:"折后价",datafield:"originalPrice",pk:!0,editable:!1,cellsalign:"right",hidden:!_global_settings.acOwner.ownerAttr.discountFlag},{text:"金额    ",datafield:"price3_server",pk:!0,cellsalign:"right",aggregates:["sum"],aggregatesrenderer:function(e,t,a){var r=table.jqxGrid("getcolumnaggregateddata","price3",["sum"]).sum;return gridSettings.dellist&&(r=getgridcheckedsum("price3",table)),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;金额:'+("NaN"===money(r)?"0.00":money(r))+"</div>"},editable:!1},{text:"长",columngroup:"外箱尺寸",width:"4%",datafield:"extent",cellsalign:"right"},{text:"宽",columngroup:"外箱尺寸",width:"4%",datafield:"breadth",cellsalign:"right",aggregates:["sum"],aggregatesrenderer:function(e,t,a){if("add"==addoredit&&_global_settings.acOwner.ownerAttr.customFormulaFlag||("edit"==addoredit||"view"==addoredit)&&settings.order.customFormulaFlag)return"";var r=table.jqxGrid("getcolumnaggregateddata","tj",["sum"]).sum/1e6;return gridSettings.dellist&&(r=getgridcheckedsum("tj",table)/1e6),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;体积:'+(0==money(r,4,!0)?"<0.0001":money(r,4,!0))+"m³</div>"}},{text:"高",columngroup:"外箱尺寸",width:"4%",datafield:"altitude",cellsalign:"right"},{text:"体积",columngroup:"外箱尺寸",hidden:!0,datafield:"tj",cellsalign:"right",aggregates:["sum"],aggregatesrenderer:!0,editable:!1},{text:"外箱尺寸(m³)",datafield:"volume",cellsalign:"right",aggregates:["sum"],aggregatesrenderer:function(e,t,a){if("add"==addoredit&&_global_settings.acOwner.ownerAttr.customFormulaFlag||("edit"==addoredit||"view"==addoredit)&&settings.order.customFormulaFlag)return"";var r=table.jqxGrid("getcolumnaggregateddata","tj",["sum"]).sum;return gridSettings.dellist&&(r=getgridcheckedsum("tj",table)),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;体积:'+(0==money(r,4,!0)?"<0.0001":money(r,4,!0))+"m³</div>"}},{text:'<div class="sendStart " title="'+(1==qtyNowVisible?"一键"+columntypedeliveiedQtyText[0]+"货":"")+'" style="'+(1==qtyNowVisible?style:"")+'">'+columntypedeliveiedQtyText+sendStartbtn+"</div>",width:"7%",datafield:"deliveryQtyNow",cellsalign:"right",pk:!0,aggregates:["sum"],aggregatesrenderer:function(e,t,a){var r=table.jqxGrid("getcolumnaggregateddata","deliveryQtyAll",["sum"]).sum;gridSettings.dellist&&(r=getgridcheckedsum("deliveryQtyAll",table));var o=money(r,4,!0);return'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">'+columntypedeliveiedQtyText+":"+o+"</div>"}},{text:"备注      ",datafield:"remark"},{text:"单子id",datafield:"dzid",hidden:!0,cellsformat:"n"},{text:"总重量",datafield:"rowweight",hidden:!0,aggregates:[{sum:function(e,t,a,r){return r.waitdel?e+t:e}}]},{text:"主单位",datafield:"basicUnit",hidden:!0},{text:"是否开启多单位",datafield:"unitsFlag",hidden:!0},{text:"单位数量",datafield:"unitRateqty",hidden:!0},{text:"送货总数量",datafield:"deliveryQtyAll",hidden:!0},{text:"后台总金额",datafield:"price3",hidden:!0},{text:"已收送货总金额",datafield:"ysprice",hidden:!0,aggregates:["sum"]},{text:"待收送货总金额",datafield:"dsprice",hidden:!0,aggregates:["sum"]},{text:"金额公式",datafield:"amountFormula",hidden:!0},{text:"库存数量公式",datafield:"inventoryQtyFormula",hidden:!0},{text:"inventoryReducere",datafield:"inventoryReducere",hidden:!0,aggregates:["sum"]},{text:"grid_focus",datafield:"grid_focus",hidden:!0},{text:"产品规格ID",datafield:"specId",hidden:!0},{text:"产品颜色ID",datafield:"colorId",hidden:!0}],settings.aggregates=[{type:"Multiply",datafield:["totalCartons","eachCartons","qty"]},{type:"Multiply",datafield:["priceBefore","discount","originalPrice"]},{type:"Multiply",datafield:["qty","priceBefore","price3_server"]},{type:"Multiply",datafield:["deliveryQtyNow","priceBefore","ysprice"]},{type:"Multiply",datafield:["deliveiedQty","priceBefore","dsprice"]},{type:"Multiply",datafield:["qty","weight","rowweight"]},{type:"Multiply",datafield:["rowweight","unitRate","rowweight"]},{type:"Multiply",datafield:["deliveryQtyNow","unitRate","deliveryQtyAll"]},{type:"Multiply",datafield:["qty","unitRate","unitRateqty"]},{type:"Multiply",datafield:["totalCartons","extent","breadth","altitude","tj"]}],("add"==addoredit&&"volume"==_global_settings.acOwner.cartonType||("edit"==addoredit||"view"==addoredit)&&"volume"==settings.order.cartonType)&&(settings.aggregates=[{type:"Multiply",datafield:["totalCartons","eachCartons","qty"]},{type:"Multiply",datafield:["priceBefore","discount","originalPrice"]},{type:"Multiply",datafield:["qty","priceBefore","price3_server"]},{type:"Multiply",datafield:["deliveiedQty","priceBefore","ysprice"]},{type:"Multiply",datafield:["deliveryQtyNow","priceBefore","dsprice"]},{type:"Multiply",datafield:["qty","weight","rowweight"]},{type:"Multiply",datafield:["rowweight","unitRate","rowweight"]},{type:"Multiply",datafield:["deliveryQtyNow","unitRate","deliveryQtyAll"]},{type:"Multiply",datafield:["qty","unitRate","unitRateqty"]},{type:"Multiply",datafield:["totalCartons","volume","tj"]}]),"container"==_global_settings.acOwner.prodUnit[0].weightWay&&(settings.aggregates.splice(5,1,{type:"Multiply",datafield:["totalCartons","weight","rowweight"]}),settings.aggregates.splice(6,1)),_global_settings.acOwner.ownerAttr.discountFlag&&(settings.aggregates.splice(3,1,{type:"Multiply",datafield:["deliveiedQty","originalPrice","ysprice"]}),settings.aggregates.splice(4,1,{type:"Multiply",datafield:["deliveryQtyNow","originalPrice","dsprice"]})),"false"==gridSettings.delBtn.toString()&&(settings.columns[3]={text:"图片",datafield:"photoId",editable:!1,width:"60px",cellsrenderer:function(e,t,a,r,o,i){var n="",l=void 0==i.photoId?"":i.photoId;return""!=l&&(n=ctx+"/CXF/rs/SimpleAC/down/"+(new Base64).encode("toocr/order/downFile/"+l+"/"+settings.ownerSettings.soOwnerId+"/"+settings.ownerSettings.userName)),""!=n&&(n="<img title='点击查看大图' width='48' height='32' src='"+n+"'>"),"<div style='background: white;text-align:center;margin: 3px;'>"+n+"</div>"}},settings.columns[5]={text:"规格型号",columntype:"combobox",jqxSettings:{source:"producttype",displayMember:"spec",valueMember:"spec"},width:"8%",datafield:"spec",displayfield:"spec"},settings.columns[6]={text:"颜色",datafield:"color",columntype:"combobox",width:"5%",jqxSettings:{displayMember:"color",valueMember:"color",source:"producttype"},displayfield:"color"},delete settings.columns[8].cellsrenderer);for(var i in _global_settings.owner.easyGridSetting)settings.columns=deleteBy(settings.columns,i,"datafield");settings.columns=setToggerColumns(settings.toggerColumns,settings.columns,saleorbuy);var aggregates=settings.aggregates,columns=settings.columns,pk={},datafields={},getVisibleColumn=function(){var e={printOfGoods:"",totalCartons:0,eachCartons:0,spec:null,color:null,weight:0,extent:0,breadth:0,altitude:0,remark:"",yards:"",unit:"",discount:"",originalPrice:"",deliveryQtyNow:0,volume:0},t={};for(var a in e)try{table.jqxGrid("iscolumnvisible",a)&&(t[a]=e[a])}catch(e){}return t},getData=function(e,t){var a=[],r={boundindex:!0,uid:!0,uniqueid:!0,undefined:!0,visibleindex:!0},o=[];if(void 0===e){o=table.jqxGrid("source").records;for(var i=0;i<o.length;i++){var n={};for(var l in o[i])r[l]||(n[l]=o[i][l]);a.push(n)}return a}delete r[void 0],o=e;for(var i=0;i<o.length;i++)for(var l in r)o[i][l]=i;return o},getDataWash=function(e,t){var a={sequence:0,qty:0,priceBefore:0,dzid:null,productName:null,photoId:null,photoAddId:null,deliveryQtyNow:0,spec:null,color:null,unitsFlag:null,amountFormula:"",inventoryQtyFormula:""};a=$.extend(!0,a,getVisibleColumn()),void 0!==a.unit&&(a.unitRate="",a.basicUnit="");for(var r=[],o=0;o<e.length;o++){var i=ComboBoxSources.getInfoMapByKey(productSourceName,"name",e[o].productName),n={};for(var l in a){var d=e[o][l];if(null==d||""==d)n[l]=a[l],"sequence"==l&&(n[l]=o+1),"unitsFlag"==l&&(n[l]=i.multiUnitFlag);else if("sequence"==l)n[l]=o+1;else if("originalPrice"==l||"discount"==l)if("discount"==l)n[l]=money(d.split("%")[0]/100,4,!0);else{var s=e[o][l],c=n.priceBefore;n.priceBefore=s,n[l]=c}else n[l]="unit"==l?e[o][l].replace(/\(.{0,}\)$/,""):d}if(0!=n.qty&&(null==n.productName||""==n.productName))throw Core.alert({message:"第"+(o+1)+"行请重新选择产品"}),"第"+(o+1)+"行请重新选择产品";if(null!=n.productName&&""!=n.productName&&void 0!=n.productName){if(!1!==t){if(0==n.qty)throw Core.alert({message:"第"+(o+1)+"行"+columntypeQtyText+"数量不能为0"}),"第"+(o+1)+"行"+columntypeQtyText+"数量不能为0";if(n.priceBefore<0)throw Core.alert({message:"第"+(o+1)+"行单价不能为负数"}),"第"+(o+1)+"行单价不能为负数";if(n.totalCartons<0||n.totalCartons<0||n.qty<0||n.deliveryQtyNow<0)throw Core.alert({message:"第"+(o+1)+"行数量不能为负数"}),"第"+(o+1)+"行数量不能为负数";if(n.deliveryQtyNow<0){var u="";throw u="add"==addoredit?"sale"==saleorbuy?"送货数量":"收货数量":"sale"==saleorbuy?"已送数量":"已收数量",Core.alert({message:"第"+(o+1)+"行"+u+"不能为负数"}),"第"+(o+1)+"行数量不能为负数"}if(n.deliveryQtyNow<0){var u="";throw"add"==addoredit||(u="sale"==saleorbuy?"本次送货":"本次收货"),Core.alert({message:"第"+(o+1)+"行"+u+"不能为负数"}),"第"+(o+1)+"行数量不能为负数"}}void 0!=n.photoId&&""!=n.photoId?void 0!=n.photoAddId&&""!=n.photoAddId?delete n.photoId:delete n.photoAddId:void 0!=n.photoAddId&&""!=n.photoAddId?delete n.photoId:(delete n.photoAddId,delete n.photoId),n.qty=money(n.qty,4,!0),n.priceBefore="NaN"===money(n.priceBefore,4,!0)?"0.00":money(n.priceBefore,4,!0),delete n.dzid,n.productName=n.productName.trim(),r.push(n)}}return r},getRowData=function(){var e=table.jqxGrid("getselectedcell").rowindex;return table.jqxGrid("getrowdata",e)},addLastRow=function(e){var t=getData(),a=ComboBoxSources.getInfoMapByKey(productSourceName,"name",e);if(null==a)return t;for(var r=0;r<t.length;r++){var o=t[r];if(""==o.id||null==o.id)return o.id=a.id,o.name=a.name,o.type=""==a.type?"未分类":a.type,o.sku=a.sku,o.spec=a.spec,o.priceBefore=parseFloat(a["salePrice"!=sourceType?"purchasePrice":"salePrice"]),o.spec=a.spec,o.photoId=a.photoId,o.photoAddId=a.photoAddId,o.color=a.color,t}var o={};return o.name=a.productName,o.type=""==a.type?"未分类":a.type,o.sku=a.sku,o.spec=a.spec,o.priceBefore=parseFloat(a["salePrice"!=sourceType?"purchasePrice":"salePrice"]),o.photoId=a.photoId,o.photoAddId=a.photoAddId,o.color=a.color,t.push(o),t},getProductInfoById=function(e){var e=e,t=settings.ownerSettings.soOwnerId,a=settings.ownerSettings.userName;Core.AjaxRequest({type:"get",url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/productid/"+e+"/"+t+"/"+a),showMsg:!1,callback:function(e){productInfo=e}})},getUnitBySpecColor=function(e,t){var t=t,a=settings.ownerSettings.userName,r=settings.ownerSettings.soOwnerId;Core.AjaxRequest({type:"get",url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/inventoryDetail/"+r+"/"+a+"/"+t+"/0/0"),showMsg:!1,callback:function(t){var a=t.conList,r=t.mainContainer;$.each(a,function(e,t){t.unitName!=r&&(t._unitName=t.unitName,t.unitName=t.unitName+"("+t.rate+r+")")});var o=ComboBoxSources.getInfoMapByKey(a,"commonFlag",!0);e.basicUnit=r,e.unit=o.unitName,e.unitRate=o.rate,e.unitsFlag=!0,"salePrice"==sourceType?(e.priceBefore=o.salePrice,e.cost=o.purchasePrice):e.priceBefore=o.purchasePrice,table.jqxGrid("refresh")}})},setRowData=function(e,t){var a=t,r=(table.jqxGrid("getrowid",a),table.jqxGrid("getrowdata",a));if("productName"==e){if(null==r[e])return;var o=ComboBoxSources.getInfoMapOrderByKey(productSourceName,"name",r[e]);if(null==o)return;o=o[0],r.productName=o.name,""!=o.type&&null!=o.type||(o.type="未分类"),r.type=o.type,r.spec=o.spec,null!=r.priceBefore&&""!=r.priceBefore&&0!=r.priceBefore&&"NaN"!=r.priceBefore||(r.priceBefore=parseFloat(o["salePrice"!=sourceType?"purchasePrice":"salePrice"])),r.color=o.color,r.photoId=void 0==o.prodPhoto?r.photoId:o.prodPhoto,r.unit="",r.unitRate="",r.basicUnit="",r.unitsFlag=!1,r.amountFormula=o.amountFormula,r.inventoryQtyFormula=o.inventoryFormula,o.multiUnitFlag?getUnitBySpecColor(r,o.id):(r.basicUnit=o.unit,r.unit=o.unit,r.unitRate=1)}},setRowCoaData=function(e,t){var a=table.jqxGrid("getselectedcell").rowindex,r=(table.jqxGrid("getrowid",a),table.jqxGrid("getrowdata",a)),o=(ComboBoxSources.getInfoMapByKey(productSourceName,"type"),null);"productName"==e&&null!=(o=ComboBoxSources.getInfoMapByKey(productSourceName,"productName",r.productName))&&(o=o.productName),"spec"==e&&null!=r.productName&&""!=r.productName&&null!=(o=ComboBoxSources.getInfoMapByKey(productSourceName,"productName",r.productName))&&(o=o.spec),"color"==e&&null!=r.productName&&""!=r.productName&&null!=(o=ComboBoxSources.getInfoMapByKey(productSourceName,"productName",r.productName))&&(o=o.color),t.jqxComboBox({source:o})},fouroperations=function(expression,row,qtydatafield,bool){var formulaMap={volume:"volume",extent:"extent",breadth:"breadth",altitude:"altitude",weight:"weight",price:"priceBefore",originalPrice:"originalPrice",eachCartons:"eachCartons",totalCartons:"totalCartons",qty:"qty",inventoryQty:"inventoryReducere"};expression.indexOf("inventoryQty")>-1&&(expression=expression.replace("inventoryQty",row.inventoryQtyFormula)),_global_settings.acOwner.ownerAttr.discountFlag&&expression.indexOf("price")>-1&&(expression=expression.replace("price","originalPrice")),expression.indexOf("meas")>-1&&(expression="volume"==_global_settings.acOwner.cartonType?expression.replace(/meas/g,"volume"):expression.replace(/meas/g,"extent * breadth * altitude"));for(var arr=expression.split(" "),i=0;i<arr.length;i++){var line=formulaMap[arr[i]];if(null!=line&&(arr[i]=row[line],"qty"==line&&(arr[i]=void 0==row[qtydatafield]?0:row[qtydatafield],bool))){if(arr[i]=row.qty,table.jqxGrid("iscolumnvisible","yards")){var yards=row.yards,sum=0;if(null!=yards){var y=yards.split(",");$.each(y,function(i,v){var abc=eval(v);abc>0&&(sum+=abc)}),arr[i]=sum}}var unitRate=row.unitRate;if(null!=unitRate&&""!=unitRate||(unitRate=1),"add"==addoredit){var productunitFlag=_global_settings.acOwner.productunitFlag;productunitFlag&&(arr[i]=arr[i]*unitRate)}if("edit"==addoredit||"view"==addoredit){var productunitFlag=settings.order.productunitFlag;productunitFlag&&(arr[i]=arr[i]*unitRate)}}}for(var i=0,len=arr.length;i<len;i++)""==arr[i]&&(arr[i]=0);return eval(arr.join(""))};window.fouroperations=fouroperations;var computeRow=function(e){for(var t=["priceBefore","cost","extent","breadth","altitude","volume","weight","totalCartons","eachCartons","tj","qty","deliveiedQty","deliveryQtyNow","purchaseNumber"],a=0;a<t.length;a++){var r=t[a];e[r]=money(e[r],4,!0)}var o=!1;("add"==addoredit&&_global_settings.acOwner.ownerAttr.customFormulaFlag||("edit"==addoredit||"view"==addoredit)&&settings.order.customFormulaFlag)&&(o=!0);for(var i=0;i<aggregates.length;i++)if("Multiply"==aggregates[i].type){if(3==aggregates[i].datafield.length){if("qty"!=aggregates[i].datafield[2]||table.jqxGrid("iscolumnvisible","eachCartons"))if("totalCartons"!=aggregates[i].datafield[0]&&"weight"!=aggregates[i].datafield[1]||"single"==_global_settings.acOwner.prodUnit[0].weightWay||table.jqxGrid("iscolumnvisible","totalCartons"))if($.strInArr(aggregates[i].datafield[2],["price3_server","ysprice","dsprice","originalPrice"])){var n=e[aggregates[i].datafield[0]]*e[aggregates[i].datafield[1]];if($.strInArr(aggregates[i].datafield[2],["ysprice","dsprice"])&&(e[aggregates[i].datafield[2]]=money(n)),"price3_server"==aggregates[i].datafield[2]&&(_global_settings.acOwner.ownerAttr.discountFlag||(e[aggregates[i].datafield[2]]=money(n),e.price3=money(n))),_global_settings.acOwner.ownerAttr.discountFlag&&"originalPrice"==aggregates[i].datafield[2]){var l=e[aggregates[i].datafield[1]];void 0!=l&&l.toString().indexOf("%")>-1&&(l=l.split("%")[0]);var n=e[aggregates[i].datafield[0]]*l/100;e[aggregates[i].datafield[2]]=money(n,4,!0),e.price3_server=money(e.qty*e[aggregates[i].datafield[2]],4,!0),e.price3=e.price3_server}}else{
if("unitRate"!=aggregates[i].datafield[1]||e[aggregates[i].datafield[1]]&&!table.jqxGrid("iscolumnvisible","eachCartons")&&table.jqxGrid("iscolumnvisible","unitRate"))if("tj"==aggregates[i].datafield[2])if(table.jqxGrid("iscolumnvisible","eachCartons"))var n=e[aggregates[i].datafield[0]]*e[aggregates[i].datafield[1]];else var n=1*e[aggregates[i].datafield[1]];else var n=e[aggregates[i].datafield[0]]*e[aggregates[i].datafield[1]];else var n=1*money(e[aggregates[i].datafield[0]],4,!0);"qty"==aggregates[i].datafield[2]&&""!=e.productName&&void 0!=e.productName&&0==n&&(n=1),e[aggregates[i].datafield[2]]=money(n,4,!0)}else{var n=1*e[aggregates[i].datafield[1]];e[aggregates[i].datafield[2]]=money(n,4,!0)}else;if(null!=e.amountFormula&&""!=e.amountFormula&&$.strInArr(aggregates[i].datafield[2],["price3_server","ysprice","dsprice"])&&o){var n=fouroperations(e.amountFormula,e,aggregates[i].datafield[0]);e[aggregates[i].datafield[2]]=n,"price3_server"==aggregates[i].datafield[2]&&(e.price3_server=money(n),e.price3=money(n))}}try{if(5==aggregates[i].datafield.length&&"tj"==aggregates[i].datafield[4]){if(table.jqxGrid("iscolumnvisible","eachCartons"))var n=e[aggregates[i].datafield[0]]*e[aggregates[i].datafield[1]]*e[aggregates[i].datafield[2]]*e[aggregates[i].datafield[3]];else var n=1*e[aggregates[i].datafield[1]]*e[aggregates[i].datafield[2]]*e[aggregates[i].datafield[3]];e[aggregates[i].datafield[4]]=n}}catch(e){}}if(o)if(null!=e.inventoryQtyFormula&&""!=e.inventoryQtyFormula){var n=fouroperations(e.inventoryQtyFormula,e,"qty",!0);e.inventoryReducere=n}else e.inventoryReducere=0},grid_refresh=function(e,t){if(null!=e)var a=e;else var a=table.jqxGrid("source").records;for(var r=$.extend(!0,a,[]),o=0;o<r.length;o++)computeRow(r[o]);grid_render(r,t)},columns_Handle=function(column){for(var columns=$.extend(!0,[],column),defaultArr=[{text:"编号",editable:!1,enabletooltips:!1,resizable:!1,pk:!0,aggregates:["sum"],aggregatesrenderer:function(e,t,a){return'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: center;">合计</div>'},datafield:"sequence",columntype:"number",width:"3%",cellsrenderer:function(e,t,a){return"<div style='margin:11px auto;text-align:center;'>"+(a+1)+"</div>"}},{text:"操作",editable:!1,width:"7%",datafield:"操作",align:"center",cellsrenderer:function(e){return'<div style="text-align: center;padding-top: 8px;"><a class="md-cancel hoverspan del" data-id="'+e+'" title="删除"></a><a class=" md-description hoverspan copy" data-id="'+e+'" title="复制"></a><a class="md-note-add hoverspan add" data-id="'+e+'" title="新增"></a></div>'}}],jqxType={template:function(e,t){var a={theme:currentTheme,animationType:"none",height:"40px",searchMode:"none",enableBrowserBoundsDetection:!1,placeHolder:"请选择",source:[]},r=$.extend(!0,a,e),o="",i="";return"product"==r.type&&(o="id",i=productSourceName),"vendor"==r.type&&(o="clientInfoid",i="vendor_p"),delete r.type,function(e,a,n,l,d){if(""!=i){var s=ComboBoxSources.getRecords(i);r.source=s}n.comboBox(r),"id"==o&&n.addClass(t)}},combobox:function(e,t){var a={theme:currentTheme,height:"40px",searchMode:"containsignorecase",autoComplete:!0,enableBrowserBoundsDetection:!1,placeHolder:"请选择"};$.extend(!0,a,e);return function(e,a,r){var o=table.jqxGrid("getrowdata",e);if(null!=o.productName&&""!=o.productName){var i=search(o.productName),n=i[0];i[1];n.length=200}else{var n=ComboBoxSources.getInfoMapByKey(productSourceName);n.length=200}r.jqxComboBox({theme:currentTheme,searchMode:"none",enableBrowserBoundsDetection:!1,source:n,height:"40px",displayMember:"name",valueMember:"name"}),r.addClass(t)}},numberinput:function(e){return function(t,a,r){r.jqxNumberInput(e)}},dropdownlist:function(e,t){var a={autoDropDownHeight:!0,placeHolder:"请选择"},r=$.extend(!0,a,e);return r.source=ComboBoxSources.getInfoMapByKey(r.source),function(e,a,o){o.jqxDropDownList(r).addClass(t)}}},len=columns.length,i=0;i<len;i++)null!=columns[i].columntype?"function"==typeof jqxType[columns[i].columntype]&&(columns[i].createeditor=jqxType[columns[i].columntype](columns[i].jqxSettings,columns[i].datafield)):columns[i].geteditorvalue=function(row,cellvalue,editor,a,b,c){if(editor[0].id.indexOf("yards")>-1){for(var reg=/^(\-?)\d+(\.\d+)?((\*?)(\-?)\d+(\.\d+)?){0,}$/,val=editor.val(),arr=val.split(","),length=arr.length,newArr=[],i=0;i<length;i++){var abc=money(arr[i],4,!0).toString();if(reg.test(abc)){var bc=eval(abc);bc>0?newArr.push(abc):bc<0&&-1==abc.indexOf("*")&&newArr.push(abc)}}return newArr.toString()}return editor.val()},!0===columns[i].aggregatesrenderer&&(columns[i].aggregatesrenderer=function(e,t,a){var r=null,o="",n="right";columns[i].cellsformat?(r=null==e.sum?0:e.sum,r=money(moneySmall(r.toString().replace("￥","")))):r=e.sum,gridSettings.dellist&&(r=getgridcheckedsum(t.datafield,table)),t.text.indexOf("编号")>-1&&(r="合计",n="left"),t.text.indexOf("金额")>-1?(o="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;金额:",r=money(r)):r=money(r,4,!0),t.text.indexOf("重量")>-1&&(o="重量:"),t.text.indexOf("箱数")>-1&&(o="总箱数:"),t.text.indexOf("总数量")>-1&&(o="总数量:"),t.text.indexOf("送货数量")>-1&&(o="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;送货数量:"),t.text.indexOf("收货数量")>-1&&(o="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;收货数量:"),t.text.indexOf("已送数量")>-1&&(o="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;已送数量:"),t.text.indexOf("已收数量")>-1&&(o="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;已收数量:"),t.text.indexOf("本次送货")>-1&&(o="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本次送货:"),t.text.indexOf("本次收货")>-1&&(o="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本次收货:");var l='<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: '+n+'; ">'+o+r+"</div>";return 0!=qtyNowVisible||"已送数量:"!=o&&"已收数量:"!=o||(l=""),l});if(columns.unshift(defaultArr[0]),gridSettings.delBtn&&columns.unshift(defaultArr[1]),gridSettings.dellist){var html='<div style="position: absolute; top: 50%; left: 50%; margin-top: -7px; margin-left: -10px; overflow: visible; cursor: auto;" id="dellist" tabindex="0" class="jqx-widget jqx-checkbox"><div class="jqx-checkbox-default jqx-fill-state-normal jqx-rc-all"><div style="width: 13px; height: 13px;"><span style="width: 13px; height: 13px;" class=""></span></div></div><div style="clear: both;"></div></div>';columns.unshift({text:html,columntype:"checkbox",width:"3%",datafield:"waitdel",hidden:!1,enabletooltips:!1}),$("#addPurchaseOrder_grid").on("click","#dellist",function(){var e=$(this).find("span"),t=!1,a=null;"jqx-checkbox-check-checked"===e.attr("class")?a="remove":(a="add",t=!0);var r=$("#addPurchaseOrder_grid").getData(),o=[];for(var i in r)r[i].waitdel=t,o.push(r[i]);0==o.length?$("#addPurchaseOrder_grid").updateListRow([{}]):$("#addPurchaseOrder_grid").updateListRow(o),"remove"==a?$("#dellist").find("span").removeClass("jqx-checkbox-check-checked"):$("#dellist").find("span").addClass("jqx-checkbox-check-checked")});for(var i in columns){var datafield=columns[i].datafield;"qty"===datafield&&(columns[i].text="本次采购"),"purchasedQty"!==datafield&&"salesQty"!==datafield||(columns[i].hidden=!1)}}return columns},dataCopyLast=function(e){var t={},a=e[e.length-1];for(var r in a)t[r]=null;return e.push(t),e},dataCopyNullList=function(e){var t={},a=e[e.length-1];for(var r in a)t[r]=null;return t},grid_render=function(e,t){if(!1===t){var a={localdata:e,datatype:"array"},r=new $.jqx.dataAdapter(a,{downloadComplete:function(e,t,a){},loadComplete:function(e){},loadError:function(e,t,a){}});return table.jqxGrid({source:r}),void settings.columnSumEvent()}var a={localdata:e,datatype:"json",datafields:[{name:"productName",type:"string"},{name:"id",type:"string"},{name:"waitdel",type:"bool"},{name:"printOfGoods",type:"string"},{name:"photoId",type:"string"},{name:"oldPhotoId",type:"string"},{name:"photoAddId",type:"string"},{name:"spec",type:"string"},{name:"descr",type:"string"},{name:"color",type:"string"},{name:"prodColourDescr",type:"string"},{name:"weight",type:"string"},{name:"totalCartons",type:"string"},{name:"eachCartons",type:"string"},{name:"qty",type:"string"},{name:"purchasedQty",type:"string"},{name:"salesQty",type:"string"},{name:"priceBefore",type:"string"},{name:"price3",type:"string"},{name:"price3_server",type:"string"},{name:"extent",type:"string"},{name:"breadth",type:"string"},{name:"altitude",type:"string"},{name:"tj",type:"string"},{name:"deliveiedQty",type:"string"},{name:"deliveryQtyNow",type:"string"},{name:"remark",type:"string"},{name:"dzid",type:"string"},{name:"rowweight",type:"string"},{name:"ysprice",type:"string"},{name:"dsprice",type:"string"},{name:"volume",type:"string"},{name:"yards",type:"string"},{name:"unit",type:"string"},{name:"unitRate",type:"string"},{name:"unitRateqty",type:"string"},{name:"basicUnit",type:"string"},{name:"unitsFlag",type:"string"},{name:"deliveryQtyAll",type:"string"},{name:"inventoryReducere",type:"string"},{name:"amountFormula",type:"string"},{name:"inventoryQtyFormula",type:"string"},{name:"grid_focus",type:"string"},{name:"discount",type:"string"},{name:"originalPrice",type:"string"},{name:"specId",type:"string"},{name:"colorId",type:"string"}],addrow:function(e,t,a,r){r(!0),timeOut(function(){table.jqxGrid("endupdate")})},updaterow:function(e,t,a){a(!0)}},r=new $.jqx.dataAdapter(a,{loadComplete:function(e){},loadError:function(e,t,a){}});table.jqxGrid({selectionmode:"singlecell",editmode:"click",enableanimations:!1,scrollmode:"deferred",enablemousewheel:!0,keyboardnavigation:!0,columnsheight:columnsheight,altrows:!0,editable:gridSettings.editable,columnsresize:!0,width:"100%",rowsheight:40,pageable:!1,enablebrowserselection:!1,enabletooltips:!0,autoheight:!0,localization:gridLocalizationObj,source:r,statusbarheight:40,showstatusbar:!0,showaggregates:!0,showtoolbar:!1,rendertoolbar:function(e){},columns:columns_Handle(columns),columngroups:[{text:"外箱尺寸(cm)",align:"center",name:"外箱尺寸"}],ready:function(){table.addClass("easyGrid"),timeOut(function(){grid_refresh()})},rendered:function(e){},handlekeyboardnavigation:function(e){if(table.is(":visible")){var t=e.target,a=e.charCode?e.charCode:e.keyCode?e.keyCode:0,r=t.id;if(r.indexOf("remarkPrint")>-1&&13==a)return!1;var o=void 0==t.selectionStart?0:t.selectionStart,i=table.jqxGrid("getselectedcell");if(void 0==i){if(27==a){var n=$("#floatImg>img");n.length>0&&n.eq(0).trigger("dblclick")}return}if(1==$("#confirmWindow").length)return 13==a&&($("#okButton_cf").addClass("btnClass"),timeOut(function(){$("#okButton_cf").trigger("click")},500)),!0;var l=$(t).val(),d=i.rowindex,s=i.datafield,c=void 0==l.length?"":l.length,u=$("#templateeditor"+table.attr("id")+s);if(39==e.keyCode&&o==c&&table.jqxGrid("endcelledit",d,s,!1),37==e.keyCode&&0==o&&table.jqxGrid("endcelledit",d,s,!1),9==e.keyCode&&timeOut(function(){$("#"+u.attr("aria-owns")).hide()},60),82==e.keyCode&&e.altKey&&"remark"==s){var g=l.length;t.selectionStart=g,t.selectionEnd=g}if(!(48!=e.keyCode&&96!=e.keyCode||r!="content"+table.attr("id")||"操作"!=s&&"sequence"!=s)){for(var p=0;p<5;p++)table.jqxGrid("addrow",null,defaultrow());return!0}if(e.altKey&&e.ctrlKey&&(table.jqxGrid("endcelledit",d,s,!1),table.jqxGrid("selectcell",d,"productName")),e.ctrlKey&&88==a&&-1==t.className.indexOf("form-control")&&-1==t.className.indexOf("jqx-calendar"))return u.length&&u.jqxComboBox("close"),table.jqxGrid("endcelledit",d,s,!1),table.find(".del").eq(d).trigger("click"),!0;if(e.ctrlKey&&e.shiftKey&&-1==t.className.indexOf("form-control")&&-1==t.className.indexOf("jqx-calendar"))return u.length&&u.jqxComboBox("close"),table.jqxGrid("endcelledit",d,s,!1),table.find(".copy").eq(d).trigger("click"),!0}}})};needRefresh?grid_refresh(source):grid_render(source),gridSettings.delBtn&&(table.on("click",".addPhoto",function(e){setTimeout(function(){timeOut(function(){photoModal(table.attr("id"),settings.productSourceName)},20)},0)}),table.on("click",".addyards",function(e){setTimeout(function(){timeOut(function(){yardsModal(table.attr("id"))},20)},0)}),table.on("click",".addUnit",function(e){setTimeout(function(){timeOut(function(){addUnitModal(table.attr("id"))},20)},0)}),table.on("click",".sendStart",function(e){timeOut(function(){for(var e=table.jqxGrid("source").records,t=0;t<e.length;t++)e[t].deliveryQtyNow=e[t].qty,computeRow(e[t]);table.jqxGrid("source").records=e,table.jqxGrid("refreshdata"),table.jqxGrid("refresh"),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()})}),table.on("click",".sendRun",function(e){timeOut(function(){for(var e=table.jqxGrid("source").records,t=0;t<e.length;t++)e[t].deliveryQtyNow=money(money(e[t].qty)-money(e[t].deliveiedQty),2,!0),computeRow(e[t]);table.jqxGrid("source").records=e,table.jqxGrid("refreshdata"),table.jqxGrid("refresh"),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()})}),table.on("click",".del",function(e){return 1!=table.jqxGrid("source").records.length&&(Core.confirm({message:"确定要删除？",confirmCallback:function(){var e=table.jqxGrid("source").records,t=table.jqxGrid("getselectedcell").rowindex,a=table.jqxGrid("getrowid",t);table.jqxGrid("deleterow",a),e=getData(e),table.jqxGrid("source").records=e,table.jqxGrid("refreshdata"),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()}}),!1)}),table.on("click",".add",function(e){timeOut(function(){table.jqxGrid("beginupdate");var e=table.jqxGrid("getselectedcell").rowindex,t=(table.jqxGrid("getrowdata",e),table.jqxGrid("source").records),a=defaultrow();t.splice(e+1,0,a),t=getData(t),table.jqxGrid("source").records=t,table.jqxGrid("refreshdata"),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent(),table.jqxGrid("endupdate")},0)}),table.on("click",".copy",function(e){timeOut(function(){table.jqxGrid("beginupdate");var e=table.jqxGrid("getselectedcell").rowindex,t=(table.jqxGrid("getrowdata",e),table.jqxGrid("source").records),a=getData()[e];a.dzid=null,t.splice(e+1,0,a),t=getData(t),table.jqxGrid("source").records=t,table.jqxGrid("refreshdata"),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent(),table.jqxGrid("endupdate")},0);var t=table.jqxGrid("source").records.length;if(table.jqxGrid("getselectedcell")+1==t)return!1})),table.on("resetColumnSum",function(){"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()}),table.on("click",".addspecbtn",function(){var e=table.attr("id"),t=table.jqxGrid("getselectedcell").rowindex,a=null==table.jqxGrid("getrowdata",t)?{}:table.jqxGrid("getrowdata",t),r=a.id;if(null==r||""==r)return Core.alert({message:"请先选择产品"}),!1;specModal(e,r)}),table.on("refresh",function(e){grid_refresh(null,!1)}),table.on("click",".jqx-grid-header,.jqx-button,.del,.add,.copy,.addPhoto",function(e){var t=table.data();null!=t.lastcell&&table.jqxGrid("endcelledit",t.lastindex,t.lastcell,!1)}),table.on("cellbeginedit",function(e){e.stopPropagation();var t=e.args,a=e.args.datafield,r=e.args.rowindex;t.value,t.row;table.data("lastcell",a),table.data("lastindex",r)});var search=function(e,t){if(""==e)return!1;var a=prodArr;if(t){for(var r=0,o=a.length;r<o;r++)if(a[r].name==e)return!0;return!1}for(var i=settings.productSourceName.product.concat(prodArr),r=0,o=i.length;r<o;r++)if(i[r].name==e)return!0;return!1},easytablekeyup=null;table.on("keyup",".color",function(){if("start"===table.prop("comStart"))return void event.stopPropagation();var e=$(this),t=e.val(),a=$("#templateeditor"+table.attr("id")+"color"),r=a.jqxComboBox("getItems");$("#"+table.attr("id")+"id");9==event.keyCode&&timeOut(function(){$("#"+a.attr("aria-owns")).hide(),a.jqxComboBox("open")},60),clearTimeout(easytablekeyup),easytablekeyup=setTimeout(function(){for(var e in r)t==r[e].label&&a.jqxComboBox("selectItem",t)},60)}),table.on("keyup",".spec",function(){if("start"===table.prop("comStart"))return void event.stopPropagation();var e=$(this),t=e.val(),a=$("#templateeditor"+table.attr("id")+"spec"),r=a.jqxComboBox("getItems");$("#"+table.attr("id")+"id");9==event.keyCode&&timeOut(function(){$("#"+a.attr("aria-owns")).hide(),a.jqxComboBox("open")},60),clearTimeout(easytablekeyup),easytablekeyup=setTimeout(function(){for(var e in r)t==r[e].label&&a.jqxComboBox("selectItem",t)},60)}),table.on("cellclick",function(e){}),table.on("keyup",".productName",function(e){var t=$(this),a=t.val(),r=$("#templateeditor"+table.attr("id")+"productName"),o=$("#"+table.attr("id")+"id");if(9==e.keyCode&&timeOut(function(){$("#"+r.attr("aria-owns")).hide(),r.jqxComboBox("open")},60),clearTimeout(easytablekeyup),27==e.keyCode)return $("#floatImg>img").eq(0).trigger("dblclick"),r.jqxComboBox("open"),!0;easytablekeyup=setTimeout(function(){t.find("input").focusIndex();if(""==a)return o.text(""),void r.jqxComboBox("clearSelection");search(a)?(o.text(""),r.jqxComboBox("selectItem",a)):o.text("新产品")},60)}),table.on("cellendedit",function(event){event.preventDefault();var lastcell=table.data();$("#"+table.attr("id")+"id").text("");var datafield=null==event.args?{}:event.args.datafield,t=$("#templateeditor"+table.attr("id")+datafield);t.length>0&&timeOut(function(){$("#"+t.attr("aria-owns")).hide()},60);var rowBoundIndex=event.args.rowindex,selectedrowindex=event.args.rowindex,id=table.jqxGrid("getrowid",selectedrowindex),productName=event.args.value,row=table.jqxGrid("getrowdata",selectedrowindex),oldname=row.productName;if("object"==typeof event.args.value)var searchName=null==event.args.value?row.name:event.args.value.label,sourceByName=ComboBoxSources.getInfoMapByKey(productSourceName,"name",searchName);else var searchName=event.args.value.replace(/ /g,""),sourceByName=ComboBoxSources.getInfoMapByKey(settings.productSourceName.productsInUse,"name",searchName);if("productName"==datafield){if(table.jqxGrid("iscolumnvisible","yards")||(row.qty=1),table.jqxGrid("iscolumnvisible","discount")&&(row.discount="100%"),table.jqxGrid("iscolumnvisible","totalCartons")&&(row.totalCartons=1,row.eachCartons=0,row.qty=0),2==JSON.stringify(sourceByName).toString().length&&""!=searchName)return null==searchName||(row.productName=searchName,row.photoId="",null==t.jqxComboBox("getSelectedItem")&&(row.spec="",row.color=""),row.name=searchName,row.unit="",row.basicUnit="",row.amountFormula=_global_settings.acOwner.ownerAttr.amount,row.inventoryQtyFormula=_global_settings.acOwner.ownerAttr.inventoryQty,search(searchName)||prodArr.push({name:searchName}),timeOut(function(){table.jqxGrid("updaterow",id,row)},0),!0);if(""==sourceByName.name||null==sourceByName.name){table.jqxGrid("iscolumnvisible","discount")&&(row.discount="0"),row.qty=0,row.productName=searchName,row.photoId="",row.spec="",row.color="",row.name="",row.unit="",row.basicUnit="",null==t.jqxComboBox("getSelectedItem")&&t.jqxComboBox("close");var commit=table.jqxGrid("updaterow",id,row);return!0}if(event.args.oldvalue===event.args.value.value)return!1;row.productName=searchName,row.photoId=sourceByName.prodPhoto,row.name=searchName,setRowData(datafield,rowBoundIndex)}else if("unitRate"==datafield)if(null!=event.args.value.label&&""!=event.args.value.label&&event.args.value.label!=event.args.oldvalue.label){var prod=ComboBoxSources.getInfoMapByKey(productSourceName,"name",row.productName);if(prod.multiUnitFlag){var unitRow=ComboBoxSources.getInfoMapByKey(prod.prodContainerList,"unitName",event.args.value.label.replace(/\(.{0,}\)$/,""));row.unitRate=unitRow.rate,unitRow.unitName!=row.basicUnit?row.unit=unitRow.unitName+"("+row.unitRate+row.basicUnit+")":row.unit=unitRow.unitName,row.priceBefore="salePrice"==sourceType?unitRow.salePrice:unitRow.purchasePrice}else row.unit=event.args.value.label,row.unitRate=1,row.basicUnit=event.args.value.label}else null!=event.args.value.label&&""!=event.args.value.label||(row.unitRate=1,row.basicUnit="",row.unit="",null==t.jqxComboBox("getSelectedItem")&&t.jqxComboBox("close"));else if("spec"==datafield){var t=$("#templateeditor"+table.attr("id")+datafield),label=event.args.value.label,item=t.jqxComboBox("getSelectedItem");null==item&&""!=label&&specArr.push({descr:label}),null==t.jqxComboBox("getSelectedItem")&&t.jqxComboBox("close"),row[datafield]=label}else if("color"==datafield){var prod=ComboBoxSources.getInfoMapByKey(productSourceName,"name",row.productName),t=$("#templateeditor"+table.attr("id")+datafield),label=event.args.value.label,item=t.jqxComboBox("getSelectedItem");null==item&&""!=label&&colorArr.push({descr:label}),null==t.jqxComboBox("getSelectedItem")&&t.jqxComboBox("close"),row[datafield]=label}else if("yards"==datafield){var yards=event.args.value,sum=0;row[datafield]=event.args.value,$.each(yards.split(","),function(i,v){sum+=eval(v)}),row.qty=sum}else if("discount"==datafield){var a=event.args.value.split("%")[0],b=a>=1e3||a<=0?1e3:money(a),c=b.toString().split(".");1==c.length?b=c[0]:"00"==c[1]&&(b=c[0]),row[datafield]=b+"%",row.originalPrice=money(row.priceBefore*b/100,4,!0)}else row[datafield]=event.args.value;row.qty=""==row.qty||"NaN"==row.qty?0:row.qty;var oldqty=row.qty;"qty"==datafield&&(row.totalCartons=0,row.eachCartons=0,row.qty=oldqty);for(var arr=["weight","priceBefore","totalCartons","eachCartons","qty","extent","breadth","altitude","volume","tj","deliveiedQty","deliveryQtyNow"],i=0;i<arr.length;i++){var v=row[arr[i]];row[arr[i]]=money(v,4,!0);var arrs=["extent","breadth","altitude","volume"];arrs.indexOf(arr[i])>-1&&(row[arr[i]]=money(v,4,!0,!0))}computeRow(row);var xrow=$.extend(!0,{},row);if("productName"==datafield){var prod=ComboBoxSources.getInfoMapByKey(productSourceName,"name",row.productName);getProductInfoById(prod.id),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()}else timeOut(function(){if("spec"==datafield||"color"==datafield){var e=ComboBoxSources.getInfoMapByKey(productSourceName,"name",row.productName);event.args.value.value!=event.args.oldvalue&&e.id&&setUnit(xrow,e.id)}table.jqxGrid("updaterow",id,xrow);"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()},0);return!0});var setUnit=function(e,t){var a=t,r=settings.ownerSettings.soOwnerId,o=settings.ownerSettings.userName;Core.AjaxRequest({type:"get",url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/productid/"+a+"/"+r+"/"+o),async:!1,showMsg:!1,callback:function(t){if(!t.multiUnitFlag){for(var a=t.prodColourList,r=0;r<a.length;r++)if(e[n]==a[r].descr){var o="";void 0!=a[r].photo&&""!=a[r].photo&&(o=a[r].photo),""!=o&&(e.photoId=o)}return!1}var i=void 0==e.spec?"":e.spec,n=void 0==e.color?"":e.color,l=t.inDataList,d=t.prodContainerList[0].unitName;$.each(l,function(a,r){if(i==r.spec&&n==r.colour){var o=r.prodContainerList;$.each(o,function(e,t){t.unitName!=d&&(t._unitName=t.unitName,t.unitName=t.unitName+"("+t.rate+d+")")});var l=ComboBoxSources.getInfoMapByKey(o,"commonFlag",!0);return e.basicUnit=d,e.unit=l.unitName,e.unitRate=l.rate,e.unitsFlag=!0,"salePrice"==sourceType?(e.priceBefore=l.salePrice,e.cost=l.purchasePrice):e.priceBefore=l.purchasePrice,!1}var o=t.prodContainerList;$.each(o,function(e,t){t.unitName!=d&&(t._unitName=t.unitName,t.unitName=t.unitName+"("+t.rate+d+")")}),e.basicUnit=d,e.unit=e.unit,e.unitRate=e.unitRate,e.unitsFlag=!0})}})};table[0].getData=function(e){return getData(e)},table[0].getDataWash=function(e,t){return getDataWash(e,t)},table[0].getDataDirty=function(){return getDataDirty()},table[0].addLastRow=function(e){return addLastRow(e)},table[0].grid_render=function(e,t){grid_render(e,t)}},$.fn.getData=function(e){return $(this)[0].getData(e)},$.fn.getDataWash=function(e){return $(this)[0].getDataWash($(this).getData(),e)},$.fn.getDataDirty=function(e){return $(this)[0].getDataDirty(e)},$.fn.addLastRow=function(e){var t=$(this),a={totalCartons:0,eachCartons:0,prodSpecId:null,prodColourId:null,weight:null,extent:null,breadth:null,altitude:null,tj:null},r=[];for(var o in a)try{t.jqxGrid("iscolumnvisible",o)||r.push(o)}catch(e){}t[0].grid_render(t[0].addLastRow(e));for(var o=0;o<r.length;o++)"totalCartons"==r[o]&&t.jqxGrid("setcolumnproperty","qty","editable",!0),t.jqxGrid("hidecolumn",r[o]);t.jqxGrid("hidecolumn","dzid")},$.fn.updateListRow=function(e){$(this)[0].grid_render(e,!1)},$.fn.getRowData=function(){var e=$(this).jqxGrid("getselectedcell").rowindex;return $(this).jqxGrid("getrowdata",e)},$.fn.boxSetting=function(e){var t=$(this);if(!t.is(":hidden")){var a="hide"==e?"hidecolumn":"showcolumn",r="hide"==e,o=["totalCartons","eachCartons"];t.jqxGrid("beginupdate");for(var i=0;i<o.length;i++)t.jqxGrid(a,o[i]);t.jqxGrid("setcolumnproperty","qty","editable",r),t.jqxGrid("endupdate"),t.trigger("refresh")}},$.fn.printOfGoodsFlag=function(e){var t=$(this),a="hide"==e?"hidecolumn":"showcolumn";_global_settings.acOwner.blueTooth&&t.attr("id").indexOf("ale")>-1&&(a="hidecolumn");t.jqxGrid("beginupdate"),t.jqxGrid(a,"printOfGoods"),t.jqxGrid("endupdate")},$.fn.productMeasFlag=function(e,t){var a=$(this),r="hide"==e?"hidecolumn":"showcolumn",o=["volume"];"size"!=t&&null!=t||(o=["extent","breadth","altitude"]),a.jqxGrid("beginupdate");for(var i=0;i<o.length;i++)a.jqxGrid(r,o[i]);a.jqxGrid("endupdate")},$.setGoodsBinning=function(e,t,a,r,o,i,n,l){var d=null;!0===i||(i=!1),$.visibleDoFunc($(".easyGridClientId"),function(e){d=e.val()});var s=a.productName,c=null,u=a.spec;for(var g in l)s==l.name&&(c=l.id);if(""!=d&&null!=d||(d=null),""==c||null==c)return!1;if(""!=u&&null!=u||(u=null),"salePrice"==o)var p=_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("order/goodsBinning/"+d+"/"+c+"/"+u);else var p=_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("/order/goodsBinning/purchaseOrder/"+d+"/"+c+"/"+u);Core.AjaxRequest({type:"GET",showMsg:!1,async:i,url:p,callback:function(a){for(var o=e.jqxGrid("getrowdata",t),i=["printOfGoods","weight","totalCartons","eachCartons","priceBefore","extent","breadth","altitude"],d=0;d<i.length;d++){var s=a[i[d]];""!=s&&null!=s&&0!=s&&(o[i[d]]=a[i[d]])}n?o.qty=money(o.totalCartons*o.eachCartons,4,!0):(o.totalCartons=0,o.eachCartons=0,o.qty=money(o.qty,4,!0)),o.price3_server=money(o.priceBefore*o.qty),o.price3=o.priceBefore*o.qty,o.photoId=void 0===o.photoId?void 0===l?"":l.prodPhoto:o.photoId;e.jqxGrid("updaterow",t,o);"function"==typeof r&&r()},failure:function(e){}})};var unitArr=[],specArr=[],colorArr=[],prodArr=[],addUnitModal=function(e){var t=$("#"+e).data().soownerid,a=$("#"+e).data().name,r=function(){$("#order_unitTbody").html("").append('<tr><td><input data-index="0" data-blacklist=" " class="addLine" type="text"></td><td colspan="2"></td></tr>'),Core.AjaxRequest({url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/searchOwnerUnitTypeVO/"+t+"/"+a),type:"GET",async:!1,callback:function(e){d(e)},failure:function(){}}),$("#order_unitTbody").off("keyup").on("keyup",".addLine",function(e){var t=$(this),a=t.val();if(13==e.keyCode&&""!=a){if(o(a))return Core.alert({message:"单位已存在，请重新输入！"}),$(this).val(""),!1;var r='<tr><td><input data-blacklist=" " class="addUnit" type="text" value="'+a+'"></td><td colspan="2"><span class="md-cancel delete"></span></td></tr>';t.parents("tr").after(r),t.val(""),l(),$("#order_unitTbody").find(".addUnit").off("blur").on("blur",i)}}),$("#order_unitTbody").find(".addUnit").off("blur").on("blur",i),$("#order_unitTbody").off("click").on("click",".delete",function(e){var t=$(this);Core.confirm({message:"确定要删除吗？",confirmCallback:function(){t.parents("tr").remove(),l()}})}),$("#order_addUnit").modal("show"),s()},o=function(e){for(var t=$("#order_unitTbody").find("tr:gt(0)"),a=0,r=t.length;a<r;a++)if(t.eq(a).find("input").val()==e)return!0;return!1},i=function(){var e=$(this),t=e.attr("data-index"),a=e.attr("value"),r=e.val();if(r!=a&&n(e,r,t))return Core.alert({message:"第"+t+"行单位已存在，请重新填写！"}),e.val(a),!1},n=function(e,t,a){for(var r=$("#order_unitTbody").find("tr"),o=0,i=r.length;o<i;o++)if(o!=a&&r.eq(o).find("input").val()==t)return!0;return!1},l=function(){for(var e=$("#order_unitTbody").find("tr"),t=0,a=e.length;t<a;t++)e.eq(t).find("input").attr("data-index",t)},d=function(e){for(var t=0;t<unitArr.length;t++){var a='<tr><td><input data-index="'+(t+1)+'" data-blacklist=" " type="text" class="addUnit" value="'+unitArr[t].unitName+'"></td><td colspan="2"><span class="md-cancel delete"></span></td></tr>';$("#order_unitTbody").append(a)}for(var t=0;t<e.length;t++){var a='<tr><td><input readonly type="text" value="'+e[t].unitGroupName+'"></td><td colspan="2"></td></tr>';$("#order_unitTbody").append(a)}},s=function(){$("#save_addUnitBtn").on("click",function(){unitArr=[];var e=$("#order_unitTbody").find("tr"),t=e.eq(0).find("input").val();if(o(t))return Core.alert({message:"单位已存在，请重新输入！"}),e.eq(0).find("input").val(""),!1;$.each(e,function(e,t){var a=$(t),r=a.find("input").val(),o=a.find("input").attr("readonly");if(""!=r&&!o){var i={unitName:r,rate:1};unitArr.push(i)}})})};0==$("#order_addUnit").length?$.loadModal("page/common/segment/addUnit.html",function(e){$("body").append(e),r()}):r()},photoModal=function(e,t){var a=$("#"+e).jqxGrid("getselectedcell").rowindex,r=$("#"+e).jqxGrid("getrowdata",a),o=($("#"+e).data().soownerid,$("#"+e).data().name,r.productName);if(null==o||""==o)return Core.alert({message:"请选择产品"}),!1;var i=t.product,n=(ComboBoxSources.getInfoMapByKey(i,"name",o),function(){$("#photoModal_list").html('<div style="width: 258.66px; height: 166px; position: relative;">  \t<img class="img0" border="0" src="images/common/photo_icon2.png"\t\twidth="100%" height="100%"> <i                              \t\tclass="md-cancel close-lab"></i>                            </div>                                                             <input type="file" class="file0" style="display: none"             \tname="file">                                                    '),l(),$("#photoModal").modal("show")}),l=function(t){$("#photoModal_saveBtn").off("click").on("click",function(){try{var t=ComboBoxSources.getInfoMapByKey(i,"name",o);if(t.prodPhoto=$("#photoModal").find(".file0").data("id"),null==t.prodPhoto||""==t.prodPhoto)throw Core.alert({message:"请上传产品图片"}),new Error("请上传产品图片");t.name=t._name,delete t._name;t.id,t.prodPhoto;$("#photoModal").modal("hide"),r.photoId=t.prodPhoto,r.oldPhotoId=r.photoId;$("#"+e).jqxGrid("updaterow",a,r),$("#"+e).data();$("#"+e).jqxGrid("begincelledit",a,"grid_focus"),$("#"+e).jqxGrid("endcelledit",a,"grid_focus",!0)}catch(e){}})};0==$("#photoModal").length?$.loadModal("page/common/segment/photoModal.html",function(t){var a=$(t);$("body").append(a),$("#photoModal").on("click",".close-lab",function(e){var t=$(this),a=$(this).parents("form"),r=t.data("id");if(""!=r&&null!=r)return Core.AjaxRequest({url:ws_url+"/CXF/rs/common/file/"+r,type:"DELETE",showMsg:!1,callback:function(e){a.find(".file0").val(""),a.find(".img0").attr("src","images/common/photo_icon2.png"),a.find(".file0").data("id",""),t.data("id","")},failure:function(e){}}),!1}),$("#photoModal").on("click",".img0",function(){-1!=$(this).attr("src").indexOf("images/common")&&$(this).parents("form").find(".file0").trigger("click")}),$("#photoModal").on("change",".file0",function(){var t=$(this),a=getObjectURL(this.files[0]),r=$("#"+e).attr("data-soOwnerId"),o=$("#"+e).attr("data-name");uploadImage(t,t.parents("form"),r,o)&&timeOut(function(){t.parents("form").find(".img0").attr("src",a)})}),n()}):n()},getObjectURL=function(e){var t=null;return void 0!=window.createObjectURL?t=window.createObjectURL(e):void 0!=window.URL?t=window.URL.createObjectURL(e):void 0!=window.webkitURL&&(t=window.webkitURL.createObjectURL(e)),t},uploadImage=function(e,t,a,r){if(!checkFileType(e))return!1;var o=function(o){var i=ctx+"/CXF/rs/SimpleAC/file/"+(new Base64).encode("toocr/order/file/"+a+"/"+r),n=new FormData,l=function(e){for(var t=e.split(","),a=t[0].match(/:(.*?);/)[1],r=atob(t[1]),o=r.length,i=new Uint8Array(o);o--;)i[o]=r.charCodeAt(o);return new Blob([i],{type:a})}(o),d=e[0].files[0];$.each(d,function(e,t){n.append(e,t)}),n.append("file",l,d.name),$.ajax({type:"POST",url:i,data:n,async:!1,cache:!1,contentType:!1,processData:!1,success:function(a){if(e.data("id",a.id),t.attr("class").indexOf("imgFile")>-1&&t.find(".close-lab").data("id",a.id),e.parents(".colorModalList").length>0){
var r=e.parents(".imgFile").find(".prod_specText").val();if(""==r)return!1;$("#colorModal_id").val(),a.id}else e.parents("#photoModal_list").length>0&&e.parents("#photoModal_list").find(".file0").data("id",a.id)},error:function(e,t,a){Core.alert({message:"上传失败，请检查文件格式或刷新后重试！"})}})};return timeOut(function(){new imgBase64(e).toDataURL(e.parents(".imgFile").find("img")[0],o)}),!0},checkFileType=function(e){var t="";if(""==(t="string"==typeof e?e:e.val()))return void("string"!=typeof e&&(Core.alert({message:"请选择上传图片！"}),e.parents("form").find("img").attr("src","images/common/photo_icon2.png")));var a=t.substr(t.lastIndexOf(".")+1).toLowerCase();return"jpg"==a||"jpeg"==a||"gif"==a||"png"==a||"bmp"==a||("string"!=typeof e&&Core.alert({message:"请选择图片文件！"}),!1)},yardsModal=function(e){var t=$("#"+e).jqxGrid("getselectedcell").rowindex,a=$("#"+e).jqxGrid("getrowdata",t),r=null==a.yards||""==a.yards?[]:a.yards.split(","),o=function(e){for(var t=[],a=0;a<e.length;a++)t[a]={},t[a].label=e[a],t[a].value=a.toString();return t},i={localdata:o(r),datatype:"array"},n=new $.jqx.dataAdapter(i),l=function(){for(var e=$("#yardsModal_box"),t=0;t<i.localdata.length;t++)e.jqxComboBox("selectIndex",t)},d=function(e){e=0!=e;var t=$("#yardsModal_box"),a=t.jqxComboBox("getSelectedItems"),r=money(t.find("input").val(),4,!0),i=[];return $.each(a,function(e){i.push(this.label)}),0!=r&&i.push(r.toString()),e?o(i):i},s=function(){$("#yardsModal_saveBtn").off("click").on("click",function(){var t=d(!1),a=0;if($.each(t,function(e,t){a+=parseFloat(t)}),t.length>20)return Core.alert({message:"细码个数不能超过20个哦"}),!1;if(Math.max.apply(null,t)>9999999)return Core.alert({message:"单个细码数值不能超过1000万，请删除后重试"}),!1;var r=$("#"+e),o=$("#"+e).jqxGrid("getselectedcell").rowindex;r.jqxGrid("setcellvalue",o,"yards",t.join(","));var i=r.jqxGrid("getcolumnproperty","qty","editable");r.jqxGrid("setcolumnproperty","qty","editable",!0),r.jqxGrid("begincelledit",o,"qty",a),r.jqxGrid("endcelledit",o,"qty",!1),r.jqxGrid("setcolumnproperty","qty","editable",i),$("#yardsModal").modal("hide")}),$("#yardsModal_box").off("keyup").on("keyup",function(e){if(13==e.keyCode){var t=$(this).find("input").val();if(""==t)return void $("#yardsModal_saveBtn").triggerHandler("click");if(d(!1).length>20)return Core.alert({message:"细码个数不能超过20个哦"}),!1;if(t>9999999)return Core.alert({message:"单个细码数值不能超过1000万"}),!1;i.localdata=d(),n.dataBind(),l()}})},c=function(){s(),$("#yardsModal_box").jqxComboBox({source:n}),l(),$("#yardsModal").modal("show"),$("#yardsModal_box").find("input").focus()};0==$("#yardsModal").length?$.loadModal("page/common/segment/yardsModal.html",function(e){var t=$(e);$("body").append(t),$("#yardsModal_box").jqxComboBox({showArrow:!1,multiSelect:!0,width:"100%",popupZIndex:-1,searchMode:"none",displayMember:"label",valueMember:"value",height:30}),c()}):c()},deleteBy=function(e,t,a){"string"==typeof t&&(t=[t]);for(var r=[],o=0;o<e.length;o++){for(var i=!0,n=0;n<t.length;n++)if(e[o][a]==t[n]){i=!1;break}i&&r.push(e[o])}return r},setToggerColumns=function(e,t,a){for(var r=!1,o=0;o<t.length;o++){for(var i in e)!0!==e[i]&&!1!==e[i]||t[o].datafield==i&&("totalCartons"===i&&(r=!0),t[o].hidden=e[i]);"qty"===t[o].datafield&&(r&&(t[o].editable=!0),_global_settings.acOwner.yardsFlag&&(t[o].editable=!1))}return t};!function(e){var t=e("<div style='position: fixed;display:none;z-index: 9999990;' id='floatImg'></div>"),a=e("<div class='md-rotate-right hide' id='floatImg_rotate' title='点击旋转' style='color:red;cursor:pointer;font-size:33px;float:right;position:fixed;z-index:999'></div>");e("body").append(t).append(a);var r=document.getElementById("floatImg");!function(){e("#floatImg").off("mousedown").on({mousedown:function(t){var a=!0,o=t.clientX,i=t.clientY,n=e(this)[0].offsetLeft,l=e(this)[0].offsetTop,d=r.offsetWidth,s=r.offsetHeight,c=r.getAttribute("rotate");if(90==c||270==c){var u=(r.offsetHeight-r.offsetWidth)/2;d=r.offsetHeight-u,s=r.offsetWidth+u}e(this)[0].ondragstart=function(){return!1},e("#floatImg").off("mousemove").on("mousemove",function(t){var r=t.clientX-o,c=t.clientY-i;a&&(e("#floatImg_rotate").css({top:l+c+s,left:n+r+d}),e("#floatImg").css({left:n+r,top:l+c}))}),e("#floatImg").off("mouseup").on("mouseup",function(e){a=!1})}})}(),function(){e("#floatImg").on("mousewheel",function(t,a){var r=e(this),o=t.originalEvent.wheelDelta>0?1.1:.9,i=t.originalEvent.wheelDelta>0?-.1:.1,n=parseFloat(r[0].style.width.replace("px","")),l=parseFloat(r[0].style.height.replace("px","")),d=parseFloat(r.css("top").replace("px","")),s=parseFloat(r.css("left").replace("px","")),c={top:d+i*l/2,left:s+i*n/2,width:n*o,height:l*o};r.css(c);var u=e("#floatImg_rotate"),g=void 0==r.attr("rotate")?0:parseFloat(r.attr("rotate"));360==g&&(g=0);var p=parseFloat(u.css("top").replace("px","")),m=parseFloat(u.css("left").replace("px",""));return 0==g||180==g?u.css({top:p-i*l/2,left:m-i*n/2}):u.css({top:p-i*n/2,left:m-i*l/2}),!1})}(),e("#floatImg_rotate").on("click",function(){var t=e("#floatImg").data("rotate");t+=90,e("#floatImg").data("rotate",t).css("transform","rotate("+t+"deg)"),o(e("#floatImg"),e("#floatImg_rotate"),!0)});"Chrome"!=function(){var e=navigator.userAgent,t=e.indexOf("Opera")>-1,a=window.ActiveXObject||"ActiveXObject"in window,r=e.indexOf("Edge")>-1,o=e.indexOf("Firefox")>-1,i=e.indexOf("Safari")>-1&&-1==e.indexOf("Chrome"),n=e.indexOf("Chrome")>-1&&e.indexOf("Safari")>-1&&!r;if(a){new RegExp("MSIE (\\d+\\.\\d+);").test(e);var l=parseFloat(RegExp.$1);return-1!=e.indexOf("MSIE 6.0")?"IE6":7==l?"IE7":8==l?"IE8":9==l?"IE9":10==l?"IE10":e.toLowerCase().match(/rv:([\d.]+)\) like gecko/)?"IE11":"0"}return o?"FF":t?"Opera":i?"Safari":n?"Chrome":r?"Edge":void 0}()&&("dblclick",e(document).on("click","img",function(){var t=e(this),a=null==t.attr("src")?"":t.attr("src");a.indexOf("rs/common/file/original/")>-1&&null==a||""==a||-1==a.indexOf("rs/common/file/thumbnail/")||Core.alert({message:"双击即可查看大图哦"})}));var o=function(e,t,a){var r=void 0!=a&&a,o=parseFloat(e[0].style.width.replace("px","")),i=parseFloat(e[0].style.height.replace("px","")),n=parseFloat(e[0].style.top.replace("px","")),l=parseFloat(e[0].style.left.replace("px",""));if(r){var d=void 0==e.attr("rotate")?0:parseFloat(e.attr("rotate"));360==d&&(d=0),90==d||270==d?t.css({top:n+i,left:l+o}):t.css({top:n+i+(o-i)/2,left:l+o-(o-i)/2}),e.attr("rotate",d+90)}else t.removeClass("hide"),t.css({top:n+i,left:l+o})},i=function(t){isImgLoad(function(){for(var a=0,r=0;r<t.length;r++)a+=t[r].naturalWidth;var i=e("#floatImg>img")[0].naturalHeight,n=function(t,a){var r=e(window).width(),o=e(window).height(),i=.618*r,n=function(e){var r=Math.max.call(this,e,t,a);return r>e?e/r:1},l=t*n(i),d=a*n(i);if(d>o){var i=.95*o;l=t*n(i),d=a*n(i)}return[l,d,t,a]}(a,i);a=n[0],i=n[1];var l=e(window).width(),d=e(window).height();e("#floatImg").css({top:(d-i)/2,left:(l-a)/2,width:a,height:i+60}).show(),o(e("#floatImg"),e("#floatImg_rotate"))},"#floatImg>img")};e(document).on("dblclick","img",function(t){var a=e(this),r=a.attr("data-id");e("#floatImg").data("rotate",0).css("transform","rotate(0deg)");var o=null==a.attr("src")?"":a.attr("src");if(null!=o&&""!=o&&-1!=o.indexOf("rs/SimpleAC/down")){o=o.replace("/thumbnail/","/original/");var n=e("<img style='height:100%'/>");if(n.attr("src",o).attr("data-id",r).addClass("floatImg"),e("#floatImg").is(":visible")){e("#floatImg").attr("rotate",0);var l=a.attr("class"),d=e("#floatImg>img"),s=d.length;if(s<=5){if(5==s){if("floatImg"==l){a.remove();var c=e("#floatImg>img");if(0==c.length)e("#floatImg").attr("rotate",0).hide(),e("#floatImg_rotate").addClass("hide");else{var u=(100/c.length).toFixed(2);c.css({width:u+"%"}),i(c)}return}return}for(var g=0;g<s;g++){var p=e(d[g]).attr("data-id");if("floatImg"==l||p==r){e(d[g]).remove();var c=e("#floatImg>img");if(0==c.length)e("#floatImg").attr("rotate",0).hide(),e("#floatImg_rotate").addClass("hide");else{var u=(100/c.length).toFixed(2);c.css({width:u+"%"}),i(c)}return}}}e("#floatImg").append(n);var u=(100/e("#floatImg>img").length).toFixed(2);e("#floatImg>img").css({width:u+"%"})}else{e("#floatImg").append(n);var u=(100/e("#floatImg>img").length).toFixed(2);e("#floatImg>img").css({width:u+"%"})}i(e("#floatImg>img"))}}),e("body").on("click",".yulan",function(){var t="http://"+window.location.host+e(this).attr("src"),a=window.open(),r=a.document.createElement("img");r.src=t,a.document.getElementsByTagName("body")[0].appendChild(r)})}($);var getMsgForNullSpecId=function(e,t,a,r,o){if(0==_global_settings.owner.easyGridSetting.spec)return void t(a,r,o);var i=ComboBoxSources.getInfoMapOrderByKey(e,"prodSpecId")["未分类"];null!=i&&0!=i.length||(i=[]);for(var n=[],l=0;l<i.length;l++)void 0==i[l].spec&&n.push(i[l].sequence);n=n.toString(),n.length>0?timeOut(function(){Core.confirm({message:"第"+n+"行没有选择规格型号，确认保存此销售单吗？？",confirmCallback:function(){t(a,r,o)}})}):timeOut(function(){t(a,r,o)})};