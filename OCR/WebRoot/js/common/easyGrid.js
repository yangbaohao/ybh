$.fn.easyGrid=function(settings){function getDataDirty(e,t){for(var o={name:!0,color:null,spec:null,sku:!0,priceBefore:"0.00",deliveryQtyNow:0,unit:""},a=0;a<e.length;a++){var r=ComboBoxSources.getInfoMapByKey(settings.productSourceName.product,"name",e[a].productName);for(var i in o)if("spec"===i)null!=e[a].spec?e[a].descr=e[a].spec:(e[a].spec="",e[a].descr="");else if("prodAddId"===i)null!=e[a].photoAddId&&null!=e[a].photoAddId?e[a].photoId=e[a].photoAddId:e[a].photoId="";else if("color"===i)null!=e[a].color?e[a].color=e[a].color:e[a].color="";else if("deliveryQtyNow"==i)e[a].deliveryQty=0;else if("priceBefore"==i)e[a].priceBefore="NaN"===money(e[a].priceBefore,4,!0)?"0.00":money(e[a].priceBefore,4,!0);else if("unit"===i){if(r.multiUnitFlag){var n=null==r.prodContainerList?null:r.prodContainerList[0];null!=n&&""!=e[a][i]&&null!=e[a][i]&&e[a][i]!=n.unitName&&(e[a][i]=e[a][i]+"("+e[a].unitRate+n.unitName+")")}}else e[a][i]=r[i]}return e}window.modallist={},window.prodmodallist=function(e,t,o,a,r){null==window.modallist[e]&&(window.modallist[e]={}),null==window.modallist[e][t]&&(window.modallist[e][t]=[]);for(var i=window.modallist[e][t],n=!1,d=0;d<i.length;d++){if(i[d].name==a){i[d]=o,n=!0;break}if(i[d].name==r){i[d]=o,n=!0;break}}n||i.push(o)};var settings=void 0===settings?{}:settings;settings.ownerSettings.elementId=$(this)[0].id,$(this).attr({"data-id":settings.ownerSettings.elementId,"data-soOwnerId":settings.ownerSettings.soOwnerId,"data-name":settings.ownerSettings.userName});var gridSettings=$.extend(!0,{editable:!0,delBtn:!0},settings.gridSettings),xsweight="kg";_global_settings.acOwner.productKgFlag&&Core.AjaxRequest({url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/prodUnit/"+settings.ownerSettings.soOwnerId+"/"+settings.ownerSettings.userName),type:"get",showMsg:!1,callback:function(e){xsweight=void 0==e[0].descr?"kg":e[0].descr}});var singleUnit=[];_global_settings.acOwner.productunitFlag&&Core.AjaxRequest({url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/singleUnit/"+settings.ownerSettings.soOwnerId+"/"+settings.ownerSettings.userName),type:"get",showMsg:!1,callback:function(e){singleUnit=e}});var defaultrow=function(){return{name:"",id:null,printOfGoods:"",photoId:"",salesQty:"",purchasedQty:"",spec:"",descr:"",color:"",prodColourDescr:"",weight:"",totalCartons:"",eachCartons:"",qty:"",priceBefore:"",price3:"",price3_server:"",extent:"",breadth:"",altitude:"",tj:"",deliveiedQty:"",deliveryQtyNow:"",remark:"",dzid:"",rowweight:"",ysprice:"",dsprice:"",volume:"",yards:"",unit:"",unitRate:"",basicUnit:"",unitsFlag:"",unitRateqty:"",deliveryQtyAll:"",inventoryReducere:"",amountFormula:"",inventoryQtyFormula:""}},source=[defaultrow()],sourceType=null==settings.sourceType?"salePrice":settings.sourceType,iscopy=null!=settings.iscopy&&settings.iscopy,easyGridType=settings.easyGridType,modalNameMap={addSaleOrder_grid:"addSOProduct",editSaleOrder_grid:"editSOProduct",addPurchaseOrder_grid:"addPOProduct",editPurchaseOrder_grid:"editPOProduct"},modalName=modalNameMap[$(this).attr("id")],saleorbuy="",addoredit="",columntypeQtyText="",columntypedeliveiedQtyText="",columntypedeliveryQtyNowText="",qtyedit=!1,qtyNowVisible=!0;"costPrice"==sourceType?(saleorbuy="buy",columntypeQtyText="采购",null!=modalName&&modalName.indexOf("edit")>-1?(addoredit="edit",columntypedeliveiedQtyText="已收数量",columntypedeliveryQtyNowText="本次收货",qtyNowVisible=!1):(addoredit="add",columntypedeliveiedQtyText="收货数量")):(saleorbuy="sale",columntypeQtyText="销售",null!=modalName&&modalName.indexOf("edit")>-1?(addoredit="edit",columntypedeliveiedQtyText="送货数量",columntypedeliveryQtyNowText="本次送货",qtyNowVisible=!1):(addoredit="add",columntypedeliveiedQtyText="送货数量"));var addbtn="",addspecbtn="",addunitbtn="",sendStartbtn="",sendRunbtn="",style="",productSourceName=null;gridSettings.delBtn?("costPrice"!=sourceType&&"salePrice"!=sourceType||(addunitbtn='<div class="col-sm-1 p-0 p-l-10 p-t-10 littleAdd addUnit" style="top: -4px;left: 20px;"><a href="javascript:void(0)" data="productunit" ><i class="icon-plus"></i></a></div>'),productSourceName="true"==_global_settings.acOwner.productNumberFlag?settings.productSourceName.productsInUse_Part:settings.productSourceName.productsInUse,settings.stop||(style="cursor: pointer;text-decoration: underline;color:#00B7EF;margin-top: -2px;",sendStartbtn='<a class="color-1193C5 hoverspan md-local-shipping " style="color:#00B7EF;margin:0;" title="一键'+columntypedeliveiedQtyText[0]+'货"></a>',sendRunbtn='<a class="color-1193C5 hoverspan md-local-shipping " style="color:#00B7EF;margin:0;" title="一键'+columntypedeliveiedQtyText[1]+'货"></a>'),addbtn="<i style='vertical-align: middle;padding-left:5px;' data-toggle='modal' data-target='#"+modalName+"' class='icon-plus addbtn' data-btn='biz:prod:create'>",addspecbtn="<i style='vertical-align: middle;padding-left:5px;' class='icon-plus addbtn addspecbtn' data-btn='biz:prod:create'>"):productSourceName="true"==_global_settings.acOwner.productNumberFlag?settings.productSourceName.product_Part:settings.productSourceName.product;var needRefresh=!1;void 0!==settings.source&&(0==settings.source.length?source=[defaultrow()]:(source=getDataDirty(settings.source),(gridSettings.delBtn||iscopy)&&source.push(defaultrow())),needRefresh=!0);var table=$(this),columnsheight=20;settings.columns=[{text:"种类  ",datafield:"type",hidden:!0},{text:'产品<div id="'+table.attr("id")+'id" style="float:right;color:cornflowerblue;"></div>',datafield:"productName",columntype:"combobox",pk:!0,jqxSettings:{selectedIndex:0,source:productSourceName,displayMember:"_name",valueMember:"productName"},displayfield:"productName",pk:!0,width:"14%",aggregatesrenderer:function(e,t,o){var a=table.jqxGrid("getcolumnaggregateddata","inventoryReducere",["sum"]).sum,r=money(a,2,!0),i="";return 0!=r&&(i='<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;库存减少:'+r+"</div>"),i},enabletooltips:!gridSettings.delBtn},{text:"客户货号",datafield:"printOfGoods"},{text:"图片",datafield:"photoId",editable:!1,width:"60px",cellsrenderer:function(e,t,o,a,r,i){var n="",d="";return d=void 0!=i.photoId&&""!=i.photoId?void 0!=i.photoAddId&&""!=i.photoAddId?i.photoAddId:i.photoId:void 0!=i.photoAddId&&""!=i.photoAddId?i.photoAddId:"",null!=d&&""!=d&&(n=ctx+"/CXF/rs/SimpleAC/down/"+(new Base64).encode("toocr/order/downFile/"+d+"/"+settings.ownerSettings.soOwnerId+"/"+settings.ownerSettings.userName)),"<div style='background: white;text-align:center;margin: 3px;'>"+(n=""!=n?"<img title='点击查看大图' width='48' height='32' src='"+n+"'>":'<input type="button" style="opacity: 0.99; position: absolute; top: 0%; left: 0%; padding: 0px; margin-top: 2px; margin-left: 2px; width: 96%; height: 36px;" value="请选择" role="button" class="jqx-rc-all jqx-button jqx-fill-state-normal addPhoto">')+"</div>"}},{text:"货号   ",datafield:"sku",hidden:!0},{text:"规格型号",datafield:"spec",editable:!1,columntype:"button",resizable:!1,width:"100px",cellsrenderer:function(e,t,o,a,r){return""==o||null==o?"请选择":o},buttonclick:function(e){return timeOut(function(){timeOut(function(){$("#comboboxeditor"+table.attr("id")+"id").css("display","none"),specModal2(table.attr("id"),null,sourceType,settings.productSourceName)},20)},0),!0},displayfield:"spec"},{text:"颜色",datafield:"color",columntype:"button",editable:!1,resizable:!1,width:"60px",cellsrenderer:function(e,t,o,a,r){return""==o||null==o?"请选择":o},buttonclick:function(e){return timeOut(function(){timeOut(function(){$("#comboboxeditor"+table.attr("id")+"id").css("display","none"),colorModal(table.attr("id"),null,sourceType,settings.productSourceName)},20)},0),!0},displayfield:"color"},{text:"重量",datafield:"weight",cellsalign:"right",aggregates:["sum"],aggregatesrenderer:function(e,t,o){var a=table.jqxGrid("getcolumnaggregateddata","rowweight",["sum"]).sum;gridSettings.dellist&&(a=getgridcheckedsum("rowweight",table));return a="g"==xsweight?money(a/1e3,4,!0):money(a,4,!0),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">重量:'+(a+"kg")+"</div>"},width:"5%"},{text:"细码",datafield:"yards",editable:!1,hidden:!0,resizable:!0,width:"15%",cellsrenderer:function(e,t,o,a,r){return""==o||null==o?'<input type="button" style="opacity: 0.99; position: absolute; top: 0%; left: 0%; padding: 0px; margin-top: 2px; margin-left: 2px; width: 98%; height: 36px;" value="请选择" role="button" class="jqx-rc-all jqx-button jqx-fill-state-normal addyards">':'<input type="button" style="opacity: 0.99; position: absolute; top: 0%; left: 0%; padding: 0px; margin-top: 2px; margin-left: 2px; width: 98%; height: 36px;" value="'+o+'" role="button" class="jqx-rc-all jqx-button jqx-fill-state-normal addyards">'},aggregates:[{"细码合计":function(e,t,o,a){var r=null==a.yards?"":a.yards.toString();if(null!=r){var i=0;return gridSettings.dellist&&1!=a.waitdel||$.each(r.split(","),function(e,t){t>0&&(i+=1)}),money(e+i,4,!0)}return e},"损耗数量":function(e,t,o,a){var r=null==a.yards?"":a.yards.toString(),i=0;return null!=r?(gridSettings.dellist&&1!=a.waitdel||$.each(r.split(","),function(e,t){t<0&&(i+=parseFloat(t)*a.unitRate)}),money(e+i,4,!0)):e}}],aggregatesrenderer:function(e,t,o){var a="";return $.each(e,function(e,t){0!=t&&(a+=e+":"+Math.abs(t)+"&nbsp;&nbsp;&nbsp;")}),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+a+"</div>"}},{text:"箱数",datafield:"totalCartons",width:"5%",cellsalign:"right",aggregates:["sum"],aggregatesrenderer:function(e,t,o){var a=table.jqxGrid("getcolumnaggregateddata","totalCartons",["sum"]).sum;return gridSettings.dellist&&(a=getgridcheckedsum("totalCartons",table)),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;总箱数:'+money(a,4,!0)+"</div>"}},{text:"每箱数量",datafield:"eachCartons",width:"6%",cellsalign:"right"},{text:"总数量",datafield:"qty",width:"5%",cellsalign:"right",pk:!0,aggregates:["sum"],aggregatesrenderer:function(e,t,o){var a=table.jqxGrid("getcolumnaggregateddata","unitRateqty",["sum"]).sum;return'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;总数量:'+("NaN"==money(a,4,!0)?"0.00":money(a,4,!0))+"</div>"},editable:qtyedit},{text:"单位"+addunitbtn,cellsalign:"left",columntype:"template",hidden:!0,datafield:"unitRate",displayfield:"unit",width:"5%",jqxSettings:{displayMember:"unitName",valueMember:"unitName",width:"5%"},initeditor:function(e,t,o,a,r){var i=table.jqxGrid("getrowdata",e),n=table.attr("id"),d=($("#"+n).data().soownerid,$("#"+n).data().name,i.productName);if(null==d||""==d)o.comboBox({width:"auto",source:[],displayMember:"unitName",valueMember:"unitName"});else{var l=ComboBoxSources.getInfoMapByKey(settings.productSourceName.product,"name",d);if(l.multiUnitFlag){var s=$.extend(!0,[],l.prodContainerList);$.each(s,function(e,t){0!=e&&(t._unitName=t.unitName,t.unitName=t.unitName+"("+t.rate+s[0].unitName+")")}),o.comboBox({width:"auto",source:s,displayMember:"unitName",valueMember:"unitName"})}else{var c=unitArr,u=singleUnit.concat(c);o.comboBox({width:"auto",source:u,displayMember:"unitName",valueMember:"unitName"})}o.val(i.unit)}timeOut(function(){o.jqxComboBox("open"),o.find("input").eq(0).focus(),o.triggerHandler("keyup")},0)},geteditorvalue:function(e,t,o){var a=o.jqxComboBox("getSelectedItem");return null!=a?{label:a.label,value:a.originalItem.rate}:{label:"",value:"1"}}},{text:"已采购",datafield:"purchasedQty",editable:!1,pk:!0,hidden:!0,cellsalign:"right"},{text:"销售数量",datafield:"salesQty",editable:!1,pk:!0,hidden:!0,cellsalign:"right"},{text:"单价  ",datafield:"priceBefore",pk:!0,cellsalign:"right"},{text:"金额    ",datafield:"price3_server",pk:!0,cellsalign:"right",aggregates:["sum"],aggregatesrenderer:function(e,t,o){var a=table.jqxGrid("getcolumnaggregateddata","price3",["sum"]).sum;return gridSettings.dellist&&(a=getgridcheckedsum("price3",table)),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;金额:'+("NaN"===money(a)?"0.00":money(a))+"</div>"},editable:!1},{text:"长",columngroup:"外箱尺寸",width:"4%",datafield:"extent",cellsalign:"right"},{text:"宽",columngroup:"外箱尺寸",width:"4%",datafield:"breadth",cellsalign:"right",aggregates:["sum"],aggregatesrenderer:function(e,t,o){var a=table.jqxGrid("getcolumnaggregateddata","tj",["sum"]).sum/1e6;return gridSettings.dellist&&(a=getgridcheckedsum("tj",table)/1e6),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;体积:'+(0==money(a,4,!0)?"<0.0001":money(a,4,!0))+"m³</div>"}},{text:"高",columngroup:"外箱尺寸",width:"4%",datafield:"altitude",cellsalign:"right"},{text:"体积",columngroup:"外箱尺寸",hidden:!0,datafield:"tj",cellsalign:"right",aggregates:["sum"],aggregatesrenderer:!0,editable:!1},{text:"外箱尺寸(m³)",datafield:"volume",cellsalign:"right",aggregates:["sum"],aggregatesrenderer:function(e,t,o){var a=table.jqxGrid("getcolumnaggregateddata","volume",["sum"]).sum;return gridSettings.dellist&&(a=getgridcheckedsum("tj",table)),'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">&nbsp;&nbsp;&nbsp;体积:'+(0==money(a,2,!0)?"<0.01":money(a,2,!0))+"m³</div>"}},{text:'<div class="sendStart " title="'+(1==qtyNowVisible?"一键"+columntypedeliveiedQtyText[0]+"货":"")+'" style="'+(1==qtyNowVisible?style:"")+'">'+columntypedeliveiedQtyText+sendStartbtn+"</div>",width:"7%",datafield:"deliveryQtyNow",cellsalign:"right",pk:!0,aggregates:["sum"],aggregatesrenderer:function(e,t,o){var a=table.jqxGrid("getcolumnaggregateddata","deliveryQtyAll",["sum"]).sum;gridSettings.dellist&&(a=getgridcheckedsum("deliveryQtyAll",table));var r=money(a,4,!0);return'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: left">'+columntypedeliveiedQtyText+":"+r+"</div>"}},{text:"备注      ",datafield:"remark"},{text:"单子id",datafield:"dzid",hidden:!0,cellsformat:"n"},{text:"总重量",datafield:"rowweight",hidden:!0,aggregates:[{sum:function(e,t,o,a){return a.waitdel?e+t:e}}]},{text:"主单位",datafield:"basicUnit",hidden:!0},{text:"是否开启多单位",datafield:"unitsFlag",hidden:!0},{text:"单位数量",datafield:"unitRateqty",hidden:!0},{text:"送货总数量",datafield:"deliveryQtyAll",hidden:!0},{text:"后台总金额",datafield:"price3",hidden:!0},{text:"已收送货总金额",datafield:"ysprice",hidden:!0,aggregates:["sum"]},{text:"待收送货总金额",datafield:"dsprice",hidden:!0,aggregates:["sum"]},{text:"金额公式",datafield:"amountFormula",hidden:!0},{text:"库存数量公式",datafield:"inventoryQtyFormula",hidden:!0},{text:"inventoryReducere",datafield:"inventoryReducere",hidden:!0,aggregates:["sum"]}],settings.aggregates=[{type:"Multiply",datafield:["totalCartons","eachCartons","qty"]},{type:"Multiply",datafield:["qty","priceBefore","price3_server"]},{type:"Multiply",datafield:["deliveryQtyNow","priceBefore","ysprice"]},{type:"Multiply",datafield:["deliveiedQty","priceBefore","dsprice"]},{type:"Multiply",datafield:["qty","weight","rowweight"]},{type:"Multiply",datafield:["rowweight","unitRate","rowweight"]},{type:"Multiply",datafield:["deliveryQtyNow","unitRate","deliveryQtyAll"]},{type:"Multiply",datafield:["qty","unitRate","unitRateqty"]},{type:"Multiply",datafield:["totalCartons","extent","breadth","altitude","tj"]}],"volume"==_global_settings.acOwner.cartonType&&(settings.aggregates=[{type:"Multiply",datafield:["totalCartons","eachCartons","qty"]},{type:"Multiply",datafield:["qty","priceBefore","price3_server"]},{type:"Multiply",datafield:["deliveiedQty","priceBefore","ysprice"]},{type:"Multiply",datafield:["deliveryQtyNow","priceBefore","dsprice"]},{type:"Multiply",datafield:["qty","weight","rowweight"]},{type:"Multiply",datafield:["rowweight","unitRate","rowweight"]},{type:"Multiply",datafield:["deliveryQtyNow","unitRate","deliveryQtyAll"]},{type:"Multiply",datafield:["qty","unitRate","unitRateqty"]},{type:"Multiply",datafield:["totalCartons","volume","tj"]}]),"false"==gridSettings.delBtn.toString()&&(settings.columns[3]={text:"图片",datafield:"photoId",editable:!1,width:"60px",cellsrenderer:function(e,t,o,a,r,i){var n="",d="";return d=void 0!=i.photoId&&""!=i.photoId?void 0!=i.photoAddId&&""!=i.photoAddId?i.photoAddId:i.photoId:void 0!=i.photoAddId&&""!=i.photoAddId?i.photoAddId:"",null!=d&&""!=d&&(n=ctx+"/CXF/rs/SimpleAC/down/"+(new Base64).encode("toocr/order/downFile/"+d+"/"+settings.ownerSettings.soOwnerId+"/"+settings.ownerSettings.userName)),""!=n&&(n="<img title='点击查看大图' width='48' height='32' src='"+n+"'>"),"<div style='background: white;text-align:center;margin: 3px;'>"+n+"</div>"}},settings.columns[5]={text:"规格型号",columntype:"combobox",jqxSettings:{source:"producttype",displayMember:"spec",valueMember:"spec"},width:"8%",datafield:"spec",displayfield:"spec"},settings.columns[6]={text:"颜色",datafield:"color",columntype:"combobox",width:"5%",jqxSettings:{displayMember:"color",valueMember:"color",source:"producttype"},displayfield:"color"},delete settings.columns[8].cellsrenderer);for(var i in _global_settings.owner.easyGridSetting)settings.columns=deleteBy(settings.columns,i,"datafield");if(settings.columns=setToggerColumns(settings.toggerColumns,settings.columns,saleorbuy),_global_settings.acOwner.yardsFlag)for(var i=0;i<settings.columns.length;i++)"qty"==settings.columns[i].datafield&&(settings.columns[i].editable=!1);var aggregates=settings.aggregates,columns=settings.columns,pk={},datafields={},getVisibleColumn=function(){var e={printOfGoods:"",totalCartons:0,eachCartons:0,spec:null,color:null,weight:0,extent:0,breadth:0,altitude:0,remark:"",yards:"",unit:"",deliveryQtyNow:0,volume:0},t={};for(var o in e)try{table.jqxGrid("iscolumnvisible",o)&&(t[o]=e[o])}catch(e){}return t},getData=function(e,t){var o=[],a={boundindex:!0,uid:!0,uniqueid:!0,undefined:!0,visibleindex:!0},r=[];if(void 0===e){r=table.jqxGrid("source").records;for(var i=0;i<r.length;i++){var n={};for(var d in r[i])a[d]||(n[d]=r[i][d]);o.push(n)}return o}delete a[void 0],r=e;for(var i=0;i<r.length;i++)for(var d in a)r[i][d]=i;return r},getDataWash=function(e,t){var o={sequence:0,qty:0,priceBefore:0,dzid:null,productName:null,photoId:null,photoAddId:null,deliveryQtyNow:0,spec:null,color:null,unitsFlag:null,amountFormula:"",inventoryQtyFormula:""};o=$.extend(!0,o,getVisibleColumn()),void 0!==o.unit&&(o.unitRate="",o.basicUnit="");for(var a=[],r=0;r<e.length;r++){var i=ComboBoxSources.getInfoMapByKey(productSourceName,"name",e[r].productName),n={};for(var d in o){var l=e[r][d];null==l||""==l?(n[d]=o[d],"sequence"==d&&(n[d]=r+1),"unitsFlag"==d&&(n[d]=i.multiUnitFlag)):n[d]="sequence"==d?r+1:"unit"==d?e[r][d].replace(/\(.{0,}\)$/,""):l}if(0!=n.qty&&(null==n.productName||""==n.productName))throw Core.alert({message:"第"+(r+1)+"行请重新选择产品"}),"第"+(r+1)+"行请重新选择产品";if(null!=n.productName&&""!=n.productName&&void 0!=n.productName){if(!1!==t){if(0==n.qty)throw Core.alert({message:"第"+(r+1)+"行"+columntypeQtyText+"数量不能为0"}),"第"+(r+1)+"行"+columntypeQtyText+"数量不能为0";if(n.priceBefore<0)throw Core.alert({message:"第"+(r+1)+"行单价不能为负数"}),"第"+(r+1)+"行单价不能为负数";if(n.totalCartons<0||n.totalCartons<0||n.qty<0||n.deliveryQtyNow<0)throw Core.alert({message:"第"+(r+1)+"行数量不能为负数"}),"第"+(r+1)+"行数量不能为负数";if(n.deliveryQtyNow<0){var s="";throw s="add"==addoredit?"sale"==saleorbuy?"送货数量":"收货数量":"sale"==saleorbuy?"已送数量":"已收数量",Core.alert({message:"第"+(r+1)+"行"+s+"不能为负数"}),"第"+(r+1)+"行数量不能为负数"}if(n.deliveryQtyNow<0){var s="";throw"add"==addoredit||(s="sale"==saleorbuy?"本次送货":"本次收货"),Core.alert({message:"第"+(r+1)+"行"+s+"不能为负数"}),"第"+(r+1)+"行数量不能为负数"}}void 0!=n.photoId&&""!=n.photoId?void 0!=n.photoAddId&&""!=n.photoAddId?delete n.photoId:delete n.photoAddId:void 0!=n.photoAddId&&""!=n.photoAddId?delete n.photoId:(delete n.photoAddId,delete n.photoId),n.qty=money(n.qty,4,!0),n.priceBefore="NaN"===money(n.priceBefore,4,!0)?"0.00":money(n.priceBefore,4,!0),delete n.dzid,n.productName=n.productName.trim(),a.push(n)}}return a},getRowData=function(){var e=table.jqxGrid("getselectedrowindex");return table.jqxGrid("getrowdata",e)},addLastRow=function(e){var t=getData(),o=ComboBoxSources.getInfoMapByKey(productSourceName,"name",e);if(null==o)return t;for(var a=0;a<t.length;a++){var r=t[a];if(""==r.id||null==r.id)return r.id=o.id,r.name=o.name,r.type=""==o.type?"未分类":o.type,r.sku=o.sku,r.spec=o.spec,r.priceBefore=parseFloat(o["salePrice"!=sourceType?"purchasePrice":"salePrice"]),r.spec=o.spec,r.photoId=o.photoId,r.photoAddId=o.photoAddId,r.color=o.color,t}var r={};return r.name=o.productName,r.type=""==o.type?"未分类":o.type,r.sku=o.sku,r.spec=o.spec,r.priceBefore=parseFloat(o["salePrice"!=sourceType?"purchasePrice":"salePrice"]),r.photoId=o.photoId,r.photoAddId=o.photoAddId,r.color=o.color,t.push(r),t},setRowData=function(e,t){var o=t,a=(table.jqxGrid("getrowid",o),table.jqxGrid("getrowdata",o));if("productName"==e){if(null==a[e])return;var r=ComboBoxSources.getInfoMapOrderByKey(productSourceName,"name",a[e]);if(null==r)return;if(r=r[0],a.productName=r.name,""!=r.type&&null!=r.type||(r.type="未分类"),a.type=r.type,null!=a.priceBefore&&""!=a.priceBefore&&0!=a.priceBefore&&"NaN"!=a.priceBefore||(a.priceBefore=parseFloat(r["salePrice"!=sourceType?"purchasePrice":"salePrice"])),a.photoId=r.prodPhoto,a.unit="",a.unitRate="",a.basicUnit="",a.unitsFlag=!1,a.amountFormula=r.amountFormula,a.inventoryQtyFormula=r.inventoryFormula,r.multiUnitFlag){var i=r.prodContainerList,n=ComboBoxSources.getInfoMapByKey(i,"commonFlag",!0),d=i[0];d.unitName!=n.unitName&&(n.unitName=n.unitName+"("+n.rate+d.unitName+")"),a.basicUnit=d.unitName,a.unit=n.unitName,a.unitRate=n.rate,a.unitsFlag=!0,"salePrice"==sourceType?(a.priceBefore=n.salePrice,a.cost=n.purchasePrice):a.priceBefore=n.purchasePrice}else a.basicUnit=r.unit,a.unit=r.unit,a.unitRate=1}},setRowCoaData=function(e,t){var o=table.jqxGrid("getselectedrowindex"),a=(table.jqxGrid("getrowid",o),table.jqxGrid("getrowdata",o)),r=(ComboBoxSources.getInfoMapByKey(productSourceName,"type"),null);"productName"==e&&null!=(r=ComboBoxSources.getInfoMapByKey(productSourceName,"productName",a.productName))&&(r=r.productName),"spec"==e&&null!=a.productName&&""!=a.productName&&null!=(r=ComboBoxSources.getInfoMapByKey(productSourceName,"productName",a.productName))&&(r=r.spec),"color"==e&&null!=a.productName&&""!=a.productName&&null!=(r=ComboBoxSources.getInfoMapByKey(productSourceName,"productName",a.productName))&&(r=r.color),t.jqxComboBox({source:r})},computeRow=function(e){for(var t=["priceBefore","cost","extent","breadth","altitude","volume","weight","totalCartons","eachCartons","tj","qty","deliveiedQty","deliveryQtyNow","purchaseNumber"],o=0;o<t.length;o++){var a=t[o];e[a]=money(e[a],4,!0)}var r=!1;("add"==addoredit&&_global_settings.acOwner.customNumberFlag||("edit"==addoredit||"view"==addoredit)&&settings.order.customNumberFlag)&&(r=!0);for(var i=0;i<aggregates.length;i++)if("Multiply"==aggregates[i].type){if(3==aggregates[i].datafield.length){if("qty"!=aggregates[i].datafield[2]||table.jqxGrid("iscolumnvisible","eachCartons"))if($.strInArr(aggregates[i].datafield[2],["price3_server","ysprice","dsprice"])){var n=e[aggregates[i].datafield[0]]*money(e[aggregates[i].datafield[1]],4,!0);$.strInArr(aggregates[i].datafield[2],["ysprice","dsprice"])&&(e[aggregates[i].datafield[2]]=money(n)),"price3_server"==aggregates[i].datafield[2]&&(e[aggregates[i].datafield[2]]=money(n),e.price3=n)}else{if("unitRate"!=aggregates[i].datafield[1]||e[aggregates[i].datafield[1]]&&!table.jqxGrid("iscolumnvisible","eachCartons")&&table.jqxGrid("iscolumnvisible","unitRate"))var n=money(e[aggregates[i].datafield[0]],4,!0)*money(e[aggregates[i].datafield[1]],4,!0);else var n=1*money(e[aggregates[i].datafield[0]],4,!0);e[aggregates[i].datafield[2]]=money(n,4,!0)}else;if(null!=e.amountFormula&&""!=e.amountFormula&&$.strInArr(aggregates[i].datafield[2],["price3_server","ysprice","dsprice"])&&r){var n=fouroperations(e.amountFormula,e,aggregates[i].datafield[0]);e[aggregates[i].datafield[2]]=n,"price3_server"==aggregates[i].datafield[2]&&(e[aggregates[i].datafield[2]]=money(n),e.price3_server=money(n,2,!0),e.price3=money(n,2,!0))}}try{if(5==aggregates[i].datafield.length){var n=money(e[aggregates[i].datafield[0]]*(money(e[aggregates[i].datafield[1]])*e[aggregates[i].datafield[2]]*e[aggregates[i].datafield[3]]));e[aggregates[i].datafield[4]]=n}}catch(e){}}if(r)if(null!=e.inventoryQtyFormula&&""!=e.inventoryQtyFormula){var n=fouroperations(e.inventoryQtyFormula,e,"qty",!0);e.inventoryReducere=n}else e.inventoryReducere=0},grid_refresh=function(e){if(null!=e)var t=e;else var t=table.jqxGrid("source").records;for(var o=$.extend(!0,t,[]),a=0;a<o.length;a++)computeRow(o[a]);grid_render(o)},columns_Handle=function(e){for(var t=$.extend(!0,[],e),o=[{text:"编号",editable:!1,enabletooltips:!1,resizable:!1,pk:!0,aggregates:["sum"],aggregatesrenderer:function(e,t,o){return'<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: center;">合计</div>'},datafield:"sequence",columntype:"number",width:"3%",cellsrenderer:function(e,t,o){return"<div style='margin:11px auto;text-align:center;'>"+(o+1)+"</div>"}},{text:"操作",editable:!1,width:"7%",datafield:"操作",align:"center",cellsrenderer:function(e){return'<div style="text-align: center;padding-top: 8px;"><a class="md-cancel hoverspan del" data-id="'+e+'" title="删除"></a><a class=" md-description hoverspan copy" data-id="'+e+'" title="复制"></a><a class="md-note-add hoverspan add" data-id="'+e+'" title="新增"></a></div>'}}],a={template:function(e,t){var o={theme:currentTheme,animationType:"none",height:"40px",searchMode:"none",enableBrowserBoundsDetection:!1,placeHolder:"请选择",source:[]},a=$.extend(!0,o,e),r="",i="";return"product"==a.type&&(r="id",i=productSourceName),"vendor"==a.type&&(r="clientInfoid",i="vendor_p"),delete a.type,function(e,o,n,d,l){if(""!=i){var s=ComboBoxSources.getRecords(i);a.source=s}n.comboBox(a),"id"==r&&n.addClass(t)}},combobox:function(e,t){var o={theme:currentTheme,height:"40px",searchMode:"containsignorecase",autoComplete:!0,enableBrowserBoundsDetection:!1,placeHolder:"请选择"};$.extend(!0,o,e);return function(e,o,a){var r=table.jqxGrid("getrowdata",e);if(null!=r.productName&&""!=r.productName){var i=search(r.productName),n=i[0];i[1];n.length=200}else{var n=ComboBoxSources.getInfoMapByKey(productSourceName);n.length=200}a.jqxComboBox({theme:currentTheme,searchMode:"none",enableBrowserBoundsDetection:!1,source:n,height:"40px",displayMember:"name",valueMember:"name"}),a.addClass(t)}},numberinput:function(e){return function(t,o,a){a.jqxNumberInput(e)}},dropdownlist:function(e,t){var o={autoDropDownHeight:!0,placeHolder:"请选择"},a=$.extend(!0,o,e);return a.source=ComboBoxSources.getInfoMapByKey(a.source),function(e,o,r){r.jqxDropDownList(a).addClass(t)}}},r=t.length,i=0;i<r;i++)null!=t[i].columntype&&"function"==typeof a[t[i].columntype]&&(t[i].createeditor=a[t[i].columntype](t[i].jqxSettings,t[i].datafield)),!0===t[i].aggregatesrenderer&&(t[i].aggregatesrenderer=function(e,o,a){var r=null,n="",d="right";t[i].cellsformat?(r=null==e.sum?0:e.sum,r=money(moneySmall(r.toString().replace("￥","")))):r=e.sum,gridSettings.dellist&&(r=getgridcheckedsum(o.datafield,table)),o.text.indexOf("编号")>-1&&(r="合计",d="left"),o.text.indexOf("金额")>-1?(n="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;金额:",r=money(r)):r=money(r,4,!0),o.text.indexOf("重量")>-1&&(n="重量:"),o.text.indexOf("箱数")>-1&&(n="总箱数:"),o.text.indexOf("总数量")>-1&&(n="总数量:"),o.text.indexOf("送货数量")>-1&&(n="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;送货数量:"),o.text.indexOf("收货数量")>-1&&(n="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;收货数量:"),o.text.indexOf("已送数量")>-1&&(n="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;已送数量:"),o.text.indexOf("已收数量")>-1&&(n="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;已收数量:"),o.text.indexOf("本次送货")>-1&&(n="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本次送货:"),o.text.indexOf("本次收货")>-1&&(n="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本次收货:");var l='<div style="position: relative; margin-top: 10px; margin-right:5px; text-align: '+d+'; ">'+n+r+"</div>";return 0!=qtyNowVisible||"已送数量:"!=n&&"已收数量:"!=n||(l=""),l});if(t.unshift(o[0]),gridSettings.delBtn&&t.unshift(o[1]),gridSettings.dellist){t.unshift({text:'<div style="position: absolute; top: 50%; left: 50%; margin-top: -7px; margin-left: -10px; overflow: visible; cursor: auto;" id="dellist" tabindex="0" class="jqx-widget jqx-checkbox"><div class="jqx-checkbox-default jqx-fill-state-normal jqx-rc-all"><div style="width: 13px; height: 13px;"><span style="width: 13px; height: 13px;" class=""></span></div></div><div style="clear: both;"></div></div>',columntype:"checkbox",width:"3%",datafield:"waitdel",hidden:!1,enabletooltips:!1}),$("#addPurchaseOrder_grid").on("click","#dellist",function(){var e=$(this).find("span"),t=!1,o=null;"jqx-checkbox-check-checked"===e.attr("class")?o="remove":(o="add",t=!0);var a=$("#addPurchaseOrder_grid").getData(),r=[];for(var i in a)a[i].waitdel=t,r.push(a[i]);0==r.length?$("#addPurchaseOrder_grid").updateListRow([{}]):$("#addPurchaseOrder_grid").updateListRow(r),"remove"==o?$("#dellist").find("span").removeClass("jqx-checkbox-check-checked"):$("#dellist").find("span").addClass("jqx-checkbox-check-checked")});for(var i in t){var n=t[i].datafield;"qty"===n&&(t[i].text="本次采购"),"purchasedQty"!==n&&"salesQty"!==n||(t[i].hidden=!1)}}return t},dataCopyLast=function(e){var t={},o=e[e.length-1];for(var a in o)t[a]=null;return e.push(t),e},dataCopyNullList=function(e){var t={},o=e[e.length-1];for(var a in o)t[a]=null;return t},grid_render=function(e,t){if(!1===t){var o={localdata:e,datatype:"array"},a=new $.jqx.dataAdapter(o,{downloadComplete:function(e,t,o){},loadComplete:function(e){},loadError:function(e,t,o){}});return table.jqxGrid({source:a}),void settings.columnSumEvent()}var o={localdata:e,datatype:"json",datafields:[{name:"productName",type:"string"},{name:"id",type:"string"},{name:"waitdel",type:"bool"},{name:"printOfGoods",type:"string"},{name:"photoId",type:"string"},{name:"oldPhotoId",type:"string"},{name:"photoAddId",type:"string"},{name:"spec",type:"string"},{name:"descr",type:"string"},{name:"color",type:"string"},{name:"prodColourDescr",type:"string"},{name:"weight",type:"string"},{name:"totalCartons",type:"string"},{name:"eachCartons",type:"string"},{name:"qty",type:"string"},{name:"purchasedQty",type:"string"},{name:"salesQty",type:"string"},{name:"priceBefore",type:"string"},{name:"price3",type:"string"},{name:"price3_server",type:"string"},{name:"extent",type:"string"},{name:"breadth",type:"string"},{name:"altitude",type:"string"},{name:"tj",type:"string"},{name:"deliveiedQty",type:"string"},{name:"deliveryQtyNow",type:"string"},{name:"remark",type:"string"},{name:"dzid",type:"string"},{name:"rowweight",type:"string"},{name:"ysprice",type:"string"},{name:"dsprice",type:"string"},{name:"volume",type:"string"},{name:"yards",type:"string"},{name:"unit",type:"string"},{name:"unitRate",type:"string"},{name:"unitRateqty",type:"string"},{name:"basicUnit",type:"string"},{name:"unitsFlag",type:"string"},{name:"deliveryQtyAll",type:"string"},{name:"inventoryReducere",type:"string"},{name:"amountFormula",type:"string"},{name:"inventoryQtyFormula",type:"string"}],addrow:function(e,t,o,a){a(!0)},updaterow:function(e,t,o){o(!0)}},a=new $.jqx.dataAdapter(o,{loadComplete:function(e){},loadError:function(e,t,o){}});table.jqxGrid({selectionmode:"singlerow",columnsheight:columnsheight,altrows:!0,editable:gridSettings.editable,columnsresize:!0,width:"100%",rowsheight:40,pageable:!1,enablebrowserselection:!1,enabletooltips:!0,autoheight:!0,localization:gridLocalizationObj,source:a,statusbarheight:40,showstatusbar:!0,showaggregates:!0,showtoolbar:!1,rendertoolbar:function(e){},columns:columns_Handle(columns),columngroups:[{text:"外箱尺寸(cm)",align:"center",name:"外箱尺寸"}],ready:function(){table.addClass("easyGrid"),timeOut(function(){})}})};needRefresh?grid_refresh(source):grid_render(source),gridSettings.delBtn&&(table.on("click",".addPhoto",function(e){setTimeout(function(){timeOut(function(){
photoModal(table.attr("id"),settings.productSourceName)},20)},0)}),table.on("click",".addyards",function(e){setTimeout(function(){timeOut(function(){yardsModal(table.attr("id"))},20)},0)}),table.on("click",".addUnit",function(e){setTimeout(function(){timeOut(function(){addUnitModal(table.attr("id"))},20)},0)}),table.on("click",".sendStart",function(e){timeOut(function(){for(var e=table.jqxGrid("source").records,t=0;t<e.length;t++)e[t].deliveryQtyNow=e[t].qty,computeRow(e[t]);table.jqxGrid("source").records=e,table.jqxGrid("refreshdata"),table.jqxGrid("refresh"),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()})}),table.on("click",".sendRun",function(e){timeOut(function(){for(var e=table.jqxGrid("source").records,t=0;t<e.length;t++)e[t].deliveryQtyNow=money(money(e[t].qty)-money(e[t].deliveiedQty),2,!0),computeRow(e[t]);table.jqxGrid("source").records=e,table.jqxGrid("refreshdata"),table.jqxGrid("refresh"),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()})}),table.on("click",".del",function(e){return 1!=table.jqxGrid("source").records.length&&(Core.confirm({message:"确定要删除？",confirmCallback:function(){var e=table.jqxGrid("source").records,t=table.jqxGrid("getselectedrowindex"),o=table.jqxGrid("getrowid",t);table.jqxGrid("deleterow",o),e=getData(e),table.jqxGrid("source").records=e,table.jqxGrid("refreshdata"),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()}}),!1)}),table.on("click",".add",function(e){timeOut(function(){table.jqxGrid("beginupdate");var e=table.jqxGrid("getselectedrowindex"),t=(table.jqxGrid("getrowdata",e),table.jqxGrid("source").records),o=defaultrow();t.splice(e+1,0,o),t=getData(t),table.jqxGrid("source").records=t,table.jqxGrid("refreshdata"),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent(),table.jqxGrid("endupdate")},0)}),table.on("click",".copy",function(e){timeOut(function(){table.jqxGrid("beginupdate");var e=table.jqxGrid("getselectedrowindex"),t=(table.jqxGrid("getrowdata",e),table.jqxGrid("source").records),o=getData()[e];o.dzid=null,t.splice(e+1,0,o),t=getData(t),table.jqxGrid("source").records=t,table.jqxGrid("refreshdata"),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent(),table.jqxGrid("endupdate")},0);var t=table.jqxGrid("source").records.length;if(table.jqxGrid("getselectedrowindex")+1==t)return!1})),table.on("resetColumnSum",function(){"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()}),table.on("click",".addspecbtn",function(){var e=table.attr("id"),t=table.jqxGrid("getselectedrowindex"),o=null==table.jqxGrid("getrowdata",t)?{}:table.jqxGrid("getrowdata",t),a=o.id;if(null==a||""==a)return Core.alert({message:"请先选择产品"}),!1;specModal(e,a)}),table.on("refresh",function(e){grid_refresh()}),table.on("click",".jqx-grid-header,.jqx-button,.del,.add,.copy,.addPhoto",function(e){var t=table.data("lastcell"),o=table.data("lastindex");table.jqxGrid("endcelledit",o,t,!1)}),table.on("cellbeginedit",function(e){e.stopPropagation();var t=e.args,o=e.args.datafield,a=e.args.rowindex,r=t.value,i=t.row;table.data("lastcell",o),table.data("lastindex",a);table.jqxGrid("source").records.length,table.jqxGrid("getselectedrowindex");"productName"==o&&$("#comboboxeditor"+table.attr("id")+o).length>0&&$("#comboboxeditor"+table.attr("id")+o).jqxComboBox("clearSelection");var n=null==i[o]?"":i[o];void 0==ComboBoxSources.getInfoMapByKey(productSourceName,"name",n).name||ComboBoxSources.getInfoMapByKey(productSourceName,"name",n).name;if("productName"==o&&$("#comboboxeditor"+table.attr("id")+o).length>0){var d=void 0==search(i.productName)[0]?r:search(i.productName)[0];d.length=200,$("#comboboxeditor"+table.attr("id")+o).jqxComboBox({source:d}),$("#comboboxeditor"+table.attr("id")+o).val(n),timeOut(function(){$("#comboboxeditor"+table.attr("id")+o).val(n),$("#comboboxeditor"+table.attr("id")+o).find("input.jqx-combobox-input").val(n),$("#comboboxeditor"+table.attr("id")+o).jqxComboBox("open")},0)}else"productName"==o&&$("#comboboxeditor"+table.attr("id")+o).val(n),timeOut(function(){"productName"==o&&($("#comboboxeditor"+table.attr("id")+o).val(n),$("#comboboxeditor"+table.attr("id")+o).jqxComboBox("open"))},0)});var search=function(e,t){var o=null==t?"_name":t,a=ComboBoxSources.getInfoMapByKey(settings.productSourceName.productsInUse,o),r=[],i=null;for(var n in a){var d=a[n],l=o.replace("_","");d[l]===e?(r.unshift(d),i=d.productName):"name"===l&&d[l].replace(d.sku,"")===e?(r.unshift(d),i=d.productName):"name"===l&&(d._name.indexOf(e)>-1||d.name.indexOf(e)>-1)?r.push(d):n.indexOf(e)>-1&&r.push(d)}return[r,i]},easytablekeyup=null;table.on("keyup",".productName",function(e){if("start"===table.prop("comStart"))return void e.stopPropagation();var t=$(this),o=$("#"+table.attr("id")+"id"),a=null==e.keyCode?"":e.keyCode;if($.strEqArr(a,[13,17,35,36,37,38,39,40,""]))return!0;clearTimeout(easytablekeyup),easytablekeyup=setTimeout(function(){var e=t.find("input").focusIndex();if(0==t.val().length&&o.text(""),null==t.jqxComboBox("getSelectedItem")){var a=t.val(),r=ComboBoxSources.getInfoMapByKey(settings.productSourceName.productsInUse_server,"name",a);if(null==r.name){var i=ComboBoxSources.getInfoMapByKey(settings.productSourceName.product_server,"name",a);i.name,o.text("新产品")}}else{var a=t.find("input.jqx-combobox-input").val(),r=ComboBoxSources.getInfoMapByKey(settings.productSourceName.productsInUse_server,"name",a);if(null==r.name){var i=ComboBoxSources.getInfoMapByKey(settings.productSourceName.product_server,"name",a);null!=i.name?($("#comboboxeditor"+table.attr("id")+"productName").jqxComboBox("clearSelection"),$("#comboboxeditor"+table.attr("id")+"productName").find("input.jqx-combobox-input").val(a)):(o.text("新产品"),$("#comboboxeditor"+table.attr("id")+"productName").jqxComboBox("clearSelection"),$("#comboboxeditor"+table.attr("id")+"productName").find("input.jqx-combobox-input").val(a))}}var n=search(a),d=n[0],l=n[1];d.length=200,t.jqxComboBox({source:d}),null!=l?(t.val(l),o.text("")):(t.find("input").val(a),t.find("input").focusIndex(e))},60)}).on("compositionend",".productName",function(){table.prop("comStart","end");var e=$(this);timeOut(function(){e.trigger("keyup")},0)}).on("compositionstart",".productName",function(e){table.prop("comStart","start")}),table.on("cellendedit",function(e){$("#"+table.attr("id")+"id").text("");var t=null==e.args?{}:e.args.datafield,o=e.args.rowindex,a=e.args.rowindex,r=table.jqxGrid("getrowid",a),i=e.args.value,n=table.jqxGrid("getrowdata",a);n.productName;if("object"==typeof e.args.value)var d=e.args.value.label,l=ComboBoxSources.getInfoMapByKey(productSourceName,"name",d);else var d=e.args.value.replace(/ /g,""),l=ComboBoxSources.getInfoMapByKey(settings.productSourceName.productsInUse,"name",d);if("productName"==t){if(2==JSON.stringify(l).toString().length&&""!=d){if(null==d)return!0;if("object"==typeof e.args.value)var s=ComboBoxSources.getInfoMapByKey(settings.productSourceName.product,"name",d).name;else var s=ComboBoxSources.getInfoMapByKey(settings.productSourceName.product,"name",d).name;if(null!=s){var c={productName:""};timeOut(function(){table.jqxGrid("updaterow",r,c)},0)}var u=(_global_settings.service.url,_global_settings.owner);"true"==u.productCoLorTypeFlag&&ComboBoxSources.getRecords("systemColorList_forAjax"),"true"==u.productSpeTypeFlag&&ComboBoxSources.getRecords("systemSpec_forAjax");var p=$.extend(!0,table.jqxGrid("getrowdata",a),{}),g={};for(var m in p)null==p[m]?g[m]="":g[m]=p[m];g.productName=d,g.photoId="",g.photoAddId="",timeOut(function(){null!=n.productName&&""!=n.productName&&void 0!=n.productName||$("#comboboxeditor"+table.attr("id")+t).jqxComboBox("addItem",d);table.jqxGrid("updaterow",r,g)},0)}if(""==l.name||null==l.name){n.productName=i,n.photoId="",n.spec="",n.color="";table.jqxGrid("updaterow",r,n);return!0}if(e.args.oldvalue===e.args.value)return!0;n.productName=l.name,n.photoId=l.prodPhoto,n.spec="",n.color="",n.name=l.name,setRowData(t,o)}else if("unitRate"==t)if(null!=e.args.value.label&&""!=e.args.value.label&&e.args.value.label!=e.args.oldvalue.label){var f=ComboBoxSources.getInfoMapByKey(productSourceName,"name",n.productName);if(f.multiUnitFlag){var h=ComboBoxSources.getInfoMapByKey(f.prodContainerList,"unitName",e.args.value.label.replace(/\(.{0,}\)$/,""));n.unitRate=h.rate,h.unitName!=n.basicUnit?n.unit=h.unitName+"("+n.unitRate+n.basicUnit+")":n.unit=h.unitName,n.priceBefore="salePrice"==sourceType?h.salePrice:h.purchasePrice}else n.unit=e.args.value.label,n.unitRate=1,n.basicUnit=e.args.value.label}else null!=e.args.value.label&&""!=e.args.value.label||(n.unitRate=1,n.basicUnit="",n.unit="");else n[t]=e.args.value;var n=table.jqxGrid("getrowdata",a);n.qty=""==n.qty||"NaN"==n.qty?0:n.qty;for(var v=n.qty,y=["priceBefore"],m=0;m<y.length;m++){var b=n[y[m]];n[y[m]]=money(b,4,!0)}computeRow(n),"qty"==t&&(n.totalCartons=0,n.eachCartons=0,n.qty=v);for(var x=["weight","totalCartons","eachCartons","qty","extent","breadth","altitude","volume","tj","deliveiedQty","deliveryQtyNow"],m=0;m<x.length;m++){var b=n[x[m]];n[x[m]]=money(b,4,!0);["extent","breadth","altitude","volume"].indexOf(x[m])>-1&&(n[x[m]]=money(b,4,!0))}var w=$.extend(!0,{},n);if("productName"==t){var q=w.productName;table.jqxGrid("updaterow",r,w);timeOut(function(){table.jqxGrid("getrowdata",a).productName=q},0),"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()}else timeOut(function(){table.jqxGrid("updaterow",r,w);"function"==typeof settings.columnSumEvent&&settings.columnSumEvent()},0);return!0});var fouroperations=function(expression,row,qtydatafield,bool){var formulaMap={meas:"tj",weight:"rowweight",price:"priceBefore",eachCartons:"eachCartons",totalCartons:"totalCartons",qty:"qty",inventoryQty:"inventoryReducere"};expression.indexOf("inventoryQty")>-1&&(expression=expression.replace("inventoryQty",row.inventoryQtyFormula));for(var arr=expression.split(" "),i=0;i<arr.length;i++){var line=formulaMap[arr[i]];if(null!=line&&(arr[i]=row[line],"qty"==line&&(arr[i]=row[qtydatafield],bool))){arr[i]=row.qty;var unitRate=row.unitRate;if(null!=unitRate&&""!=unitRate||(unitRate=1),"add"==addoredit){var productunitFlag=_global_settings.acOwner.productunitFlag;productunitFlag&&(arr[i]=arr[i]*unitRate)}if("edit"==addoredit||"view"==addoredit){var productunitFlag=settings.order.productunitFlag;productunitFlag&&(arr[i]=arr[i]*unitRate)}}}for(var i=0,len=arr.length;i<len;i++)""==arr[i]&&(arr[i]=0);return eval(arr.join(""))};window.fouroperations=fouroperations,table[0].getData=function(e){return getData(e)},table[0].getDataWash=function(e,t){return getDataWash(e,t)},table[0].getDataDirty=function(){return getDataDirty()},table[0].addLastRow=function(e){return addLastRow(e)},table[0].grid_render=function(e,t){grid_render(e,t)}},$.fn.getData=function(e){return $(this)[0].getData(e)},$.fn.getDataWash=function(e){return $(this)[0].getDataWash($(this).getData(),e)},$.fn.getDataDirty=function(e){return $(this)[0].getDataDirty(e)},$.fn.addLastRow=function(e){var t=$(this),o={totalCartons:0,eachCartons:0,prodSpecId:null,prodColourId:null,weight:null,extent:null,breadth:null,altitude:null,tj:null},a=[];for(var r in o)try{t.jqxGrid("iscolumnvisible",r)||a.push(r)}catch(e){}t[0].grid_render(t[0].addLastRow(e));for(var r=0;r<a.length;r++)"totalCartons"==a[r]&&t.jqxGrid("setcolumnproperty","qty","editable",!0),t.jqxGrid("hidecolumn",a[r]);t.jqxGrid("hidecolumn","dzid")},$.fn.updateListRow=function(e){$(this)[0].grid_render(e,!1)},$.fn.getRowData=function(){var e=$(this).jqxGrid("getselectedrowindex");return $(this).jqxGrid("getrowdata",e)},$.fn.boxSetting=function(e,t,o){var a=$(this),r="hide"==e?"hidecolumn":"showcolumn",i="hide"==e,n=["totalCartons","eachCartons"];"volume"==_global_settings.acOwner.cartonType&&(n=["totalCartons","eachCartons","volume"]);for(var d=0;d<n.length;d++)a.jqxGrid("beginupdate"),a.jqxGrid(r,n[d]),a.jqxGrid("endupdate");a.jqxGrid("setcolumnproperty","qty","editable",i)},$.fn.printOfGoodsFlag=function(e,t,o){var a=$(this),r="hide"==e?"hidecolumn":"showcolumn";_global_settings.acOwner.blueTooth&&a.attr("id").indexOf("ale")>-1&&(r="hidecolumn");a.jqxGrid("beginupdate"),a.jqxGrid(r,"printOfGoods"),a.jqxGrid("endupdate")},$.fn.productMeasFlag=function(e,t,o){var a=$(this),r="hide"==e?"hidecolumn":"showcolumn",i=["volume"];"size"!=_global_settings.acOwner.cartonType&&null!=_global_settings.acOwner.cartonType||(i=["extent","breadth","altitude"]);for(var n=0;n<i.length;n++)a.jqxGrid("beginupdate"),a.jqxGrid(r,i[n]),a.jqxGrid("endupdate")},$.setGoodsBinning=function(e,t,o,a,r,i,n,d){var l=null;!0===i||(i=!1),$.visibleDoFunc($(".easyGridClientId"),function(e){l=e.val()});var s=o.productName,c=null,u=o.spec;for(var p in d)s==d.name&&(c=d.id);if(""!=l&&null!=l||(l=null),""==c||null==c)return!1;if(""!=u&&null!=u||(u=null),"salePrice"==r)var g=_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("order/goodsBinning/"+l+"/"+c+"/"+u);else var g=_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("/order/goodsBinning/purchaseOrder/"+l+"/"+c+"/"+u);Core.AjaxRequest({type:"GET",showMsg:!1,async:i,url:g,callback:function(o){for(var r=e.jqxGrid("getrowdata",t),i=["printOfGoods","weight","totalCartons","eachCartons","priceBefore","extent","breadth","altitude"],l=0;l<i.length;l++){var s=o[i[l]];""!=s&&null!=s&&0!=s&&(r[i[l]]=o[i[l]])}n?r.qty=money(r.totalCartons*r.eachCartons,4,!0):(r.totalCartons=0,r.eachCartons=0,r.qty=money(r.qty,4,!0)),r.price3_server=money(r.priceBefore*r.qty),r.price3=r.priceBefore*r.qty,r.photoId=void 0===r.photoId?void 0===d?"":d.prodPhoto:r.photoId;e.jqxGrid("updaterow",t,r);"function"==typeof a&&a()},failure:function(e){}})};var unitArr=[],addUnitModal=function(e){var t=$("#"+e).data().soownerid,o=$("#"+e).data().name,a=function(){$("#order_unitTbody").html("").append('<tr><td><input data-index="0" data-blacklist=" " class="addLine" type="text"></td><td colspan="2"></td></tr>'),Core.AjaxRequest({url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/searchOwnerUnitTypeVO/"+t+"/"+o),type:"GET",async:!1,callback:function(e){l(e)},failure:function(){}}),$("#order_unitTbody").off("keyup").on("keyup",".addLine",function(e){var t=$(this),o=t.val();if(13==e.keyCode&&""!=o){if(r(o))return Core.alert({message:"单位已存在，请重新输入！"}),$(this).val(""),!1;var a='<tr><td><input data-blacklist=" " class="addUnit" type="text" value="'+o+'"></td><td colspan="2"><span class="md-cancel delete"></span></td></tr>';t.parents("tr").after(a),t.val(""),d(),$("#order_unitTbody").find(".addUnit").off("blur").on("blur",i)}}),$("#order_unitTbody").find(".addUnit").off("blur").on("blur",i),$("#order_unitTbody").off("click").on("click",".delete",function(e){var t=$(this);Core.confirm({message:"确定要删除吗？",confirmCallback:function(){t.parents("tr").remove(),d()}})}),$("#order_addUnit").modal("show"),s()},r=function(e){for(var t=$("#order_unitTbody").find("tr:gt(0)"),o=0,a=t.length;o<a;o++)if(t.eq(o).find("input").val()==e)return!0;return!1},i=function(){var e=$(this),t=e.attr("data-index"),o=e.attr("value"),a=e.val();if(a!=o&&n(e,a,t))return Core.alert({message:"第"+t+"行单位已存在，请重新填写！"}),e.val(o),!1},n=function(e,t,o){for(var a=$("#order_unitTbody").find("tr"),r=0,i=a.length;r<i;r++)if(r!=o&&a.eq(r).find("input").val()==t)return!0;return!1},d=function(){for(var e=$("#order_unitTbody").find("tr"),t=0,o=e.length;t<o;t++)e.eq(t).find("input").attr("data-index",t)},l=function(e){for(var t=0;t<unitArr.length;t++){var o='<tr><td><input data-index="'+(t+1)+'" data-blacklist=" " type="text" class="addUnit" value="'+unitArr[t].unitName+'"></td><td colspan="2"><span class="md-cancel delete"></span></td></tr>';$("#order_unitTbody").append(o)}for(var t=0;t<e.length;t++){var o='<tr><td><input readonly type="text" value="'+e[t].unitGroupName+'"></td><td colspan="2"></td></tr>';$("#order_unitTbody").append(o)}},s=function(){$("#save_addUnitBtn").on("click",function(){unitArr=[];var e=$("#order_unitTbody").find("tr");$.each(e,function(e,t){var o=$(t),a=o.find("input").val(),r=o.find("input").attr("readonly");if(""!=a&&!r){var i={unitName:a,rate:1};unitArr.push(i)}})})};0==$("#order_addUnit").length?$.loadModal("page/common/segment/addUnit.html",function(e){$("body").append(e),a()}):a()},photoModal=function(e,t){var o=$("#"+e).jqxGrid("getselectedrowindex"),a=$("#"+e).jqxGrid("getrowdata",o),r=($("#"+e).data().soownerid,$("#"+e).data().name,a.productName);if(null==r||""==r)return Core.alert({message:"请选择产品"}),!1;var i=t.product,n=(ComboBoxSources.getInfoMapByKey(i,"name",r),function(){$("#photoModal_list").html('<div style="width: 258.66px; height: 166px; position: relative;">  \t<img class="img0" border="0" src="images/common/photo_icon2.png"\t\twidth="100%" height="100%"> <i                              \t\tclass="md-cancel close-lab"></i>                            </div>                                                             <input type="file" class="file0" style="display: none"             \tname="file">                                                    '),d(),$("#photoModal").modal("show")}),d=function(t){$("#photoModal_saveBtn").off("click").on("click",function(){try{var t=ComboBoxSources.getInfoMapByKey(i,"name",r);if(t.prodPhoto=$("#photoModal").find(".file0").data("id"),null==t.prodPhoto||""==t.prodPhoto)throw Core.alert({message:"请上传产品图片"}),new Error("请上传产品图片");t.name=t._name,delete t._name;t.id,t.prodPhoto;$("#photoModal").modal("hide"),a.photoId=t.prodPhoto,a.oldPhotoId=a.photoId;$("#"+e).jqxGrid("updaterow",o,a)}catch(e){}})};0==$("#photoModal").length?$.loadModal("page/common/segment/photoModal.html",function(t){var o=$(t);$("body").append(o),$("#photoModal").on("click",".close-lab",function(e){var t=$(this),o=$(this).parents("form"),a=t.data("id");if(""!=a&&null!=a)return Core.AjaxRequest({url:ws_url+"/CXF/rs/common/file/"+a,type:"DELETE",showMsg:!1,callback:function(e){o.find(".file0").val(""),o.find(".img0").attr("src","images/common/photo_icon2.png"),o.find(".file0").data("id",""),t.data("id","")},failure:function(e){}}),!1}),$("#photoModal").on("click",".img0",function(){-1!=$(this).attr("src").indexOf("images/common")&&$(this).parents("form").find(".file0").trigger("click")}),$("#photoModal").on("change",".file0",function(){var t=$(this),o=getObjectURL(this.files[0]),a=$("#"+e).attr("data-soOwnerId"),r=$("#"+e).attr("data-name");uploadImage(t,t.parents("form"),a,r)&&timeOut(function(){t.parents("form").find(".img0").attr("src",o)})}),n()}):n()},colorModal=function(e,t,o,a){var r=$("#"+e).jqxGrid("getselectedrowindex"),i=$("#"+e).jqxGrid("getrowdata",r),n=$("#"+e).attr("data-soOwnerId"),d=$("#"+e).attr("data-name"),l=i.productName,s=null,c=a.product;void 0!=l&&$.each(c,function(e,t){t.name==l&&(s=t.id)}),$("#colorModal_id").val(l),$("#colorModal_search_text").val("");var u="";u=e.indexOf("Sale")>-1?"销售":"采购";var p=!1;try{p=$("#"+e).jqxGrid("iscolumnvisible","totalCartons")}catch(e){}if(p?"箱数":u+"数量",null==l||""==l)return Core.alert({message:"请选择产品"}),!1;var g=function(e){var t="";return $.each(e,function(e,o){var a="images/common/photo_icon2.png",r=null;null!=o.photo&&""!=o.photo&&"undefined"!=o.photo&&(r=o.photo,a=ctx+"/CXF/rs/SimpleAC/down/"+(new Base64).encode("toocr/order/downFile/"+r+"/"+n+"/"+d));var i=void 0===o.descr?void 0===o.name?void 0===o.typeValue?"":o.typeValue:o.name:o.descr,l=' <form class="col-md-3 imgFile" style="padding-bottom: 40pt;">                                                                                                                         \t       <div class="col-md-12">                                                                                                                      \t\t\t  <div class="colorModalImgCell">                                                                                                                    \t\t\t      <img title="查看大图" src="'+a+'" style="width: 100%; height: 100%;" class="img0"> \t\t\t  </div>                                                                                                                                    \t\t\t  <input type="file" name="file" data-id="'+o.photo+'" data-pid="'+o.id+'" style="display:none" class="file0">                                        \t\t\t  <div class="m-t-10 relative proTypeLabel" style=" width: 190pt;background: #f8f9f9;color: #53687D;">                                                                                                \t\t\t      <div class="text-center seifColorDefine" ><div class="prod_checkbox"><input type="checkbox" class="prod_specCheck prod_checkbox_left" data-pid="'+o.id+'"><span class="prod_checkbox_left_img" data-checked="'+o.likeFlag+'" data-pid="'+o.id+'"  data-type="colour"></span></div><input  style="80%" class="prod_specText" data-oldvalue="'+i+'" placeholder="颜色描述" data-pid="'+o.id+'" data-orderflag="'+o.orderFlag+'" value="'+i+'"></div>                                                         \t\t\t  </div>                                                                                                                                    \t       </div>                                                                                                                                       \t   </form>';t+=l}),t},m=function(e,t){Core.AjaxRequest({type:"GET",showWaiting:!1,url:_global_settings.service.url+"/product/searchcolor/"+e+"/"+t,callback:function(e){var t=e,o=g(t);$("#colorModal").find(".colorModalList").html(o),$("#colorModal").find(".colorModalList").find(".prod_specNum").moneyinput({textalign:"center",noEndZero:!0})}})},f=function(){$("#colorModal").keydown(function(e){return 13!=e.keyCode}),$("#colorModal").find(".colorModalList").html("");var t=$("#"+e).jqxGrid("getselectedrowindex"),o=$("#"+e).jqxGrid("getrowdata",t),a=$("#"+e).jqxGrid("source").records,r=(o.currentColorData,o.id,$("#"+e).data().soownerid),i=$("#"+e).data().name;if(void 0==s){var n=[];Core.AjaxRequest({type:"GET",showWaiting:!1,async:!1,url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/searchOwnerColor/"+r+"/"+i),callback:function(e){for(var t=[],o=0;o<e.length;o++)t[o]={},t[o].id=e[o].id,t[o].descr=e[o].typeValue;n=n.concat(e)}}),null!=modallist[l]&&(void 0!=modallist[l].colorModalList&&(n=n.concat(modallist[l].colorModalList)),$.each(n,function(e,t){$.each(a,function(t,o){void 0!=o.color&&""!=o.color&&null!=o.color&&n[e].name==o.color&&(""!=n[e].photo&&void 0!=n[e].photo&&null!=n[e].photo||(""!=o.photoAddId&&void 0!=o.photoAddId?n[e].photo=o.photoAddId:n[e].photo=""))})}));var d=g(n);$("#colorModal").find(".colorModalList").html(d);var c=$("#colorModal").find(".prod_specText");return $.each(c,function(e,t){var a=c.eq(e).attr("data-pid");"undefined"!=a&&""!=a&&null!=a&&void 0!=a&&($("#colorModal").find(".close-lab").removeClass("md-cancel"),$("#colorModal").find(".prod_specText").eq(e).attr("disabled",!0)),$(this).val()==o.color&&$(this).parent().find(".prod_specCheck").attr("checked",!0)}),$("#colorModal").find(".colorModalList").find(".prod_specNum").moneyinput({textalign:"center",noEndZero:!0}),h(p),void $("#colorModal").modal("show")}Core.AjaxRequest({type:"GET",showWaiting:!1,url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/productid/"+s+"/"+r+"/"+i),callback:function(e){var t=e.prodColourList;if(null!=modallist[e.name]&&void 0!=modallist[e.name].colorModalList){t=t.concat(modallist[e.name].colorModalList);for(var r=0;r<t.length;r++)$.each(a,function(e,o){void 0!=o.color&&""!=o.color&&null!=o.color&&t[r].name==o.color&&(""!=t[r].photo&&void 0!=t[r].photo&&null!=t[r].photo||(""!=o.photoAddId&&void 0!=o.photoAddId?t[r].photo=o.photoAddId:t[r].photo=""))})}var i=g(t);$("#colorModal").find(".colorModalList").html(i);var n=$("#colorModal").find(".prod_specText");$.each(n,function(e,t){var a=n.eq(e).attr("data-pid");"undefined"!=a&&""!=a&&null!=a&&void 0!=a&&($("#colorModal").find(".close-lab").removeClass("md-cancel"),$("#colorModal").find(".prod_specText").eq(e).attr("disabled",!0)),$(this).val()==o.color&&$(this).parent().find(".prod_specCheck").attr("checked",!0)}),$("#colorModal").find(".colorModalList").find(".prod_specNum").moneyinput({textalign:"center",noEndZero:!0}),h(p),$("#colorModal").modal("show")}})},h=function(t){$("#colorModalListAddBtn").off("click").on("click",function(){var e=$(".colorModalList"),t=$(' <form class="col-md-3 imgFile" style="padding-bottom: 40pt;">                                                                                                                         \t       <div class="col-md-12">                                                                                                                      \t\t\t  <div class="colorModalImgCell">                                                                                                                    \t\t\t      <img src="images/common/photo_icon2.png" style="width: 100%; height: 100%;position: relative;" class="img0"> \t\t\t  </div>                                                                                                                                    \t\t\t  <input type="file" name="file" multiple="multiple" style="display:none" class="file0">                                        \t\t\t  <div class="m-t-10 relative proTypeLabel" style=" width: 190pt;background: #f8f9f9;color: #53687D;">                                                                                                <div class="prod_checkbox"><input type="checkbox" checked="true" class="prod_specCheck prod_checkbox_left"><span class="prod_checkbox_left_img" data-checked="false"  data-type="colour"></span></div><input  style="width:80%" class="prod_specText" data-blacklist=" " placeholder="颜色描述" data-orderFlag="false" value=""></div>                                                         \t\t\t  </div>                                                                                                                                    \t       </div>                                                                                                                                       \t   </form>');t.find(".prod_specNum").moneyinput({textalign:"center",noEndZero:!0}),e.prepend(t),$(".colorModalList").find(".prod_specText").eq(0).focus(),$(".colorModalList").find(".prod_specText").on("input",function(){var e=$(this).val();$(this).val(e.replace(/ /g,""))})});var o=function(t){var o=($("#"+e).attr("data-soOwnerId"),$("#"+e).attr("data-name"),$(".colorModalList").find(".imgFile"));ComboBoxSources.getInfoMapByKey(c,"name");var a=[],i=[];$.each(o,function(e,o){var r=$(this),n="";n=1==t&&null!=r.find(".prod_specText").data("oldvalue")?r.find(".prod_specText").data("oldvalue"):r.find(".prod_specText").val();var d={color:n,orderFlag:r.find(".prod_specText").data("orderflag"),photoAddId:"undefined"==r.find(".file0").data("id")?void 0:r.find(".file0").data("id"),qty:"",id:r.find(".file0").data("pid")},l={id:r.find(".file0").data("pid"),qty:r.find(".prod_specNum").val(),color:r.find(".prod_specText").val(),photoAddId:"undefined"==r.find(".file0").data("id")?void 0:r.find(".file0").data("id"),orderFlag:r.find(".prod_specText").data("orderflag")};if(""==d.color&&null!=d.photoAddId)throw Core.alert({message:"颜色描述不能为空"}),"颜色描述不能为空";(""!=d.color||null!=d.photoId&&""!=d.photoId)&&(a.push(d),r.find(".prod_specCheck").is(":checked")&&i.push(l))}),$("#colorModal").modal("hide");var n=$("#"+e).jqxGrid("getrowdata",r),d=[],u=ComboBoxSources.getInfoMapByKey(c,"name"),p=u[l];if(i.length>0)for(var g=0;g<i.length;g++){var m={};m.id=s,m.productName=n.productName,m.photoAddId=i[g].photoAddId,m.color=i[g].color,m.spec=n.spec,m.photoId=i[g].photoAddId,""!=m.photoId&&null!=m.photoId||(m.photoId=void 0!=p?p.prodPhoto:i[g].photoAddId),d.push(m)}var f=$.extend(!0,$("#"+e).jqxGrid("source").records,[]),h=f.splice(r+1),v=d.shift(),y=f.pop();null==v?(y.photoAddId=null,y.color="",void 0!=p?(y.photoId=p.prodPhoto,y.oldPhotoId=p.prodPhoto):(y.photoId="",y.oldPhotoId="")):(y.id=v.id,y.productName=v.productName,y.photoAddId=v.photoAddId,y.color=v.color,y.oldPhotoId=y.photoId,y.photoId=v.photoAddId,""!=y.photoId&&null!=y.photoId||(void 0!=p?y.photoId=p.prodPhoto:void 0!=v.photoAddId&&""!=v.photoAddId?y.photoId=i[g].photoAddId:y.photoId=y.oldPhotoId)),d.unshift(y),f=f.concat(d).concat(h),f=$("#"+e).getData(f),$("#"+e).updateListRow(f),$("#"+e).trigger("resetColumnSum")};$("#colorModal_search_Btn").off("click").on("click",function(){var e=$("#colorModal_search_text").val();""==e&&(e="%20"),m(e,s)}),$(".colorModalList").off("blur",".prod_specText").on("blur",".prod_specText",function(e){var t=$(this);if(("undefined"==t.data("pid")||void 0==t.data("pid"))&&""!=t.val()){var o=t.val(),a=t.parents(".imgFile").find(".file0").data("id");"undefined"!=a&&void 0!=a||(a="");var r={name:o,photo:a};return prodmodallist(i.productName,"colorModalList",r,t.data("oldvalue")),void t.data("oldvalue",o)}t.data("pid")}),$("#colorModal_saveBtn").off("click").on("click",function(){return void o()})};0==$("#colorModal").length?$.loadModal("page/common/segment/colorModal.html",function(t){var o=$(t);$("body").append(o),$("#colorModal_id").val(l),$("#colorModal").on("click",".close-lab",function(t){var o=$(this),a=$(this).parents("form"),i=($("#edit-colorList").children().length,$(this).data("pid")),n=$(this).index(),d=o.data("id");if(""!=d&&null!=d)return a.find(".file0").val(""),a.find(".img0").attr("src","images/common/photo_icon2.png"),a.find(".file0").data("id",""),o.data("id",""),!1;null!=i&&""!=i&&"undefined"!=i||Core.confirm({message:"确定要删除？",confirmCallback:function(){a.remove();var t=$("#"+e).jqxGrid("getrowdata",r);removeArrayByIndex(window.modallist[t.productName].colorModalList,n)}})}),$(".colorModalList").on("click",".img0",function(){-1!=$(this).attr("src").indexOf("images/common")&&$(this).parents("form").find(".file0").trigger("click")}),$(".colorModalList").on("change",".file0",function(){var t=$(this),o=getObjectURL(this.files[0]),a=($("#"+e).jqxGrid("getrowdata",r),$("#"+e).attr("data-soOwnerId")),i=$("#"+e).attr("data-name");uploadImage(t,t.parents("form"),a,i)&&timeOut(function(){t.parents("form").find(".img0").attr("src",o)})}),f()}):f()},getObjectURL=function(e){var t=null;return void 0!=window.createObjectURL?t=window.createObjectURL(e):void 0!=window.URL?t=window.URL.createObjectURL(e):void 0!=window.webkitURL&&(t=window.webkitURL.createObjectURL(e)),t},uploadImage=function(e,t,o,a){if(!checkFileType(e))return!1;var r=function(r){var i=ctx+"/CXF/rs/SimpleAC/file/"+(new Base64).encode("toocr/order/file/"+o+"/"+a),n=new FormData,d=function(e){for(var t=e.split(","),o=t[0].match(/:(.*?);/)[1],a=atob(t[1]),r=a.length,i=new Uint8Array(r);r--;)i[r]=a.charCodeAt(r);return new Blob([i],{type:o})}(r),l=e[0].files[0];$.each(l,function(e,t){n.append(e,t)}),n.append("file",d,l.name),$.ajax({type:"POST",url:i,data:n,async:!1,cache:!1,contentType:!1,processData:!1,success:function(o){if(e.data("id",o.id),t.attr("class").indexOf("imgFile")>-1&&t.find(".close-lab").data("id",o.id),e.parents(".colorModalList").length>0){var a=e.parents(".imgFile").find(".prod_specText").val();if(""==a)return!1;$("#colorModal_id").val(),o.id}else e.parents("#photoModal_list").length>0&&e.parents("#photoModal_list").find(".file0").data("id",o.id)},error:function(e,t,o){Core.alert({message:"上传失败，请检查文件格式或刷新后重试！"})}})};return timeOut(function(){new imgBase64(e).toDataURL(e.parents(".imgFile").find("img")[0],r)}),!0},checkFileType=function(e){var t="";if(""==(t="string"==typeof e?e:e.val()))return void("string"!=typeof e&&(Core.alert({message:"请选择上传图片！"}),e.parents("form").find("img").attr("src","images/common/photo_icon2.png")));var o=t.substr(t.lastIndexOf(".")+1).toLowerCase();return"jpg"==o||"jpeg"==o||"gif"==o||"png"==o||"bmp"==o||("string"!=typeof e&&Core.alert({message:"请选择图片文件！"}),!1)},specModal2=function(e,t,o,a){var r=$("#"+e).jqxGrid("getselectedrowindex"),i=$("#"+e).jqxGrid("getrowdata",r),n=(i.id,
i.productName),d=$("#"+e).attr("data-soOwnerId"),l=$("#"+e).attr("data-name"),s="";s=e.indexOf("Sale")>-1?"销售":"采购";var c=!1;try{c=$("#"+e).jqxGrid("iscolumnvisible","totalCartons")}catch(e){}if(c?"箱数":s+"数量",null==n||""==n)return Core.alert({message:"请选择产品"}),!1;var u=a.product,p=ComboBoxSources.getInfoMapByKey(u,"name",n),g=function(t,a,n,d){function l(){var e=!1,t=$("#specModal2").find(".selfDefine");if(t.length>1)for(var o=0;o<t.length;o++)for(var a=o+1;a<t.length;a++)if(t.find(".prod_specText").eq(o).val()==t.find(".prod_specText").eq(a).val()){e=!0;break}return e}var s=function(a){var i=$("#specModal2").find(".selfDefine"),n=[],l=[],s={};$.each(i,function(e,t){var o=$(this),r="";r=1==a&&null!=o.find(".prod_specText").data("oldvalue")?o.find(".prod_specText").data("oldvalue"):o.find(".prod_specText").val();var i={id:o.find(".prod_specText").data("pid"),spec:r,specFlag:o.find(".prod_specText").data("orderflag"),qty:void 0==o.find(".prod_specNum").data("qty")?void 0==o.find(".prod_specNum").val()?"0":o.find(".prod_specNum").val():o.find(".prod_specNum").data("qty")},d={id:o.find(".prod_specText").data("pid"),spec:o.find(".prod_specText").val(),qty:void 0==o.find(".prod_specNum").data("qty")?void 0==o.find(".prod_specNum").val()?"0":o.find(".prod_specNum").val():o.find(".prod_specNum").data("qty")};""!=i.spec&&(s[i.spec.toLowerCase()]=!0,n.push(i),o.find(".prod_specCheck").is(":checked")&&l.push(d))}),d.prodSpecList=n,d.name=d._name,delete u._name,$("#specModal2").modal("hide");for(var c=[],p=$("#"+e).jqxGrid("getrowdata",r),g=0;g<l.length;g++){var m={};m.photoId=p.photoId,m.productName=p.productName,m.color=p.color,m.spec=l[g].spec,c.push(m)}var f=$.extend(!0,$("#"+e).jqxGrid("source").records,[]),h=f.splice(r+1),v=c.shift(),y=f.pop();null==v?y.spec="":(_global_settings.acOwner.productCoLorFlag,y.spec=v.spec,y.productName=v.productName),c.unshift(y),f=f.concat(c).concat(h),f=$("#"+e).getData(f),$("#"+e).updateListRow(f),$("#"+e).trigger("resetColumnSum");for(var b=r,x=0;x<l.length;x++){var w=$("#"+e).jqxGrid("getrowdata",b);$.setGoodsBinning($("#"+e),b,w,function(){$("#"+e).trigger("resetColumnSum")},o,!0,t,d),b++}};$("#specModal2_saveBtn").off("click").on("click",function(){return l()?(Core.alert({message:"规格型号描叙不能重复！"}),!1):void s()}),$("#specModelAddBtn").off("click").on("click",function(){var e=$(".specModal2List"),t=$(' <form class="col-md-3 specdiv" style="padding-bottom: 10pt;">\t       <div class="col-md-12">\t\t\t  <div class="m-t-10 relative proTypeLabel" style=" width: 190pt;background: #f8f9f9;color: #53687D;">\t\t\t      <div class="text-center selfDefine" ><div class="prod_checkbox"><input type="checkbox" checked="true" class="prod_specCheck prod_checkbox_left"><span class="prod_checkbox_left_img" data-checked="false"  data-type="spec"></span></div><input class="prod_specText" data-blacklist=" " placeholder="规格描述" style="width:80%;"></div>\t\t\t  </div>\t       </div>\t   </form>');t.find(".prod_specNum").moneyinput({textalign:"center",noEndZero:!0}),e.prepend(t),$(".specModal2List").find(".prod_specText").eq(0).focus(),$(".specModal2List").find(".prod_specText").on("input",function(){var e=$(this).val();$(this).val(e.replace(/ /g,""))})}),$(".specModal2List").off("blur",".prod_specText").on("blur",".prod_specText",function(e){var t=$(this);if(null==t.data("pid")&&""!=t.val()){var o=t.val(),a={name:o};prodmodallist(i.productName,"specModalList",a,t.data("oldvalue")),t.data("oldvalue",o)}})},m=function(e){var t="";return null!=e&&void 0!=e&&""!=e&&$.each(e,function(o,a){if(void 0===e[o].id){var r=' <form class="col-md-3 specdiv" style="padding-bottom: 10pt;">                                                                                                                         \t       <div class="col-md-12">                                                                                                                      \t\t\t  <div class="m-t-10 relative proTypeLabel" style=" width: 190pt;background: #f8f9f9;color: #53687D;">                                                                                                \t\t\t      <div class="text-center selfDefine" ><div class="prod_checkbox"><input type="checkbox" class="prod_specCheck prod_checkbox_left"><span class="prod_checkbox_left_img" data-checked="" data-pid=""  data-type="spec"></span></div><input style="80%" class="prod_specText" data-oldValue="'+a.name+'" data-pid="" data-orderFlag="" placeholder="规格描述" value="'+a.name+'"></div>\t\t\t  </div>                                                                                                                                    \t       </div>                                                                                                                                       \t   </form>';t+=r}else{var i=void 0==a.descr?a.spec:a.descr,r=' <form class="col-md-3 specdiv" style="padding-bottom: 10pt;">                                                                                                                         \t       <div class="col-md-12">                                                                                                                      \t\t\t  <div class="m-t-10 relative proTypeLabel" style=" width: 190pt;background: #f8f9f9;color: #53687D;">                                                                                                \t\t\t      <div class="text-center selfDefine" ><div class="prod_checkbox"><input type="checkbox" class="prod_specCheck prod_checkbox_left"><span class="prod_checkbox_left_img" data-checked="'+a.likeFlag+'" data-pid="'+a.id+'"  data-type="spec"></span></div><input style="80%" class="prod_specText" data-oldValue="'+i+'" data-pid="'+a.id+'" data-orderFlag="'+a.orderFlag+'" placeholder="规格描述" value="'+i+'"></div>                                                         \t\t\t  </div>                                                                                                                                    \t       </div>                                                                                                                                       \t   </form>';t+=r}}),t},f=function(t,o,a){$("#specModal2").keydown(function(e){return 13!=e.keyCode}),$("#specModal2").find(".specModal2List").html("");var r=$("#"+e).jqxGrid("getselectedrowindex"),i=$("#"+e).jqxGrid("getrowdata",r);i.id;if(void 0!=t.id)Core.AjaxRequest({type:"GET",showWaiting:!1,url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/productid/"+t.id+"/"+o+"/"+a),callback:function(e){var o=e.prodSpecList;null!=modallist[e.name]&&void 0!=modallist[e.name].specModalList&&(o=o.concat(modallist[e.name].specModalList));var a=m(o);$("#specModal2").find(".specModal2List").append(a);var r=$("#specModal2").find(".prod_specText");$.each(r,function(e,t){var o=r.eq(e).attr("data-pid");void 0!=o&&""!=o&&null!=o&&($("#specModal2").find(".close-lab").eq(e).removeClass("md-cancel"),$("#specModal2").find(".prod_specText").eq(e).attr("disabled",!0)),$(this).val()==i.spec&&$(this).parent().find(".prod_specCheck").attr("checked",!0)}),$("#specModal2").find(".specModal2List").find(".prod_specNum").moneyinput({textalign:"center",noEndZero:!0}),g(c,0,0,t),$("#specModal2").modal("show")},failure:function(e){}});else{var n=[];Core.AjaxRequest({type:"GET",showWaiting:!1,async:!1,url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/searchOwnerSpec/"+o+"/"+a),callback:function(e){for(var t=[],o=0;o<e.length;o++)t[o]={},t[o].id=e[o].id,t[o].descr=e[o].typeValue;n=n.concat(t)}});var d="";if(void 0!=modallist[i.productName])for(var l in modallist[i.productName])"specModalList"!=l?d=m(n):(n=n.concat(modallist[i.productName].specModalList),d=m(n));else d=m(n);$("#specModal2").find(".specModal2List").append(d);var s=$("#specModal2").find(".prod_specText");$.each(s,function(e,t){var o=s.eq(e).attr("data-pid");void 0!=o&&""!=o&&null!=o&&($("#specModal2").find(".close-lab").eq(e).removeClass("md-cancel"),$("#specModal2").find(".prod_specText").eq(e).attr("disabled",!0)),$(this).val()==i.spec&&$(this).parent().find(".prod_specCheck").attr("checked",!0)}),$("#specModal2").find(".specModal2List").find(".prod_specNum").moneyinput({textalign:"center",noEndZero:!0}),g(c,0,0,t),$("#specModal2").modal("show")}};0==$("#specModal2").length?$.loadModal("page/common/segment/specModel2.html",function(e){var t=$(e);if($("body").append(t),"true"==_global_settings.acOwner.productCoLorFlag){t.append("<style>                       #specModal2 .prod_specText {              width: 84%;               height: 33px;             text-align: center;        border: none;             outline: none;        }                                                   #specModal2 .prod_specNum {               display: none;        }                                                   #specModal2 .prod_specNum_span {          display: none;        }                     </style>                  ")}$(".specModal2List").on("click",".close-lab",function(e){var t=$(this).parents(".specdiv"),o=($(".specModal2List").children().length,t.find(".prod_specText").data("pid"));return null==o||""==o?(t.remove(),!1):(Core.confirm({message:"确定要删除？",confirmCallback:function(){Core.AjaxRequest({url:ctx+"/CXF/rs/product/del/prodspec/"+o,type:"POST",callback:function(e){t.find(".prod_specText").data("pid",""),t.find(".prod_specText").val(""),t.remove()},failure:function(e){}})}}),!1)}),f(p,d,l)}):f(p,d,l)},yardsModal=function(e){var t=$("#"+e).jqxGrid("getselectedrowindex"),o=$("#"+e).jqxGrid("getrowdata",t),a=null==o.yards||""==o.yards?[]:o.yards.split(","),r=function(e){for(var t=[],o=0;o<e.length;o++)t[o]={},t[o].label=e[o],t[o].value=o.toString();return t},i={localdata:r(a),datatype:"array"},n=new $.jqx.dataAdapter(i),d=function(){for(var e=$("#yardsModal_box"),t=0;t<i.localdata.length;t++)e.jqxComboBox("selectIndex",t)},l=function(e){e=0!=e;var t=$("#yardsModal_box"),o=t.jqxComboBox("getSelectedItems"),a=money(t.find("input").val(),4,!0),i=[];return $.each(o,function(e){i.push(this.label)}),0!=a&&i.push(a.toString()),e?r(i):i},s=function(){$("#yardsModal_saveBtn").off("click").on("click",function(){var t=l(!1),o=0;if($.each(t,function(e,t){o+=parseFloat(t)}),t.length>20)return Core.alert({message:"细码个数不能超过20个哦"}),!1;if(Math.max.apply(null,t)>9999999)return Core.alert({message:"单个细码数值不能超过1000万，请删除后重试"}),!1;var a=$("#"+e),r=$("#"+e).jqxGrid("getselectedrowindex");a.jqxGrid("setcellvalue",r,"yards",t.join(","));var i=a.jqxGrid("getcolumnproperty","qty","editable");a.jqxGrid("setcolumnproperty","qty","editable",!0),a.jqxGrid("begincelledit",r,"qty",o),a.jqxGrid("endcelledit",r,"qty",!1),a.jqxGrid("setcolumnproperty","qty","editable",i),$("#yardsModal").modal("hide")}),$("#yardsModal_box").off("keyup").on("keyup",function(e){if(13==e.keyCode){var t=$(this).find("input").val();if(""==t)return void $("#yardsModal_saveBtn").triggerHandler("click");if(l(!1).length>20)return Core.alert({message:"细码个数不能超过20个哦"}),!1;if(t>9999999)return Core.alert({message:"单个细码数值不能超过1000万"}),!1;i.localdata=l(),n.dataBind(),d()}})},c=function(){s(),$("#yardsModal_box").jqxComboBox({source:n}),d(),$("#yardsModal").modal("show"),$("#yardsModal_box").find("input").focus()};0==$("#yardsModal").length?$.loadModal("page/common/segment/yardsModal.html",function(e){var t=$(e);$("body").append(t),$("#yardsModal_box").jqxComboBox({showArrow:!1,multiSelect:!0,width:"100%",popupZIndex:-1,searchMode:"none",displayMember:"label",valueMember:"value",height:30}),c()}):c()},deleteBy=function(e,t,o){"string"==typeof t&&(t=[t]);for(var a=[],r=0;r<e.length;r++){for(var i=!0,n=0;n<t.length;n++)if(e[r][o]==t[n]){i=!1;break}i&&a.push(e[r])}return a},setToggerColumns=function(e,t,o){for(var a=!1,r=0;r<t.length;r++){for(var i in e)!0!==e[i]&&!1!==e[i]||t[r].datafield==i&&("totalCartons"===i&&(a=!0),t[r].hidden=e[i]);"qty"===t[r].datafield&&a&&(t[r].editable=!0)}return t};!function($){function BrowserType(){var e=navigator.userAgent,t=e.indexOf("Opera")>-1,o=window.ActiveXObject||"ActiveXObject"in window,a=e.indexOf("Edge")>-1,r=e.indexOf("Firefox")>-1,i=e.indexOf("Safari")>-1&&-1==e.indexOf("Chrome"),n=e.indexOf("Chrome")>-1&&e.indexOf("Safari")>-1&&!a;if(o){new RegExp("MSIE (\\d+\\.\\d+);").test(e);var d=parseFloat(RegExp.$1);return-1!=e.indexOf("MSIE 6.0")?"IE6":7==d?"IE7":8==d?"IE8":9==d?"IE9":10==d?"IE10":e.toLowerCase().match(/rv:([\d.]+)\) like gecko/)?"IE11":"0"}return r?"FF":t?"Opera":i?"Safari":n?"Chrome":a?"Edge":void 0}var close=!0,html=$("<div style='position: fixed;display:none;z-index: 9999990;' id='floatImg'><img style='width:100%;height:100%'/><div class='md-rotate-right' id='floatImg_rotate' title='点击旋转' style='cursor: pointer;font-size:25px;float: right;'></div>");$("body").append(html);var oImg=document.getElementById("floatImg");!function(){addEvent(oImg,"mousedown",function(e){var t=prEvent(e),o=oImg.parentNode,a=t.clientX-oImg.offsetLeft,r=t.clientY-oImg.offsetTop,i=function(e){o.setCapture&&o.setCapture();var t=e||window.event,i=t.clientX-a,n=t.clientY-r;oImg.style.left=i+"px",oImg.style.top=n+"px",o.onselectstart=function(){return!1}},n=function(e){o.releaseCapture&&o.releaseCapture(),o.onselectstart=null,removeEvent(o,"mousemove",i),removeEvent(o,"mouseup",n)};return addEvent(o,"mousemove",i),addEvent(o,"mouseup",n),!1})}(),function(){addWheelEvent(oImg,function(delta){var ratioL=(this.clientX-oImg.offsetLeft)/oImg.offsetWidth,ratioT=(this.clientY-oImg.offsetTop)/oImg.offsetHeight,ratioDelta=delta?.9:1.1,w=parseInt(oImg.offsetWidth*ratioDelta),h=parseInt(oImg.offsetHeight*ratioDelta),l=Math.round(this.clientX-w*ratioL),t=Math.round(this.clientY-h*ratioT);with(oImg.style)width=w+"px",height=h+"px",left=l+"px",top=t+"px"})}(),$("#floatImg_rotate").on("click",function(){var e=$("#floatImg").data("rotate");e+=90,$("#floatImg").data("rotate",e).css("transform","rotate("+e+"deg)")});var clickType="dblclick";"Chrome"!=function BrowserType(){var e=navigator.userAgent,t=e.indexOf("Opera")>-1,o=window.ActiveXObject||"ActiveXObject"in window,a=e.indexOf("Edge")>-1,r=e.indexOf("Firefox")>-1,i=e.indexOf("Safari")>-1&&-1==e.indexOf("Chrome"),n=e.indexOf("Chrome")>-1&&e.indexOf("Safari")>-1&&!a;if(o){new RegExp("MSIE (\\d+\\.\\d+);").test(e);var d=parseFloat(RegExp.$1);return-1!=e.indexOf("MSIE 6.0")?"IE6":7==d?"IE7":8==d?"IE8":9==d?"IE9":10==d?"IE10":e.toLowerCase().match(/rv:([\d.]+)\) like gecko/)?"IE11":"0"}return r?"FF":t?"Opera":i?"Safari":n?"Chrome":a?"Edge":void 0}()&&(clickType="dblclick",$(document).on("click","img",function(){var e=$(this),t=null==e.attr("src")?"":e.attr("src");t.indexOf("rs/common/file/original/")>-1&&null==t||""==t||-1==t.indexOf("rs/common/file/thumbnail/")||Core.alert({message:"双击即可查看大图哦"})})),$(document).on("dblclick","img",function(e){if($("#floatImg").is(":visible"))return void $("#floatImg").hide();$("#floatImg").data("rotate",0).css("transform","rotate(0deg)");var t=$(this),o=null==t.attr("src")?"":t.attr("src");null!=o&&""!=o&&-1!=o.indexOf("rs/SimpleAC/down")&&(o=o.replace("/thumbnail/","/original/"),$("#floatImg").find("img").attr("src",o),isImgLoad(function(){var e=$("#floatImg>img")[0].naturalWidth,t=$("#floatImg>img")[0].naturalHeight,o=function(e,t){var o=$(window).width(),a=$(window).height(),r=.618*o,i=function(o){var a=Math.max.call(this,o,e,t);return a>o?o/a:1},n=e*i(r),d=t*i(r);if(d>a){var r=.95*a;n=e*i(r),d=t*i(r)}return[n,d,e,t]}(e,t);e=o[0],t=o[1];var a=$(window).width(),r=$(window).height();$("#floatImg").css({top:(r-t)/2,left:(a-e)/2,width:e,height:t+60}).center().show()},"#floatImg>img"))}),$("body").on("click",".yulan",function(){var e="http://"+window.location.host+$(this).attr("src"),t=window.open(),o=t.document.createElement("img");o.src=e,t.document.getElementsByTagName("body")[0].appendChild(o)})}($);var getMsgForNullSpecId=function(e,t,o,a,r){if(0==_global_settings.owner.easyGridSetting.spec)return void t(o,a,r);var i=ComboBoxSources.getInfoMapOrderByKey(e,"prodSpecId")["未分类"];null!=i&&0!=i.length||(i=[]);for(var n=[],d=0;d<i.length;d++)void 0==i[d].spec&&n.push(i[d].sequence);n=n.toString(),n.length>0?timeOut(function(){Core.confirm({message:"第"+n+"行没有选择规格型号，确认保存此销售单吗？？",confirmCallback:function(){t(o,a,r)}})}):timeOut(function(){t(o,a,r)})};