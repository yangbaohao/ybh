var EquipmentBssMgt=function(){var e=this;this.debug=!1;var t=_global_settings.service.url+"/ac/journal";this.initInput=function(){e.initSearch(),e.initGrid(e.searchObj),e.initEvent(),$("#eqmgt_sale_rq").datetimeinput({width:140,height:33,value:new Date}),$("#eqmgt_break_rq").datetimeinput({width:140,height:33,value:new Date})},this.initEvent=function(){$("#eqmgt_sale_sr").on("keyup blur",function(){var e=parseFloat(money($(this).val())),t=parseFloat(money($("#eqmgt_sale_ye").text()));$("#eqmgt_sale_jsy").text(money(e-t))}),$("#eqmgt_sale_saveBtn").on("click",function(){if(!$("#eqmgt_sale_modal").jqxValidator("validate"))return!1;var e=$("#EquiGrid").jqxGrid("getselectedrowindex"),t=$("#EquiGrid").jqxGrid("getrowdata",e),a="";if(a=null!=t.depreciateStartMonth?t.depreciateStartMonth.substring(0,10):t.depreciatePauseMonth.substring(0,10),$("#eqmgt_sale_rq").val()<a)return Core.alert({message:"出售日期不能早于已经计提过折旧的日期"}),!1;var r={id:$("#eqmgt_sale_id").text(),depreciateEndMonth:$("#eqmgt_sale_rq").val(),income:$("#eqmgt_sale_sr").val()};Core.AjaxRequest({url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/asset/sell/"+currentUserInfo.id+"/"+currentUserInfo.loginId),type:"PUT",async:!1,params:r,showMsg:!1,callback:function(e){setCloseAlertTimeOneSecond(),$("#EquiGrid").jqxGrid("updatebounddata","cells")}})}),$("#eqmgt_break_saveBtn").on("click",function(){if(!$("#eqmgt_break_modal").jqxValidator("validate"))return!1;var e=$("#EquiGrid").jqxGrid("getselectedrowindex"),t=$("#EquiGrid").jqxGrid("getrowdata",e),a="";if(a=null!=t.depreciateStartMonth?t.depreciateStartMonth.substring(0,10):t.depreciatePauseMonth.substring(0,10),$("#eqmgt_break_rq").val()<a)return Core.alert({message:"报废日期不能早于已经计提过折旧的日期"}),!1;var r={id:$("#eqmgt_break_id").text(),depreciateEndMonth:$("#eqmgt_break_rq").val()};Core.AjaxRequest({url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/asset/scrap/"+currentUserInfo.id+"/"+currentUserInfo.loginId),type:"PUT",async:!1,params:r,showMsg:!1,callback:function(e){setCloseAlertTimeOneSecond(),t.startDepreciate,$("#EquiGrid").jqxGrid("updatebounddata","cells")}})}),$("#eqmgt_sale_modal").jqxValidator({animationDuration:1,hintType:"label",rules:[{input:"#eqmgt_sale_rq",message:"请选择",action:"keyup, blur",rule:function(e,t){return""!=e.val()}},{input:"#eqmgt_sale_sr",message:"只能为大于0的数字",action:"keyup, blur",rule:function(e,t){return parseFloat(e.val())==e.val()&&e.val()>0}}]}),$("#eqmgt_break_modal").jqxValidator({animationDuration:1,hintType:"label",rules:[{input:"#eqmgt_break_rq",message:"请选择",action:"keyup, blur",rule:function(e,t){return""!=e.val()}}]})},this.initGrid=function(){e.settings.source.data=e.searchObj;var t=Core.AcDataAdapter(e.settings.grid.element,e.settings.source,{beforeLoadComplete:function(e){},loadComplete:function(e){}},e.debug),a={source:t,rendergridrows:function(){return t.recordids},columns:[{text:"资产编码",dataField:"assetRef",width:"10%"},{text:"资产名称",dataField:"name",width:"15%",cellsrenderer:function(e,t,a,r,i,n){var s='<div class="grida likea" title="查看资产详情">';return s+='<a class="color-1193C5 hoverspan viewequipmentDetail viewabtn" data-btn="fms:asset:view">'+a+"</a>",s+="</div>"}},{text:"数量",dataField:"qty",width:"10%"},{text:"单价",dataField:"price",cellsalign:"right",cellsformat:"c2",width:"10%"},{text:"资产原值",dataField:"iniValue",cellsalign:"right",cellsformat:"c2",width:"10%"},{text:"月折旧/摊销额",dataField:"monthlyDepreciateValue",cellsformat:"c2",cellsalign:"right",width:"10%"},{text:"累计折旧额",dataField:"totalDepreciatedValue",cellsformat:"c2",cellsalign:"right",width:"10%"},{text:"净残值",cellsalign:"right",width:"10%",sortable:!1,cellsrenderer:function(e,t,a,r,i,n){var s=money(n.iniValue*n.scrapValueRatio/100),l='<div style="text-align: right;padding-top: 6px;padding-right:4px;">';return l+="￥"+s+"</div>"}},{text:"状态",dataField:"startDepreciate",width:"7%",cellsrenderer:codeRender},{text:"操作",align:"center",width:"8%",sortable:!1,cellsrenderer:function(e,t,a,r,i,n){var s='<div style="text-align: center;padding-top: 2px;">';return s+='<a class="color-1193C5 hoverspan md-rate-review editEquipment editbtn" data-btn="fms:asset:update"  title="编辑"></a>',s+='<a class="md-local-offer eqmgt_sale editbtn" data-toggle="modal" data-target="#eqmgt_sale_modal" data-btn="fms:asset:update" title="出售" ></a>',s+='<a class="md-delete eqmgt_break editbtn" data-toggle="modal" data-target="#eqmgt_break_modal" data-btn="fms:asset:update" title="报废" ></a>',s+="</div>"}}],pagesize:10,pageSizeOptions:["10","20","30"],columnsheight:45};$("#"+e.settings.grid.element).grid(a),$("#EquiGrid").on("click",".editEquipment",function(e){var t=$("#EquiGrid").jqxGrid("getselectedrowindex");if(t>=0){var a=$("#EquiGrid").jqxGrid("getrowdata",t);if("stopDepreciate"==a.startDepreciate||"scrap"==a.startDepreciate||"sell"==a.startDepreciate)return Core.alert({message:"当前状态不可编辑！"}),!1;$.addTab({title:"编辑资产",isFrame:!1,url:ctx+"/page/modules/equipment/editequipment.html",pk:{data:a},reload:!0})}}),$("#EquiGrid").on("click",".eqmgt_sale",function(e){var t=$("#EquiGrid").jqxGrid("getselectedrowindex");if(t>=0){var a=$("#EquiGrid").jqxGrid("getrowdata",t);if("scrap"==a.startDepreciate||"sell"==a.startDepreciate)return Core.alert({message:"当前状态不可出售！"}),!1;$("#eqmgt_sale_rq").val(new Date),$("#eqmgt_sale_sr").val(""),$("#eqmgt_sale_ye").text(""),$("#eqmgt_sale_jsy").text(""),$("#eqmgt_sale_id").text(""),$("#eqmgt_sale_ye").text(money(a.iniValue-a.totalDepreciatedValue)),$("#eqmgt_sale_id").text(a.id)}}),$("#EquiGrid").on("click",".eqmgt_break",function(e){var t=$("#EquiGrid").jqxGrid("getselectedrowindex");if(t>=0){var a=$("#EquiGrid").jqxGrid("getrowdata",t);if("stopDepreciate"==a.startDepreciate||"scrap"==a.startDepreciate||"sell"==a.startDepreciate)return Core.alert({message:"当前状态不可报废！"}),!1;$("#eqmgt_break_rq").val(new Date),$("#eqmgt_break_id").text(""),$("#eqmgt_break_id").text(a.id)}})};var a={condition:[],filterscount:0,groupscount:0,sortorder:"desc",pagenum:0,pagesize:20};(new Base64).encode(JSON.stringify(a)),(new Base64).encode("tosys/coaReport/asset/search/"+currentUserInfo.id+"/"+currentUserInfo.loginId);this.settings={source:{datafields:[{name:"id",type:"number"},{name:"ownerId",type:"number"},{name:"coaDepreciate",type:"ChartOfAccount"},{name:"coaExpense",type:"ChartOfAccount"},{name:"name",type:"string"},{name:"assetRef",type:"string"},{name:"purchaseDate",map:"purchaseDate"},{name:"iniValue",type:"float"},{name:"totalDepreciatedValue",type:"float"},{name:"scrapValueRatio",type:"float"},{name:"startDepreciate",type:"string"},{name:"depreciateMonth",type:"number"},{name:"depreciateStartMonth",map:"depreciateStartMonth"},{name:"depreciateEndMonth",map:"depreciateEndMonth"},{name:"monthlyDepreciateValue",type:"float"},{name:"createDate",type:"date"},{name:"createBy",type:"string"},{name:"lastUpdateDate",type:"date"},{name:"lastUpdateBy",type:"string"},{name:"price",type:"string"},{name:"qty",type:"string"},{name:"depreciatePauseMonth",type:"string"}],url:t,data:e.searchObj},grid:{element:"EquiGrid"},ajax:{url:t}},this.searchDataInfo=function(t){var a=void 0===t?e.settings.grid.element:t;$("#"+a).jqxGrid("applyfilters"),$("#"+a).jqxGrid("refreshfilterrow"),$("#"+a).jqxGrid("clearselection")},this.searchObj={},this.initSearch=function(){e.searchObj={name:{value:[],action:"like"}}},this.refreshDataInfo=function(t){var a=void 0===t?e.settings.grid.element:t;$("#"+a).jqxGrid("updatebounddata","cells"),$("#"+a).jqxGrid("clearselection"),$("#"+a).jqxGrid("refreshdata")}},EquipmentBssBindModle=function(e){var t=this;this.search=function(){var t=$("#equipment-name").val();e.searchObj.name.value=[],""!=t&&e.searchObj.name.value.push(t),e.searchDataInfo()},$("#EquiGrid").on("click",".viewequipmentDetail",function(e){e.preventDefault();var t=$("#EquiGrid").jqxGrid("getselectedrowindex");if(t>=0){var a=$("#EquiGrid").jqxGrid("getrowdata",t);$.addTab({title:a.name,isFrame:!1,url:ctx+"/page/modules/equipment/equipmentDetail.html",pk:{data:a,random:Math.random()},reload:!0})}}),this.bind=function(){$("#addequipment-btn").on("click",function(){$.addTab({title:"新增固定资产",isFrame:!1,url:ctx+"/page/modules/equipment/addequipment.html",reload:!0})}),$("#equipment-search").on({click:t.search})},this.unbindAll=function(){$("#equipment-search").off("click"),$("#addequipment-btn").off("click")}};