var EquipmentAddBssMgt=function(){var e=this,a=_global_settings.service.url+"/ac/";this.coaExpenseCombo=[],this.checked=null,this.settings={source:{datafields:[{name:"ownerId",type:"number"},{name:"coaDepreciate",type:"ChartOfAccount"},{name:"coaExpense",type:"ChartOfAccount"},{name:"name",type:"string"},{name:"assetRef",type:"string"},{name:"purchaseDate",type:"date"},{name:"iniValue",type:"float"},{name:"totalDepreciatedValue",type:"float"},{name:"scrapValueRatio",type:"float"},{name:"startDepreciate",type:"string"},{name:"depreciateMonth",type:"number"},{name:"depreciateStartMonth",type:"date"},{name:"depreciateEndMonth",type:"date"},{name:"monthlyDepreciateValue",type:"float"},{name:"createDate",type:"date"},{name:"createBy",type:"string"},{name:"lastUpdateDate",type:"date"},{name:"lastUpdateBy",type:"string"}],url:a+"/search"},grid:{element:"EquiGrid"},ajax:{url:a}},this.refreshDataInfo=function(a){var t=void 0===a?e.settings.grid.element:a;$("#"+t).jqxGrid("updatebounddata","cells"),$("#"+t).jqxGrid("clearselection"),$("#"+t).jqxGrid("refreshdata")},this.initInput=function(){$.addTabCloseEvent(),$("#add-coaDepreciate").coaCombbox({width:"100%",height:34,theme:currentTheme,displayMember:"name",valueMember:"id",placeHolder:"请选择或输入",searchMode:"contains"},["1602","1702"]),$("#add-coaExpense").coaCombbox({width:"100%",height:34,theme:currentTheme,displayMember:"name",valueMember:"id",placeHolder:"请选择或输入",searchMode:"contains"},["510101","660120","660225"]),$("#add-purchaseDate").datetimeinput({placeHolder:"除暂停折旧，不可编辑",formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#add-startTime").datetimeinput({placeHolder:"除暂停折旧，不可编辑",formatString:"yyyy-MM",width:"100%",height:"34px"});var a=function(){var a=$("#add-ininum").val(),t=$("#add-iniprice").val(),n=$("#add-scrapValueRatio").val(),d=$("#add-expectTime").val(),i=$("#add-startTime").val(),r=new Date,l=r.getFullYear(),u=r.getMonth()+1;if(u=u.toString().length>1?u:"0"+u,a==parseInt(a)&&!isNaN(t)){var s=money(a*t);$("#add-iniValue").val(s)}if(a!=parseInt(a)||isNaN(t)||isNaN(n)||$("#add-sumExpectVal").val(money($("#add-iniValue").val()*n/100)),d==parseInt(d)&&""!=i&&d>=0&&e.setEndTime(d),a==parseInt(a)&&d==parseInt(d)&&!isNaN(t)&&!isNaN(n)&&0!=d){$("#add-assetMonth").val(money((parseFloat($("#add-iniValue").val())-parseFloat($("#add-sumExpectVal").val()))/d));var o=0;if(""!=i){if(i<l+"-"+u){var c=i.substring(0,4),p=i.substring(5,7);l>c?(o+=12*(parseInt(l)-parseInt(c)),o+=parseInt(u)-parseInt(p)):u>p?o+=parseInt(u)-parseInt(p):o=0}o<d?$("#add-totalDepreciatedValue").val(money(o*$("#add-assetMonth").val())):$("#add-totalDepreciatedValue").val(money(d*$("#add-assetMonth").val())),$("#add-assetBal").val(money(parseFloat($("#add-iniValue").val())-parseFloat($("#add-totalDepreciatedValue").val())))}}};$("#add-equipment").on("keyup",".addequipment",function(){a()}),$("#add-startTime").on("valueChanged",function(e){a()}),$("#add-iniValue").bind("blur",function(){var e=$("#add-iniValue").val();""==e||/^(\-?\d*)(\.\d+)?$/g.exec(e)&&(e=money(e),$("#add-iniValue").val(e))}),$("#add-startTime").jqxDateTimeInput("val",""),e.initValidator()},this.judgeAndGetMonth=function(){var e,a=new Date,t=parseInt(a.getFullYear()),n=parseInt(a.getMonth());n+=1;var d=(a.getDate(),$("#add-startTime").val()),i=$("#add-purchaseDate").val();if(""==i)e=0;else if(""==d)e=0;else{var r=parseInt(d.substring(0,4)),l=parseInt(d.substring(5)),u=parseInt(i.substring(0,4)),s=parseInt(i.substring(5,7));parseInt(i.substring(8,10));e=u>t?0:u==t&&s>=n?0:r<u?0:r==t?l<n?n-l:0:r>t?0:l==n?12*(t-r):l<n?12*(t-r)+(n-l):12*(t-r)-(l-n)}return e},this.setEndTime=function(e){var a,t,n,d,i=$("#add-startTime").jqxDateTimeInput("val"),r=i.split("-");a=parseInt(e),t=parseInt(r[1]),n=parseInt(r[0]),d=Math.floor(a/12),0==d?1==t?(a=a,d=n):a+t<=12?(a=t+a-1,d=n):(a+t)%13==0?(d=n,a=12):(d=n+1,a=(a+t)%13):1==t?12==a?(d=n,a=a):(d=Math.floor(a/12)+n,0==(a=a%12+t-1)&&(a=12,d-=1)):12==a?(d=n+1,a=t-1):(d=Math.floor(a/12)+n,(a=a%12+t-1)>12&&(a%=12,d+=1)),a<10&&(a="0"+a),$("#add-endTime").val(d+"-"+a)},this.initValidator=function(){$("#add-equipment").jqxValidator({hintType:"label",animationDuration:1,rules:[{input:"#add-assetRef",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#add-assetRef",message:"必须是数字或字母",action:"keyup, blur",rule:function(e,a){return!/[\u4E00-\u9FA5]/g.test(e.val())}},{input:"#add-assetName",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#add-iniValue",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#add-iniValue",message:"必须是数字",action:"keyup, blur",rule:function(e,a){return!!/^(\-?\d*)(\.\d+)?$/g.exec(e.val())}},{input:"#add-iniprice",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#add-iniprice",message:"必须是数字",action:"keyup, blur",rule:function(e,a){return!!/^(\-?\d*)(\.\d+)?$/g.exec(e.val())}},{input:"#add-ininum",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#add-ininum",message:"必须是整数",action:"keyup, blur",rule:function(e,a){return parseInt(e.val()).toFixed(0)===e.val()&&!(isNaN(e.val())||e.val()<0||""==e.val())}},{input:"#add-iniValue",message:"不能小于0",action:"keyup, blur",rule:function(e,a){return!(e.val()<0)}},{input:"#add-totalDepreciatedValue",message:"必须是数字",action:"keyup, blur",rule:function(e,a){return!!/^(\-?\d*)(\.\d+)?$/g.exec(e.val())}},{input:"#add-totalDepreciatedValue",message:"不能大于原值",action:"keyup, blur",rule:function(e,a){return!(e.val()>parseInt($("#add-iniValue").val()))}},{input:"#add-scrapValueRatio",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#add-scrapValueRatio",message:"必须是数字",action:"keyup, blur",rule:function(e,a){return!!/^(\-?\d*)(\.\d+)?$/g.exec(e.val())}},{input:"#add-scrapValueRatio",message:"不能大于100",action:"keyup, blur",rule:function(e,a){return!(e.val()>100)}},{input:"#add-scrapValueRatio",message:"不能小于0",action:"keyup, blur",rule:function(e,a){return!(e.val()<0)}},{input:"#add-coaDepreciate",message:"输入不合法，请重新输入",action:"keyup, blur",rule:function(e,a){return""!=e.val()&&null!=e.jqxComboBox("getSelectedItem")}},{input:"#add-coaExpense",message:"输入不合法，请重新输入",action:"keyup, blur",rule:function(e,a){return""!=e.val()&&null!=e.jqxComboBox("getSelectedItem")}},{input:"#add-purchaseDate",message:"请选择",action:"keyup, blur",rule:function(e,a){return""!==e.val()}},{input:"#add-purchaseDate",message:"购买日期不能大于当前日期",action:"blur",rule:function(e,a){var t=new Date,n=t.getFullYear(),d=t.getMonth(),i=t.getDate();return d+=1,!(parseInt(e.val().substring(0,4))>n)&&(parseInt(e.val().substring(0,4))!=n||!(parseInt(e.val().substring(5,7))>d)&&(parseInt(e.val().substring(5,7))!=d||!(parseInt(e.val().substring(8))>i)))}},{input:"#add-startTime",message:"请选择",action:"blur",rule:function(e,a){return""!==e.val()}},{input:"#add-startTime",message:"折旧开始日期不能小于购买日期",action:"change,blur",rule:function(e,a){return""==$("#add-purchaseDate").val()||!(e.val()<$("#add-purchaseDate").val().toString().substring(0,7))}},{input:"#add-expectTime",message:"不能为空",action:"keyup ,blur",rule:function(e,a){return""!==e.val()}},{input:"#add-expectTime",message:"必须是数字,且大于0",action:"keyup, blur",rule:function(e,a){return 0!=e.val()&&(!!/^(\-?\d*)(\.\d+)?$/g.exec(e.val())||($("#add-assetMonth").val(""),$("#add-endTime").val(""),!1))}},{input:"#add-expectTime",message:"必须是整数",action:"keyup, blur",rule:function(e,a){return!!/^\d*$/.exec(e.val())}}]})}},EquipmentAddBssBindModle=function(e){var a=this;this.addEquipment=function(a){return $("#add-equipment").jqxValidator("validate")&&Core.AjaxRequest({url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/asset/create/"+currentUserInfo.id+"/"+currentUserInfo.loginId),type:"POST",async:!1,params:a,showMsg:!1,callback:function(a){if(0==a)try{setCloseAlertTimeOneSecond(),e.refreshDataInfo();$.closeTab(void 0)}catch(e){}else 1==a&&Core.alert({message:"固定资产编码重复不能保存!"})},failure:function(e){Core.alert({message:"固定资产异常,不能保存！"})}}),!1},this.initAddEquParam=function(){var e,a,t,n,d,i,r=$("#add-assetRef").val(),l=$("#add-purchaseDate").val(),u=$("#add-assetName").val(),s=$("#add-iniValue").val(),o=$("#add-totalDepreciatedValue").val(),c=($("#add-assetBal").val(),$("#add-scrapValueRatio").val()),p=($("#add-sumExpectVal").val(),$("#add-expectTime").val()),m=$("#add-assetMonth").val(),v=$("#add-startTime").val(),g=$("#add-endTime").val(),f=$("#add-coaDepreciate").val(),h=$("#add-coaExpense").val(),y=new Date,b=y.getHours(),V=y.getMinutes(),x=y.getSeconds();return b<10&&(b="0"+b),V<10&&(V="0"+V),x<10&&(x="0"+x),i=b+":"+V+":"+x,e=0,a=p,d=m,t=v+"-01 "+i,n=g+"-01 "+i,{coaDepreciate:{id:f},coaExpense:{id:h},price:$("#add-iniprice").val(),qty:$("#add-ininum").val(),name:u,assetRef:r,purchaseDate:l+" "+i,iniValue:s,totalDepreciatedValue:o,scrapValueRatio:c,depreciateMonth:a,depreciateStartMonth:t,depreciateEndMonth:n,monthlyDepreciateValue:d,startDepreciate:e}},this.setValue=function(){var e=$("#add-iniValue").val(),a=$("#add-sumExpectVal").val();$("#add-totalDepreciatedValue").val(money(0)),""==e?$("#add-assetBal").val(""):/^(\-?\d*)(\.\d+)?$/g.exec(e)&&e>=0&&/^(\-?\d*)(\.\d+)?$/g.exec(a)&&a>=0&&$("#add-assetBal").val(money(e-a))},this.setTwoValue=function(){var a=$("#add-iniValue").val(),t=$("#add-sumExpectVal").val(),n=$("#add-expectTime").val(),d=e.judgeAndGetMonth();if(""==a)$("#add-totalDepreciatedValue").val(""),$("#add-assetBal").val("");else if(/^(\-?\d*)(\.\d+)?$/g.exec(a)&&a>=0)if(""==t)$("#add-totalDepreciatedValue").val(""),$("#add-assetBal").val("");else if(/^(\-?\d*)(\.\d+)?$/g.exec(t)&&t>=0)if(""==n)$("#add-totalDepreciatedValue").val(""),$("#add-assetBal").val("");else if(/^(\-?\d*)(\.\d+)?$/g.exec(n)&&n>=0)if(0==d)$("#add-totalDepreciatedValue").val(money(0)),$("#add-assetBal").val(money(a-t));else{var i=(a-t)/n*d;i>=a?($("#add-totalDepreciatedValue").val(money(a-t)),$("#add-assetBal").val(money(t))):($("#add-totalDepreciatedValue").val(money(i)),$("#add-assetBal").val(money(a-i)))}},this.bind=function(){$("#add-assetSave").on({click:function(){a.addEquipment(a.initAddEquParam())}}),$("#add-equipInlineRadio1").on("click",function(){$("#add-equipInlineRadio1").attr("checked",!0),$("#add-equipInlineRadio2").attr("checked",!1),$("#dateshow_hide").css({display:"block"}),a.setTwoValue()}),$("#add-equipInlineRadio2").on("click",function(){a.setValue(),$("#add-equipInlineRadio1").attr("checked",!1),$("#add-equipInlineRadio2").attr("checked",!0),$("#dateshow_hide").css({display:"none"})})},this.unbindAll=function(){$("#add-assetSave").off("click"),$("#add-equipInlineRadio1").off("click"),$("#add-equipInlineRadio2").off("click")}};