var EquipmenteditBssMgt=function(){var e=this,t=_global_settings.service.url+"/asset";this.data=null,this.checked=null,this.stop={sum:0,time:null},this.refreshDataInfo=function(t){var i=void 0===t?e.settings.grid.element:t;$("#"+i).jqxGrid("updatebounddata","cells"),$("#"+i).jqxGrid("clearselection"),$("#"+i).jqxGrid("refreshdata")},this.getStockSubject=function(e,t){for(var i=ComboBoxSources.getAdapter(e),a=i.records,u=0;u<a.length;u++)if(a[u].id==t)return a[u].name;if(!t)return ComboBoxSources.load(e),"暂无"},this.initInput=function(){$.addTabCloseEvent(),$("#editequip-totalDepreciatedValue").attr("readonly","true"),e.data=$.pk.data,void 0!==$.pk&&void 0===$.pk.data&&Core.alert({message:"data入参错误",callback:function(){$.closeTab()}}),"pauseDepreciate"==e.data.startDepreciate?(e.stop.sum=e.data.totalDepreciatedValue,e.stop.time=e.data.depreciatePauseMonth,setTimeout(function(){$("#editequip-stop").trigger("click")},200)):($("#editEquipmentPage").find("input").attr("disabled","disabled"),$("#editequip-purchaseDate").jqxDateTimeInput({disabled:!0}),$("#editequip-startTime").jqxDateTimeInput({disabled:!0}),$("#editequip-assetRef").removeAttr("disabled"),$("#editequip-assetName").removeAttr("disabled"),$("#editequip-stop").removeAttr("disabled")),$("#editequip-stop").val(e.data.startDepreciate),$("#editequip-iniprice").val(e.data.price),$("#editequip-ininum").val(e.data.qty),$("#editequip-assetRef").val(e.data.assetRef),$("#editequip-assetName").val(e.data.name),$("#editequip-iniValue").val(money(e.data.iniValue)),$("#editequip-totalDepreciatedValue").val(money(e.data.totalDepreciatedValue)),$("#editequip-assetBal").val(money(e.data.iniValue-e.data.totalDepreciatedValue)),$("#editequip-scrapValueRatio").val(e.data.scrapValueRatio),$("#editequip-sumExpectVal").val(money(e.data.iniValue*(e.data.scrapValueRatio/100))),$("#editequip-scrapValueRatio").val(e.data.scrapValueRatio),$("#editequip-purchaseDate").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#editequip-purchaseDate").jqxDateTimeInput("setDate",new Date(e.data.purchaseDate.substring(0,10))),$("#editequip-dateshow_hide2").css({display:"block"}),$("#editequip-expectTime").val(e.data.depreciateMonth),null!=e.data.depreciateMonth&&$("#editequip-assetMonth").val(e.data.monthlyDepreciateValue),$("#editequip-startTime").datetimeinput({formatString:"yyyy-MM",width:"100%",height:"34px"}),$("#editequip-startTime").val(e.data.depreciateStartMonth),null!=e.data.depreciateEndMonth&&$("#editequip-endTime").val(e.data.depreciateEndMonth.substring(0,7)),$("#editequip-coaDepreciate").coaCombbox({displayMember:"name",valueMember:"id",width:"100%",height:34,searchMode:"contains"},["1602","1702"]),$("#editequip-coaDepreciate").val(e.data.coaDepreciate.id),$("#editequip-coaExpense").coaCombbox({displayMember:"name",valueMember:"id",width:"100%",height:34,searchMode:"contains"},["5101","6601","6602"]),$("#editequip-coaExpense").val(e.data.coaExpense.id);var t=function(){var t=$("#editequip-ininum").val(),i=$("#editequip-iniprice").val(),a=$("#editequip-scrapValueRatio").val(),u=$("#editequip-expectTime").val(),n=$("#editequip-startTime").val(),l=new Date,p=l.getFullYear(),s=l.getMonth()+1;if(s=s.toString().length>1?s:"0"+s,t==parseInt(t)&&!isNaN(i)){var d=money(t*i);$("#editequip-iniValue").val(d)}if(t!=parseInt(t)||isNaN(i)||isNaN(a)||($("#editequip-sumExpectVal").val(money($("#editequip-iniValue").val()*a/100)),$("#editequip-assetBal").val(money(parseFloat($("#editequip-iniValue").val())-parseFloat(money($("#editequip-totalDepreciatedValue").val()))))),u==parseInt(u)&&""!=n&&u>=0&&e.setEndTime(u),t==parseInt(t)&&u==parseInt(u)&&!isNaN(i)&&!isNaN(a)&&0!=u){$("#editequip-assetMonth").val(money((parseFloat($("#editequip-iniValue").val())-parseFloat($("#editequip-sumExpectVal").val())-e.stop.sum)/u));var r=0;if(""!=n){if(n<p+"-"+s){var o=n.substring(0,4),c=n.substring(5,7);p>o?(r+=12*(parseInt(p)-parseInt(o)),r+=parseInt(s)-parseInt(c)):s>c?r+=parseInt(s)-parseInt(c):r=0}r<u?$("#editequip-totalDepreciatedValue").val(money(r*$("#editequip-assetMonth").val())):$("#editequip-totalDepreciatedValue").val(money(u*$("#editequip-assetMonth").val())),$("#editequip-totalDepreciatedValue").val(money(parseFloat($("#editequip-totalDepreciatedValue").val())+e.stop.sum)),$("#editequip-assetBal").val(money(parseFloat($("#editequip-iniValue").val())-parseFloat($("#editequip-totalDepreciatedValue").val())))}}};e.setAllVal=t,$("#editEquipmentPage").on("keyup",".editequipment",function(){t()}),$("#editequip-startTime").on("valueChanged",function(){t()}),$("#editequip-iniValue").bind("blur",function(){var e=$("#editequip-iniValue").val();""==e||/^(\-?\d*)(\.\d+)?$/g.exec(e)&&(e=money(e),$("#editequip-iniValue").val(e))}),this.judgeAndGetMonth=function(){var e,t=new Date,i=parseInt(t.getFullYear()),a=parseInt(t.getMonth());a+=1;var u=(t.getDate(),$("#editequip-startTime").val()),n=$("#editequip-purchaseDate").val();if(""==n)e=0;else if(""==u)e=0;else{var l=parseInt(u.substring(0,4)),p=parseInt(u.substring(5)),s=parseInt(n.substring(0,4)),d=parseInt(n.substring(5,7));parseInt(n.substring(8,10));e=s>i?0:s==i&&d>=a?0:l<s?0:l==i?p<a?a-p:0:l>i?0:p==a?12*(i-l):p<a?12*(i-l)+(a-p):12*(i-l)-(p-a)}return e},this.setEndTime=function(e){var t,i,a,u,n=$("#editequip-startTime").jqxDateTimeInput("val"),l=n.split("-");t=parseInt(e),i=parseInt(l[1]),a=parseInt(l[0]),u=Math.floor(t/12),0==u?1==i?(t=t,u=a):t+i<=12?(t=i+t-1,u=a):(t+i)%13==0?(u=a,t=12):(u=a+1,t=(t+i)%13):1==i?12==t?(u=a,t=t):(u=Math.floor(t/12)+a,0==(t=t%12+i-1)&&(t=12,u-=1)):12==t?(u=a+1,t=i-1):(u=Math.floor(t/12)+a,(t=t%12+i-1)>12&&(t%=12,u+=1)),t<10&&(t="0"+t),$("#editequip-endTime").val(u+"-"+t)},e.initValidator()},this.initValidator=function(){var t=function(){return $("#editequip-stop")[0].checked};$("#editEquipmentPage").jqxValidator({hintType:"label",animationDuration:1,rules:[{input:"#editequip-assetRef",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#editequip-assetRef",message:"必须是数字或字母",action:"keyup, blur",rule:function(e,t){return!/[\u4E00-\u9FA5]/g.test(e.val())}},{input:"#editequip-assetName",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#editequip-iniValue",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#editequip-iniValue",message:"必须是数字",action:"keyup, blur",rule:function(e,t){return!!/^(\-?\d*)(\.\d+)?$/g.exec(e.val())}},{input:"#editequip-iniprice",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#editequip-iniprice",message:"必须是数字",action:"keyup, blur",rule:function(e,t){return!!/^(\-?\d*)(\.\d+)?$/g.exec(e.val())}},{input:"#editequip-ininum",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#editequip-ininum",message:"必须是整数",action:"keyup, blur",rule:function(e,t){return parseInt(e.val()).toFixed(0)===e.val()&&!(isNaN(e.val())||e.val()<0||""==e.val())}},{input:"#editequip-iniValue",message:"不能小于0",action:"keyup, blur",rule:function(e,t){return!(e.val()<0)}},{input:"#editequip-scrapValueRatio",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#editequip-scrapValueRatio",message:"必须是数字",action:"keyup, blur",rule:function(e,t){return!!/^(\-?\d*)(\.\d+)?$/g.exec(e.val())||($("#editequip-sumExpectVal").val(""),!1)}},{input:"#editequip-scrapValueRatio",message:"不能大于100",action:"keyup, blur",rule:function(e,t){return!(e.val()>100)}},{input:"#editequip-scrapValueRatio",message:"不能小于0",action:"keyup, blur",rule:function(e,t){return!(e.val()<0)}},{input:"#editequip-purchaseDate",message:"请选择",action:"keyup, blur",rule:function(e,t){return""!==e.val()}},{input:"#editequip-purchaseDate",message:"购买日期不能大于当前日期!",action:"blur,keyup",rule:function(e,t){var i=new Date,a=i.getFullYear(),u=i.getMonth(),n=i.getDate();return u+=1,!(parseInt(e.val().substring(0,4))>a)&&(parseInt(e.val().substring(0,4))!=a||!(parseInt(e.val().substring(5,7))>u)&&(parseInt(e.val().substring(5,7))!=u||!(parseInt(e.val().substring(8))>n)))}},{input:"#editequip-coaDepreciate",message:"请选择",action:"keyup, blur",rule:function(e,t){return""!=e.val()&&null!=e.jqxComboBox("getSelectedItem")}},{input:"#editequip-coaExpense",message:"输入不合法，请重新输入",action:"keyup, blur",rule:function(e,t){return""!=e.val()&&null!=e.jqxComboBox("getSelectedItem")}},{input:"#editequip-startTime",message:"请选择",action:"blur",rule:function(e,i){return!!t()||""!==e.val()}},{input:"#editequip-startTime",message:"折旧开始日期不能小于购买日期",action:"change,blur",rule:function(e,i){return!!t()||(""==$("#editequip-purchaseDate").val()||!(e.val()<$("#editequip-purchaseDate").val().toString().substring(0,7)))}},{input:"#editequip-startTime",message:"折旧重新开始日期不能小于上次停止折旧日期",action:"change,blur",rule:function(i,a){return!!t()||(null==e.stop.time||!(i.val()<e.stop.time.toString().substring(0,7)))}},{input:"#editequip-expectTime",message:"不能为空",action:"keyup,blur",rule:function(e,i){return!!t()||""!==e.val()}},{input:"#editequip-expectTime",message:"必须是数字，且大于0",action:"keyup,blur",rule:function(e,i){return!!t()||0!=e.val()&&(!!/^(\-?\d*)(\.\d+)?$/g.exec(e.val())||($("#editequip-assetMonth").val(0),$("#editequip-endTime").val(""),!1))}},{input:"#editequip-expectTime",message:"必须是整数",action:"keyup, blur",rule:function(e,i){return!!t()||!!/^\d*$/.exec(e.val())}}]})},this.settings={source:{datafields:[{name:"id",type:"long"},{name:"name",type:"string"},{name:"type",type:"string"},{name:"unit",type:"string"},{name:"createDate",type:"date"}],url:t+"/update"},grid:{element:"EquiGrid"},ajax:{url:t}}},EquipmenteditBssBindModle=function(e){var t=this;this.editEquipment=function(t){return $("#editEquipmentPage").jqxValidator("validate")&&Core.AjaxRequest({url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/asset/update/"+currentUserInfo.id+"/"+currentUserInfo.loginId),type:"PUT",async:!1,params:t,showMsg:!1,callback:function(t){if(0==t)try{setCloseAlertTimeOneSecond(),e.refreshDataInfo(),$.closeTab()}catch(e){}else 1==t&&Core.alert({message:"固定资产编码重复不能保存!"})},failure:function(e){Core.alert({message:"固定资产异常,不能保存！"})}}),!1},this.initEditEquParam=function(){var t,i,a,u,n,l,p,s,d=e.data.id,r=$("#editequip-assetRef").val(),o=$("#editequip-purchaseDate").val(),c=$("#editequip-assetName").val(),q=$("#editequip-iniValue").val(),m=$("#editequip-totalDepreciatedValue").val(),v=($("#editequip-assetBal").val(),$("#editequip-scrapValueRatio").val()),g=($("#editequip-sumExpectVal").val(),$("#editequip-expectTime").val()),h=$("#editequip-assetMonth").val(),f=$("#editequip-startTime").val(),b=$("#editequip-endTime").val(),y=null,V=new Date,D=V.getHours(),x=V.getMinutes(),k=V.getSeconds();D<10&&(D="0"+D),x<10&&(x="0"+x),k<10&&(k="0"+k),s=D+":"+x+":"+k;var I=$("#editequip-coaDepreciate").jqxComboBox("getSelectedIndex"),M=$("#editequip-coaDepreciate").jqxComboBox("getItem",I);t=-1==I?e.data.coaDepreciate.id:M.value;var T=$("#editequip-coaExpense").jqxComboBox("getSelectedIndex"),E=$("#editequip-coaExpense").jqxComboBox("getItem",T);i=-1==T?e.data.coaExpense.id:E.value,a=0,u=g,p=h,n=f+"-01 "+s,l=b+"-01 "+s;var a=void 0;return 1==$("#editequip-stop")[0].checked&&(a="pauseDepreciate",u=null,p=0,n=null,l=null,null!=e.data.depreciatePauseMonth&&(y=e.data.depreciatePauseMonth)),{startDepreciate:a,id:d,coaDepreciate:{id:t},coaExpense:{id:i},price:$("#editequip-iniprice").val(),qty:$("#editequip-ininum").val(),name:c,assetRef:r,purchaseDate:o+" "+s,iniValue:q,totalDepreciatedValue:m,scrapValueRatio:v,depreciateMonth:u,depreciateStartMonth:n,depreciateEndMonth:l,monthlyDepreciateValue:p,depreciatePauseMonth:y,startDepreciate:a}},this.setValue=function(){var e=$("#editequip-iniValue").val(),t=$("#editequip-sumExpectVal").val();$("#editequip-totalDepreciatedValue").val(money(0)),""==e?$("#editequip-assetBal").val(""):/^(\-?\d*)(\.\d+)?$/g.exec(e)&&e>=0&&/^(\-?\d*)(\.\d+)?$/g.exec(t)&&t>=0&&$("#editequip-assetBal").val(money(e-t))},this.setTwoValue=function(){var t=$("#editequip-iniValue").val(),i=$("#editequip-sumExpectVal").val(),a=$("#editequip-expectTime").val(),u=e.judgeAndGetMonth();if(""==t)$("#editequip-totalDepreciatedValue").val(""),$("#editequip-assetBal").val("");else if(/^(\-?\d*)(\.\d+)?$/g.exec(t)&&t>=0)if(""==i)$("#editequip-totalDepreciatedValue").val(""),$("#editequip-assetBal").val("");else if(/^(\-?\d*)(\.\d+)?$/g.exec(i)&&i>=0)if(""==a)$("#editequip-totalDepreciatedValue").val(""),$("#editequip-assetBal").val("");else if(/^(\-?\d*)(\.\d+)?$/g.exec(a)&&a>=0)if(0==u)$("#editequip-totalDepreciatedValue").val(money(0)),$("#editequip-assetBal").val(money(t-i));else{var n=(t-i)/a*u;n>=t?($("#editequip-totalDepreciatedValue").val(money(t-i)),$("#editequip-assetBal").val(money(i))):($("#editequip-totalDepreciatedValue").val(money(n)),$("#editequip-assetBal").val(money(t-n)))}},this.bind=function(){$("#editequip-stop").on("change",function(){e.setAllVal(),1==$(this)[0].checked?("pauseDepreciate"==e.data.startDepreciate&&$("#editequip-totalDepreciatedValue").val(e.stop.sum),$("#editequip-dateshow_hide2").css({display:"none"})):$("#editequip-dateshow_hide2").css({display:"block"})}),$("#editequip-inlineRadio1").on({click:function(){$("#editequip-dateshow_hide2").css({display:"block"}),$("#editequip-inlineRadio1").attr("checked",!0),$("#editequip-inlineRadio2").attr("checked",!1),t.setTwoValue()}}),$("#editequip-inlineRadio2").on({click:function(){t.setValue(),$("#editequip-dateshow_hide2").css({display:"none"}),$("#editequip-inlineRadio1").attr("checked",!1),$("#editequip-inlineRadio2").attr("checked",!0)}}),$("#editequip-button").on({click:function(){t.editEquipment(t.initEditEquParam())}})},this.unbindAll=function(){$("#editequip-inlineRadio1").off("click"),$("#editequip-inlineRadio2").off("click"),$("#editequip-button").off("click")}};