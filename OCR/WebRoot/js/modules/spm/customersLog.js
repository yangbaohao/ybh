var CustomersLogMgt=function(){var e=this,t=_global_settings.service.url+"/customerLog";this.debug=!1,this.userData=null,this.lineData=null,this.initInput=function(){e.initUserPage(),e.initWindows(),e.initSearch(),e.initValidator(),e.initGrid(e.searchObj)},this.initValidator=function(){$("#addChatContentWin").jqxValidator({hintType:"label",animationDuration:1,rules:[{input:"#addChatContentRemark",message:"100字以内",action:"keyup,blur",rule:function(e,t){return!(e.val().length>100)}},{input:"#addChatContentRemark",message:"不能为空",action:"keyup, blur",rule:"required"}]}),$("#remarkLogWin").jqxValidator({hintType:"label",animationDuration:1,rules:[{input:"#customersLogRemark",message:"100字以内",action:"keyup,blur",rule:function(e,t){return!(e.val().length>100)}},{input:"#customersLogRemark",message:"不能为空",action:"keyup, blur",rule:"required"}]})},this.initUserPage=function(){$("#customersLog-show").css("display",""),$("#customersLog-date").jqxDropDownList({source:["请选择","最近一周","最近两周","最近三周","本月","本季度","本年"],theme:"energyblue",width:"100%",height:"34px",selectedIndex:0,dropDownHeight:150}),$("#customersLog-sDate").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#customersLog-eDate").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#customersLog-date").on("change",function(){var e=$("#customersLog-date").attr("id"),t=$("#customersLog-sDate").attr("id"),o=$("#customersLog-eDate").attr("id");setValueById(e,t,o)}),$("#customersLog-show").addClass("hiddendiv");!function(){Core.AjaxRequest({url:_global_settings.service.url+"/user/managesaleinfo/"+_global_settings.owner.employeeCode,type:"GET",showMsg:!1,async:!1,callback:function(e){$("#customersLog-cust").comboBox({source:e,displayMember:"username",valueMember:"id",height:34,width:"100%",placeHolder:"请选择",dropDownHeight:"100px"})}})}()},this.initWindows=function(){$("#remarkLogWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:500,height:"500",minWidth:650,cancelButton:$("#customersLogRemarkCancleBtn"),initContent:function(){$("#customersLogRemark").val("")}}).on("close",function(){setTimeout(function(){$("#customersLogRemark").val("")},500)}),$("#deleteCustomerLogWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:900,minHeight:280,height:"auto",minWidth:500,cancelButton:$("#customerLogCancelBtn"),initContent:function(){}}).on("close",function(){}),$("#addChatContentWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:900,minHeight:450,height:"500",minWidth:650,width:650,cancelButton:$("#addChatContentCancelBtn"),initContent:function(){$("#addChatContentRemark").val("")}}).on("close",function(){$("#addChatContentRemark").val("")})},this.getSalesInfo=function(e){var t=ComboBoxSources.getRecords("salesInfo");for(i=0;i<t.length;i++)if(e==t[i].employeeCode)return t[i];if(!e)return""},this.getCustService=function(e){var t=ComboBoxSources.getRecords("custService");for(i=0;i<t.length;i++)if(e==t[i].employeeCode)return t[i];if(!e)return""},this.initGrid=function(){e.setting.source.data=e.searchObj;var o=Core.AcDataAdapter("customersLog",e.setting.source,{beforeLoadComplete:function(e){}},e.debug),a={source:o,columnsresize:!1,autorowheight:!0,autoheight:!0,rendergridrows:function(){return o.recordids},columns:[{text:"日期",dataField:"createDate",width:"9%",cellsrenderer:function(e,t,o,a,r,i){return'<div class="agrid">'+i.createDate.substring(0,10)+"</div>"}},{text:"电话",width:"9%",cellsrenderer:function(e,t,o,a,r,i){var n='<div class="agrid">';return(n+=i.phone)+"</div>"}},{text:"客服(姓名/用户名)",width:"11%",cellsrenderer:function(t,o,a,r,i,n){var s='<div class="agrid">';return(s+=void 0==n.customer.employeeCode?"":void 0==e.getCustService(n.customer.employeeCode)?"":e.getCustService(n.customer.employeeCode).name+"("+e.getCustService(n.customer.employeeCode).username+")")+"</div>"}},{text:"用户名",width:"9%",cellsrenderer:function(e,t,o,a,r,i){var n='<div class="agrid">';return(n+=void 0==i.name?"":i.name)+"</div>"}},{text:"聊天内容",width:"30%",cellsrenderer:function(e,t,o,a,r,i){var n="",s="";if(void 0!==i.content)for(var c=0;c<i.content.length;c++)s=i.content[c].remark,n+='<div class="agrid" style="position: relative; border-top: 1px solid  #EBEFF2;text-overflow: ellipsis; height:auto; line-height:20px; font-size:13px;" title='+s+">"+s+"</div>";return'<div style="height:auto;">'+n+"</div>"}},{text:"备注",width:"24%",cellsrenderer:function(e,t,o,a,r,i){var n="",s="";if(i.remark.length>0)for(var c=0;c<i.remark.length;c++)s=i.remark[c].remark,n+='<div class="agrid" style="position: relative; border-top: 1px solid  #EBEFF2;text-overflow: ellipsis; height:auto; line-height:20px; font-size:13px;" title='+s+">"+s+"</div>";return'<div style="height:auto;">'+n+"</div>"}},{text:"操作",width:"8%",cellsrenderer:function(e,t,o,a,r,i){var n='<div style="text-align:center; margin-top:-17px; position:relative; top:50%; text-overflow: ellipsis;">';return n+='<a class="hoverspan md-edit addChatContentBtn" data-index="'+e+'" title="添加聊天内容"></a>',n+='<a class="hoverspan md-note-add remarkLogBtn" data-index="'+e+'" title="添加备注"></a>',(n+='<a class="hoverspan md-cancel  delLogBtn" data-index="'+e+'" title="删除"></a>')+"</div>"}}],columnsheight:50};$("#customersLog").grid(a),$("#customersLog").on("click",".remarkLogBtn",function(){var t=$("#customersLog").jqxGrid("getselectedrowindex"),o=$("#customersLog").jqxGrid("getrowdata",t);e.lineData=o,$("#remarkLogWin").jqxWindow("open",function(){var e={localdata:o.remark,datatype:"array"},t=new $.jqx.dataAdapter(e);$("#customersLogRemarkTbody").jqxGrid({source:t,width:"100%",height:220,pageable:!1,columns:[{text:"更新时间",dataField:"createDate",width:"40%"},{text:"备注",dataField:"remark",width:"60%"}]})})}),$("#customersLogRemarkSaveBtn").off("click").on("click",function(){if($("#remarkLogWin").jqxValidator("validate")){var t=e.lineData.id,o=_global_settings.service.url+"/customerLog/add/remark/"+t;Core.AjaxRequest({url:o,type:"POST",params:{remark:$("#customersLogRemark").val()},async:!1,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#remarkLogWin").jqxWindow("close"),$("#customersLog").jqxGrid("updatebounddata","cells"),$("#customersLogRemarkTbody").jqxGrid("updatebounddata","cells"),$("#customersLogRemark").val("")},failure:function(){}})}}),$("#customersLog").on("click",".addChatContentBtn",function(){var t=$("#customersLog").jqxGrid("getselectedrowindex"),o=$("#customersLog").jqxGrid("getrowdata",t);e.userData=o,$("#addChatContentWin").jqxWindow("open",function(){var e={localdata:o.content,datatype:"json"},t=new $.jqx.dataAdapter(e);$("#addChatContentTbody").jqxGrid({source:t,width:"100%",height:220,pageable:!1,columns:[{text:"类型",width:"40%",cellsrenderer:function(e,t,o,a,r,i){var n="";return n+='<div class="agrid" style=" margin-top:-17px; position:relative; top:50%; text-overflow: ellipsis;">',"0"==i.type?n+="客服":"1"==i.type?n+="注册用户":"2"==i.type&&(n+="非注册用户"),n+"</div>"}},{text:"聊天内容",dataField:"remark",width:"60%",cellsrenderer:function(e,t,o,a,r,i){return'<div style="height:auto;"><div class="agrid" style="position: relative; border-top: 1px solid  #EBEFF2;text-overflow: ellipsis; height:auto; line-height:20px; font-size:13px;" title='+i.remark+">"+i.remark+"</div></div>"}}]})})}),$("#addChatContentSaveBtn").off("click").on("click",function(){if($("#addChatContentWin").jqxValidator("validate")){var t=e.userData.id,o=null,a=_global_settings.owner.roleName;"customerService"!=a&&"customerManage"!=a&&"secondLevelCustomerManage"!=a||(o="0");var r=_global_settings.service.url+"/customerLog/add/content/"+t;Core.AjaxRequest({url:r,type:"POST",params:{type:o,remark:$("#addChatContentRemark").val()},async:!1,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#addChatContentTbody").jqxGrid("updatebounddata","cells"),$("#addChatContentWin").jqxWindow("close"),$("#customersLog").jqxGrid("updatebounddata","cells"),$("#addChatContentRemark").val("")},failure:function(){}})}}),$("#customersLog").on("click",".delLogBtn",function(){var e=$("#customersLog").jqxGrid("getselectedrowindex"),o=$("#customersLog").jqxGrid("getrowdata",e);$("#deleteCustomerLogWin").jqxWindow("open"),$("#customerLogConfirmBtn").on("click",function(){Core.AjaxRequest({url:t+"/"+o.id,type:"DELETE",async:!1,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#deleteCustomerLogWin").jqxWindow("close"),$("#customersLog").jqxGrid("updatebounddata","cells")},failure:function(){}})})})},this.setting={source:{url:t+"/page",data:e.searchObj,updaterow:function(e,t,o){o(!0)}},grid:{element:"customersLog"},ajax:{url:t}},this.searchObj={},this.initSearch=function(){e.searchObj={"c.createDate":{value:[],action:"between"},"c.phone":{value:[],action:"like"},"c.customer.username":{value:[],action:"like"},"c.name":{value:[],action:"like"}}},this.searchDataInfo=function(){$("#customersLog").jqxGrid("applyfilters"),$("#customersLog").jqxGrid("refreshfilterrow"),$("#customersLog").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#customersLog").jqxGrid("updatebounddata","cells"),$("#customersLog").jqxGrid("clearselection"),$("#customersLog").jqxGrid("refreshdata")}},CustomersLogBindModle=function(e){var t=this;this.search=function(){var t=$("#customersLog-sDate").val(),o=$("#customersLog-eDate").val(),a=$("#customersLog-phone").val(),r=$("#customersLog-username").val(),i=$("#customersLog-cust").find("input").val();e.searchObj["c.createDate"].value=[],""!=t&&""!=o&&e.searchObj["c.createDate"].push(t+" 00:00:00",o+" 23:59:59"),""!=t&&""===o&&e.searchObj["c.createDate"].value.push(t+" 00:00:00"),e.searchObj["c.createDate"].action="ge",""===t&&""!=o&&e.searchObj["c.createDate"].value.push(o+" 00:00:00"),e.searchObj["c.createDate"].action="le",e.searchObj["c.phone"].value=[],""!=a&&e.searchObj["c.phone"].value.push(a),e.searchObj["c.name"].value=[],""!=r&&e.searchObj["c.name"].value.push(r),e.searchObj["c.customer.username"].value=[],""!=i&&null!=i&&e.searchObj["c.customer.username"].value.push(i),e.searchDataInfo()},this.bind=function(){$("#customersLog-search").on("click",function(){$("#customersLog-show").is(":hidden")?$("#customersLog-show").slideDown("slow"):t.search()}),hiddenAclick()},this.unbindAll=function(){}};