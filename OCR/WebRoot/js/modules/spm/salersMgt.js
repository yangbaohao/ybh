var SaleMgt=function(){var e=this,i=_global_settings.service.url+"/user",a=_global_settings.service.url+"/owner",t=(_global_settings.owner.roleName,null),s=null,r=null;this.debug=!1,this.data=null,this.initInput=function(){e.initUserPage(),e.initWindows(),e.initSearch(),e.initGrid(e.searchObj)};var n={condition:[],filterscount:0,groupscount:0,pagenum:0,pagesize:20},l={url:{value:[i+"/sales/0/0/0/"+(new Base64).encode(JSON.stringify(n))]}};this.setUrl=function(e){var a=$("#sale-sTime").find("input").val(),t=$("#sale-eTime").find("input").val();null!=a&&void 0!=a&&""!==a||(a=0),null!=t&&void 0!=t&&""!==t||(t=0),l.url={value:[i+"/sales/0/"+a+"/"+t+"/"+e]}},this.initUserPage=function(){$("#sale-show").css("display",""),$("#sale-time").jqxDropDownList({source:["请选择","最近一周","最近两周","最近三周","本月","本季度","本年"],theme:"energyblue",width:"100%",height:"34px",selectedIndex:0,dropDownHeight:150}),$("#sale-sTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#sale-eTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#sale-time").on("change",function(){setValueById("sale-time","sale-sTime","sale-eTime")}),$("#sale-sp").comboBox({theme:currentTheme,source:ComboBoxSources.getRecords("salesInfo_name"),searchMode:"contains",displayMember:"name_user",valueMember:"username",height:34,width:"100%",placeHolder:"请选择或输入"}),$("#sale-status").jqxDropDownList({source:{all:"请选择",N:"启用",Y:"禁用"},theme:"energyblue",width:"100%",height:"34px",selectedIndex:0,dropDownHeight:150}),$("#sale-show").addClass("hiddendiv")},this.initWindows=function(){$("#disableSalersWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:300,height:"auto",minWidth:500,cancelButton:$("#cancelDisableSalersBtn"),initContent:function(){$("#disableSalers-yn").jqxDropDownList({source:{false:"否",true:"是"},width:"100%",height:34,selectedIndex:0})}}).on("close",function(){setTimeout(function(){$("#disableSalers-yn").jqxDropDownList({selectedIndex:0})},500)}),$("#partMoreUserWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1200,minHeight:380,height:"auto",minWidth:750,cancelButton:$("#partMoreUser-cancel"),initContent:function(){}}).on({close:function(){setTimeout(function(){$("#partMoreUserTbody").jqxGrid("clearselection")},500)}})},this.getSales=function(e){for(var i=ComboBoxSources.getRecords("salesInfo"),a=0;a<i.length;a++)if(i[a].id==e)return i[a];if(!e)return""},this.initGrid=function(){function i(e){$("#partMoreUserWin").jqxWindow("open",function(){var i={localdata:e,datatype:"json"},a=new $.jqx.dataAdapter(i);$("#partMoreUserTbody").jqxGrid({source:a,width:"100%",height:220,pageable:!1,selectionmode:"checkbox",columns:[{text:"注册日期",width:"20%",cellsrenderer:function(e,i,a,t,s,r){var n='<div class="agrid">';return(n+=r.createDate.substring(0,10))+"</div>"}},{text:"用户名",width:"25%",cellsrenderer:function(e,i,a,t,s,r){var n='<div class="agrid">';return(n+=r.loginId)+"</div>"}},{text:"电话号码",width:"20%",cellsrenderer:function(e,i,a,t,s,r){var n='<div class="agrid">';return(n+=r.enterpriseInfo.telephone)+"</div>"}},{text:"公司名称",width:"30%",cellsrenderer:function(e,i,a,t,s,r){var n='<div class="agrid">';return(n+=r.enterpriseInfo.name)+"</div>"}}]})})}var n=Core.AcDataAdapter("saleGrid",e.settings.source,{beforeLoadComplete:function(e){}},e.debug),l={source:n,rendergridrows:function(){return n.recordids},columns:[{text:"销售人员(姓名/用户名)",width:"15%",height:"40px",cellsrenderer:function(e,i,a,t,s,r){var n='<div class="agrid">';return(n+=r.sales.username)+"</div>"}},{text:"拥有代理商",width:"9%",height:"40px",cellsrenderer:function(e,i,a,t,s,r){var n='<div class="agrid">';return(n+='<a class="hoverspan viewOwnAgent">'+r.salesAgentNum+"</a>")+"</div>"}},{text:"成功客户",width:"9%",height:"40px",cellsrenderer:function(e,i,a,t,s,r){var n='<div class="agrid">';return(n+='<a class="hoverspan viewOwnSuccessUser">'+r.ownerNum+"</a>")+"</div>"}},{text:"付费客户",dataField:"feeNum",width:"9%",height:"40px",cellsrenderer:function(e,i,a,t,s,r){var n='<div class="agrid">';return(n+='<a class="hoverspan viewOwnPaidUser">'+r.feeNum+"</a>")+"</div>"}},{text:"直销",dataField:"salesNum",columngroup:"monResult",cellsalign:"right",cellsformat:"c2",width:"10%",height:"20px"},{text:"商机销",dataField:"potentialNum",columngroup:"monResult",cellsalign:"right",cellsformat:"c2",width:"10%",height:"20px"},{text:"代理销",dataField:"agentSaleNum",columngroup:"monResult",cellsalign:"right",cellsformat:"c2",width:"10%",height:"20px"},{text:"状态",width:"10%",height:"40px"},{text:"是否禁用",width:"8%",height:"40px",cellsrenderer:function(e,i,a,t,s,r){var n='<div class="agrid">';return null!=r.sales.locked&&void 0!=r.sales.locked&&(n+=getCodeData(r.sales.locked)),n+"</div>"}},{text:"操作",width:"10%",height:"40px",cellsrenderer:function(e,i,a,t,s,r){var n='<div class="text-center">';return n+='<a class="hoverspan md-format-list-bulleted partMoreUser" title="分配信息"></a>',(n+='<a class="hoverspan md-error disableSalersBtn" title="禁用"></a>')+"</div>"}}],columngroups:[{text:"本月业绩",align:"center",name:"monResult",height:"20px"}],pagesize:20,columnsheight:30};$("#saleGrid").grid(l),$("#saleGrid").on("click",".viewOwnAgent",function(){var e=$("#saleGrid").jqxGrid("getselectedrowindex");if(e>=0){var i=$("#saleGrid").jqxGrid("getrowdata",e),a=$("#sale-sTime").find("input").val(),t=$("#sale-eTime").find("input").val();null!=a&&void 0!=a&&""!==a||(a="2015-01-01"),null!=t&&void 0!=t&&""!==t||(t=getNowFormatDate()),$.addTab({title:"查看拥有代理商",isFrame:!1,url:"page/modules/spm/viewOwnAgent.html",pk:{id:i.sales.id,agentName:i.sales.username,beginDate:a,endDate:t},reload:!0})}}),$("#saleGrid").on("click",".viewOwnSuccessUser",function(){var e=$("#saleGrid").jqxGrid("getselectedrowindex");if(e>=0){var i=$("#saleGrid").jqxGrid("getrowdata",e),a=$("#sale-sTime").find("input").val(),t=$("#sale-eTime").find("input").val();null!=a&&void 0!=a&&""!==a||(a="2015-01-01"),null!=t&&void 0!=t&&""!==t||(t=getNowFormatDate()),$.addTab({title:"查看成功用户",isFrame:!1,url:"page/modules/spm/viewOwnSuccessUser.html",pk:{id:i.sales.id,agentName:i.sales.username,employeeCode:i.sales.employeeCode,beginDate:a,endDate:t},reload:!0})}}),$("#saleGrid").on("click",".viewOwnPaidUser",function(){var e=$("#saleGrid").jqxGrid("getselectedrowindex");if(e>=0){var i=$("#saleGrid").jqxGrid("getrowdata",e),a=$("#sale-sTime").find("input").val(),t=$("#sale-eTime").find("input").val();null!=a&&void 0!=a&&""!==a||(a="2015-01-01"),null!=t&&void 0!=t&&""!==t||(t=getNowFormatDate()),$.addTab({title:"查看付费用户",isFrame:!1,url:"page/modules/spm/viewOwnPaidUser.html",pk:{id:i.sales.id,agentName:i.sales.username,employeeCode:i.sales.employeeCode,beginDate:a,endDate:t},reload:!0})}}),$("#saleGrid").on("click",".disableSalersBtn",function(){var i=$("#saleGrid").jqxGrid("getselectedrowindex");if(i>=0){var a=$("#saleGrid").jqxGrid("getrowdata",i);e.data=a,$("#disableSalersWin").jqxWindow("open"),$("#disableSalers-name").val(a.sales.username),$("#disableSalers-name").attr("data-id",a.sales.id)}}),$("#disableSalersBtn").on("click",function(){var e=$("#disableSalers-yn").val(),i=$("#disableSalers-name").attr("data-id");Core.AjaxRequest({url:_global_settings.service.url+"/user/lock/"+i+"/"+e,type:"PUT",async:!1,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#disableSalersWin").jqxWindow("close"),$("#saleGrid").jqxGrid("updatebounddata","cells")},failure:function(){}})}),$("#saleGrid").on("click",".partMoreUser",function(){var e=$("#saleGrid").jqxGrid("getselectedrowindex");if(e>=0){var s=$("#saleGrid").jqxGrid("getrowdata",e);r=s.sales.id;var n={condition:[],filterscount:0,groupscount:0,pagenum:0,pagesize:100},l=(new Base64).encode(JSON.stringify(n));Core.AjaxRequest({url:a+"/getownerlist/0/"+l,type:"GET",async:!1,callback:function(e){t=e.rows,i(e.rows)},failure:function(e){}})}}),$("#partMoreUserTbody").on("rowselect",function(){var e=$("#partMoreUserTbody").jqxGrid("getselectedrowindexes");indexes=e}),$("#partMoreUser-save").on("click",function(){var e=[],i=null,n=$("#partMoreUserTbody").jqxGrid("getselectedrowindexes");if(void 0==t||""==t||null==t)Core.alert({message:"暂无用户可分配！"});else if(0==n.length)Core.alert({message:"所选负责人不能为空！"});else if(void 0!=s||n.length>0){var l=$("#saleGrid").jqxGrid("getselectedrowindexes"),d=$("#saleGrid").jqxGrid("getrowdata",l),o=d.sales.employeeCode;$.each(n,function(i,a){s=t[n[i]].id,e.push(s)}),i=e.join(","),Core.AjaxRequest({url:a+"/writeownerlist/"+i+"/"+r+"/"+o+"/0",type:"POST",async:!1,showMsg:!1,callback:function(e){setCloseAlertTimeOneSecond(),$("#partMoreUserTbody").jqxGrid("clearselection"),$("#partMoreUserWin").jqxWindow("close");try{$("#saleGrid").jqxGrid("updatebounddata","cells"),$("#userMgtGrid").jqxGrid("updatebounddata","cells")}catch(e){}},failure:function(e){}})}})},this.settings={source:{data:e.searchObj,url:l.url.value[0],dataUrl:l},grid:{element:"saleGrid"},ajax:{url:i}},this.searchObj={},this.initSearch=function(){e.searchObj={username:{value:[],action:"like"},locked:{value:[],action:"eq"}}},this.searchDataInfo=function(){$("#saleGrid").jqxGrid("applyfilters"),$("#saleGrid").jqxGrid("refreshfilterrow"),$("#saleGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#saleGrid").jqxGrid("updatebounddata","cells"),$("#saleGrid").jqxGrid("clearselection"),$("#saleGrid").jqxGrid("refreshdata")}},SaleBindModle=function(e){var i=this;this.search=function(i){var a=$("#sale-sp").find("input").val(),t=a.substring(a.indexOf("(")+1,a.length-1),s=void 0==getSalesInfoByName(a)?void 0==getSalesInfoByName(t)?"":getSalesInfoByName(t).username:getSalesInfoByName(a).username,r=$("#sale-status").val();if(e.searchObj.username.value=[],null!=s&&""!=s&&e.searchObj.username.value.push(s),e.searchObj.locked.value=[],"all"!=r&&e.searchObj.locked.value.push(r),i)return e.searchObj;e.searchDataInfo()},this.bind=function(){$("#sale-search").on("click",function(){$("#sale-show").is(":hidden")?$("#sale-show").slideDown("slow"):(e.setUrl(getConditionParams(i.search(!0))),i.search())}),hiddenAclick()},this.unbindAll=function(){$("#sale-search").off("click")}};