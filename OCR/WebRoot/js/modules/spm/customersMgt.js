var CustomersMgt=function(){var e=this,t=_global_settings.service.url+"/user",s=_global_settings.service.url+"/owner",r=(_global_settings.owner.roleName,null),i=null,n=null;this.debug=!1,this.data=null,this.initInput=function(){e.initUserPage(),e.initWindows(),e.initSearch(),e.initGrid(e.searchObj)};var o={condition:[],filterscount:0,groupscount:0,pagenum:0,pagesize:20},a={url:{value:[t+"/sales/1/0/0/"+(new Base64).encode(JSON.stringify(o))]}};this.setUrl=function(e){var s=$("#customers-sTime").find("input").val(),r=$("#customers-eTime").find("input").val();null!=s&&void 0!=s&&""!==s||(s=0),null!=r&&void 0!=r&&""!==r||(r=0),a.url={value:[t+"/sales/1/"+s+"/"+r+"/"+e]}},this.initUserPage=function(){$("#customers-show").css("display",""),$("#customers-time").jqxDropDownList({source:["请选择","最近一周","最近两周","最近三周","本月","本季度","本年"],theme:"energyblue",width:"100%",height:"34px",selectedIndex:0,dropDownHeight:150}),$("#customers-sTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#customers-eTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#customers-time").on("change",function(){setValueById("customers-time","customers-sTime","customers-eTime")}),$("#customers-sp").comboBox({theme:currentTheme,source:ComboBoxSources.getRecords("custService_name"),searchMode:"contains",displayMember:"name_user",valueMember:"username",height:34,width:"100%",placeHolder:"请选择或输入"}),$("#customers-status").jqxDropDownList({source:{all:"请选择",N:"启用",Y:"禁用"},theme:"energyblue",width:"100%",height:"34px",selectedIndex:0,dropDownHeight:150}),$("#customers-show").addClass("hiddendiv")},this.initWindows=function(){$("#disableCustomersWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:300,height:"auto",minWidth:500,cancelButton:$("#cancelDisableCustomersBtn"),initContent:function(){}}).on("close",function(){setTimeout(function(){$("#disablecustomers-yn").jqxDropDownList({selectedIndex:0})},500)}),$("#custPartMoreUserWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1200,minHeight:380,height:"auto",minWidth:750,cancelButton:$("#custPartMoreUser-cancel"),initContent:function(){}}).on({close:function(){setTimeout(function(){$("#custPartMoreUserTbody").jqxGrid("clearselection")},500)}})},this.getSales=function(e){for(var t=ComboBoxSources.getRecords("customerssInfo"),s=0;s<t.length;s++)if(t[s].id==e)return t[s];if(!e)return""},this.initGrid=function(){e.settings.source.data=e.searchObj;var t=Core.AcDataAdapter("customersGrid",e.settings.source,{beforeLoadComplete:function(e){}},e.debug),o={source:t,rendergridrows:function(){return t.recordids},columns:[{text:"客服人员",width:"15%",height:"40px",cellsrenderer:function(e,t,s,r,i,n){var o='<div class="agrid">';return(o+=n.sales.username)+"</div>"}},{text:"拥有代理商",width:"9%",height:"40px",cellsrenderer:function(e,t,s,r,i,n){var o='<div class="agrid">';return(o+='<a class="hoverspan viewOwnAgent">'+n.salesAgentNum+"</a>")+"</div>"}},{text:"成功客户",width:"9%",height:"40px",cellsrenderer:function(e,t,s,r,i,n){var o='<div class="agrid">';return(o+='<a class="hoverspan viewOwnSuccessUser">'+n.ownerNum+"</a>")+"</div>"}},{text:"付费客户",dataField:"feeNum",width:"9%",height:"40px",cellsrenderer:function(e,t,s,r,i,n){var o='<div class="agrid">';return(o+='<a class="hoverspan viewOwnPaidUser">'+n.feeNum+"</a>")+"</div>"}},{text:"直销",dataField:"salesNum",columngroup:"monResult",cellsalign:"right",cellsformat:"c2",width:"10%",height:"20px"},{text:"商机销",dataField:"potentialNum",columngroup:"monResult",cellsalign:"right",cellsformat:"c2",width:"10%",height:"20px"},{text:"代理销",dataField:"agentSaleNum",columngroup:"monResult",cellsalign:"right",cellsformat:"c2",width:"10%",height:"20px"},{text:"状态",width:"10%",height:"40px"},{text:"是否禁用",width:"8%",height:"40px",cellsrenderer:function(e,t,s,r,i,n){var o='<div class="agrid">';return null!=n.sales.locked&&void 0!=n.sales.locked&&(o+=getCodeData(n.sales.locked)),o+"</div>"}},{text:"操作",width:"10%",height:"40px",cellsrenderer:function(e,t,s,r,i,n){var o='<div class="text-center">';return o+='<a class="hoverspan md-format-list-bulleted partMoreUser" title="分配信息"></a>',(o+='<a class="hoverspan md-error disableCustomersBtn" title="禁用"></a>')+"</div>"}}],columngroups:[{text:"本月业绩",align:"center",name:"monResult",height:"20px"}],pagesize:20,columnsheight:30};$("#customersGrid").grid(o),$("#customersGrid").on("click",".viewOwnAgent",function(){var e=$("#customersGrid").jqxGrid("getselectedrowindex");if(e>=0){var t=$("#customersGrid").jqxGrid("getrowdata",e),s=$("#customers-sTime").find("input").val(),r=$("#customers-eTime").find("input").val();null!=s&&void 0!=s&&""!==s||(s="2015-01-01"),null!=r&&void 0!=r&&""!==r||(r=getNowFormatDate()),$.addTab({title:"查看拥有代理商",isFrame:!1,url:"page/modules/spm/viewCustAgent.html",pk:{id:t.sales.id,agentName:t.sales.username,beginDate:s,endDate:r},reload:!0})}}),$("#customersGrid").on("click",".viewOwnSuccessUser",function(){var e=$("#customersGrid").jqxGrid("getselectedrowindex");if(e>=0){var t=$("#customersGrid").jqxGrid("getrowdata",e),s=$("#customers-sTime").find("input").val(),r=$("#customers-eTime").find("input").val();null!=s&&void 0!=s&&""!==s||(s="2015-01-01"),null!=r&&void 0!=r&&""!==r||(r=getNowFormatDate()),$.addTab({title:"查看成功用户",isFrame:!1,url:"page/modules/spm/viewCustSuccessUser.html",pk:{id:t.sales.id,agentName:t.sales.username,employeeCode:t.sales.employeeCode,beginDate:s,endDate:r},reload:!0})}}),$("#customersGrid").on("click",".viewOwnPaidUser",function(){var e=$("#customersGrid").jqxGrid("getselectedrowindex");if(e>=0){var t=$("#customersGrid").jqxGrid("getrowdata",e),s=$("#customers-sTime").find("input").val(),r=$("#customers-eTime").find("input").val();null!=s&&void 0!=s&&""!==s||(s="2015-01-01"),null!=r&&void 0!=r&&""!==r||(r=getNowFormatDate()),$.addTab({title:"查看付费用户",isFrame:!1,url:"page/modules/spm/viewCustPaidUser.html",pk:{id:t.sales.id,agentName:t.sales.username,employeeCode:t.sales.employeeCode,beginDate:s,endDate:r},reload:!0})}}),$("#customersGrid").on("click",".disableCustomersBtn",function(){var t=$("#customersGrid").jqxGrid("getselectedrowindex");if(t>=0){var s=$("#customersGrid").jqxGrid("getrowdata",t);e.data=s,$("#disableCustomersWin").jqxWindow("open",function(){$("#disablecustomers-yn").jqxDropDownList({source:{false:"否",true:"是"},width:"100%",height:34,selectedIndex:0})}),$("#disableCustomers-name").val(s.sales.username),$("#disableCustomers-name").attr("data-id",s.sales.id)}}),$("#disableCustomersBtn").on("click",function(){var e=$("#disablecustomers-yn").val(),t=$("#disableCustomers-name").attr("data-id");Core.AjaxRequest({url:_global_settings.service.url+"/user/lock/"+t+"/"+e,type:"PUT",async:!1,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#disableCustomersWin").jqxWindow("close"),$("#customersGrid").jqxGrid("updatebounddata","cells")},failure:function(){}})}),$("#customersGrid").on("click",".partMoreUser",function(){var e=$("#customersGrid").jqxGrid("getselectedrowindex");if(e>=0){var t=$("#customersGrid").jqxGrid("getrowdata",e);n=t.sales.id;var i={condition:[],filterscount:0,groupscount:0,pagenum:0,pagesize:100},o=(new Base64).encode(JSON.stringify(i));Core.AjaxRequest({url:s+"/getownerlist/1/"+o,type:"GET",async:!1,callback:function(e){r=e.rows,$("#custPartMoreUserWin").jqxWindow("open",function(){var e={localdata:r,datatype:"json"},t=new $.jqx.dataAdapter(e);$("#custPartMoreUserTbody").jqxGrid({source:t,width:"100%",height:220,pageable:!1,selectionmode:"checkbox",columns:[{text:"注册日期",width:"20%",cellsrenderer:function(e,t,s,r,i,n){var o='<div class="agrid">';return(o+=n.createDate.substring(0,10))+"</div>"}},{text:"用户名",width:"25%",cellsrenderer:function(e,t,s,r,i,n){var o='<div class="agrid">';return(o+=n.loginId)+"</div>"}},{text:"电话号码",width:"20%",cellsrenderer:function(e,t,s,r,i,n){var o='<div class="agrid">';return(o+=n.enterpriseInfo.telephone)+"</div>"}},{text:"公司名称",width:"30%",cellsrenderer:function(e,t,s,r,i,n){var o='<div class="agrid">';return(o+=n.enterpriseInfo.name)+"</div>"}}]})})},failure:function(e){}})}}),$("#custPartMoreUserTbody").on("rowselect",function(){var e=$("#custPartMoreUserTbody").jqxGrid("getselectedrowindexes");indexes=e}),$("#custPartMoreUser-save").on("click",function(){var e=[],t=null,o=$("#custPartMoreUserTbody").jqxGrid("getselectedrowindexes");if(void 0==r||""==r||null==r)Core.alert({message:"暂无用户可分配！"});else if(0==o.length)Core.alert({message:"所选负责人不能为空！"});else if(void 0!=i||o.length>0){var a=$("#customersGrid").jqxGrid("getselectedrowindexes"),d=$("#customersGrid").jqxGrid("getrowdata",a),l=d.sales.employeeCode;$.each(o,function(t,s){i=r[o[t]].id,e.push(i)}),t=e.join(","),Core.AjaxRequest({url:s+"/writeownerlist/"+t+"/"+n+"/"+l+"/1",type:"POST",async:!1,showMsg:!1,callback:function(e){setCloseAlertTimeOneSecond(),$("#custPartMoreUserTbody").jqxGrid("clearselection"),$("#custPartMoreUserWin").jqxWindow("close");try{$("#customersGrid").jqxGrid("updatebounddata","cells")}catch(e){}},failure:function(e){}})}})},this.settings={source:{data:e.searchObj,url:a.url.value[0],dataUrl:a},grid:{element:"customersGrid"},ajax:{url:t}},this.searchObj={},this.initSearch=function(){e.searchObj={username:{value:[],action:"like"},locked:{value:[],action:"eq"}}},this.searchDataInfo=function(){$("#customersGrid").jqxGrid("applyfilters"),$("#customersGrid").jqxGrid("refreshfilterrow"),$("#customersGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#customersGrid").jqxGrid("updatebounddata","cells"),$("#customersGrid").jqxGrid("clearselection"),$("#customersGrid").jqxGrid("refreshdata")}},CustomersBindModle=function(e){var t=this;this.getCustomersByName=function(e){for(var t=ComboBoxSources.getRecords("custService"),s=0;s<t.length;s++)if(t[s].username==e)return t[s];if(!e)return""},this.search=function(s){var r=$("#customers-sp").find("input").val(),i=r.substring(r.indexOf("(")+1,r.length-1),n=void 0==t.getCustomersByName(r)?void 0==t.getCustomersByName(i)?"":t.getCustomersByName(i).username:t.getCustomersByName(r).username,o=$("#customers-status").val();if(e.searchObj.username.value=[],null!=n&&""!=n&&e.searchObj.username.value.push(n),e.searchObj.locked.value=[],"all"!=o&&e.searchObj.locked.value.push(o),s)return e.searchObj;e.searchDataInfo()},this.bind=function(){$("#customers-search").on("click",function(){$("#customers-show").is(":hidden")?$("#customers-show").slideDown("slow"):(e.setUrl(getConditionParams(t.search(!0))),t.search())}),hiddenAclick()},this.unbindAll=function(){$("#customers-search").off("click")}};