var UserbMgt=function(){var e=this,t=_global_settings.service.url+"/user";this.debug=!1,this.userbData=null,this.initInput=function(){"taxStaffadmin"!=_global_settings.owner.roleName&&($("#userb-add").remove(),$("#userb-import").remove(),$("#userb-download").remove()),e.initUserPage(),e.initWindows(),e.initValidator(),e.initGrid(e.searchObj)},this.searchObj={"l.accountPeriodMonth":{value:[],action:"eq"},"t.taxType":{value:[],action:"eq"},"t.loginId":{value:[],action:"like"},"i.name":{value:[],action:"like"}},this.initUserPage=function(){$("#userb-show").css("display","");for(var e=ComboBoxSources.getRecords("userInfo"),t=["全部"],a=0;a<e.length;a++)t.push(e[a].username);$("#userb-username").comboBox({theme:currentTheme,source:t,searchMode:"contains",displayMember:"username",height:34,width:"100%",selectedIndex:0});for(var e=ComboBoxSources.getRecords("userInfo"),t=["全部"],a=0;a<e.length;a++)t.push(e[a].name);$("#userb-buymou").comboBox({theme:currentTheme,source:t,searchMode:"contains",displayMember:"name",height:34,width:"100%",selectedIndex:0}),$("#userb-tax").dropDownlist({source:{all:"全部",smallscale:"小规模纳税人",generalvat:"一般增值税纳税人"},theme:currentTheme,height:34,width:"100%",selectedIndex:0}),$("#userb-pday").monthpicker({callback:"abc"}),$("#userb-pday").val(""),$("#userb-show").addClass("hiddendiv")},this.initWindows=function(){$("#userbMgtWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:700,minHeight:300,height:"auto",minWidth:600,maxWidth:800,cancelButton:$("#userbMgtCancleBtn"),initContent:function(){$("#userbMgtDate").monthpicker({callback:"abc"})}}).on("close",function(){setTimeout(function(){$("#userb-company").text("")},500)}),$("#addUserbMgtWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:900,minHeight:460,height:"auto",minWidth:900,maxWidth:900,cancelButton:$("#addUserbMgtCancleBtn"),initContent:function(){$("#addbMgtDate").monthpicker({callback:"abc"});var e=["0%","3%","6%","11%","13%","17%"];$("#add-vat").dropDownlist({source:e,theme:currentTheme,width:"100%",height:"34px",dropDownHeight:200,selectedIndex:0}),$("#add-taxType").dropDownlist({source:{smallscale:"小规模纳税人",generalvat:"一般增值税纳税人"},theme:currentTheme,height:34,width:"100%",selectedIndex:0}),$("#payee-period").dropDownlist({source:{paymouth:"按月收款",payseason:"按季度收款",payhalfyear:"按半年收款",payyear:"按年收款"},theme:currentTheme,height:34,width:"100%",selectedIndex:0}),$("#payee-period").val("paymouth"),$("#contract-sTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}).val(""),$("#contract-eTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}).val(""),$("#add-email").val(""),$("#add-phone").val(""),$("#payee-amount").input({width:"98%",height:33}).moneyinput(),$("#payee-amount").val("0.00")}}).on("close",function(){setTimeout(function(){$("#add-name").val("")},500)}),$("#editUserbMgtWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:700,minHeight:460,height:"auto",minWidth:900,maxWidth:900,cancelButton:$("#editUserbMgtCancleBtn"),initContent:function(){$("#edit-MgtDate").monthpicker({callback:"abc"}),$("#edit-period").dropDownlist({source:{paymouth:"按月收款",payseason:"按季度收款",payhalfyear:"按半年收款",payyear:"按年收款"},theme:currentTheme,height:34,width:"100%",selectedIndex:0}),$("#edit-taxType").dropDownlist({source:{smallscale:"小规模纳税人",generalvat:"一般增值税纳税人"},theme:currentTheme,height:34,width:"100%",selectedIndex:0});var e=["0%","3%","6%","11%","13%","17%"];$("#edit-vat").dropDownlist({source:e,theme:currentTheme,width:"100%",height:"34px",dropDownHeight:200,selectedIndex:0}),$("#edit-sTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#edit-eTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#edit-amount").input({width:"98%",height:33}).moneyinput()}}).on({close:function(){setTimeout(function(){$("#edit-name").val("")},500)},open:function(){}}),$("#partUserbMgtWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:700,minHeight:300,height:"auto",minWidth:600,maxWidth:800,cancelButton:$("#partUserbMgtCancleBtn"),initContent:function(){}}).on("close",function(){setTimeout(function(){$("#part-name").val("")},"open",function(){ComboBoxSources.load("taxManage")},500)}),$("#matchUserbMgtWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:700,minHeight:300,height:"auto",minWidth:600,maxWidth:800,cancelButton:$("#matchUserbMgtCancleBtn"),initContent:function(){$("#match-getMsg").text("免费获取验证码")}}).on("close",function(){setTimeout(function(){$("#match-getMsg").text("免费获取验证码")},500)}),$("#receiptUserbMgtWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:700,minHeight:"450",height:"450",minWidth:600,maxWidth:800,cancelButton:$("#receiptUserbMgtCancleBtn"),initContent:function(){$("#receipt-sTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#receipt-eTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#receipt-amount").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#receipt-money").input({width:"100%",height:33}).moneyinput()}}).on("close",function(){setTimeout(function(){},"open",function(){},500)}),$("#sendEmailUserbMgtWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:700,minHeight:480,height:"480",minWidth:600,maxWidth:800,cancelButton:$("#sendEmailUserbMgtCancleBtn"),initContent:function(){$("#sendEmail-sTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#sendEmail-eTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#sendEmail-amount").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#sendEmail-money").input({width:"98%",height:33}).moneyinput()}}).on("close",function(){setTimeout(function(){},"open",function(){},500)})},this.getTaxerInfo=function(e){var t=ComboBoxSources.getRecords("taxerInfo");for(i=0;i<t.length;i++)if(e==t[i].username)return t[i];if(!e)return""};var a=function(){return"taxStaffadmin"==_global_settings.owner.roleName?[{text:"用户名",width:"12.2%",cellsrenderer:function(e,t,a,i,n,r){var o='<div style="padding-top:6px; text-overflow:ellipsis; white-space: nowrap; overflow: hidden;">';return o+='<a class="hoverspan viewTaxerUserDetail" data-index="'+e+'"  >'+r.loginId+"</a>",o+="</div>"}},{text:"公司名称",width:"12.2%",cellsrenderer:function(e,t,a,i,n,r){var o='<div style="padding-top:6px; text-overflow:ellipsis; white-space: nowrap; overflow: hidden;">';return o+=r.name,o+="</div>"}},{text:"纳税人性质",width:"10%",cellsrenderer:function(e,t,a,i,n,r){return'<div style="padding-top:6px">'+getCodeData(r.taxType)+"</div>"}},{text:"纳税人识别号",dataField:"owerTaxCode",width:"9%"},{text:"增值税率(%)",dataField:"vat",width:"9%"},{text:"当前账期",dataField:"mouthDate",width:"8%"},{text:"报税人",dataField:"taxer",width:"9%",cellsrenderer:function(t,a,i,n,r,o){var d="";return"AdminAccount"==o.taxer?d+="<div>代理报税</div>":void 0!=e.getTaxerInfo(o.taxer)?e.getTaxerInfo(o.taxer).username==o.taxer&&(d+='<div style="padding-top:6px;">'+e.getTaxerInfo(o.taxer).name+"</div>"):d+='<div style="padding-top:6px;">'+o.taxer+"</div>","<div>"+d+"</div>"}},{text:"报税状态",dataField:"taxProgressType",width:"10%"},{text:"收款状态",width:"8%",cellsrenderer:function(e,t,a,i,n,r){return'<div style="padding-top:6px">'+getCodeData(r.paidType)+"</div>"}},{text:"操作",width:"10%",cellsrenderer:function(e,t,a,i,n,r){var o='<div style="text-align:center">';return o+='<a class="hoverspan md-label  decGoodsBtn" data-index="'+e+'" title="报税"></a>',o+='<a class="hoverspan md-edit editGoodsBtn" data-index="'+e+'" title="编辑"></a>',o+='<a class="hoverspan md-format-list-bulleted partGoodsBtn" data-index="'+e+'" title="分配员工"></a>',o+='<a class="hoverspan md-attach-money receiptMoneyBtn" data-index="'+e+'" title="收款"></a>',(o+='<a class="hoverspan md-send sendPaymentEmail" data-index="'+e+'" title="发送催款邮件"></a>')+"</div>"}}]:[{text:"用户名",width:"15%",cellsrenderer:function(e,t,a,i,n,r){var o='<div style="padding-top:6px; text-overflow:ellipsis; white-space: nowrap; overflow: hidden;">';return o+='<a class="hoverspan viewTaxerUserDetail" data-index="'+e+'"  >'+r.loginId+"</a>",o+="</div>"}},{text:"公司名称",width:"15%",cellsrenderer:function(e,t,a,i,n,r){var o='<div style="padding-top:6px; text-overflow:ellipsis; white-space: nowrap; overflow: hidden;">';return o+=r.name,o+="</div>"}},{text:"纳税人性质",width:"15%",cellsrenderer:function(e,t,a,i,n,r){return'<div style="padding-top:6px">'+getCodeData(r.taxType)+"</div>"}},{text:"纳税人识别号",dataField:"owerTaxCode",width:"10.6%"},{text:"增值税率(%)",dataField:"vat",width:"8%"},{text:"当前账期",dataField:"mouthDate",width:"8%"},{text:"状态",dataField:"taxProgressType",width:"8%"},{text:"收款状态",width:"10%",cellsrenderer:function(e,t,a,i,n,r){return'<div style="padding-top:6px">'+getCodeData(r.paidType)+"</div>"}},{text:"操作",width:"8%",cellsrenderer:function(e,t,a,i,n,r){var o='<div style="text-align:center;">';return o+='<a class="hoverspan md-label decGoodsBtn" data-index="'+e+'" title="报税"></a>',o+='<a class="hoverspan md-edit editGoodsBtn" data-index="'+e+'" title="编辑"></a>',o+='<a class="hoverspan md-attach-money receiptMoneyBtn" data-index="'+e+'" title="收款"></a>',(o+='<a class="hoverspan md-send sendPaymentEmail" data-index="'+e+'" title="发送催款邮件"></a>')+"</div>"}}]};this.initGrid=function(){var t=Core.AcDataAdapter("userbMgtGrid",e.settings.source,{beforeLoadComplete:function(e){}},e.debug),i={source:t,enablehover:!1,rendergridrows:function(){return t.recordids},columns:a(),selectionmode:"checkbox",pagesize:20,columnsheight:45};$("#userbMgtGrid").grid(i),$("#userbMgtGrid").on("rowselect rowunselect",function(){n()}),$("#userbMgtGrid").on("click",".viewTaxerUserDetail",function(){var e=$(this).attr("data-index");if(e>=0){var t=$("#userbMgtGrid").jqxGrid("getrowdata",e);$.addTab({title:"查看用户",url:"page/modules/user/viewTaxerUserDetail.html",isFrame:!1,pk:{data:t},reload:!0})}})};var n=function(){indexes=[];var e=0,t=null,a=$("#userbMgtGrid").jqxGrid("getselectedrowindexes");if($.each(a,function(i){void 0!=a[i]&&(e++,t=a[i])}),indexes=a,(e>1||0==e)&&(removeIndex(arr_tab),$("#index-companyname").text("")),1===e&&t>0){var i=$("#userbMgtGrid").jqxGrid("getrowdata",t);void 0!=i&&$("#index-companyname").text(i.name)}};this.settings={source:{url:t+"/searchusertax/1",data:e.searchObj},grid:{element:"userbMgtGrid"},ajax:{url:t}},this.searchDataInfo=function(){$("#userbMgtGrid").jqxGrid("applyfilters"),$("#userbMgtGrid").jqxGrid("refreshfilterrow"),$("#userbMgtGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#userbMgtGrid").jqxGrid("updatebounddata","cells"),$("#userbMgtGrid").jqxGrid("clearselection"),$("#userbMgtGrid").jqxGrid("refreshdata")},this.initValidator=function(){$("#addUserbMgtWin").jqxValidator({hintType:"label",animationDuration:1,rules:[{input:"#add-loginId",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#add-loginId",message:"只能是数字,字母,下划线。下划线不能开头或结尾",action:"keyup, blur",rule:function(e,t){var a=e.val(),i=new RegExp("[`~!@#$^&*()=|{}':;',\\[\\].<>/?~！@#￥……&*（） &;|{}【】‘；：”“'。，、？一-龥]");return 0!==a.indexOf("_")&&a.indexOf("_")!==a.length-1&&!i.test(e.val())}},{input:"#add-phone",message:"联系电话格式不正确,请重新输入",action:"keyup,blur",rule:function(e,t){return!!/^1[3|4|5|7|8]\d{9}$/.test(e.val())}}]}),$("#sendEmailUserbMgtWin").jqxValidator({hintType:"label",animationDuration:1,rules:[{input:"#sendEmail-money",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#sendEmail-sTime",message:"不能为空",action:"keyup, blur",rule:"required"},{input:"#sendEmail-eTime",message:"不能为空",action:"keyup, blur",rule:"required"}]})}},UserbBindModle=function(t){var a=this,n=0,r=_global_settings.service.url+"/common";this.search=function(){var e=$("#userb-username").find("input").val(),a=$("#userb-buymou").find("input").val(),i=$("#userb-pday").val(),n=$("#userb-tax").val();t.searchObj["i.name"].value=[],"全部"!=a&&t.searchObj["i.name"].value.push(a),t.searchObj["t.loginId"].value=[],"全部"!=e&&t.searchObj["t.loginId"].value.push(e),t.searchObj["t.taxType"].value=[],"all"!=n&&t.searchObj["t.taxType"].value.push(n),t.searchObj["l.accountPeriodMonth"].value=[],""!=i&&t.searchObj["l.accountPeriodMonth"].value.push(i),t.searchDataInfo()},this.bind=function(){function o(){$("#add-email").val(""),$("#add-phone").val(""),$("#payee-amount").val("0.00"),$("#add-name").val(""),$("#add-loginId").val(""),$("#add-taxpayer").val(""),$("#contract-sTime").val(""),$("#contract-eTime").val("")}function d(){var e={};return $("#addUserbMgtWin").jqxValidator("validate")&&(e.username=$("#add-loginId").val(),e.enterpriseName=$("#add-name").val(),e.taxType=$("#add-taxType").val(),e.vat=$("#add-vat").val().substring(0,$("#add-vat").val().length-1),e.startMonth=$("#addbMgtDate").val(),e.enterpriseTaxCode=$("#add-taxpayer").val(),e.startDate=$("#contract-sTime").val(),e.endDate=$("#contract-eTime").val(),e.dateType=$("#payee-period").val(),e.payAmt="NaN"==money($("#payee-amount").val())?"0.00":money($("#payee-amount").val()),e.email=$("#add-email").val(),e.regTelephone=$("#add-phone").val()),e}function s(e){var t;return Core.AjaxRequest({type:"POST",url:_global_settings.service.url+"/owner/direct/reg",async:!1,params:e,showMsg:!1,callback:function(a){t=a,!0===a?(setCloseAlertTimeOneSecond(),o(),$("#addUserbMgtWin").jqxWindow("close"),$("#userbMgtGrid").jqxGrid("updatebounddata","cells")):l(e)},failure:function(e){var t=JSON.parse(e.responseText);Core.alert({message:t.errorMsg})}}),t}function l(e){$("#matchUserbMgtWin").jqxWindow("open"),$("#match-username").html(e.username),$("#match-inputUserName").val(e.username),$("#match-validCode").val(""),$("#match-validCode").attr("disabled",!0),$("#match-getMsg").text("免费获取验证码"),$("#match-validCode").keyup(function(){$("#match-validCode").val().length>0?$("#matchUserSubmitBtn").attr("disabled",!1):$("#matchUserSubmitBtn").attr("disabled",!0)})}function c(){$.ajax({type:"GET",url:_global_settings.service.url+"/owner/direct/acPhone/"+$("#match-inputUserName").val(),datatype:"json",success:function(e){u(e)},failure:function(e){var t=JSON.parse(e.responseText);Core.alert({message:t.errorMsg,callback:function(){$("#userbMgtWin").jqxWindow("close")}})}})}function u(e){var t=e.toString().substr(0,3),a=e.toString().substr(3),i=t+"****"+a;$("#mark_no").text(i),$("#matchConfirmphone").slideDown(300),$("#qyzh").css("boxShadow","0px 0px 0px white")}function m(){$("#matchConfirmphone").slideUp(300);var e=60,t=function(){e-=1,$("#match-getMsg").text("获取验证码("+e+")"),$("#match-getMsg").attr("disabled",!0),0===e&&(clearInterval(a),$("#match-getMsg").text("重新发送"),$("#match-getMsg").attr("disabled",!1))};n+=1;var a=setInterval(t,1e3),i=$("#match-inputUserName").val();$.ajax({type:"GET",url:_global_settings.service.url+"/owner/direct/enrolledAgent/session/"+i+"/"+n,datatype:"json",success:function(e){$(".jqx-window-close-button").eq(4).on("click",function(){clearInterval(a),$("#match-getMsg").attr("disabled",!1),$("#match-getMsg").text("免费获取验证码")}),$("#matchUserbMgtCancleBtn").on("click",function(){clearInterval(a),$("#match-getMsg").attr("disabled",!1),$("#match-getMsg").text("免费获取验证码")}),$("#match-validCode").attr("disabled",!1)},failure:function(e){Core.alert({message:"短信发送失败！请检查您的网络，似乎不太好哦！"})}})}function p(){var e,t=$("#match-inputUserName").val(),a=$("#match-validCode").val();if(Core.AjaxRequest({url:_global_settings.service.url+"/owner/direct/valid/verify/"+a+"/"+t,type:"GET",showMsg:!1,async:!1,callback:function(t){e=t}}),1==e){var i={};i.name=$("#match-inputUserName").val(),i.taxCode=_global_settings.owner.employeeCode,Core.AjaxRequest({url:_global_settings.service.url+"/owner/updateTaxCodeByName",type:"PUT",params:i,showMsg:!1,async:!1,callback:function(e){e&&Core.alert({message:"匹配成功,刷新页面即可查看！",callback:function(){$("#matchUserbMgtWin").jqxWindow("close",function(){clearInterval(times),$("#match-getMsg").attr("disabled",!1),$("#match-getMsg").text("免费获取验证码")}),$("#userbMgtGrid").jqxGrid("updatebounddata","cells"),$("#addUserbMgtWin").jqxWindow("close")}})}})}else Core.alert({message:"验证码输入有误，请重新输入！"})}function h(e){$("#editUserbMgtWin").jqxWindow("open",function(){$("#edit-loginId").val(e.loginId),$("#edit-name").val(e.name),$("#edit-taxType").val(e.taxType),$("#edit-vat").val(e.vat+"%"),$("#edit-MgtDate").val(e.mouthDate),$("#edit-taxpayer").val(e.owerTaxCode),$("#edit-sTime").val(e.startDate),$("#edit-eTime").val(e.endDate),$("#edit-period").val(e.dateType),$("#edit-amount").val(money(e.payAmt)),$("#edit-phone").val(void 0==e.regTelephone?"":e.regTelephone),$("#edit-email").val(void 0==e.email?"":e.email)})}function g(){var e={};return e.ownerId=a.userbData.id,e.username=$("#edit-loginId").val(),e.enterpriseName=$("#edit-name").val(),e.taxType=$("#edit-taxType").val(),e.vat=$("#edit-vat").val().substring(0,$("#edit-vat").val().length-1),e.startMonth=$("#edit-MgtDate").val(),e.enterpriseTaxCode=$("#edit-taxpayer").val(),e.startDate=$("#edit-sTime").val(),e.endDate=$("#edit-eTime").val(),e.dateType=$("#edit-period").val(),e.payAmt=$("#edit-amount").val(),e.email=$("#edit-email").val(),e.regTelephone=$("#edit-phone").val(),e}function v(e){Core.AjaxRequest({type:"PUT",url:_global_settings.service.url+"/owner/updateLoginById",async:!1,params:e,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#editUserbMgtWin").jqxWindow("close"),$("#userbMgtGrid").jqxGrid("updatebounddata","cells")},failure:function(e){Core.alert({message:e.responseJSON.errorMsg})}})}$("#userb-search").on("click",function(){$("#userb-show").is(":hidden")?$("#userb-show").slideDown("slow"):a.search()}),$("#userb-download").on("click",function(){"localhost"==getHostName()||"192.168.1.3:8080/SimpleBss/".indexOf(getHostName())>-1?window.open("/SimpleBss/template/owner.xls"):window.open("/template/owner.xls")}),$("#userb-import").on("click",function(){var e={url:r+"/import/taxOwner/"+_global_settings.owner.userid};$("#userb-attachment").html(""),$("#userb-modal").modal("show"),$("#userb-attachment").fileuploader(e)}),$("#userb-add").on("click",function(){$("#addUserbMgtWin").jqxWindow("open"),o()}),$("#addUserSubmitBtn").off("click").on("click",function(){s(d())}),$("#match-getMsg").off().on("click",function(){c()}),$("#match_Confirmphone").off().on("click",function(){m()}),$("#match_cancelPhone").click(function(){$("#matchConfirmphone").slideUp(300)}),$("#matchUserSubmitBtn").off().on("click",function(){p()}),$("#addUserbMgtCancleBtn").off("click").on("click",function(){o(),$("#addUserbMgtWin").jqxWindow("close")}),$("#addUserbMgtWin").find(".jqx-window-close-button").off("click").on("click",function(){o(),$("#addUserbMgtWin").jqxWindow("close")}),$("#userbMgtGrid").on("click",".decGoodsBtn",function(){var e=$(this).attr("data-index"),t=$("#userbMgtGrid").jqxGrid("getrowdata",e);a.userbData=t,$("#userbMgtWin").jqxWindow("open",function(){$("#userb-company").text(t.name),$("#userbMgtDate").val(t.mouthDate)})}),$("#userbMgtConfirmBtn").on("click",function(){var e={};e.mouthDate=$("#userbMgtDate").val(),e.ownerId=a.userbData.id,e.username=a.userbData.loginId,e.vat=a.userbData.vat,Core.AjaxRequest({type:"POST",url:_global_settings.service.url+"/common/tax/save",async:!1,params:e,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#userbMgtWin").jqxWindow("close"),$("#userbMgtGrid").jqxGrid("updatebounddata","cells")},failure:function(e){var t=JSON.parse(e.responseText);Core.alert({message:t.errorMsg,callback:function(){$("#userbMgtWin").jqxWindow("close")}})}})}),$("#userbMgtGrid").on("click",".editGoodsBtn",function(){var e=$(this).attr("data-index"),t=$("#userbMgtGrid").jqxGrid("getrowdata",e);a.userbData=t,h(t)}),$("#editUserSubmitBtn").on("click",function(){v(g())}),enterSubmit("#editUserbMgtWin","#editUserSubmitBtn"),$("#userbMgtGrid").on("click",".partGoodsBtn",function(){var e=$(this).attr("data-index"),i=$("#userbMgtGrid").jqxGrid("getrowdata",e);a.userbData=i,Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/user/taxManage",async:!1,callback:function(e){for(var a=[],n=0;n<e.length;n++)t.getTaxerInfo(e[n].username).username==e[n].username&&a.push(t.getTaxerInfo(e[n].username).name);$("#part-taxer").dropDownlist({theme:currentTheme,source:a,searchMode:"contains",displayMember:"username",height:34,width:"100%",selectedIndex:0}),$("#partUserbMgtWin").jqxWindow("open",function(){t.getTaxerInfo(i.taxer).username==i.taxer&&$("#part-taxer").val(t.getTaxerInfo(i.taxer).name),$("#part-username").val(i.loginId),$("#part-name").val(i.name)})},failure:function(){}})}),$("#partUserSubmitBtn").on("click",function(){var e=null,t=function(e){var t=ComboBoxSources.getRecords("taxerInfo");for(i=0;i<t.length;i++)if(e==t[i].name)return t[i];if(!e)return""};t($("#part-taxer").val()).name==$("#part-taxer").val()&&(e=t($("#part-taxer").val()).username);var n=[{id:a.userbData.id,loginId:e,name:$("#part-username").val(),mouthDate:a.userbData.mouthDate}];Core.AjaxRequest({type:"POST",url:_global_settings.service.url+"/common/owner/tax/update/"+e,async:!1,params:n,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#partUserbMgtWin").jqxWindow("close"),$("#userbMgtGrid").jqxGrid("updatebounddata","cells")},failure:function(){}})}),$("#userbMgtGrid").on("click",".receiptMoneyBtn",function(){var e=$(this).attr("data-index"),t=$("#userbMgtGrid").jqxGrid("getrowdata",e);a.userbData=t,$("#receiptUserbMgtWin").jqxWindow("open",function(){function e(){"paymouth"==$("#receipt-period").val()?($("#receipt-money").val(money(t.payAmt)),$("#receipt-eTime").val(getChangeDate($("#receipt-sTime").val(),1))):"payseason"==$("#receipt-period").val()?($("#receipt-money").val(money(3*t.payAmt)),$("#receipt-eTime").val(getChangeDate($("#receipt-sTime").val(),3))):"payhalfyear"==$("#receipt-period").val()?($("#receipt-money").val(money(6*t.payAmt)),$("#receipt-eTime").val(getChangeDate($("#receipt-sTime").val(),6))):"payyear"==$("#receipt-period").val()&&($("#receipt-money").val(money(12*t.payAmt)),$("#receipt-eTime").val(getChangeDate($("#receipt-sTime").val(),12)))}$("#receipt-period").dropDownlist({source:{paymouth:"按月收款",payseason:"按季度收款",payhalfyear:"按半年收款",payyear:"按年收款"},theme:currentTheme,height:34,width:"100%"}),$("#receipt-loginId").val(a.userbData.loginId),$("#receipt-name").val(a.userbData.name),$("#receipt-amount").val(new Date),$("#receipt-period").val(a.userbData.dateType),$("#receipt-period").on("select",function(){e()}),void 0!=a.userbData.startDate?($("#receipt-sTime").val(a.userbData.startDate),e()):($("#receipt-sTime").val($("#receipt-amount").val()),e()),$("#receipt-sTime").change(function(){e()}),e()})}),$("#receiptUserSubmitBtn").on("click",function(){var e={};e.entryDate=$("#receipt-amount").val(),e.dateType=$("#receipt-period").val(),e.startDate=""==$("#receipt-sTime").val()?"":$("#receipt-sTime").val(),e.endDate=""==$("#receipt-eTime").val()?"":$("#receipt-eTime").val(),e.amt="NaN"==money($("#receipt-money").val())?"":money($("#receipt-money").val()),e.owner={},e.owner.id=a.userbData.id,e.type="pay",Core.AjaxRequest({type:"POST",url:_global_settings.service.url+"/owner/payRemark",async:!1,params:e,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#receiptUserbMgtWin").jqxWindow("close"),$("#userbMgtGrid").jqxGrid("updatebounddata","cells")},failure:function(){}})}),$("#userbMgtGrid").on("click",".sendPaymentEmail",function(){var t=$(this).attr("data-index"),i=$("#userbMgtGrid").jqxGrid("getrowdata",t);a.userbData=i,$("#sendEmailUserbMgtWin").jqxWindow("open",function(){function t(){"paymouth"==$("#sendEmail-period").val()?($("#sendEmail-money").val(money(i.payAmt)),$("#sendEmail-eTime").val(getChangeDate($("#sendEmail-sTime").val(),1))):"payseason"==$("#sendEmail-period").val()?($("#sendEmail-money").val(money(3*i.payAmt)),$("#sendEmail-eTime").val(getChangeDate($("#sendEmail-sTime").val(),3))):"payhalfyear"==$("#sendEmail-period").val()?($("#sendEmail-money").val(money(6*i.payAmt)),$("#sendEmail-eTime").val(getChangeDate($("#sendEmail-sTime").val(),6))):"payyear"==$("#sendEmail-period").val()&&($("#sendEmail-money").val(money(12*i.payAmt)),$("#sendEmail-eTime").val(getChangeDate($("#sendEmail-sTime").val(),12)))}$("#sendEmail-period").dropDownlist({source:{paymouth:"按月收款",payseason:"按季度收款",payhalfyear:"按半年收款",payyear:"按年收款"},theme:currentTheme,height:34,width:"100%",selectedIndex:0}),$("#sendEmail-loginId").val(a.userbData.loginId),$("#sendEmail-name").val(a.userbData.name),$("#sendEmail-amount").val(new Date),$("#sendEmail-money").val(money("0"==a.userbData.payAmt?"0.00":a.userbData.payAmt)),$("#sendEmail-email").text(void 0==a.userbData.email?"":a.userbData.email),$("#sendEmail-period").val(a.userbData.dateType),void 0!=a.userbData.startDate?($("#sendEmail-sTime").val(a.userbData.startDate),t()):($("#sendEmail-sTime").val($("#sendEmail-amount").val()),t()),$("#sendEmail-sTime").change(function(){t()}),t(),$("#sendEmail-period").on("select",function(){t()}),$("#sendEmailUserSubmitBtn").off("click").on("click",function(){var t=$("#sendEmail-email").text(),n=/^([0-9A-Za-z\-_\.]+)@([0-9a-z]+\.[a-z]{2,3}(\.[a-z]{2})?)$/g;if(""==t)Core.alert({message:"发送催款邮件，邮件不能为空哦！是否需要去编辑邮件？",callback:function(){$("#sendEmailUserbMgtWin").jqxWindow("close"),$("#editUserbMgtWin").jqxWindow("open",function(){$("#edit-loginId").val(i.loginId),$("#edit-name").val(i.name),$("#edit-taxType").val(i.taxType),$("#edit-vat").val(i.vat+"%"),$("#edit-MgtDate").val(i.mouthDate),$("#edit-taxpayer").val(i.owerTaxCode),$("#edit-sTime").val(i.startDate),$("#edit-eTime").val(i.endDate),$("#edit-period").val(i.dateType),$("#edit-amount").val(money(i.payAmt)),$("#edit-phone").val(void 0==i.regTelephone?"":i.regTelephone),$("#edit-email").val(void 0==i.email?"":i.email)})}});else if(n.test(t))if("0.00"==$("#sendEmail-money").val())Core.alert({message:"催款金额不能为零！"});else if(Number($("#sendEmail-sTime").val().replace(/[-]/g,""))>Number($("#sendEmail-eTime").val().replace(/[-]/g,"")))Core.alert({message:"请检查收款区间时间！"});else{var r={};r.entryDate=$("#sendEmail-amount").val(),r.dateType=$("#sendEmail-period").val(),r.startDate=""==$("#sendEmail-sTime").val()?"":$("#sendEmail-sTime").val(),r.endDate=""==$("#sendEmail-eTime").val()?"":$("#sendEmail-eTime").val(),r.amt="NaN"==money($("#sendEmail-money").val())?"0.00":money($("#sendEmail-money").val()),r.owner={},r.owner.id=a.userbData.id,r.type="nopay",Core.AjaxRequest({type:"POST",url:_global_settings.service.url+"/owner/payRemark",async:!1,params:r,showMsg:!1,callback:function(t){Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/owner/mail/"+a.userbData.email+"/"+a.userbData.id+"/"+$("#sendEmail-sTime").val()+"/"+$("#sendEmail-eTime").val()+"/"+$("#sendEmail-money").val(),async:!1,params:r,callback:function(e){setCloseAlertTimeOneSecond(),$("#sendEmailUserbMgtWin").jqxWindow("close"),$("#userbMgtGrid").jqxGrid("updatebounddata","cells")},failure:function(){Core.alert({message:e.responseJSON.errorMsg})}})},failure:function(e){Core.alert({message:e.responseJSON.errorMsg,callback:function(){$("#sendEmailUserbMgtWin").jqxWindow("close")}})}})}else Core.alert({message:"邮件格式不正确，请确认邮件格式！",callback:function(){$("#sendEmailUserbMgtWin").jqxWindow("close"),$("#editUserbMgtWin").jqxWindow("open",function(){$("#edit-loginId").val(i.loginId),$("#edit-name").val(i.name),$("#edit-taxType").val(i.taxType),$("#edit-vat").val(i.vat+"%"),$("#edit-MgtDate").val(i.mouthDate),$("#edit-taxpayer").val(i.owerTaxCode),$("#edit-sTime").val(i.startDate),$("#edit-eTime").val(i.endDate),$("#edit-period").val(i.dateType),$("#edit-amount").val(money(i.payAmt)),$("#edit-phone").val(void 0==i.regTelephone?"":i.regTelephone),$("#edit-email").val(void 0==i.email?"":i.email)})}})})})}),hiddenAclick()},this.unbindAll=function(){$("#userb-search").off("click"),$("#addUserSubmitBtn").off("click"),$("#editUserSubmitBtn").off("click"),$("#userbMgtConfirmBtn").off("click"),$("#partUserSubmitBtn").off("click"),$("#receiptUserSubmitBtn").off("click"),$("#sendEmailUserSubmitBtn").off("click")}};