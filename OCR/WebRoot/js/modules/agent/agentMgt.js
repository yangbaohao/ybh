var AgentMgt=function(){var e=this,a=_global_settings.service.url+"/salesagent";this.initInput=function(){e.initAgentPage(),e.initSearch(),e.initGrid(e.searchObj),e.agentChange()},this.agentChange=function(){for(var e=ComboBoxSources.getRecords("allSenior"),a=0;a<e.length;a++)e[a].name_user=e[a].userInfo.name+"("+e[a].agentName+")",e[a]._user=e[a].agentName;$("#agent-name").comboBox({source:e,searchMode:"contains",displayMember:"name_user",valueMember:"_user",width:"100%"}),$("#agentSenior").on("select",function(){var a=null,t=$("#agentSenior").val();"small"==t&&(a=ComboBoxSources.getRecords("notSenior")),"big"==t&&(a=ComboBoxSources.getRecords("isSenior")),"all"==t&&(a=ComboBoxSources.getRecords("allSenior"));for(var n=0;n<a.length;n++)a[n].name_user=a[n].userInfo.name+"("+a[n].agentName+")",e[n]._user=e[n].agentName;$("#agent-name").comboBox({source:a,width:"100%"})})},this.initAgentPage=function(){$("#agent-show").css("display",""),$("#agentCustomer").dropDownlist({source:{client:"成功客户",free:"付费客户"},width:"100%",height:34,selectedIndex:0}),$("#agentSenior").dropDownlist({source:{all:"全部代理",small:"普通代理",big:"高级代理"},width:"100%",height:34,selectedIndex:0}),$("#agent-customer").comboBox({source:ComboBoxSources.getRecords("custService_name"),searchMode:"contains",displayMember:"name_user",valueMember:"username",width:"100%"}),$("#agent-lebal").comboBox({source:ComboBoxSources.getRecords("agentLabel"),searchMode:"contains",displayMember:"lebal",valueMember:"lebal",width:"100%"}),$("#agent-time").dropDownlist({source:["请选择","最近一周","最近两周","最近三周","本月","本季度","本年"],theme:"energyblue",width:"100%",height:"34px",selectedIndex:0,dropDownHeight:150}),$("#agent-sTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#agent-eTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#agent-time").on("change",function(){setValueById("agent-time","agent-sTime","agent-eTime")}),$("#agent-head").comboBox({source:ComboBoxSources.getRecords("salesInfo_name"),searchMode:"contains",displayMember:"name_user",valueMember:"username",width:"100%"}),$("#agent-show").addClass("row hiddendiv")},this.initColumns=function(){var e=[{text:"日期",width:"8%",cellsrenderer:function(e,a,t,n,r,i){return'<div class="agrid">'+i.userInfo.createDate.substring(0,10)+"</div>"}},{text:"用户名",width:"10%",cellsrenderer:function(e,a,t,n,r,i){var s='<div class="agrid">';return(s+='<a class="hoverspan viewAgent">')+i.agentName+"</a></div>"}},{text:"电话号码",dataField:"phone",width:"10%",cellsrenderer:function(e,a,t,n,r,i){return'<div class="agrid">'+i.userInfo.telephone+"</a></div>"}},{text:"佣金系数",width:"6%",cellsrenderer:function(e,a,t,n,r,i){var s='<div class="agrid">';return(s+=100*i.rate+"%")+"</div>"}},{text:"成功客户",dataField:"client",width:"6%",cellsrenderer:function(e,a,t,n,r,i){var s='<div class="agrid">';return(s+='<a class="hoverspan succeedAgent">')+i.client+"</a></div>"}},{text:"付费客户",dataField:"feeClient",width:"6%",cellsrenderer:function(e,a,t,n,r,i){var s='<div class="agrid">';return(s+='<a class="hoverspan payAgent">')+i.feeClient+"</a></div>"}},{text:"销售负责人(姓名/用户名)",width:"11%",cellsrenderer:function(e,a,t,n,r,i){var s='<div class="agrid">';return(s+=void 0==i.sales?"":getSalesInfoById(i.sales.id).name_user)+"</div>"}},{text:"客服人员(姓名/用户名)",width:"10%",cellsrenderer:function(e,a,t,n,r,i){var s='<div class="agrid">';return(s+=void 0==i.customer?"":getCustomerInfoById(i.customer.id).name_user)+"</div>"}},{text:"父级代理(姓名/用户名)",dataField:"parentAgentName",width:"10%",cellsrenderer:function(e,a,t,n,r,i){var s='<div class="agrid">';return(s+=void 0==i.parentAgentCode?"":getAgentInfoById(null,i.parentAgentCode).name_user)+"</div>"}},{text:'标签<div class="userMgtDiv"><a class="hoverspan md-add addAgentLabel"></a></div>',dataField:"lebal",width:"8%"},{text:"状态",width:"6%",hidden:!1,cellsrenderer:function(e,a,t,n,r,i){var s='<div class="agrid">';return(s+=void 0==i.user?"":getCodeData(i.user.locked))+"</div>"}},{text:"操作",width:"9%",cellsrenderer:function(e,a,t,n,r,i){var s='<div class="text-center">';return s+='<a class="hoverspan md-format-list-bulleted fpSalesAgent" title="分配信息"></a>',s+='<a class="hoverspan md-edit editAgentLebal" title="编辑标签"></a>',s+='<a class="hoverspan md-note-add addAgentRemark" title="添加备注"></a>',s+='<a class="hoverspan md-error disableAgentBtn" title="禁用"></a>',s+="</div>"}}],a=getCurrentInfo();if("sys"!=a)for(var t in e)e[t].width="9.09%","状态"==e[t].text&&(e[t].hidden=!0),"操作"==e[t].text&&(e[t].cellsrenderer=function(e,t,n,r,i,s){var d='<div class="text-center">';return"sale"==a&&"customer"==a||(d+='<a class="hoverspan md-format-list-bulleted fpSalesAgent" title="分配信息"></a>'),d+='<a class="hoverspan md-edit editAgentLebal" title="编辑标签"></a>',d+='<a class="hoverspan md-note-add addAgentRemark" title="添加备注"></a>',d+="</div>"});return e},this.initGrid=function(){e.settings.source.data=e.searchObj;var a=Core.AcDataAdapter("agentGrid",e.settings.source,{beforeLoadComplete:function(e){}},!1),t={source:a,rendergridrows:function(){return a.recordids},columns:e.initColumns(),pagesize:20,columnsheight:45};$("#agentGrid").grid(t),$("#agentGrid").on("click",".disableAgentBtn",function(){var e=$("#agentGrid").jqxGrid("getselectedrowindex"),a=$("#agentGrid").jqxGrid("getrowdata",e);disabledUser(a.user.id,a.agentName,a.user.locked)}),$("#agentGrid").on("click",".fpSalesAgent",function(){var e=$("#agentGrid").jqxGrid("getselectedrowindex"),a=$("#agentGrid").jqxGrid("getrowdata",e);allotSale(a)}),$("#agentGrid").on("click",".editAgentLebal",function(){var e=$("#agentGrid").jqxGrid("getselectedrowindex"),a=$("#agentGrid").jqxGrid("getrowdata",e);addUserLabel(a.id,a.lebal,"agentLabel")}),$("#agentGrid").on("click",".addAgentRemark",function(){var e=$("#agentGrid").jqxGrid("getselectedrowindex"),a=$("#agentGrid").jqxGrid("getrowdata",e);addRemark(a.trackList,a.id,"agent")}),$("#agentGrid").on("click",".addAgentLabel",function(){addUserLabel(null,null,"agentLabel")}),$("#agentGrid").on("click",".viewAgent",function(){var e=$("#agentGrid").jqxGrid("getselectedrowindex");if(e>=0){var a=$("#agentGrid").jqxGrid("getrowdata",e);$.addTab({title:"查看代理商",url:"page/modules/agent/viewAgentMgt.html",pk:{id:a.id},reload:!0})}}),$("#agentGrid").on("click",".succeedAgent",function(){var e=$("#agentGrid").jqxGrid("getselectedrowindex");if(e>=0){var a=$("#agentGrid").jqxGrid("getrowdata",e);$.addTab({title:"查看成功用户",url:"page/modules/agent/viewSuccessAgent.html",pk:{agentCode:a.agentCode,id:a.id,agentName:a.agentName},reload:!0})}}),$("#agentGrid").on("click",".payAgent",function(){var e=$("#agentGrid").jqxGrid("getselectedrowindex");if(e>=0){var a=$("#agentGrid").jqxGrid("getrowdata",e);$.addTab({title:"查看付费用户",url:"page/modules/agent/viewPaidAgent.html",pk:{agentCode:a.agentCode,id:a.id,agentName:a.agentName},reload:!0})}})},this.settings={source:{url:a+"/page",data:e.searchObj},grid:{element:"userGrid"},ajax:{url:a}},this.searchObj={},this.initSearch=function(){e.searchObj={"userInfo.createDate":{value:[],action:"between"},agentName:{value:[],action:"like"},lebal:{value:[],action:"like"},"customer.username":{value:[],action:"like"},"userInfo.telephone":{value:[],action:"like"},"sales.username":{value:[],action:"like"},"o.client":{value:[],action:"between"},feeClient:{value:[],action:"between"},senior:{value:[],action:"eq"}},"salesStaff"==_global_settings.owner.roleName&&(e.searchObj["sales.id"]={value:[""+_global_settings.owner.userid],action:"eq"})},this.searchDataInfo=function(){$("#agentGrid").jqxGrid("applyfilters"),$("#agentGrid").jqxGrid("refreshfilterrow"),$("#agentGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#agentGrid").jqxGrid("updatebounddata","cells"),$("#agentGrid").jqxGrid("clearselection"),$("#agentGrid").jqxGrid("refreshdata")}},AgentBindModle=function(e){var a=this;this.search=function(){var a=$("#agent-name").val(),t=$("#agent-head").val(),n=$("#agent-customer").val(),r=$("#agent-sTime").val(),i=$("#agent-eTime").val(),s=$("#agent-lebal").find("input").val(),d=$("#agent-phone").val(),l=$("#agent-sc").val(),o=$("#agent-ec").val(),c=$("#agentCustomer").val();e.searchObj["o.client"].value=[],e.searchObj.feeClient.value=[],"client"==c&&""!=l&&""!=o&&e.searchObj["o.client"].value.push(l,o),"free"==c&&""!=l&&""!=o&&e.searchObj.feeClient.value.push(l,o),e.searchObj["userInfo.telephone"].value=[],""!=d&&e.searchObj["userInfo.telephone"].value.push(d),e.searchObj.lebal.value=[],""!=s&&e.searchObj.lebal.value.push(s),e.searchObj["customer.username"].value=[],""!=n&&e.searchObj["customer.username"].value.push(n);var g=$("#agentSenior").val();e.searchObj.senior.value=[],"small"==g&&e.searchObj.senior.value.push("N"),"big"==g&&e.searchObj.senior.value.push("Y"),e.searchObj.agentName.value=[],""!=a&&e.searchObj.agentName.value.push(a),e.searchObj["userInfo.createDate"].value=[],""!=r&&""!=i&&e.searchObj["userInfo.createDate"].value.push(r+" 00:00:00",i+" 23:59:59"),""!=r&&""===i&&e.searchObj["userInfo.createDate"].value.push(r+" 00:00:00",getNowFormatDate()+" 23:59:59"),""===r&&""!=i&&e.searchObj["userInfo.createDate"].value.push("2015-01-01 00:00:00",i+" 23:59:59"),e.searchObj["sales.username"].value=[],""!=t&&e.searchObj["sales.username"].value.push(t),e.searchDataInfo()},this.bind=function(){$("#agent-search").on("click",function(){$("#agent-show").is(":hidden")?$("#agent-show").slideDown("slow"):a.search()}),hiddenAclick(),$("#addagent-btn").on("click",function(){$.addTab({title:"新增代理商",url:"page/modules/agent/addAgentMgt.html",reload:!0})})},this.unbindAll=function(){$("#agent-search").off("click"),$("#fpSalesAgentBtn").off("click")}};