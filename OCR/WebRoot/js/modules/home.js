var HomeMgt=function(){var e=this,r=20,a=_global_settings.owner.roleName;this.initInput=function(){e.initUserPage(),e.initSearch(),e.initPlaceOrders(),e.initOcrOrderGrid(),e.bind(),e.unbindAll()},this.initUserPage=function(){$("#ocrOrder-show").css("display","");var e={all:"请选择",stayOrder:"待抢单",orderSuccess:"抢单成功",orderSubmit:"待审核",checking:"审核中",checkSuccess:"审核通过",checkFailed:"审核不通过",checkingAgain:"复核中",checkAgainSuccess:"复核通过",checkAgainFailed:"复核不通过",complete:"客户成功确认",checkRefused:"客户拒绝",orderSubmitAgain:"再次提交",kfReject:"客服驳回",KHBackout:"客户撤销",KHSubmitAgain:"客户重新提交"};$("#ocrOrder-status").dropDownlist({source:e,selectedIndex:0}),$("#ocrOrder-serviceType").dropDownlist({source:{all:"请选择",emergency:"加急",general:"一般",veryEmergency:"特别加急"},selectedIndex:0,dropDownHeight:120}),$("#ocrOrder-responsibleName").comboBox({source:ComboBoxSources.getRecords("getEmployee"),displayMember:"name",valueMember:"name"}),$("#ocrOrder-submitDate").dropDownlist({source:{"logsum.createDate":"提交日期",orderSuccessDate:"接单时间",orderSubmitDate:"完成时间",checkBeginDate:"审核开始时间",checkSuccessDate:"审核完成时间"},selectedIndex:0,dropDownHeight:150}),$("#ocrOrder-date").dropDownlist({source:{0:"请选择",1:"最近一周",2:"最近两周",3:"最近三周",4:"本月",5:"本季度",6:"本年"},selectedIndex:0,dropDownHeight:120}),$("#ocrOrder-sDate,#ocrOrder-eDate").datetimeinputs(),$("#ocrOrder-date").on("change",function(){setValueById("ocrOrder-date","ocrOrder-sDate","ocrOrder-eDate")}),$("#ocrOrder-userName").comboBox({source:ComboBoxSources.getRecords("username"),displayMember:"name",valueMember:"name"}),$("#ocrOrder-ownerName").comboBox({source:ComboBoxSources.getRecords("company"),displayMember:"company",valueMember:"company"}),$("#ocrOrder-show").addClass("hiddendiv")},this.searchObj={},this.initSearch=function(){e.searchObj={"logsum.orderApprovalStatus":{value:[],action:"eq"},serviceType:{value:[],action:"eq"},"CONCAT(userinfo2.name,'(', bsssysuser.username,')')":{value:[],action:"like"},"logsum.createDate":{value:[],action:"between"},orderSuccessDate:{value:[],action:"between"},orderSubmitDate:{value:[],action:"between"},checkBeginDate:{value:[],action:"between"},checkSuccessDate:{value:[],action:"between"},"logsum.orderNumber":{value:[],action:"like"},"sysuser.username":{value:[],action:"like"},"userinfoe.name":{value:[],action:"like"},"userinfo.telephone":{value:[],action:"like"}}},this.initPlaceOrders=function(){var e=null;"Ocr_auditor"==a?($("#placeOrdersTitle").text("待审核列表"),e=_global_settings.service.url+"/overview/waitCheck"):e=_global_settings.service.url+"/overview/waitOrder",$("#placeOrders").html(""),Core.AjaxRequest({type:"GET",url:e,callback:function(e){for(var r=0,a=e.length;r<a;r++){var t=e[r].serviceType,s='<div class="inbox-item row p-0 m-0"><div class="col-lg-12 p-0 m-0"><div class="p-t-10 m-l-15"><a class="serviceTypeAlink"><p class="m-0">'+getCodeData(t)+"："+e[r].orderQty+'单</p><p class="m-0"><span style="font-size:12px;">'+e[r].begingDate+'</span><span style="font-size:12px;">—'+e[r].endDate+"</span></p></a></div></div>";$("#placeOrders").append(s),$(".serviceTypeAlink").eq(r).data("type",t),"emergency"!=t&&"checkRefused"!=t||$("#placeOrders").find(".serviceTypeAlink").eq(r).css("color","red")}}})},window.initPlaceOrders=e.initPlaceOrders,this.initBizLog=function(){var e={condition:[],filterscount:0,groupscount:0,pagenum:0,pagesize:20},r=_global_settings.service.url+"/overview/searchLogInfo/"+(new Base64).encode(JSON.stringify(e));Core.AjaxRequest({type:"GET",url:r,callback:function(e){for(var r=e.rows,a=0,t=r.length;a<t;a++){var s=void 0==r[a].orderNumber?"":r[a].orderNumber,i='<div class="time-item"><div class="item-info"><div class="text-muted">'+r[a].createBy+" "+getCodeData(r[a].handletype)+"<br/><a>"+s+"</a></div><p>"+r[a].handleDate+"</p></div></div>";$("#operationLog").append(i)}}})},this.initOcrOrderGrid=function(){var a={data:e.searchObj,url:_global_settings.service.url+"/overview/search/salesorder/byvo",type:"get"},t=Core.AcDataAdapter("userInformationGrid",a,{beforeLoadComplete:function(e){},loadComplete:function(e){r=e.totalRows<=20?20:e.totalRows}},e.debug),s={source:t,rendergridrows:function(){return t.recordids},pagesize:20,sortable:!0,enablehover:!1,columnsheight:45,columns:e.initColumns()};$("#userInformationGrid").grid(s)};var t=function(e,r,t,s,i,o){var c='<div class="agrid">';switch(i.text){case"用户名":var d=o.userName,n=void 0==o.ocrCount?0:o.ocrCount;return(c+=n>0&&n<4?d+'<span class="count">'+n+"</span></div>":d)+"<div>";case"单号":return"stayOrder"==o.orderType?c+=o.orderNumber:"Ocr_auditor"==a&&"orderSubmit"==o.orderType?c+=o.orderNumber:c+='<a class="hoverspan viewOcrSalesOrder">'+o.orderNumber+"</a>",c+"</div>";case"服务类型":return c="emergency"==o.serviceType?'<div class="agrid" style="color:red;" title="'+getCodeData(o.serviceType)+'">':'<div class="agrid" title="'+getCodeData(o.serviceType)+'">',(c+=getCodeData(o.serviceType)+"</div>")+"</div>";case"单据状态":var l=o.orderType;return c="stayOrder"==l||"checkRefused"==l||"checkFailed"==l|"checkAgainFailed"==l?'<div class="agrid"><a class="hoverspan viewOcrOrderStatus" title="查看单据状态" style="color:red;">':'<div class="agrid"><a class="hoverspan viewOcrOrderStatus" title="查看单据状态">',(c+=getCodeData(o.orderType)+"</a>")+"</div>";case"操作":c='<div class="text-center">';var l=o.orderType;return"Ocr_createBy"!=a&&"Ocr_Admin"!=a&&"Ocr_group"!=a||"stayOrder"==l&&(c+='<a class="hoverspan md-play-install getSalerOrder" title="抢单"></a>'),"Ocr_auditor"!=a&&"Ocr_Admin"!=a&&"Ocr_group"!=a||"orderSubmit"!=l&&"orderSubmitAgain"!=l||(c+='<a class="hoverspan md-check-box checkSalerOrder" title="审批"></a>'),c+"</div>"}};this.initColumns=function(){return[{text:"用户名",datafield:"userName",width:"8%",cellsrenderer:t},{text:"商户名称",datafield:"ownerName",width:"10%"},{text:"单号",datafield:"orderNumber",width:"10%",cellsrenderer:t},{text:"产品数量",datafield:"detailQty",width:"5%"},{text:"服务类型",width:"5%",cellsrenderer:t},{text:"单据状态",width:"7%",cellsrenderer:t},{text:"制单人",datafield:"responsibleName",width:"8%"},{text:"审核人",datafield:"checkName",width:"8%"},{text:"客户提交",datafield:"submitDate"},{text:"接单时间",datafield:"orderSuccessDate"},{text:"制单完成",datafield:"orderSubmitDate"},{text:"审单时间",datafield:"checkBeginDate"},{text:"审单完成",datafield:"checkSuccessDate"},{text:"用户确认",datafield:"completeDate"},{text:"操作",width:"4%",cellsrenderer:t}]},window.initCol=e.initColumns,(new quickKey).anyKey(),this.searchDataInfo=function(){$("#userInformationGrid").jqxGrid("applyfilters"),$("#userInformationGrid").jqxGrid("refreshfilterrow"),$("#userInformationGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#userInformationGrid").jqxGrid("updatebounddata","cells"),$("#userInformationGrid").jqxGrid("clearselection"),$("#userInformationGrid").jqxGrid("refreshdata")},this.search=function(){var r=$("#ocrOrder-status").val(),a=$("#ocrOrder-serviceType").val(),t=$("#ocrOrder-responsibleName").val(),s=$("#ocrOrder-number").val(),i=$("#ocrOrder-userName").val(),o=$("#ocrOrder-ownerName").val(),c=$("#ocrOrder-phone").val(),d=$("#ocrOrder-sDate").val(),n=$("#ocrOrder-eDate").val(),l=$("#ocrOrder-submitDate").val();e.searchObj["logsum.orderApprovalStatus"].value=[],"all"!=r&&e.searchObj["logsum.orderApprovalStatus"].value.push(r),e.searchObj.serviceType.value=[],"all"!=a&&e.searchObj.serviceType.value.push(a),e.searchObj["CONCAT(userinfo2.name,'(', bsssysuser.username,')')"].value=[],""!=t&&e.searchObj["CONCAT(userinfo2.name,'(', bsssysuser.username,')')"].value.push(t),e.searchObj["logsum.orderNumber"].value=[],""!=s&&e.searchObj["logsum.orderNumber"].value.push(s),e.searchObj["sysuser.username"].value=[],""!=i&&e.searchObj["sysuser.username"].value.push(i),e.searchObj["userinfoe.name"].value=[],""!=o&&e.searchObj["userinfoe.name"].value.push(o),e.searchObj["userinfo.telephone"].value=[],""!=c&&e.searchObj["userinfo.telephone"].value.push(c),e.searchObj["logsum.createDate"].value=[],e.searchObj.orderSuccessDate.value=[],e.searchObj.orderSubmitDate.value=[],e.searchObj.checkBeginDate.value=[],e.searchObj.checkSuccessDate.value=[],""!=d&&""!=n&&(e.searchObj[l].value.push(d+" 00:00:00",n+" 23:59:59"),e.searchObj[l].action="between"),""===d&&""!=n&&(e.searchObj[l].value.push(n+" 23:59:59"),e.searchObj[l].action="le"),""!=d&&""===n&&(e.searchObj[l].value.push(d+" 00:00:00"),e.searchObj[l].action="ge"),e.searchDataInfo()},this.bind=function(){$("#ocrOrder-search").on("click",function(){$("#ocrOrder-show").is(":hidden")?$("#ocrOrder-show").slideDown("slow"):e.search()}),hiddenAclick(),$("#placeOrders").on("click",".serviceTypeAlink",function(){var r=$(this).data("type");$("#ocrOrder-serviceType").jqxDropDownList({selectedIndex:0}),$("#ocrOrder-status").jqxDropDownList({selectedIndex:0}),"checkRefused"!=r&&"KHSubmitAgain"!=r?"Ocr_auditor"==a?$("#ocrOrder-status").val(r):"checkAgainFailed"==r||"checkFailed"==r?$("#ocrOrder-status").val(r):($("#ocrOrder-serviceType").val(r),$("#ocrOrder-status").val("stayOrder")):$("#ocrOrder-status").val(r),e.search()});var t=function(e){$("#view_prove").modal("show");var r={localdata:e,datatype:"array"},a=new $.jqx.dataAdapter(r),t=function(e,r,a,t,s,i){var o='<div class="agrid">',c="";switch(i.handleType){case"orderSubmitAgain":c=void 0==i.submitRemark?"":i.submitRemark;break;case"KFReject":c=void 0==i.rejectRemark?"":i.rejectRemark;break;case"checkSuccess":case"checkFailed":c=void 0==i.checkRemark?"":i.checkRemark;break;case"checkRefused":c=void 0==i.refusedRemark?"":i.refusedRemark;break;default:c=""}return o+=getCodeData(i.handleType),""!=c&&(o+="："),(o+=c)+"</div>"},s=[{text:"更新时间",datafield:"handleDate",width:"33%"},{text:"备注",datafield:"remark",width:"33%",cellsrenderer:t},{text:"更新人",datafield:"createBy",width:"34%"}];$("#view_prove_grid").jqxGrid({source:a,width:"100%",height:160,pageable:!1,columns:s,autorowheight:!0,autoheight:!0})};$("#userInformationGrid").on("click",".viewOcrOrderStatus",function(){var e=$("#userInformationGrid").jqxGrid("getSelectedrowindex");if(e>=0){var r=$("#userInformationGrid").jqxGrid("getrowdata",e);Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/overview/orderSalesLogs/getlist/"+r.uuid,showMsg:!1,callback:function(e){0==$("#view_prove").length?$.loadModal("page/common/segment/viewProve.html",function(r){$("body").append(r),t(e)}):t(e)}})}}),$("#userInformationGrid").on("click",".getSalerOrder",function(){var e=$("#userInformationGrid").jqxGrid("getSelectedrowindex");if(e>=0){var r=$("#userInformationGrid").jqxGrid("getrowdata",e);"stayOrder"==r.orderType&&Core.AjaxRequest({type:"PUT",url:_global_settings.service.url+"/overview/orderSuccess/"+r.uuid,showMsg:!1,callback:function(e){try{$("#userInformationGrid").jqxGrid("updatebounddata","cells"),Core.alert({message:"抢单成功，正在为您跳转至销售单界面...",hide:"500",callback:function(){$.addTab({title:"新建销售单",url:"page/modules/biz/addSaleOrder.html",isFrame:!1,pk:{data:r},reload:!0})}})}catch(e){}},failure:function(e){var r=JSON.parse(e.responseText);Core.alert({message:r.errorMsg})}})}}),$("#userInformationGrid").on("click",".viewOcrSalesOrder",function(){var e=$("#userInformationGrid").jqxGrid("getSelectedrowindex");if(e>=0){var r=$("#userInformationGrid").jqxGrid("getrowdata",e),t=r.orderType;"orderSuccess"==t||"KHSubmitAgain"==t?"Ocr_auditor"==a?Core.alert({message:"此订单处于"+getCodeData(r.orderType)+"状态，不可审核!"}):$.addTab({title:"新建销售单",url:"page/modules/biz/addSaleOrder.html",isFrame:!1,pk:{data:r},reload:!0}):$.addTab({title:"查看销售单",url:"page/modules/biz/viewSaleOrder.html",isFrame:!1,pk:{data:r},reload:!0})}}),$("#userInformationGrid").on("click",".checkSalerOrder",function(){var e=$("#userInformationGrid").jqxGrid("getSelectedrowindex");if(e>=0){var r=$("#userInformationGrid").jqxGrid("getrowdata",e),a=r.orderType;["stayOrder","orderSuccess","checkFailed","checkAgainSuccess","checkAgainFailed","checkRefused"].indexOf(a)>-1&&Core.alert({message:"此订单处于"+getCodeData(r.orderType)+"状态，不可审核!"}),"orderSubmit"!=a&&"checkSuccess"!=a&&"orderSubmitAgain"!=a||$.addTab({title:"查看销售单",url:"page/modules/biz/viewSaleOrder.html",isFrame:!1,pk:{data:r},reload:!0})}});var s=function(){null!=i&&clearTimeout(i),$("#userInformationGrid").jqxGrid("updatebounddata","cells"),e.initPlaceOrders(),setTimeout(arguments.callee,18e4)},i=null;i=setTimeout(s,18e4),$("#home-fixed").off("click").on("click",function(){$("#homeFixedImg").attr("src").indexOf("toLeft")>-1?($("#home-left").removeClass("col-md-12").addClass("col-md-10"),$("#home-right").removeClass("hide"),$("#homeFixedImg").attr("src","images/common/toRight.png")):($("#home-left").removeClass("col-md-10").addClass("col-md-12"),$("#home-right").addClass("hide"),$("#homeFixedImg").attr("src","images/common/toLeft.png")),$("#userInformationGrid").resize()}),$("#ocrOrder-export").off("click").on("click",function(){var a=e.searchObj,t=getConditionParams(a,r);$.openHref(_global_settings.service.url+"/overview/search/salesorder/export/"+t)}),$("#index_img").off("click").on("click",function(){"展开"==$(this).attr("title")?($("aside").css({width:140}),$("article").css({"margin-left":150}),$("#zqw_tabs").css({"margin-left":140}),$("#level1_menu").find("span").removeClass("hide"),$(this).attr("title","收起").css({transform:"rotate(180deg)","margin-left":102}),$("#logo").find("img").eq(0).removeClass("hide")):($("aside").css({width:50}),$("article").css({"margin-left":60}),$("#zqw_tabs").css({"margin-left":50}),$("#level1_menu").find("span").addClass("hide"),$(this).attr("title","展开").css({transform:"rotate(0deg)","margin-left":-88}),$("#logo").find("img").eq(0).addClass("hide")),$("#userInformationGrid").resize()})},this.unbindAll=function(){$("#home-fixedIn").off()}};