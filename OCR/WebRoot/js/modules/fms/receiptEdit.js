var ReceiptEdit=function(){var e,t,r=this,n=_global_settings.service.url,a=null;this.initInput=function(){a=$.pk.data,r.initInterface(),r.initUserPage(),r.initPage(),r.initValidator(),r.bindModel()},this.initInterface=function(){Core.AjaxRequest({url:n+"/common/getAllclient/Y/"+currentUserInfo.id,type:"GET",async:!1,callback:function(t){e=t},failure:function(){}}),Core.AjaxRequest({url:n+"/common/getAllclient/N/"+currentUserInfo.id,type:"GET",async:!1,callback:function(e){t=e},failure:function(){}})},this.initUserPage=function(){"sales"==a.receiptType?($("#receiptEdit-radioOut").attr("checked",!0),$("#rcptEdit-account").parent().parent().find("label:first").text("收款账户")):"purchase"==a.receiptType&&($("#receiptEdit-radioIn").attr("checked",!0),$("#rcptEdit-account").parent().parent().find("label:first").text("付款账户")),$("#receiptEdit-radioOut").attr("disabled",!0),$("#receiptEdit-radioIn").attr("disabled",!0),$("#rcptEdit-category").dropDownlist({source:{otherinvoice:"其他",specialinvoice:"增值税专用发票",ordinaryinvoice:"增值税普通发票"},width:"100%",height:"34px",disabled:!1,selectedIndex:0});var i=["0%","3%","6%","11%","13%","17%"];$("#rcptEdit-tax").dropDownlist({source:i,theme:currentTheme,width:"100%",height:"34px",dropDownHeight:200,selectedIndex:0}),$("#rcptEdit-time").datetimeinput({width:"100%",height:33,value:new Date,formatString:"yyyy-MM-dd"}),$("#receiptEdit-radioOut")[0].checked?($("#rcptEdit-reasons").coaCombboxChoose({width:"100%",height:34,theme:currentTheme,displayMember:"name",valueMember:"id",selectedIndex:0,searchMode:"contains"},["6001","6051"]),$("#rcptEdit-account").coaCombboxChoose({width:"100%",height:34,theme:currentTheme,displayMember:"name",valueMember:"id",selectedIndex:0,searchMode:"contains"},["1122","1001","1002"]),$("#rcptEdit-clientName").jqxComboBox({source:e,displayMember:"name",valueMember:"clientId",width:"100%",height:"34px"}),$("#rcptEdit-account").parent().parent().find("label:first").text("收款账户")):$("#receiptEdit-radioIn")[0].checked&&($("#rcptEdit-reasons").coaCombboxChoose({width:"100%",height:34,theme:currentTheme,displayMember:"name",valueMember:"id",selectedIndex:0,searchMode:"contains"},["1405","1403","6601","6602","6603","5301"]),$("#rcptEdit-account").coaCombboxChoose({width:"100%",height:34,theme:currentTheme,displayMember:"name",valueMember:"id",selectedIndex:0,searchMode:"contains"},["2202","1001","1002"]),$("#rcptEdit-clientName").jqxComboBox({source:t,displayMember:"name",valueMember:"clientId",width:"100%",height:"34px"}),$("#rcptEdit-account").parent().parent().find("label:first").text("付款账户"))},this.getClientCustomer=function(e){for(i=0;i<clientCRd.length;i++)if(e==clientCRd[i].clientId)return clientCRd[i];if(!e)return""},this.getClientAgent=function(e){for(i=0;i<clientARd.length;i++)if(e==clientARd[i].clientId)return clientARd[i];if(!e)return""},this.getClientCustomerByName=function(e){for(i=0;i<clientCRd.length;i++)if(e==clientCRd[i].name)return clientCRd[i];if(!e)return""},this.getClientAgentByName=function(e){for(i=0;i<clientARd.length;i++)if(e==clientARd[i].name)return clientARd[i];if(!e)return""},this.initPage=function(){void 0!=a.clientId?void 0!=r.getClientCustomer(a.clientId)?$("#rcptEdit-clientName").val(r.getClientCustomer(a.clientId).name):void 0!=r.getClientAgent(a.clientId)&&$("#rcptEdit-clientName").val(r.getClientAgent(a.clientId).name):void 0!=a.name?$("#rcptEdit-clientName").val(a.name):$("#rcptEdit-clientName").val("");var e=ComboBoxSources.getInfoMapOrderByKey("chartOfAccounts","id",a.coaReason.id),t=ComboBoxSources.getInfoMapOrderByKey("chartOfAccounts","id",a.coaDeposit.id);$("#rcptEdit-reasons").val(void 0==a.coaReason?e:a.coaReason.displayValue),$("#rcptEdit-account").val(void 0==a.coaDeposit?t:a.coaDeposit.displayValue),$("#rcptEdit-type").val(void 0==a.receiptType?"":a.receiptType),$("#rcptEdit-num").val(void 0==a.receiptNumber?"":a.receiptNumber),$("#rcptEdit-time").val(void 0==a.entryDate?"":a.entryDate),$("#rcptEdit-moneyType").val("人民币"),$("#rcptEdit-tax").val(a.taxRate+"%"),$("#rcptEdit-sum").input({width:"98%",height:33}).moneyinput(),$("#rcptEdit-sum").val(money(a.receiptAmt)),$("#rcptEdit-addremarkPrint").val(a.remark2),$("#rcptEdit-addremark").val(a.remark),$("#rcptEdit-addattachment").fileuploader({bool:!0,url:_global_settings.service.url+"/common/file/"+currentUserInfo.id,avision:!0}),$("#rcptEdit-nosum").val(money(a.unuseAmt)),"otherinvoice"==a.receiptInvoiceType?$("#rcptEdit-category").val("otherinvoice"):"specialinvoice"==a.receiptInvoiceType?$("#rcptEdit-category").val("specialinvoice"):"ordinaryinvoice"==a.receiptInvoiceType?$("#rcptEdit-category").val("ordinaryinvoice"):$("#rcptEdit-category").val("")},this.initValidator=function(){$("#rcptEdit-addForm").jqxValidator({animationDuration:1,hintType:"label",rules:[{input:"#rcptEdit-clientName",message:"不能为空",action:"keyup,blur",rule:function(e,t){return""!==e.val()}},{input:"#rcptEdit-category",message:"请选择",action:"change, select",rule:function(e,t){return""!==e.val()&&null!=e.jqxDropDownList("getSelectedItem")}},{input:"#rcptEdit-time",message:"不能为空",action:"change, select",rule:function(e,t){return""!==e.val()}},{input:"#rcptEdit-num",message:"发票号码不能为空",action:"keyup,blur",rule:function(e,t){return""!=e.val()}},{input:"#rcptEdit-sum",message:"请输入数字",action:"keyup,blur",rule:IsNum},{input:"#rcptEdit-sum",message:"不能小于0",action:"keyup,blur",rule:function(e,t){return!(e.val()<0)}}]})},this.bindModel=function(){$("#rcptEdit-addsave").on("click",function(){r.submitParam(r.initParam())}),$("#rcptEdit-sum").keyup(function(){$("#rcptEdit-nosum").val(money($("#rcptEdit-sum").val()))})},this.initParam=function(){var e=[];$("#rcptEdit-addattachment").find(".item").each(function(t,i){var r=$(i).attr("data-id");void 0!==r&&e.push(r)});var t={};t.id=a.id,t.receiptNumber=$("#rcptEdit-num").val(),t.entryDate=$("#rcptEdit-time").val(),t.receiptAmt=money($("#rcptEdit-sum").val()),t.taxRate=$("#rcptEdit-tax").val().replace("%",""),t.receiptInvoiceType=$("#rcptEdit-category").val(),t.remark=$("#rcptEdit-addremark").val(),t.remark2=$("#rcptEdit-addremarkPrint").val(),t.fileInfoIds=e.toString(),t.unuseAmt=$("#rcptEdit-nosum").val(),t.coaReason={id:$("#rcptEdit-reasons").val()},t.coaDeposit={id:$("#rcptEdit-account").val()},t.createBy=_global_settings.owner.username;var i=$("#rcptEdit-clientName").find("input").val();return $("#receiptEdit-radioOut").attr("checked")&&(void 0!=r.getClientCustomerByName(i)?t.clientId=r.getClientCustomerByName(i).clientId:t.name=i,t.receiptType="sales"),$("#receiptEdit-radioIn").attr("checked")&&(void 0!=r.getClientAgentByName(i)?t.clientId=r.getClientAgentByName(i).clientId:t.name=i,t.receiptType="purchase"),t},this.submitParam=function(e){$("#rcptEdit-addForm").jqxValidator("validate")&&Core.AjaxRequest({url:n+"/ac/"+(new Base64).encode("tobss/receipt/update/"+currentUserInfo.id+"/"+currentUserInfo.loginId),type:"PUT",params:e,async:!1,showMsg:!1,callback:function(e){try{0==e.code?Core.alert({message:e.errorMsg,callback:function(){$.closeTab()}}):(setCloseAlertTimeOneSecond(),$.closeTab(),$.addTab({title:"发票",url:"page/modules/fms/receipt.html",isFrame:!1,reload:!0}))}catch(e){}},failure:function(){}})},this.unbindAll=function(){$("#rcptEdit-addsave").off()}};