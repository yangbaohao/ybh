var ReceiptMgt=function(){var e=this,t=_global_settings.service.url,r=null,n=null;this.initInput=function(){$("#receipt-show").css("display",""),$("#receipt-show").addClass("hiddendiv"),e.initInterface(),e.initGrid(e.searchObj),e.bindModel()},this.initUserPages=function(){$("#rcpt-startTime").datetimeinput({width:"100%",height:33,formatString:"yyyy-MM-dd"}),$("#rcpt-endTime").datetimeinput({width:"100%",height:33,value:new Date}),$("#rcpt-time").dropDownlist({source:["请选择 ","最近一周","最近两周","最近三周","本月","本季度","本年"],theme:"energyblue",width:"100%",height:"34px",selectedIndex:0,dropDownHeight:150}),$("#rcpt-category").dropDownlist({source:{all:"全部",otherinvoice:"其他",specialinvoice:"增值税专用发票",ordinaryinvoice:"增值税普通发票"},width:"100%",height:33}),$("#rcpt-type").dropDownlist({source:{all:"全部",sales:"开票",purchase:"收票"},width:"100%",height:33}),$("#rcpt-time").on("change",function(){var e=$("#rcpt-time").attr("id"),t=$("#rcpt-startTime").attr("id"),i=$("#rcpt-endTime").attr("id");setValueById(e,t,i)}),$("#rcpt-addchartOfAccount").coaCombbox({width:"90%",height:37,theme:currentTheme,displayMember:"name",valueMember:"id",placeHolder:"请输入",searchMode:"contains"},["1001","1002","1012"]),setTimeout(function(){$("#receipt-show").attr("class","row hiddendiv")},200)},this.initInterface=function(){Core.AjaxRequest({url:t+"/common/getAllclient/N/"+currentUserInfo.id,type:"GET",async:!1,callback:function(e){n=e},failure:function(){}}),Core.AjaxRequest({url:t+"/common/getAllclient/Y/"+currentUserInfo.id,type:"GET",async:!1,callback:function(e){r=e},failure:function(){}})},this.searchObj={receiptNumber:{value:[],action:"like"}},this.getClientCustomer=function(e){for(i=0;i<r.length;i++)if(e==r[i].clientId)return r[i];if(!e)return""},this.getClientAgent=function(e){for(i=0;i<n.length;i++)if(e==n[i].clientId)return n[i];if(!e)return""},this.initGrid=function(){e.setting.source.data=e.searchObj,e.setting.source.url=t+"/receipt/search/"+currentUserInfo.id;var i=Core.AcDataAdapter("rcpt-Grid",e.setting.source,{beforeLoadComplete:function(e){}},e.debug),r={source:i,columnsresize:!1,rendergridrows:function(){return i.recordids},columns:[{text:"公司名称",width:"15%",cellsrenderer:function(t,i,r,n,c,a){var l='<div class="jqx-grid-cell-left-align" style="margin-top: 6px;">';return void 0!=a.clientid&&(void 0!=e.getClientCustomer(a.clientid)?l+=e.getClientCustomer(a.clientid).name:void 0!=e.getClientAgent(a.clientid)&&(l+=e.getClientAgent(a.clientid).name)),l+="</div>"}},{text:"发票日期",width:"15%",cellsrenderer:function(e,t,i,r,n,c){return'<div class="grida">'+c.entryDate.substring(0,10)+"</div>"}},{text:"发票号码",dataField:"receiptNumber",width:"15%",cellsrenderer:function(e,t,i,r,n,c){var a='<div class="jqx-grid-cell-left-align" style="margin-top: 6px;">';return a+='<a class="viewRcpt hoverspan" data-btn="biz:sales:view" >'+i+"</a>",a+="</div>"}},{text:"类型",width:"15%",cellsrenderer:function(e,t,i,r,n,c){var a='<div class="jqx-grid-cell-left-align" style="margin-top: 6px;">';return a+="sales"==c.receiptType?"开票":"收票",a+="</div>"}},{text:"发票类别",dataField:"receiptInvoiceType",width:"14%",cellsrenderer:function(e,t,i,r,n,c){var a='<div class="jqx-grid-cell-left-align" style="margin-top: 6px;">';return"otherinvoice"==c.receiptInvoiceType?a+="其他":"specialinvoice"==c.receiptInvoiceType?a+="增值税专用发票":"ordinaryinvoice"==c.receiptInvoiceType?a+="增值税普通发票":a+="",a+="</div>"}},{text:"发票金额",dataField:"receiptAmt",width:"14%",cellsalign:"right",cellsformat:"c2"},{text:"未匹配金额",dataField:"unuseAmt",width:"12%",cellsalign:"right",cellsformat:"c2"}],columnsheight:50};$("#rcpt-Grid").grid(r)},this.setting={source:{data:e.searchObj},grid:{element:"rcpt-Grid"},ajax:{url:t}},this.searchDataInfo=function(){$("#rcpt-Grid").jqxGrid("applyfilters"),$("#rcpt-Grid").jqxGrid("refreshfilterrow"),$("#rcpt-Grid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#rcpt-Grid").jqxGrid("updatebounddata","cells"),$("#rcpt-Grid").jqxGrid("clearselection"),$("#rcpt-Grid").jqxGrid("refreshdata")},this.bindModel=function(){$("#rcpt-Grid").on("click",".viewRcpt",function(){var e=$("#rcpt-Grid").jqxGrid("getselectedrowindex");if(e>=0){var t=$("#rcpt-Grid").jqxGrid("getrowdata",e);void 0==t.dcmid?$.addTab({title:"发票查看",isFrame:!1,url:"page/modules/fms/receiptView.html",pk:{data:t},reload:!0}):$.addTab({title:"通用单据查看",isFrame:!1,url:"page/modules/fms/generalView.html",pk:{data:t},reload:!0})}}),$("#addrcpt-btn").on("click",function(){$.addTab({title:"新增发票",url:"page/modules/fms/receiptAdd.html"})}),$("#importrcpt-btn").on("click",function(){var e={url:t+"/ac/file/"+(new Base64).encode("tobss/receipt/importReceipt/"+_global_settings.owner.username+"/"+currentUserInfo.id+"/"+currentUserInfo.loginId)};$("#receipt-attachment").html(""),$("#receipt-modal").modal("show"),$("#receipt-attachment").fileuploader(e)}),$("#receipt-modal").find(".glyphicon-remove").on({click:function(){$(".modal-backdrop").css("display","none")}}),$("#downloadrcpt-btn").off("click").on("click",function(){if("localhost"==getHostName()||"192.168.1.3:8080/SimpleBss/".indexOf(getHostName())>-1)var e="/SimpleBss/CXF/rs/common/export/receiptImport/0";else var e="/CXF/rs/common/export/receiptImport/0";window.open(e)}),$("#rcpt-search").on("click",function(){$("#receipt-show").is(":hidden")?$("#receipt-show").slideDown("show"):e.search()}),hiddenAclick()},this.search=function(){var t=$("#rcpt-num").val();e.searchObj.receiptNumber.value=[],""!=t&&e.searchObj.receiptNumber.value.push(t),e.searchDataInfo()},this.unbindAll=function(){}};