!function(){function e(e){var t=$("#JournalEditTable> tbody").children().eq(-1);t.find(".JournalEditSelect").eq(-1).coaCombbox({width:"100%",height:"33px"});var r=e.description,a=e.chartOfAccount.id;J.push(a);var i=e.creditAmt,n=e.debitAmt,o=e.category1,l=e.category2;v+=i,t.find(".JournalEditChart").val(r),t.find(".JournalEditSelect").val(a),t.find(".JournalEditNum").eq(0).val(0===n?"":money(n)),t.find(".JournalEditNum").eq(1).val(0===i?"":money(i)),t.find(".JournalEdittp1").eq(0).val(o),t.find(".JournalEdittp2").eq(0).val(l),$("#JournalEditTable> tbody").children().eq(-1).after(c()),$(".JournalEditSelect").eq(-1).coaCombbox({width:"100%",height:"33px"}),$(".JournalEdittp1").eq(-1).comboBoxType({source:ComboBoxSources.getRecords("category1"),height:"33px"}),$(".JournalEdittp2").eq(-1).comboBoxType({source:ComboBoxSources.getRecords("category2"),height:"33px"})}function t(){$("#JournalEditTable").on("change",".JournalEdittp1",function(){$("#JournalEditTable").off("change",".JournalEdittp1"),pass=!1;var e=$(this),r=$(this).jqxComboBox("selectedIndex");$.each($(".JournalEdittp1"),function(t,a){$(a)[0]==e[0]?pass=!0:pass&&$(a).jqxComboBox({selectedIndex:r})}),t()})}function r(){$("#JournalEditTable").on("change",".JournalEdittp2",function(){$("#JournalEditTable").off("change",".JournalEdittp2"),pass=!1;var e=$(this),t=$(this).jqxComboBox("selectedIndex");$.each($(".JournalEdittp2"),function(r,a){$(a)[0]==e[0]?pass=!0:pass&&$(a).jqxComboBox({selectedIndex:t})}),r()})}function a(){isCheckEd=!1;var e=2===arguments.length?arguments[1].value:arguments[0];return isNaN(e)?($(this).focus(),$(this).css("border","solid 2px red"),isCheckEd=!1,!1):($(this).css("border",""),isCheckEd=!0,!0)}function i(e){var t={};for(var r in e){if(t[e[r]])return!0;t[e[r]]=!0}return!1}function n(){var e=[],t=0;return $.each($("#JournalEditTable>tbody>tr"),function(){var r=$(this).children();""===r.eq(2).children().val()&&""===r.eq(3).children().val()||(e[t]={description:r.eq(0).children().val(),chartOfAccount:{id:r.eq(1).children().val()},debitAmt:""===r.eq(2).children().val()?0:r.eq(2).children().val(),creditAmt:""===r.eq(3).children().val()?0:r.eq(3).children().val(),createDate:$("#datepickerEdit").val()+" "+getHMS(),category1:r.eq(4).children().val(),category2:r.eq(5).children().val()},t+=1)}),e}setTimeout($.addTabCloseEvent,200);var o=2,l=null,u=function(e){var t=$(this),r=t.val();""!=r&&a(r)?($(this).css("border",""),t.val(money(r).replace("-",""))):t.val("")},d=function(e){var t=ComboBoxSources.getRecords("taxerInfo");for(o=0;o<t.length;o++)if(e==t[o].username)return t[o];if(!e)return""},c=function(){var e="";return e+='<tr data-index="'+o+'">                                                                               ',e+='\t<td style=""><input class="JournalEditChart form-control" type="text"></td>                                                           ',e+='\t<td style=""><div class="JournalEditSelect"></div>                                                      ',e+="\t</td>                                                                                  ",e+='\t<td style=""><input class="JournalEditNum numBorrow2 form-control" type="text"></td>                                                           ',e+='\t<td style=""><input class="JournalEditNum numLoad2 form-control" type="text"></td>                                                           ',e+='\t<td style="">                                                      ',e+='\t\t\t<div class="JournalEdittp1"></div>                                                      ',e+="\t</td>                                                                                  ",e+='\t<td style="">                                                    ',e+='\t\t\t<div class="JournalEdittp2"></div>                                                  ',e+="\t</td>                                                                                  ",e+='\t<td class="del_icon" style=""><i class="    md-cancel     JournalEditDel"></i>',e+="\t</td>                                                                                           ",e+="</tr>           "};$(".JournalEdittp1").comboBoxType({source:ComboBoxSources.getRecords("category1"),height:"33px"}),$(".JournalEdittp2").comboBoxType({source:ComboBoxSources.getRecords("category2"),height:"33px"}),$("#JournalEdit-addCategory1Btn").on({click:function(){var e=$(this).attr("data");Core.showModal({type:e,broth:".JournalEdittp1",callback:function(e){}})}}),$("#JournalEdit-addCategory2Btn").on({click:function(){var e=$(this).attr("data");Core.showModal({type:e,broth:".JournalEdittp2",callback:function(e){}})}});var s=$.pk,p=!1,v=0,m=function(){var e=[];$("#JournalEditattachment").find(".item").each(function(t,r){var a=$(r).attr("data-id");void 0!==a&&e.push(a)});var t=n();return{noteNumber:$("#journalEditnoteNumber").val(),fileInfoIds:e.toString(),id:$("#journalEditid").val(),remark:$("#JournalEditRemark").val(),journalType:"input",entryDate:$("#datepickerEdit").val()+" "+getHMS(),currency:"RMB",journalNumber:l,remarkPrint:$("#JournalEditRemarkPrint").val(),journalDetails:t}};$("#JournalEdit_receiptType").dropDownlist({source:{"请选择":"请选择",specialinvoice:"增值税专用发票",ordinaryinvoice:"增值税普通发票",otherinvoice:"其他"},width:"100%",selectedIndex:0}),$("#JournalEdit_type").dropDownlist({source:{unassociation:"不匹配",inflow:"资金流入",outflow:"资金流出",OtherAssociation:"其他"}}),$("#JournalEdit_tax").dropDownlist({source:{0:"0%",3:"3%",5:"5%",6:"6%",11:"11%",13:"13%",17:"17%"},selectedIndex:0}),$("#JournalEdit_receiptType").on("change",function(){"请选择"==$(this).val()?$(".JournalEdit_receiptType_show").hide():$(".JournalEdit_receiptType_show").show()}),Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/clientInfos/Y/"+currentUserInfo.id+"/"+currentUserInfo.loginId),async:!1,callback:function(e){$("#JournalEdit_clinet").comboBox({source:e,displayMember:"name",valueMember:"clientInfoid",placeHolder:"请选择"})}}),Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/clientInfos/N/"+currentUserInfo.id+"/"+currentUserInfo.loginId),async:!1,callback:function(e){$("#JournalEdit_vendor").comboBox({source:e,displayMember:"name",valueMember:"clientInfoid",placeHolder:"请选择"})}}),$("#JournalEdit_ordercreateby").comboBox({source:ComboBoxSources.getRecords("users"),displayMember:"name",valueMember:"username",placeHolder:"请选择"}).val(s.generalDocumentsCreateBy),$("#JournalEditusers").comboBox({source:ComboBoxSources.getRecords("users"),displayMember:"name",valueMember:"userid",placeHolder:"请选择",width:"100%",height:"33px"});var h=function(e){if(0!=p)return""==e?void $("#JournalEditusers_mon").val(""):void Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/userAmt/"+e+"/create/"+currentUserInfo.id+"/"+currentUserInfo.loginId),callback:function(e){$("#JournalEditusers_mon").val(money(e))}})},E=function(e){if(0!=p&&null!=e)return""==e?void $("#JournalEdit_termValue").val(""):void Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/search/clientinfo/id/"+e+"/"+currentUserInfo.id+"/"+currentUserInfo.loginId),callback:function(e){var t=e,r=null==t.customerTermValue?"":t.customerTermValue;$("#JournalEdit_termValue").val(r)}})},f=function(e){if(0!=p&&null!=e)return""==e?void $("#JournalEdit_termValue").val(""):void Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/search/clientinfo/id/"+e+"/"+currentUserInfo.id+"/"+currentUserInfo.loginId),callback:function(e){var t=e,r=null==t.vendorTermValue?"":t.vendorTermValue;$("#JournalEdit_termValue").val(r)}})},J=[],b=function(e){var t=$("#JournalEdit_type").val();if($.addHide("#JournalEdit_pipiEdit"),$.addHide(".pipiEdit"),$.addHide("#pipiEditclinet","#pipiEditvendor","#pipiEditcreateby","#pipiEditusers_mon","#pipiEditusers","#pipiEdittermValue"),"unassociation"!=t){if(pipiEditusers_mon=0,-1!=$.inArray(y[1221].id,J)){$.removeHide("#JournalEdit_pipiEdit"),$.removeHide("#pipiEditusers");for(var e=n(),r=e.length,a=0;a<r;a++)if("26"==e[a].chartOfAccount.id&&0!=e[a].creditAmt){$.removeHide("#pipiEditusers_mon"),pipiEditusers_mon=e[a].creditAmt;break}}$("#JournalEdit_clinet").is(":visible")?E($("#JournalEdit_clinet").val()):f($("#JournalEdit_vendor").val()),"unassociation"!==t&&($.removeHide("#JournalEdit_pipiEdit"),$.removeHide(".pipiEdit"),$.removeHide("#pipiEditcreateby"),$.removeHide("#pipiEditusers"),$.removeHide("#pipiEdittermValue"),"inflow"==t&&($.removeHide("#pipiEditclinet"),$(".JournalEdit_returnFlag").text("供应商退款")),"outflow"==t&&($.removeHide("#pipiEditvendor"),$(".JournalEdit_returnFlag").text("客户退款"))),"unassociation"==t&&$.addHide("#JournalDetail_pipi"),"inflow"!=t&&"unassociation"!=t||$("#JournalEdit_returnFlag").is(":checked")&&$("#JournalEdit_returnFlag").is(":visible")&&($.removeHide("#pipiEditvendor"),$.addHide("#pipiEditclinet")),"outflow"==t&&$("#JournalEdit_returnFlag").is(":checked")&&$("#JournalEdit_returnFlag").is(":visible")&&($.removeHide("#pipiEditclinet"),$.addHide("#pipiEditvendor"))}},g=function(){J=[],$.each($(".JournalEditSelect"),function(){var e=$(this).val();""!=e&&J.push(e)}),b()},y=ComboBoxSources.getInfoMapByKey("chartOfAccounts","hardCode"),x=[];x.push(y[2203].id),x.push(y[1122].id),x.push(y[1123].id),x.push(y[2202].id),x.push(y[1001].id),x.push(y[1002].id),x.push(y[1012].id);var _=function(){if(!q())return!1;var e=[],t=0;if($.each($(".JournalEditSelect"),function(){""!==$(this).val()&&(e[t]=$(this).val(),t+=1)}),i(e))return Core.alert({message:"科目不能相同！"}),!1;var r=$(".JournalEditNum");return $.each(r,a),!1===isCheckEd?(Core.alert({message:"输入金额只能为数字！"}),!1):$("#JournalEditNumSum1").text()!==$("#JournalEditNumSum2").text()?(Core.alert({message:"借贷不平衡！"}),!1):0!==n().length||(Core.alert({message:"请输入金额！"}),!1)};!function(t){l=t.journalNumber,$("#journalEditnoteNumber").val(t.noteNumber),$("#journalEditid").val(t.id),$("#JournalEditattachment").fileuploader({bool:!0,filelist:t.fileInfoIds,url:_global_settings.service.url+"/common/file/"+currentUserInfo.id}),$("#journalEditNumber").val(t.journalNumberForShow),$("#JournalEditRemarkPrint").text(t.remarkPrint),$("#JournalEditRemark").text(t.remark),$("#datepickerEdit").datetimeinput({formatString:"yyyy-MM-dd",width:"170px",height:"33px",value:new Date}),$("#datepickerEdit").val(t.entryDate);var r=null;"AdminAccount"==t.createBy?r="代理报税":void 0!=d(t.createBy)?d(t.createBy).username==t.createBy&&(r=d(t.createBy).name):r=t.createBy,$("#journalEditcreateBy").val(r),$("#JournalEdit_clinet").val(t.clientId),$("#JournalEdit_vendor").val(t.clientId),$("#JournalEditusers").val(t.personId),$("#JournalEdit_receiptType").val(t.receiptInvoiceType),$("#JournalEdit_tax").val(t.vat),$("#JournalEdit_receiptNum").val(t.receiptNumber),$("#JournalEdit_returnFlag")[0].checked=t.returnFlag,$("#JournalEdit_type").val(t.journalRelationType);for(var a=t.journalDetails,i=0;i<a.length;i++)e(a[i]);b(t),timeOut(function(){$("#JournalEditusers_mon").val(t.prepareAmt),$("#JournalEdit_termValue").val(t.termValue),p=!0},20),$("#JournalEditNumSumCn").text(digitUppercase(v)),$("#JournalEditNumSum1").text("￥"+money(v)),$("#JournalEdit_receiptmon").val(money(v)),$("#JournalEditNumSum2").text("￥"+money(v)),$("#JournalEdit_clinet").on("change",function(){E($(this).val()),$("#JournalEditusers").jqxComboBox("clearSelection")}),$("#JournalEdit_vendor").on("change",function(){f($(this).val()),$("#JournalEditusers").jqxComboBox("clearSelection")}),$("#JournalEditusers").on("change",function(){var e=$(this).val();h(e),$("#JournalEdit_termValue").val(""),$("#JournalEdit_clinet").jqxComboBox("clearSelection"),$("#JournalEdit_vendor").jqxComboBox("clearSelection")}),$("#JournalEdit_type").on("change",function(){g()}),$("#JournalEdit_returnFlag").on("change",function(){g()}),$("#JournalEditTable").on("keyup change",function(){g()})}(s);$("#JournalEditTable").on("click",function(e){if($(e.target).parent()[0]===$("#JournalEditTable> tbody").children().eq(-1)[0]||$(e.target).parent().parent()[0]===$("#JournalEditTable> tbody").children().eq(-1)[0]){var t=$(c());t.find(".JournalEditNum").moneyinput({defaultValue:""}),t.find(".JournalEditNum").off("blur").on("blur",u),$("#JournalEditTable> tbody").append(t),$(".JournalEditSelect").eq(-1).coaCombbox({width:"100%",height:"33px"}),$(".JournalEdittp1").eq(-1).comboBoxType({source:ComboBoxSources.getRecords("category1"),height:"33px"}),$(".JournalEdittp2").eq(-1).comboBoxType({source:ComboBoxSources.getRecords("category2"),height:"33px"}),o+=1}$("#JournalEditTable tbody tr").on("dblclick",function(){$(this).find(".JournalEditChart").val($(this).prev("tr").find(".JournalEditChart").val())}),$(".numBorrow2").on("dblclick",function(){var e=0,t=0;$.each($(".numBorrow2"),function(){e=""==$(this).val()?parseFloat(e):parseFloat(e)+parseFloat($(this).val())}),$.each($(".numLoad2"),function(){t=""==$(this).val()?parseFloat(t):parseFloat(t)+parseFloat($(this).val())}),""==$(this).val()?""==$(this).parent().next().children().val()&&parseFloat(e)<parseFloat(t)&&$(this).val(money(parseFloat(t)-parseFloat(e))):""==$(this).parent().next().children().val()&&parseFloat(e)<parseFloat(t)&&$(this).val(money(parseFloat(t)-parseFloat(e)+parseFloat($(this).val()))),$("#JournalEditNumSum1").text("￥"+money(e)),$("#JournalEdit_receiptmon").val(money(e)),g()}),$(".numLoad2").on("dblclick",function(){var e=0,t=0;$.each($(".numBorrow2"),function(){e=""==$(this).val()?parseFloat(e):parseFloat(e)+parseFloat($(this).val())}),$.each($(".numLoad2"),function(){t=""==$(this).val()?parseFloat(t):parseFloat(t)+parseFloat($(this).val())}),""==$(this).val()?""==$(this).parent().prev().children().val()&&parseFloat(e)>parseFloat(t)&&$(this).val(money(parseFloat(e)-parseFloat(t))):""==$(this).parent().prev().children().val()&&parseFloat(e)>parseFloat(t)&&$(this).val(money(parseFloat(e)-parseFloat(t)+parseFloat($(this).val()))),$("#JournalEditNumSum2").text("￥"+money(t)),g()})}),t(),r(),$("#JournalEditTable").on("change",".JournalEditSelect",function(e){var t=e.args;if(""!==$(this).val()){var r=0;$(e.target).val();$.each($(".JournalEditSelect"),function(){$(this).val()===t.item.value&&(r+=1)}),r>1&&(Core.alert({message:"科目不能相同！"}),$(this).val(""))}var a=$(this).val();J=[];var r=0;$.each($(".JournalEditSelect"),function(){var e=$(this).val();""!=e&&(J.push(e),e===a&&(r+=1))}),r>1&&(Core.alert({message:"科目不能相同！"}),$(this).jqxComboBox("clearSelection")),g(J)}),$("#JournalEditTable .JournalEditNum").moneyinput({defaultValue:""}).off("blur").on("blur",u),$("#JournalEditTable").on("keyup",".JournalEditNum",function(){$(this).parent().next().children().is("input")?($(this).parent().next().children().val(""),$(this).parent().next().children().css("border","")):$(this).parent().prev().children().is("input")&&($(this).parent().prev().children().val(""),$(this).parent().prev().children().css("border",""));var e=T();$("#JournalEditNumSumCn").text(digitUppercase(money(e[1]))),$("#JournalEditNumSum1").text("￥"+money(e[1])),$("#JournalEdit_receiptmon").val(money(e[1])),$("#JournalEditNumSum2").text("￥"+money(e[0])),$("#JournalEditusers_mon").trigger("change")}),$("#JournalEditTable").on("paste",".JournalEditNum",function(e){e.preventDefault();var t;e.originalEvent.clipboardData&&(t=(e.originalEvent||e).clipboardData.getData("text/plain")),a(t)&&$(this).val(t)}),$("#JournalEditTable").on("click",".JournalEditDel",function(){if(1===$("#JournalEditTable> tbody").children().length)return!1;var e=$(this);return Core.confirm({message:"确定要删除？",confirmCallback:function(){e.parent().parent().remove()}}),!1});var C=function(){var e=$("#JournalEdit_type").val(),t=$("#JournalEdit_clinet").val(),r=$("#JournalEdit_vendor").val(),a=$("#JournalEditusers").is(":visible")?$("#JournalEditusers").val():null,i=$("#JournalEdit_receiptType").is(":visible")?$("#JournalEdit_receiptType").val():null,n=$("#JournalEdit_tax").is(":visible")?$("#JournalEdit_tax").val():null,o=$("#JournalEdit_receiptNum").is(":visible")?$("#JournalEdit_receiptNum").val():null,l=$("#JournalEdit_receiptmon").is(":visible")?$("#JournalEdit_receiptmon").val():null,u=$("#JournalEdit_ordercreateby").is(":visible")?$("#JournalEdit_ordercreateby").val():null,d=$("#JournalEditusers_mon").is(":visible")?$("#JournalEditusers_mon").val():null,c=$("#JournalEdit_returnFlag").is(":visible")?$("#JournalEdit_returnFlag").is(":checked"):null,s=$("#JournalEdit_termValue").is(":visible")?$("#JournalEdit_termValue").val():null;var p="";return p=$("#JournalEdit_clinet").is(":visible")?t:r,"请选择"==i&&(i=null),{journalRelationType:e,clientId:p,receiptInvoiceType:i,receiptNumber:o,receiptAmt:l,vat:n,personId:a,generalDocumentsCreateBy:u,prepareAmt:d,returnFlag:c,termValue:s}};$("#JournalEdit_Page").jqxValidator({animationDuration:1,hintType:"label",rules:[{input:"#JournalEdit_clinet",message:"请选择",action:"keyup,change",rule:function(e,t){return!!e.is(":hidden")||(null!=e.jqxComboBox("getSelectedItem")||""!=$("#JournalEditusers").val())}},{input:"#JournalEdit_vendor",message:"请选择",action:"keyup,change",rule:function(e,t){return!!e.is(":hidden")||(null!=e.jqxComboBox("getSelectedItem")||""!=$("#JournalEditusers").val())}},{input:"#JournalEditusers",message:"请选择",action:"keyup,change",rule:function(e,t){return!!e.is(":hidden")||(null!=e.jqxComboBox("getSelectedItem")||""==e.val())}},{input:"#JournalEdit_ordercreateby",message:"请选择",action:"keyup,change",rule:function(e,t){return!!e.is(":hidden")||(null!=e.jqxComboBox("getSelectedItem")||""==e.val())}},{input:"#JournalEditusers_mon",message:"其他应收款贷方金额不能大于预支金额",action:"keyup,change",rule:function(e,t){if(e.is(":hidden"))return!0;var r=e.val();return!(""!=r&&parseFloat(money(r))<parseFloat(money(0)))}}]}),$("#JournalEditTableAdd").on("click",function(){if(0==_())return!1;var e=_global_settings.service.url+"/ac/",t="PUT";"JournalEditTableAddAndSubmit"===$(this).attr("id")?(e+="/commit/%20",t="PUT"):e+=(new Base64).encode("tosys/coaReport/update/"+currentUserInfo.id+"/"+currentUserInfo.loginId);var r=m(),a=r.journalDetails,i=["NV","AK","HI"],n=B(a,i);if(r=$.extend(!0,{},r,C()),!$("#JournalEdit_Page").jqxValidator("validate"))return!1;n?Core.AjaxRequest({url:e,type:t,params:r,async:!1,dataType:"text",showMsg:!1,callback:function(e){if(Core.alert({message:""+e}),e)try{$("#Journal").jqxGrid("updatebounddata","cells"),$.closeTab()}catch(e){}else Core.alert({message:"借贷不平衡！"})},failure:function(e){}}):Core.alert({message:"同一科目只能为借方或贷方金额！"})});var q=function(){var e=$("#JournalEditTable> tbody>tr"),t=!0;return $.each(e,function(){var e=($(this).eq(0).children().eq(0).children().val(),$(this).eq(0).children().eq(1).children().jqxComboBox("getSelectedItem")),r=$(this).eq(0).children().eq(2).children().val(),a=$(this).eq(0).children().eq(3).children().val();if(null==e||""===r&&""===a)if(null==e&&""===r&&""===a)t=!0;else{if(null==e)return Core.alert({message:"请选择科目！"}),t=!1,!1;if(""===r||""===a)return Core.alert({message:"请输入金额！"}),t=!1,!1}else t=!0}),t},B=function(e,t){var r=!0;return $.each(t,function(t,a){var i=[],n=[],o=[],l=0;for(var t in e)e.hasOwnProperty(t)&&e[t].chartOfAccount===a&&(i[l]=e[t].creditAmt,l+=1);l=0;for(var u in i)i.hasOwnProperty(u)&&(0===i[u].length?n[l]=i[u]:o[0]=i[u]);if(o.length*n.length!=0)return r=!1,!1}),r},T=function(){for(var e=$(".JournalEditNum").length-1,t=0,r=0,a=0;a<e;a++){var i=1e3*$(".JournalEditNum").eq(a).val();a%2!=1||isNaN(i)||(t+=parseInt(i)),a%2!=0||isNaN(i)||(r+=parseInt(i))}return[t/1e3,r/1e3]}}();