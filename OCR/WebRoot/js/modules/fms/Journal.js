function downloadTemplate(){var e;e="localhost"==getHostName()?"/SimpleBss/template/JournalImportModel.xls":"template/JournalImportModel.xls",window.open(e)}var exportData=[],urls=journalUrl;$(function(){function e(){""!==$("#journalMn1").val()&&""!==$("#journalMn2").val()?r["t.journal.totalAmt"]={value:[$("#journalMn1").val(),$("#journalMn2").val()],action:"between"}:""!==$("#journalMn1").val()&&""===$("#journalMn2").val()?r["t.journal.totalAmt"]={value:[$("#journalMn1").val()],action:"ge"}:""===$("#journalMn1").val()&&""!==$("#journalMn2").val()?r["t.journal.totalAmt"]={value:[$("#journalMn2").val()],action:"le"}:delete r["t.journal.totalAmt"],""!==$("#journalTm1").val()&&""!==$("#journalTm2").val()?r["t.journal.entryDate"]={value:[$("#journalTm1").val()+" 00:00:00",$("#journalTm2").val()+" 23:59:59"],action:"between"}:""!==$("#journalTm1").val()&&""===$("#journalTm2").val()?r["t.journal.entryDate"]={value:[$("#journalTm1").val()+" 00:00:00",getNowFormatDate()+" 23:59:59"],action:"between"}:""===$("#journalTm1").val()&&""!==$("#journalTm2").val()?r["t.journal.entryDate"]={value:["2015-01-01 00:00:00",$("#journalTm2").val()+" 23:59:59"],action:"between"}:delete r["t.journal.entryDate"],""!==$("#journalNumber").val()?(number=$("#journalNumber").val(),number=number.substring(0,2),type="",value=$("#journalNumber").val(),"Y0"==number&&(type="auto",value=$("#journalNumber").val().substring(2)),"S0"==number&&(type="input",value=$("#journalNumber").val().substring(2)),"Z0"==number&&(type="carryover",value=$("#journalNumber").val().substring(2)),""==type&&(number=number.substring(0,1),"Y"==number&&(type="auto",value=$("#journalNumber").val().substring(1)),"S"==number&&(type="input",value=$("#journalNumber").val().substring(1)),"Z"==number&&(type="carryover",value=$("#journalNumber").val().substring(1))),""!=value?r["t.journal.journalNumber"]={value:[value],action:"like"}:delete r["t.journal.journalNumber"],""!=type?r["t.journal.journalType"]={value:[type],action:"eq"}:delete r["t.journal.journalType"]):(delete r["t.journal.journalNumber"],delete r["t.journal.journalType"]),""!==$("#journaldescription").val()?r["t.description"]={value:[$("#journaldescription").val()],action:"like"}:delete r["t.description"],""!==$("#journalCoa").val()?r["t.chartOfAccount.name"]={value:[$("#journalCoa").val()],action:"like"}:delete r["t.chartOfAccount.name"]}function a(e){var a=void 0===e?me.settings.grid.element:e;$("#"+a).jqxGrid("applyfilters"),$("#"+a).jqxGrid("refreshfilterrow"),$("#"+a).jqxGrid("clearselection")}var t=function(e){var a=ComboBoxSources.getRecords("taxerInfo");for(i=0;i<a.length;i++)if(e==a[i].username)return a[i];if(!e)return""};$("#JournalSelectTime").dropDownlist({source:["请选择","最近一周","最近两周","最近三周","本月","本季度","本年"],width:"100%"}),$("#JournalSelectTime").on("change",function(){setValueById("JournalSelectTime","journalTm1","journalTm2")}),$("#importJournal").on({click:function(){$("#journalmgt-attachment").html(""),$("#journalmgt-modal").modal("show");$("#journalmgt-attachment").fileuploader({url:_global_settings.service.url+"/common/importjournal/"+currentUserInfo.id+"/"+_global_settings.owner.username})}}),$("#journalTm1").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#journalTm2").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#joural-show").attr("class","row hiddendiv"),$("#jouralSearchBtn").on("click",function(){$("#joural-show").is(":hidden")?$("#joural-show").slideDown("show"):(e(),a("Journal"))}),hiddenAclick();var r={},n=_global_settings.service.url,l={datafields:[{name:"entryDate",type:"string"},{name:"journalNumberForShow",type:"string"},{name:"journalNumber",type:"string"},{name:"journalDetails",type:"string"},{name:"journalType",type:"string"},{name:"journalBizType",map:"journalBizType"},{name:"createBy",type:"string"},{name:"lastUpdateBy",type:"string"},{name:"remark",type:"string"},{name:"remarkPrint",type:"string"},{name:"currency",type:"string"},{name:"id",type:"number"},{name:"bizId",type:"number"},{name:"fileInfoIds",type:"string"},{name:"noteNumber",type:"number"},{name:"clientId",type:"string"},{name:"personId",type:"string"},{name:"receiptInvoiceType",type:"string"},{name:"vat",type:"string"},{name:"receiptNumber",type:"string"},{name:"journalRelationType",type:"string"},{name:"returnFlag",type:"bool"},{name:"termValue",type:"string"},{name:"generalDocumentsCreateBy",type:"string"}],url:n+"/ac/journal",data:r},o=function(e,a,t,r,n,i){var l="";return $.each(i.journalDetails,function(e,a){var t=void 0===a.description?"":a.description;l+='<div class="JournalDiv" style="border-top: 1px solid  #EBEFF2;" title='+t+">"+t+"</div>"}),'<div style="height:auto;">'+l+"</div>"},d=function(e,a,t,r,n,i){var l="";return $.each(i.journalDetails,function(e,a){null!=a.chartOfAccount.id?l+='<div class="JournalDiv" style="border-top: 1px solid  #EBEFF2;">'+getProductInfoById(a.chartOfAccount.id,"chartOfAccounts").name+"</div>":l+='<div class="JournalDiv" style="border-top: 1px solid  #EBEFF2;"></div>'}),'<div style="height: auto;">'+l+"</div>"},u=function(e,a,t,r,n,i){var l="";return $.each(i.journalDetails,function(e,a){var t=0===a.creditAmt?"":"￥"+moneyBig(a.creditAmt);l+='<div class="JournalDiv" style="border-top: 1px solid  #EBEFF2;    text-align: right;padding-right:5px;">'+t+"</div>"}),'<div style="height: auto;">'+l+"</div>"},c=function(e,a,t,r,n,i){var l="";return $.each(i.journalDetails,function(e,a){var t=0===a.debitAmt?"":"￥"+moneyBig(a.debitAmt);l+='<div class="JournalDiv" style="border-top: 1px solid  #EBEFF2;    text-align: right;padding-right:5px;">'+t+"</div>"}),'<div style="height: auto;">'+l+"</div>"},s={grid:{element:"Journal",columns:[{text:"日期",dataField:"entryDate",width:"8%"},{text:"凭证字号",dataField:"journalNumberForShow",width:"7%"},{text:"关联业务",width:"6%",cellsrenderer:function(e,a,t,r,n,i){var l=i.journalDetails.length,o=24*l/2-4.5;if("generalDocuments"==i.journalBizType){var d='<div style="text-align: center;padding-top: '+o+'px;">';return d+='<a class="color-1193C5 hoverspan viewgeneral" data-id='+i.boundindex+">通用单据</a>",d+="</div>"}if("Receipt"==i.journalBizType){var d='<div style="text-align: center;padding-top: '+o+'px;">';return d+='<a class="color-1193C5 hoverspan receiptView" data-id='+i.boundindex+">发票</a>",d+="</div>"}}},{text:"摘要",cellsrenderer:o,width:"19%"},{text:"科目",cellsrenderer:d,width:"20%",height:"50px"},{text:"借方金额",cellsrenderer:c,width:"10%"},{text:"贷方金额",cellsrenderer:u,width:"11%"},{text:"制单人",dataField:"createBy",width:"9%",cellsrenderer:function(e,a,r,n,i,l){var o="";return"AdminAccount"==l.createBy?o+="<div>代理报税</div>":void 0!=t(l.createBy)?t(l.createBy).username==l.createBy&&(o+="<div>"+t(l.createBy).name+"</div>"):o+="<div>"+l.createBy+"</div>",'<div style="height: auto;position:absolute;top:44%;left:5%">'+o+"</div>"}},{text:"操作",dataField:"opt",align:"center",width:"8%",cellsrenderer:function(e,a,t,r,n,i){var l=i.journalDetails.length,o=10*l+"px",d='<div style="text-align: center;padding-top:'+o+'">';return d+='<a class="md-dns JournalView " title="查看"  data-id='+i.boundindex+" ></a>",d+='<a class="md-rate-review icons-18-black JournalEdit editbtn" data-btn="fms:journal:create" title="修改"  data-id='+i.boundindex+" ></a>",d+='<a class="md-cancel  JournalDel delbtn" data-btn="fms:journal:create" title="删除"   data-id='+i.boundindex+" ></a>",d+="</div>"}}]}},m=Core.AcDataAdapter("Journal",l,{loadComplete:function(e){for(var a=0;a<e.rows.length;a++)exportData.push(e.rows[a])}},!1),v={autorowheight:!0,autoheight:!0,width:"100%",source:m,rendergridrows:function(){var e=ComboBoxSources.getInfoMapByKey("users","username");return e.AdminAccount={name:"代理报税"},$.each(m.records,function(a,t){try{t.createBy=e[t.createBy].name}catch(e){}try{t.entryDate=t.entryDate.substring(0,10)}catch(e){}}),m.records},columns:s.grid.columns,columnsheight:s.grid.columnsheight,pagesize:s.grid.pagesize,columnsheight:45,enablehover:!1,selectionmode:"checkbox"};$("#"+s.grid.element).grid(v),$("#jouralExportBtn").click(function(){e(),a("Journal");var t=journalUrl;window.open(_global_settings.service.url+"/ac/export/"+t)}),$("#Journal").on("click",".receiptView",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"发票查看",isFrame:!1,url:"page/modules/fms/receiptView.html",pk:{id:a.bizId,data:a}})}),$("#Journal").on("click",".viewgeneral",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"查看通用单据",isFrame:!1,url:"page/modules/fms/generalView.html",pk:{id:a.bizId}})}),$("#Journal").on("click",".viewPurchaseReturnPay",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"退款单",url:"page/modules/biz/viewPayment.html",pk:{id:a.bizId},reload:!0})}),$("#Journal").on("click",".viewSalesReturnPay",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"退款单",url:"page/modules/biz/viewReceive.html",pk:{id:a.bizId},reload:!0})}),$("#Journal").on("click",".viewSalesReturn",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"退货单",url:"page/modules/biz/viewGoodsReturn.html",pk:{id:a.bizId,random:Math.random()},reload:!0})}),$("#Journal").on("click",".viewPurchaseReturn",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"退货单",url:"page/modules/biz/viewGoodsrecReturn.html",pk:{id:a.bizId,random:Math.random()},reload:!0})}),$("#Journal").on("click",".viewCostIncome",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"查看其他收入",url:"page/modules/prod/viewcostIncome.html",pk:{id:a.bizId},reload:!0})}),$("#Journal").on("click",".viewExpensePayment",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"查看费用支出",url:"page/modules/prod/viewCostPay.html",pk:{id:a.bizId},reload:!0})}),$("#Journal").on("click",".viewJourReceiveDetail",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"收货单",url:"page/modules/biz/viewReceiveCargo.html",pk:{deliveryOrderId:a.bizId},reload:!0})}),$("#Journal").on("click",".viewJourSendDetail",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"送货单",url:"page/modules/biz/viewSendCargo.html",pk:{deliveryOrderId:a.bizId},reload:!0})}),$("#Journal").on("click",".viewJourReceiveMoneyDetail",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"收款",url:"page/modules/biz/viewReceive.html",pk:{id:a.bizId},reload:!0})}),$("#Journal").on("click",".viewJourPayDetail",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"付款",url:"page/modules/biz/viewPayment.html",pk:{id:a.bizId},reload:!0})}),$("#Journal").on("click",".JournalEdit",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);if("input"!==a.journalType)return Core.alert({message:"业务生成凭证不可编辑！"}),!1;$.addTab({title:"编辑凭证",url:"page/modules/fms/JournalEdit.html",pk:a,reload:!0})}),$("#Journal").on("click",".JournalView",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);$.addTab({title:"查看凭证",url:"page/modules/fms/JournalView.html",pk:a,reload:!0})}),$("#Journal").on("click",".JournalDel",function(){var e=$(this).attr("data-id"),a=$("#Journal").jqxGrid("getrowdata",e);if("auto"===a.journalType)return Core.alert({message:"业务生成凭证不可删除！"}),!1;var t=a.id;Core.confirm({message:"确定要删除？",confirmCallback:function(){Core.AjaxRequest({url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/"+t+"/"+currentUserInfo.id+"/"+currentUserInfo.loginId),type:"DELETE",dataType:"text",showMsg:!1,callback:function(e){Core.alert({message:""+e,hide:"2000"}),p("Journal")},failure:function(e){}})}})}),$("#jouralPrintBtn").on("click",function(){var e=$("#Journal").jqxGrid("getselectedrowindexes");if(void 0!=exportData||""!=exportData||null!=exportData)if(0==e.length)Core.alert({message:"请选择需要打印的项"});else if(e.length>0){var a=[],t=null;$.each(e,function(t,r){void 0!=exportData[e[t]]&&(indexId=exportData[e[t]].id,a.push(indexId))}),t=a.join(",");var r=(new Base64).encode("printHtml2reportName=JournalPrint2&journalsId="+t+"&printType=pdf&ownerId="+currentUserInfo.id+"&username="+currentUserInfo.loginId).replace("_$_",".").replace(/\//g,"_a").replace(/\+/g,"_b").replace(/\=/g,"_c");window.open(_global_settings.service.url+"/ac/print/"+r)}}),$("#addpingzheng").click(function(){$.addTab({title:"新增凭证",url:"page/modules/fms/JournalDetail.html"})}),$(".jouralSearchtime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"33px"}),$("#journalTm2").val(new Date);var p=function(e){var a=void 0===e?me.settings.grid.element:e;$("#"+a).jqxGrid("updatebounddata","cells"),$("#"+a).jqxGrid("clearselection"),$("#"+a).jqxGrid("refreshdata")};window.refreshJournalGrid=p});