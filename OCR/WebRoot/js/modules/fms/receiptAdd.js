var ReceiptAdd=function(){var e,t,r=this,n=_global_settings.service.url;this.initInput=function(){r.initInterface(),r.initUserPage(),r.initValidator(),r.bindModel()},this.initInterface=function(){Core.AjaxRequest({url:n+"/common/getAllclient/Y/"+currentUserInfo.id,type:"GET",async:!1,callback:function(t){e=t},failure:function(){}}),Core.AjaxRequest({url:n+"/common/getAllclient/N/"+currentUserInfo.id,type:"GET",async:!1,callback:function(e){t=e},failure:function(){}})},this.initUserPage=function(){$("#rcptAdd-reasons").coaCombboxChoose({width:"100%",height:34,theme:currentTheme,displayMember:"name",valueMember:"id",selectedIndex:0,searchMode:"contains"},["6001","6051"]),$("#rcptAdd-account").coaCombboxChoose({width:"100%",height:34,theme:currentTheme,displayMember:"name",valueMember:"id",selectedIndex:0,searchMode:"contains"},["1122","1001","1002"]),$("#rcptAdd-category").dropDownlist({source:{otherinvoice:"其他",specialinvoice:"增值税专用发票",ordinaryinvoice:"增值税普通发票"},width:"100%",height:"34px",disabled:!1,selectedIndex:1});var r=["0%","3%","6%","11%","13%","17%"];$("#rcptAdd-tax").dropDownlist({source:r,theme:currentTheme,width:"100%",height:"34px",dropDownHeight:200,selectedIndex:0}),$("#rcptAdd-time").datetimeinput({width:"100%",height:33,value:new Date,formatString:"yyyy-MM-dd"}),$("#rcptAdd-sum").input({width:"98%",height:33}).moneyinput(),$("#receipt-radioOut")[0].checked?$("#rcptAdd-clientName").comboBox({source:e,displayMember:"name",valueMember:"clientId",width:"100%",placeHolder:"请选择或输入"}):$("#receipt-radioIn")[0].checked&&$("#rcptAdd-clientName").comboBox({source:t,displayMember:"name",valueMember:"clientId",width:"100%",placeHolder:"请选择或输入"})},this.getClientCustomer=function(t){for(i=0;i<e.length;i++)if(t==e[i].name)return e[i];if(!t)return""},this.getClientAgent=function(e){for(i=0;i<t.length;i++)if(e==t[i].name)return t[i];if(!e)return""},this.initValidator=function(){$("#rcptAdd-addForm").jqxValidator({animationDuration:1,hintType:"label",rules:[{input:"#rcptAdd-clientName",message:"不能为空",action:"keyup,blur",rule:function(e,t){return""!==e.val()}},{input:"#rcptAdd-time",message:"不能为空",action:"change, select",rule:function(e,t){return""!==e.val()}},{input:"#rcptAdd-num",message:"发票号码不能为空",action:"keyup,blur",rule:function(e,t){return""!=e.val()}},{input:"#rcptAdd-sum",message:"请输入数字",action:"keyup,blur",rule:IsNum},{input:"#rcptAdd-sum",message:"不能小于0",action:"keyup,blur",rule:function(e,t){return!(e.val()<0)}},{input:"#rcptAdd-num",message:"发票号码只能是8位数字",action:"keyup,blur",rule:function(e,t){return 8===e.val().length}}]})},this.bindModel=function(){$("#rcptAdd-addsave").on("click",function(){if(0==$("#rcptAdd-sum").val())return Core.alert({message:"发票金额不能为0！"}),!1;r.submitParam(r.initParam())}),$("#rcptAdd-addattachment").fileuploader({bool:!0,url:_global_settings.service.url+"/common/file/"+currentUserInfo.id,avision:!0}),$("#rcptAdd-sum").keyup(function(){$("#rcptAdd-nosum").val(money($("#rcptAdd-sum").val()))}),$("#receipt-radioOut").change(function(){$("#rcptAdd-reasons").coaCombboxChoose({width:"100%",height:34,theme:currentTheme,displayMember:"name",valueMember:"id",selectedIndex:0,searchMode:"contains"},["6001","6051"]),$("#rcptAdd-account").coaCombboxChoose({width:"100%",height:33,theme:currentTheme,displayMember:"name",valueMember:"id",searchMode:"contains"},["1122","1001","1002"]),$("#rcptAdd-clientName").comboBox({source:e,displayMember:"name",valueMember:"clientId",width:"100%",placeHolder:"请选择或输入"}),$("#rcptAdd-account").parent().parent().find("label:first").text("收款账户")}),$("#receipt-radioIn").change(function(){$("#rcptAdd-reasons").coaCombboxChoose({width:"100%",height:34,theme:currentTheme,displayMember:"name",valueMember:"id",selectedIndex:0,searchMode:"contains"},["1405","1403","6601","6602","6603","5301"]),$("#rcptAdd-account").coaCombboxChoose({width:"100%",height:33,theme:currentTheme,displayMember:"name",valueMember:"id",selectedIndex:0,searchMode:"contains"},["2202","1001","1002"]),$("#rcptAdd-clientName").comboBox({source:t,displayMember:"name",valueMember:"clientId",width:"100%",placeHolder:"请选择或输入"}),$("#rcptAdd-account").parent().parent().find("label:first").text("付款账户")})},this.initParam=function(){var e=[];$("#rcptAdd-addattachment").find(".item").each(function(t,r){var n=$(r).attr("data-id");void 0!==n&&e.push(n)});var t={};if(t.receiptNumber=$("#rcptAdd-num").val(),t.entryDate=$("#rcptAdd-time").val(),t.receiptAmt=money($("#rcptAdd-sum").val()),t.taxRate=$("#rcptAdd-tax").val().replace("%",""),t.receiptInvoiceType=$("#rcptAdd-category").val(),t.remark=$("#rcptAdd-addremark").val(),t.remark2=$("#rcptAdd-addremarkPrint").val(),t.fileInfoIds=e.toString(),t.unuseAmt=money($("#rcptAdd-nosum").val()),t.coaReason={id:$("#rcptAdd-reasons").val()},t.coaDeposit={id:$("#rcptAdd-account").val()},t.createBy=_global_settings.owner.username,$("#receipt-radioOut")[0].checked){var n=$("#rcptAdd-clientName").find("input").val();void 0!=r.getClientCustomer(n)?t.clientId=r.getClientCustomer(n).clientId:t.name=n,t.receiptType="sales"}if($("#receipt-radioIn")[0].checked){var n=$("#rcptAdd-clientName").find("input").val();void 0!=r.getClientAgent(n)?t.clientId=r.getClientAgent(n).clientId:t.name=n,t.receiptType="purchase"}return t},this.submitParam=function(e){$("#rcptAdd-addForm").jqxValidator("validate")&&Core.AjaxRequest({url:n+"/ac/"+(new Base64).encode("tobss/receipt/create/"+currentUserInfo.id+"/"+currentUserInfo.loginId),type:"POST",params:e,async:!1,showMsg:!1,callback:function(e){try{1==e.code?(setCloseAlertTimeOneSecond(),$.closeTab(),$.addTab({title:"发票",url:"page/modules/fms/receipt.html",isFrame:!1,reload:!0})):0==e.code&&Core.alert({message:e.errorMsg})}catch(e){}},failure:function(){}})},this.unbindAll=function(){$("#rcptAdd-addsave").off()}};