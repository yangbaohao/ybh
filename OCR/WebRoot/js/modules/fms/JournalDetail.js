!function(){function e(){$("#JournalDetailTable").on("change",".JournalDetailtp1",function(){$("#JournalDetailTable").off("change",".JournalDetailtp1"),pass=!1;var a=$(this),t=$(this).jqxComboBox("selectedIndex");$.each($(".JournalDetailtp1"),function(e,l){$(l)[0]==a[0]?pass=!0:pass&&$(l).jqxComboBox({selectedIndex:t})}),e()})}function a(){$("#JournalDetailTable").on("change",".JournalDetailtp2",function(){$("#JournalDetailTable").off("change",".JournalDetailtp2"),pass=!1;var e=$(this),t=$(this).jqxComboBox("selectedIndex");$.each($(".JournalDetailtp2"),function(a,l){$(l)[0]==e[0]?pass=!0:pass&&$(l).jqxComboBox({selectedIndex:t})}),a()})}function t(){r=!1;var e=2===arguments.length?arguments[1].value:arguments[0];return isNaN(e)?($(this).focus(),$(this).css("border","solid 2px red"),r=!1,!1):($(this).css("border",""),r=!0,!0)}function l(e){var a={};for(var t in e){if(a[e[t]])return!0;a[e[t]]=!0}return!1}setTimeout($.addTabCloseEvent,200);var r=!1,n=null,i=function(e){var a=$(this),l=a.val();""!=l&&t(l)?($(this).css("border",""),a.val(money(l).replace("-",""))):a.val("")};Core.AjaxRequest({type:"GET",url:ws_url+"/CXF/rs/ac/"+(new Base64).encode("tosys/coaReport/ownerinformation/"+currentUserInfo.id+"/"+currentUserInfo.loginId),async:!1,callback:function(e){n=e,$(".category1_name").text(e.category1),$(".category2_name").text(e.category2)}});var o="";o+="<tr>                                                                               ",o+='\t<td style=""><input class="JournalDetailChart form-control" type="text"></td>                                                           ',o+='\t<td style=""><div class="JournalDetailSelect"></div>                                                      ',o+="\t</td>                                                                                  ",o+='\t<td style=""><input class="JournalDetailNum numBorrow form-control" type="text"></td>                                                           ',o+='\t<td style=""><input class="JournalDetailNum numLoad form-control" type="text"></td>                                                           ',o+='\t<td style="">                                                      ',o+='\t\t\t<div class="JournalDetailtp1"></div>                                                       ',o+="\t</td>                                                                                  ",o+='\t<td style="">                                                    ',o+='\t\t\t<div class="JournalDetailtp2"></div>                                                                ',o+="\t</td>                                                                                  ",o+='\t<td class="del_icon" style=""><i class="    md-cancel   del  JournalDetailDel"></i>',o+="\t</td>                                                                                           ",o+="</tr>           ",$("#JournalDetailTable").easytable({tr:o,tr_load_func:function(e){e.find(".JournalDetailNum").moneyinput({defaultValue:""}),e.find(".JournalDetailNum").off("blur").on("blur",i),e.find(".JournalDetailSelect").coaCombbox({width:"100%",height:"33px"}),e.find(".JournalDetailtp1").comboBoxType({source:ComboBoxSources.getRecords("category1"),height:"33px"}),e.find(".JournalDetailtp2").comboBoxType({source:ComboBoxSources.getRecords("category2"),height:"33px"})}}).on("dblclick",".numBorrow",function(){var e=0,a=0;if($.each($(".numBorrow"),function(){e=""==$(this).val()?parseFloat(e):parseFloat(e)+parseFloat($(this).val())}),$.each($(".numLoad"),function(){a=""==$(this).val()?parseFloat(a):parseFloat(a)+parseFloat($(this).val())}),""==$(this).val()){if(""==$(this).parent().next().children().val()&&parseFloat(e)<parseFloat(a)){var t=parseFloat(a)-parseFloat(e);e+=t,$(this).val(money(t))}}else if(""==$(this).parent().next().children().val()&&parseFloat(e)<parseFloat(a)){var t=parseFloat(a)-parseFloat(e)+parseFloat($(this).val());e+=t,$(this).val(money(t))}$("#JournalDetailNumSum1").text("￥"+money(e)),$("#JournalDetail_receiptmon").val(money(e))}).on("dblclick",".numLoad",function(){var e=0,a=0;if($.each($(".numBorrow"),function(){e=""==$(this).val()?parseFloat(e):parseFloat(e)+parseFloat($(this).val())}),$.each($(".numLoad"),function(){a=""==$(this).val()?parseFloat(a):parseFloat(a)+parseFloat($(this).val())}),""==$(this).val()){if(""==$(this).parent().prev().children().val()&&parseFloat(e)>parseFloat(a)){var t=parseFloat(e)-parseFloat(a);a+=t,$(this).val(money(t))}}else if(""==$(this).parent().prev().children().val()&&parseFloat(e)>parseFloat(a)){var t=parseFloat(e)-parseFloat(a)+parseFloat($(this).val());a+=t,$(this).val(money(t))}$("#JournalDetailNumSum2").text("￥"+money(a))}).on("dblclick",".JournalDetailChart",function(){$(this).val($(this).parent().parent().prev("tr").find(".JournalDetailChart").val())});for(var u=0;u<3;u++)timeOut(function(){$("#JournalDetailTable tbody").trigger("addline")},50);e(),a(),$("#JournalDetail-addCategory1Btn").on({click:function(){var e=$(this).attr("data");Core.showModal({type:e,broth:".JournalDetailtp1",callback:function(e){}})}}),$("#JournalDetail-addCategory2Btn").on({click:function(){var e=$(this).attr("data");Core.showModal({type:e,broth:".JournalDetailtp2",callback:function(e){}})}}),$("#JournalDetailattachment").fileuploader({bool:!0,url:_global_settings.service.url+"/common/file/"+currentUserInfo.id}),$("#JournalDetailcreateby").val(_global_settings.owner.companyname),$("#datepicker").datetimeinput({formatString:"yyyy-MM-dd",width:"170px",height:"33px",value:new Date}),$("#JournalDetail_receiptType").dropDownlist({source:{"请选择":"请选择",specialinvoice:"增值税专用发票",ordinaryinvoice:"增值税普通发票",otherinvoice:"其他"},width:"100%",selectedIndex:0}),$("#JournalDetail_type").dropDownlist({source:{unassociation:"不匹配",inflow:"资金流入",outflow:"资金流出",OtherAssociation:"其他"},selectedIndex:0}),$("#JournalDetail_tax").dropDownlist({source:{"请选择":"请选择",0:"0%",3:"3%",5:"5%",6:"6%",11:"11%",13:"13%",17:"17%"},selectedIndex:0}).val(_global_settings.owner.vat),Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/clientInfos/Y/"+currentUserInfo.id+"/"+currentUserInfo.loginId),async:!1,callback:function(e){$("#JournalDetail_clinet").comboBox({source:e,displayMember:"name",valueMember:"clientInfoid",placeHolder:"请选择"})}}),Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/clientInfos/N/"+currentUserInfo.id+"/"+currentUserInfo.loginId),async:!1,callback:function(e){$("#JournalDetail_vendor").comboBox({source:e,displayMember:"name",valueMember:"clientInfoid",placeHolder:"请选择"})}}),$("#JournalDetail_ordercreateby").comboBox({source:ComboBoxSources.getRecords("users"),displayMember:"name",valueMember:"username",placeHolder:"请选择"}).val(currentUserInfo.loginId),$("#JournalDetailusers").comboBox({source:ComboBoxSources.getRecords("users"),displayMember:"name",valueMember:"userid",placeHolder:"请选择"});var s=function(e){if(""==e)return void $("#JournalDetailusers_mon").val("");Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/userAmt/"+e+"/create/"+currentUserInfo.id+"/"+currentUserInfo.loginId),callback:function(e){$("#JournalDetailusers_mon").val(money(e))}})},c=function(e){if(null!=e)return""==e?void $("#JournalDetail_termValue").val(""):void Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/search/clientinfo/id/"+e+"/"+currentUserInfo.id+"/"+currentUserInfo.loginId),callback:function(e){var a=e,t=null==a.customerTermValue?"":a.customerTermValue;$("#JournalDetail_termValue").val(t)}})},d=function(e){if(null!=e)return""==e?void $("#JournalDetail_termValue").val(""):void Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/ac/"+(new Base64).encode("tosys/coaReport/search/clientinfo/id/"+e+"/"+currentUserInfo.id+"/"+currentUserInfo.loginId),callback:function(e){var a=e,t=null==a.vendorTermValue?"":a.vendorTermValue;$("#JournalDetail_termValue").val(t)}})};$("#JournalDetail_receiptType").on("change",function(){"请选择"==$(this).val()?$(".JournalDetail_receiptType_show").hide():$(".JournalDetail_receiptType_show").show()}),$("#JournalDetail_clinet").on("change",function(){c($(this).val()),$("#JournalDetailusers").jqxComboBox("clearSelection")}),$("#JournalDetail_vendor").on("change",function(){d($(this).val()),$("#JournalDetailusers").jqxComboBox("clearSelection")}),$("#JournalDetailusers").on("change",function(){var e=$(this).val();s(e),$("#JournalDetail_termValue").val(""),$("#JournalDetail_clinet").jqxComboBox("clearSelection"),$("#JournalDetail_vendor").jqxComboBox("clearSelection")});var p=[],v=0,m=function(){var e=$("#JournalDetail_type").val();if($.addHide("#JournalDetail_pipi"),$.addHide(".pipi"),$.addHide("#pipiclinet","#pipivendor","#pipicreateby","#pipiusers_mon","#pipiusers","#pipitermValue"),"unassociation"!=$("#JournalDetail_type").val()){if(v=0,-1!=$.inArray(f[1221].id,p)){$.removeHide("#JournalDetail_pipi"),$.removeHide("#pipiusers");for(var a=g(),t=a.length,l=0;l<t;l++)if("26"==a[l].chartOfAccount.id&&0!=a[l].creditAmt){$.removeHide("#pipiusers_mon"),v=a[l].creditAmt;break}}$("#JournalDetail_clinet").is(":visible")?c($("#JournalDetail_clinet").val()):d($("#JournalDetail_vendor").val()),"unassociation"!==e&&($.removeHide("#JournalDetail_pipi"),$.removeHide(".pipi"),$.removeHide("#pipicreateby"),$.removeHide("#pipiusers"),$.removeHide("#pipitermValue"),"inflow"==e&&($.removeHide("#pipiclinet"),$(".JournalDetail_returnFlag").text("供应商退款")),"outflow"==e&&($.removeHide("#pipivendor"),$(".JournalDetail_returnFlag").text("客户退款"))),"unassociation"==e&&$.addHide("#JournalDetail_pipi"),"inflow"!=e&&"unassociation"!=e||$("#JournalDetail_returnFlag").is(":checked")&&($.removeHide("#pipivendor"),$.addHide("#pipiclinet")),"outflow"==e&&$("#JournalDetail_returnFlag").is(":checked")&&($.removeHide("#pipiclinet"),$.addHide("#pipivendor"))}},h=function(){p=[],$.each($(".JournalDetailSelect"),function(){var e=$(this).val();""!=e&&p.push(e)}),m()};$("#JournalDetailTable").on("keyup change",function(){h()});var f=ComboBoxSources.getInfoMapByKey("chartOfAccounts","hardCode"),D=[];D.push(f[2203].id),D.push(f[1122].id),D.push(f[1123].id),D.push(f[2202].id),D.push(f[1001].id),D.push(f[1002].id),D.push(f[1012].id),$("#JournalDetail_type").on("change",function(){h()}),$("#JournalDetail_returnFlag").on("change",function(){h()}),$("#JournalDetailTable").on("change",".JournalDetailSelect",function(e){var a=$(this).val();p=[];var t=0;$.each($(".JournalDetailSelect"),function(){var e=$(this).val();""!=e&&(p.push(e),e===a&&(t+=1))}),t>1&&(Core.alert({message:"科目不能相同！"}),$(this).jqxComboBox("clearSelection")),h()}),$("#JournalDetailTable").on("keyup",".JournalDetailNum",function(){$(this).parent().next().children().is("input")?($(this).parent().next().children().val(""),$(this).parent().next().children().css("border","")):$(this).parent().prev().children().is("input")&&($(this).parent().prev().children().val(""),$(this).parent().prev().children().css("border",""));var e=_();$("#JournalDetailNumSumCn").text(digitUppercase(money(e[1]))),$("#JournalDetailNumSum1").text("￥"+money(e[1])),$("#JournalDetail_receiptmon").val(money(e[1])),$("#JournalDetailNumSum2").text("￥"+money(e[0])),$("#JournalDetailusers_mon").trigger("change")}),$("#JournalDetailTable").on("paste",".JournalDetailNum",function(e){e.preventDefault();var a;e.originalEvent.clipboardData&&(a=(e.originalEvent||e).clipboardData.getData("text/plain")),t(a)&&$(this).val(a)});var J=function(){var e=$("#JournalDetail_type").val(),a=$("#JournalDetail_clinet").val(),t=$("#JournalDetail_vendor").val(),l=$("#JournalDetailusers").is(":visible")?$("#JournalDetailusers").val():null,r=$("#JournalDetail_receiptType").is(":visible")?$("#JournalDetail_receiptType").val():null,n=$("#JournalDetail_tax").is(":visible")?$("#JournalDetail_tax").val():null,i=$("#JournalDetail_receiptNum").is(":visible")?$("#JournalDetail_receiptNum").val():null,o=$("#JournalDetail_receiptmon").is(":visible")?$("#JournalDetail_receiptmon").val():null,u=$("#JournalDetail_ordercreateby").is(":visible")?$("#JournalDetail_ordercreateby").val():null,s=$("#JournalDetailusers_mon").is(":visible")?$("#JournalDetailusers_mon").val():null,c=$("#JournalDetail_returnFlag").is(":visible")?$("#JournalDetail_returnFlag").is(":checked"):null,d=$("#JournalDetail_termValue").is(":visible")?$("#JournalDetail_termValue").val():null;var p="";return p=$("#JournalDetail_clinet").is(":visible")?a:t,"请选择"==r&&(r=null),{journalRelationType:e,clientId:p,receiptInvoiceType:r,receiptNumber:i,receiptAmt:o,vat:n,personId:l,generalDocumentsCreateBy:u,expensePaymentId:s,returnFlag:c,termValue:d}};$("#JournalDetail_Page").jqxValidator({animationDuration:1,hintType:"label",rules:[{input:"#JournalDetail_clinet",message:"请选择",action:"keyup,change",rule:function(e,a){return!!e.is(":hidden")||(null!=e.jqxComboBox("getSelectedItem")||""!=$("#JournalDetailusers").val())}},{input:"#JournalDetail_vendor",message:"请选择",action:"keyup,change",rule:function(e,a){return!!e.is(":hidden")||(null!=e.jqxComboBox("getSelectedItem")||""!=$("#JournalDetailusers").val())}},{input:"#JournalDetailusers",message:"请选择",action:"keyup,change",rule:function(e,a){return!!e.is(":hidden")||(null!=e.jqxComboBox("getSelectedItem")||""==e.val())}},{input:"#JournalDetail_ordercreateby",message:"请选择",action:"keyup,change",rule:function(e,a){return!!e.is(":hidden")||(null!=e.jqxComboBox("getSelectedItem")||""==e.val())}},{input:"#JournalDetailusers_mon",message:"其他应收款贷方金额不能大于预支金额",action:"keyup,change",rule:function(e,a){if(e.is(":hidden"))return!0;var t=e.jqxComboBox("getSelectedItem");return!(null!=t&&parseFloat(money(t.originalItem.amt))<parseFloat(money(v)))}},{input:"#JournalDetail_receiptNum",message:"不能为空",action:"keyup,change",rule:function(e,a){return!!e.is(":hidden")||""!=e.val()}}]}),$("#JournalDetailTableAdd").on("click",function(){var e=_global_settings.service.url+"/ac/";if("JournalDetailTableAddAndSubmit"===$(this).attr("id")?e+="/commit/%20":e+=(new Base64).encode("tosys/coaReport/create/"+currentUserInfo.id+"/"+currentUserInfo.loginId+"/"+_global_settings.owner.username),!b())return!1;var a=[],n=0;if($.each($(".JournalDetailSelect"),function(){""!==$(this).val()&&(a[n]=$(this).val(),n+=1)}),l(a))return Core.alert({message:"科目不能相同！"}),!1;var i=$(".JournalDetailNum");if($.each(i,t),!1===r)return Core.alert({message:"输入金额只能为数字！"}),!1;if($("#JournalDetailNumSum1").text()!==$("#JournalDetailNumSum2").text())return Core.alert({message:"借贷不平衡！"}),!1;var o=g();if(0===o.length)return Core.alert({message:"请输入金额！"}),!1;var u=[];$("#JournalDetailattachment").find(".item").each(function(e,a){var t=$(a).attr("data-id");void 0!==t&&u.push(t)});var s={noteNumber:$("#journalnoteNumber").val(),fileInfoIds:u.toString(),remark:$("#JournalDetailRemark").val(),journalType:"input",currency:"RMB",entryDate:$("#datepicker").val(),remarkPrint:$("#JournalDetailRemarkPrint").val(),journalDetails:o};s=$.extend(!0,{},s,J());var c=s.journalDetails,d=["NV","AK","HI"],p=y(c,d);if(!$("#JournalDetail_Page").jqxValidator("validate"))return!1;p?Core.AjaxRequest({url:e,type:"POST",async:!1,params:s,dataType:"text",showMsg:!1,callback:function(e){if(e){try{var a;a="操作成功"==e?"1000":"3000",Core.alert({message:""+e,hide:a}),$("#Journal").jqxGrid("updatebounddata","cells")}catch(e){}$.closeTab()}else Core.alert({message:"借贷不平衡！"})},failure:function(e){}}):Core.alert({message:"同一科目只能为借方或贷方金额！"})});var g=function(){var e=[],a=0;return $.each($("#JournalDetailTable>tbody>tr"),function(){var t=$(this).children();""===t.eq(2).children().val()&&""===t.eq(3).children().val()||(e[a]={description:t.eq(0).children().val(),chartOfAccount:{id:t.eq(1).children().val()},debitAmt:""===t.eq(2).children().val()?0:t.eq(2).children().val(),creditAmt:""===t.eq(3).children().val()?0:t.eq(3).children().val(),category1:t.eq(4).children().val(),category2:t.eq(5).children().val(),createDate:$("#datepicker").val()},a+=1)}),e},b=function(){var e=$("#JournalDetailTable> tbody>tr"),a=!0;return $.each(e,function(){var e=($(this).eq(0).children().eq(0).children().val(),$(this).eq(0).children().eq(1).children().jqxComboBox("getSelectedItem")),t=$(this).eq(0).children().eq(2).children().val(),l=$(this).eq(0).children().eq(3).children().val();if(null==e||""===t&&""===l)if(null==e&&""===t&&""===l)a=!0;else{if(null==e)return Core.alert({message:"请选择科目！"}),a=!1,!1;if(""===t||""===l)return Core.alert({message:"请输入金额！"}),a=!1,!1}else a=!0}),a},y=function(e,a){var t=!0;return $.each(a,function(a,l){var r=[],n=[],i=[],o=0;for(var a in e)e.hasOwnProperty(a)&&e[a].chartOfAccount===l&&(r[o]=e[a].creditAmt,o+=1);o=0;for(var u in r)r.hasOwnProperty(u)&&(0===r[u].length?n[o]=r[u]:i[0]=r[u]);if(i.length*n.length!=0)return t=!1,!1}),t},_=function(){for(var e=$(".JournalDetailNum").length-1,a=0,t=0,l=0;l<e;l++){var r=1e3*$(".JournalDetailNum").eq(l).val();l%2!=1||isNaN(r)||(a+=parseInt(r)),l%2!=0||isNaN(r)||(t+=parseInt(r))}return[a/1e3,t/1e3]}}();