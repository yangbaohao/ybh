var ViewSaleOrderMgt=function(){var e=this;this.url=_global_settings.service.url+"/overview",this.random=null,this.orderId=null,this.data=null,this.stop=!1,this.receiveRecord=null,this.saleRowdata=null,this.enterPriceInfo=null,this.customerSource=null;var r=0,a=[],i=0;this.initInput=function(){e.saleRowdata=$.pk.data,void 0!=$.pk&&(e.orderId=$.pk.data.id,e.random=$.pk.data.random),null!=e.random&&""!=e.random||(e.random=(new Date).getTime()),e.initWindows(),e.initPermissionStatus(e.saleRowdata),e.initOcrOrderStatus(e.saleRowdata)},this.initOtherStatusOrder=function(r){var a="";1==r?a=_global_settings.service.url+"/overview/kfRejectOrder/"+e.saleRowdata.uuid:2==r&&(a=_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/salesorderid/"+e.saleRowdata.id+"/"+e.saleRowdata.soOwnerId+"/"+e.saleRowdata.userName)),Core.AjaxRequest({type:"GET",url:a,showMsg:!1,callback:function(a,i){"success"==i&&e.initOtherStatusPages(a,r)},failure:function(e){var r=JSON.parse(e.responseText);Core.alert({message:r.errorMsg})}})},this.initOtherStatusPages=function(r,a){if(1==a&&$("#viewSO-receiveTable").css("display","none"),2==a)return e.getReceiveRecord(r.salesOrderDeal.id),void $("#viewSO-attachment").fileuploader({filelist:r.fileInfoIds.toString(),orderId:e.saleRowdata.id,ownerId:e.saleRowdata.soOwnerId,ownerName:e.saleRowdata.userName,readonly:!0,orderType:e.saleRowdata.orderType,showImg:!1});$(".viewfileorderhide").hide();var i=[];r.fileInfoIds.indexOf(",")>0?i=r.fileInfoIds.split(","):i.push(r.fileInfoIds),e.loadImgSpan(i),$("#viewSO-orderNumber").val(r.orderNumber),$("#viewSO-remarkPrint").val(r.remarkPrint),$("#viewSO-address").val(r.address),$("#viewSO-saletime").val(void 0==r.orderDate?"":r.orderDate.substring(0,10)),$("#viewSO-sendTime").val(void 0==r.deliveryDate?"":0==r.deliveryDate.substring(11,12)?r.deliveryDate.substring(0,10):r.deliveryDate.substring(0,16)),$("#viewSO-rectime").val(void 0==r.planDeliveryDate?"":r.planDeliveryDate.substring(0,10)),$("#viewSO-Form").find(".viewSoIcons").show(),$("#viewSO-orderMoney-span").find(".viewSO-orderPartMoney-text").text("合同金额"),$("#viewSO-orderPartMoney").removeClass("b-0").removeClass("p-l-0"),$("#viewSO-orderPartMoney").parent().removeClass("ab65").removeClass("col-sm-10").removeClass("col-sm-7").addClass("ab90").addClass("col-sm-9"),$("#viewSO-orderMoney-span").removeClass("col-md-3").addClass("col-md-4"),$("#viewSO-orderMoney-span").find("label").addClass("m-l-15").addClass("leftlabel"),$("#viewSO-orderMoney-span").insertAfter($("#viewSO-addCustomerId-span")),$("#viewSO-orderMoney").val(money(r.totalAmt))},this.setOrderNoReceive=function(e){var r=$("#viewSaleOrder_grid").jqxGrid("getcolumnaggregateddata","price3",["sum"]).sum;r=parseFloat(money(r));var a=e[0].arrearsType,i=parseFloat($("#viewSO-orderMoney").val()),t=parseFloat($("#viewSO-preferMoney").val()),o=parseFloat($("#viewSO-orderReceive").val()),s=parseFloat($("#viewSO-orderAlreadyDeliver").val()),d=parseFloat(money($("#viewSO-viewTaxLimit").val())),n="";"contractAmount"===a&&(n=i-o),"deliveryAmount"===a&&(n=r<=s?s-o-t+d:s-o),n<0?($("#viewSO-orderOverReceive").val(money(-n)),$("#viewSO-orderNoReceive").val(money(0)),$("#viewSO-orderOverReceive").parents(".col-md-3").find(".row").removeClass("hide")):($("#viewSO-orderOverReceive").val(money(0)),$("#viewSO-orderNoReceive").val(money(n)),$("#viewSO-orderOverReceive").parents(".col-md-3").find(".row").removeClass("show"))},this.initWindows=function(){$("#ocrCheckSubmitWindow").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,height:450,width:600,minWidth:500,cancelButton:$("#cancelOcrCheckSubmit"),initContent:function(){}}).on("close",function(){$("#ocrCheckSubmitRemark").val("")}),$("#ocrCheckSubmitWindow").center(),$(window).on("resize",function(){$("#ocrCheckSubmitWindow").center({transition:0})})},this.initOcrOrderStatus=function(r){Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/overview/orderSalesLogs/getlist/"+r.uuid,showMsg:!1,callback:function(r){$.each(r,function(e,r){a.push(r.handleType)});var t=a[a.length-1];t.indexOf("KHBackout")>-1&&a.indexOf("orderSubmit")<0&&(i=1),t.indexOf("KFReject")>-1&&a.indexOf("orderSubmit")<0&&(i=2),0==i?(e.isbox="N",getPriseInfo({id:"viewSOAddressTableArs",soOwnerId:e.saleRowdata.soOwnerId,userName:e.saleRowdata.userName,callback:function(r){e.enterPriceInfo=r,r[0].blueTooth&&$("#viewSO-boxflag").parents(".col-md-1").addClass("hide"),e.getSaleOrderDetail(e.saleRowdata.uuid)}})):e.initOtherStatusOrder(i);var o={localdata:r,datatype:"json"},s=new $.jqx.dataAdapter(o),d={source:s,rendergridrows:function(){return s.recordids},pageable:!1,width:"100%",height:"auto",enablehover:!1,columnsheight:45,columns:[{text:"更新人",dataField:"createBy",width:"15%"},{text:"备注",width:"70%",cellsrenderer:function(e,r,a,i,t,o){var s='<div class="agrid">',d="";switch(o.handleType){case"orderSubmitAgain":d=void 0==o.submitRemark?"":o.submitRemark;break;case"KFReject":d=void 0==o.rejectRemark?"":o.rejectRemark;break;case"checkSuccess":case"checkFailed":d=void 0==o.checkRemark?"":o.checkRemark;break;case"checkRefused":d=void 0==o.refusedRemark?"":o.refusedRemark;break;case"KHBackout":d=void 0==o.backRemark?"":o.backRemark;break;default:d=""}return s+=getCodeData(o.handleType),""!=d&&void 0!=d&&(s+="："),(s+=d)+"</div>"}},{text:"更新时间",dataField:"handleDate",width:"15%"}]};$("#viewOcrStatusGrid").grid(d)},failure:function(e){var r=JSON.parse(e.responseText);Core.alert({message:r.errorMsg})}})},this.initPermissionStatus=function(r){var a=r.orderType,i=getCurrentInfo();if("ocr_writer"==i){["complete","checkAgainSuccess","checkSuccess"].indexOf(a)>-1?$("#viewSO-editBtn").css("display","none"):$("#viewSO-editBtn").css("display","block")}if(["complete","checkAgainSuccess","checkSuccess","KFReject","KHBackout"].indexOf(a)>-1&&($("#viewSO-editBtn").css("display","none"),$("#viewSO-rejectBtn").css("display","none")),("ocr_checker"==i||"ocr_sys"==i||"ocr_grp"==i)&&("ocr_checker"==i&&($("#viewSO-editBtn").css("display","none"),$("#viewSO-rejectBtn").css("display","none")),"orderSubmit"==a||"checking"==a||"orderSubmitAgain"==a||"checkingAgain"==a)){$("#viewSO-checkPass").removeClass("hide"),$("#viewSO-checkRefuse").removeClass("hide");var t="checkSuccess",o="checkFailed";"orderSubmit"==e.saleRowdata.orderType||"checking"==e.saleRowdata.orderType?(t="checkSuccess",o="checkFailed"):"orderSubmitAgain"!=e.saleRowdata.orderType&&"checkingAgain"!=e.saleRowdata.orderType||(t="checkAgainSuccess",o="checkAgainFailed"),$("#viewSO-checkPass").attr("data-status",t),$("#viewSO-checkRefuse").on("click",function(){$("#ocrCheckSubmitWindow").jqxWindow("open",function(){$("#ocrCheckSubmitRemark").val("").focus(),$("#saveOcrCheckSubmit").attr("data-status",o)})})}},this.loadImgSpan=function(r){var a="";for(var i in r){a+=' <form class="col-md-4 imgFile">                                                                                                                         \t       <div class="col-md-12">                                                                                                                      \t\t\t  <div class="viewimgDetailRowImgCell" style="height:100pt">                                                                                                                    \t\t\t      <img src="'+(ctx+"/CXF/rs/SimpleAC/down/"+(new Base64).encode("toocr/order/downFile/"+r[i]+"/"+e.saleRowdata.soOwnerId+"/"+e.saleRowdata.userName))+'" style="width: 100%; height: 100%;position: relative;" class="img0"> \t\t\t  </div>                                                                                                                                    \t\t\t  </div>                                                                                                                                    \t       </div>                                                                                                                                       \t   </form>'}$(".viewimgDetailRowList").html(a),$("#viewFastSo-list").css("display","")},this.getSaleOrderDetail=function(r){Core.AjaxRequest({url:e.url+"/getOrder/"+r,type:"GET",showMsg:!1,callback:function(r){e.jsdata=$.extend(!0,{},r),e.data=r,e.receiveRecord=r,e.initPage(r),e.initReceiveRecord(r.ocrSaleOrderBill),e.initPay(r.ocrSaleOrderBill);var a={inputId:"#otherPayInput",labelId:"#viewOtherpay",otherDesc:r.otherAmtdesc,view:!0};otherPay(a),e.orderNumber=r.orderNumber,$("#viewSO-attachment").fileuploader({filelist:r.fileInfoIds.toString(),orderId:e.saleRowdata.id,ownerId:e.saleRowdata.soOwnerId,ownerName:e.saleRowdata.userName,readonly:!0,orderType:e.saleRowdata.orderType,showImg:!1})},failure:function(e){var r=JSON.parse(e.responseText);Core.alert({message:r.errorMsg,callback:function(){$.closeTab()}})}})},this.initReceiveRecord=function(r){0==r.length?($("#viewSO-receiveTable").css("display","none"),$("#viewSO-orderNoReceive").val($("#viewSO-orderMoney").val())):($("#viewSO-receiveTable").css("display",""),e.initReceiveDetails(r))},this.initPage=function(a){if($("#viewSO-customerName").val(void 0==a.clientName?a.clientInfo.userInfo.name:a.clientName),$("#viewSO-orderNumber").val(a.orderNumber),$("#viewSO-otherpay").attr("disabled","disabled"),$("#viewOtherpay").attr("disabled","disabled"),0==a.otherAmt||void 0==a.otherAmt?$("#viewSO-otherpay")[0].checked=!1:($("#viewSO-otherpay")[0].checked=!0,$("#viewSOshowOtherpay").css("display",""),$("#viewSO-otherpayInput").val(money(a.otherAmt))),$("#viewSO-saletime").val(void 0==a.orderDate?"":a.orderDate.substring(0,10)),$("#viewSO-sendTime").val(void 0==a.deliveryDate?"":0==a.deliveryDate.substring(11,12)?a.deliveryDate.substring(0,10):a.deliveryDate.substring(0,16)),$("#viewSO-rectime").val(void 0==a.planDeliveryDate?"":a.planDeliveryDate.substring(0,10)),void 0==a.deliveryAddress){for(var i=a.addressList,t="",o=0;o<i.length;o++)t+=i[o].description+",";$("#viewSO-address").val(t.substring(0,t.length-1))}else $("#viewSO-address").val(a.deliveryAddress);var s={};$("#viewSO-box").attr("disabled","disabled"),"N"!=a.goodsBinning?($("#viewSO-box")[0].checked=!0,e.isbox="Y"):($("#viewSO-box").parents(".priseInfoFlag").hide(),s.totalCartons=!0,s.eachCartons=!0),$("#viewSO-productMeasFlag").attr("disabled","disabled"),a.productMeasFlag?($("#viewSO-productMeasFlag")[0].checked=!0,"size"==a.cartonType||null==a.cartonType?s.volume=!0:(s.extent=!0,s.breadth=!0,s.altitude=!0)):($("#viewSO-productMeasFlag").parents(".priseInfoFlag").hide(),s.extent=!0,s.breadth=!0,s.altitude=!0,s.volume=!0),a.yardsFlag&&(s.yards=!1),a.productunitFlag&&(s.unitRate=!1),$("#viewSO-boxflag").attr("disabled","disabled"),a.printOfGoodsFlag?$("#viewSO-boxflag")[0].checked=!0:(s.printOfGoods=!0,$("#viewSO-nameNoFlag").css({cursor:"not-allowed",background:"#e7e7e7"})),$("#viewSO-tax").val(a.vat+"%"),0!=a.vat&&($("#viewSOTaxLimit").css("display",""),$("#viewSO-taxLimit").val(money(void 0==a.vatAmt?0:a.vatAmt))),$("#viewSO-orderMoney").val(money(a.totalAmt)),$("#viewSO-preferMoney").val(money(a.cheapAmt)),$("#viewSO-orderAlreadyDeliver").val(money(a.alreadyDeliverAmt)),$("#viewSO-orderNoReceive").val(money(a.nopaidAmt)),$("#viewSO-box").on("change",function(){$(this).is(":checked")?$("#viewSaleOrder_grid").boxSetting("show"):$("#viewSaleOrder_grid").boxSetting("hide")}),$("#viewSO-boxflag").on("change",function(){$(this).is(":checked")?$("#viewSaleOrder_grid").printOfGoodsFlag("show"):$("#viewSaleOrder_grid").printOfGoodsFlag("hide")}),$("#viewSO-productMeasFlag").on("change",function(){$(this).is(":checked")?$("#viewSaleOrder_grid").productMeasFlag("show"):$("#viewSaleOrder_grid").productMeasFlag("hide")}),$("#viewSO-remarkPrint").val(a.remarkPrint),getProductInUsePart(e.saleRowdata.soOwnerId,e.saleRowdata.userName,function(i){var t=i;$("#viewSaleOrder_grid").easyGrid({columnSumEvent:function(){var e=$("#viewSaleOrder_grid").jqxGrid("getcolumnaggregateddata","price3",["sum"]);r=e.sum},stop:e.stop,source:a.ocrSaleOrderDetail,order:a,toggerColumns:s,sourceType:"salePrice",productSourceName:t,gridSettings:{editable:!1,delBtn:!1},ownerSettings:{soOwnerId:e.saleRowdata.soOwnerId,userName:e.saleRowdata.userName,elementId:null}})})},this.initReceiveDetails=function(r){var a={setOrderNoReceive:e.setOrderNoReceive,enterPriceInfo:e.enterPriceInfo,source:r,orderMoney:$("#viewSO-orderMoney"),receiveMoney:$("#viewSO-orderReceive"),notReceiveMoney:$("#viewSO-orderNoReceive"),overReceiveMoney:$("#viewSO-orderOverReceive")};$("#viewSO-receiveRecordTable").zqwRecOrpayTable(a)},this.initPay=function(r){var a={setOrderNoReceive:e.setOrderNoReceive,enterPriceInfo:e.enterPriceInfo,type:"salesorderbill",data:r,orderMoney:$("#viewSO-orderMoney"),orderReceive:$("#viewSO-orderReceive"),orderNoReceive:$("#viewSO-orderNoReceive"),orderOverReceive:$("#viewSO-orderOverReceive"),grid:"viewSaleOrder_grid"};$("#viewSO-receiveRecordTablex").easytableExamplex(a)},this.getReceiveRecord=function(r){Core.AjaxRequest({url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/salesorderbill/"+r+"/"+e.saleRowdata.soOwnerId+"/"+e.saleRowdata.userName),type:"GET",showMsg:!1,callback:function(r){e.initReceiveRecord(r)},failure:function(e){}})}},ViewSaleOrderBindModle=function(e){e.random;this.bind=function(){function r(r){var a={};if(a.remark=$("#ocrCheckSubmitRemark").val(),a.orderApprovalStatus=r,a.id=e.saleRowdata.uuid,("checkFailed"==r||"checkAgainFailed"==r)&&""===$("#ocrCheckSubmitRemark").val())return Core.alert({message:"审批不通过意见不能为空"}),!1;Core.AjaxRequest({url:_global_settings.service.url+"/overview/orderSalesLogs",type:"POST",params:a,callback:function(e){$("#ocrCheckSubmitWindow").jqxWindow("close"),$.closeTab(),$("#userInformationGrid").jqxGrid("updatebounddata","cells"),$("#placeOrders").jqxGrid("updatebounddata","cells")},failure:function(e){}})}$("#viewSO-rejectBtn").off("click").on("click",function(){setPara(),rejectOcrOrder(e.saleRowdata.uuid)}),$("#viewSO-editBtn").off("click").on("click",function(){setPara(),$.closeTab(),$.addTab({title:"编辑销售单",url:"page/modules/biz/editSaleOrder.html",pk:{data:e.saleRowdata},reload:!0})}),$("#viewSO-checkPass").off("click").on("click",function(e){setPara(),r($(this).attr("data-status"))}),$("#saveOcrCheckSubmit").off("click").on("click",function(e){setPara(),r($(this).attr("data-status"))})},this.unbindAll=function(){}};