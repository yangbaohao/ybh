var EditSaleOrderMgt=function(){var e=this;this.url=_global_settings.service.url+"/overview",this.random=null,this.orderId=null,this.data=null,this.recRed=null,this.customerId=null,this.selectId=null,this.stop=!1,this.otherAmtdesc="",this.otherAmts=[],this.saleRowdata=null,this.addAddressObj=[],this.enterPriceInfo=null;var t=0,r=[];this.addressNew=[],unitArr=[],specArr=[],colorArr=[],prodArr=[];var i=function(){1*$("#editSO-orderReceive").val()>1*$("#editSO-orderMoney").val()?$("#editSO-orderOverReceive").parents(".col-md-3").find(".row").removeClass("hide"):$("#editSO-orderOverReceive").parents(".col-md-3").find(".row").addClass("hide")},d=function(){$("#editSOAddress").jqxValidator({animationDuration:1,hintType:"label",rules:[{input:"#editSOAddressTableArs",message:"不能为空",action:"keyup, change",rule:function(e,t){var r=!0;return $.each(e.children(),function(e){""===$(this).val()&&e<2&&(r=!1)}),!!r}},{input:"#editSOAddressTableSt",message:"不能为空",action:"keyup, blur",rule:"required"}]})};this.initWindows=function(){$("#ocrSubmitAgainWindow").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,height:450,width:600,minWidth:500,cancelButton:$("#cancelSubmitAgainSubmit"),initContent:function(){}}).on("close",function(){$("#ocrSubmitAgainRemark").val("")}),$("#ocrSubmitAgainWindow, #editSOAddress").center(),$(window).on("resize",function(){$("#ocrSubmitAgainWindow, #editSOAddress").center({transition:0})})},this.editFastSoFunc=function(){$("#editSO-orderMoney").on("keyup",function(){timeOut(function(){$("#editSO-receiveRecordTbody").find(".receiveMoney").eq(0).trigger("keyup")})}),$("#editSO-orderMoney").moneyinput({textalign:"left"}),$("#editSO-addOrderNum").moneyinput()},this.initInput=function(){e.saleRowdata=$.pk.data,e.initWindows(),$("#editSO-orderMoney").on("keyup",function(){$("#editSO-send-span").find(".succImg:visible").parent(".addSuccImg").trigger("click"),timeOut(function(){$("#editSO-receiveRecordTbody").find(".receiveMoney").eq(0).trigger("keyup")})}),$("#editSO-preferMoney").on("keyup",function(){var e=$("#editSaleOrder_grid").jqxGrid("getcolumnaggregateddata","price3",["sum"]).sum;$("#editSO-orderMoney").val(money(e-$("#editSO-preferMoney").val()));var t=e-$("#editSO-preferMoney").val()>=0?e-$("#editSO-preferMoney").val():0;$("#editSO-orderNoReceive").val(money(t))}),$("#editSOProductSalePrice").moneyinput({textalign:"left"}),getPriseInfo({id:"editSOAddressTableArs",soOwnerId:e.saleRowdata.soOwnerId,userName:e.saleRowdata.userName,callback:function(t){e.enterPriceInfo=t,"BT"==t[0].printSize&&$("#editSO-boxflag").parents(".col-md-1").addClass("hide"),e.getSaleOrderDetail(e.saleRowdata.uuid)}}),closeModel(),showAddress("editSO-editCustomerId","#editSOAddressTableSn","#editSOAddress"),$("#editSO-otherpayInput").moneyinput(),$("#editSO-editTaxLimit").moneyinput(),$("#editSO-preferMoney").moneyinput(),void 0!=$.pk&&(e.orderId=$.pk.data.id,e.random=$.pk.data.random,e.englishFlag=$.pk.data.englishFlag,e.printPictureFlag=$.pk.data.printPictureFlag,e.printPriceFlag=$.pk.data.printPriceFlag,e.printProductFeeFlag=$.pk.data.printProductFeeFlag,e.printNameNoFlag=$.pk.data.printNameNoFlag,e.printWeightFlag=$.pk.data.printWeightFlag,e.printItemFlag=$.pk.data.printItemFlag),e.initValidator(),d(),e.initPermissionStatus(e.saleRowdata),e.initOcrOrderStatus(e.saleRowdata)},this.setOrderNoReceive=function(e){var t=$("#editSaleOrder_grid").jqxGrid("getcolumnaggregateddata","price3",["sum"]).sum;t=parseFloat(money(t));var r=e[0].arrearsType,i=parseFloat($("#editSO-orderMoney").val()),d=parseFloat($("#editSO-preferMoney").val()),a=parseFloat($("#editSO-orderReceive").val()),o=parseFloat($("#editSO-orderAlreadyDeliver").val()),n=parseFloat(money($("#editSO-editTaxLimit").val())),s="";"contractAmount"===r&&(s=i-a),"deliveryAmount"===r&&(s=t<=o?o+n-a-d:o-a),s<0?($("#editSO-orderOverReceive").val(money(-s)),$("#editSO-orderNoReceive").val(money(0)),$("#editSO-orderOverReceive").parents(".col-md-3").find(".row").removeClass("hide")):($("#editSO-orderOverReceive").val(money(0)),$("#editSO-orderNoReceive").val(money(s)),$("#editSO-orderOverReceive").parents(".col-md-3").find(".row").removeClass("show"))},this.initPermissionStatus=function(e){"ocr_writer"==getCurrentInfo()&&$("#saveEditBtn").text("提交"),["checkFailed","orderSubmitAgain","checkAgainFailed","checkRefused"].indexOf(e.orderType)>-1&&$("#saveEditBtn").text("再次提交")},this.getSaleOrderDetail=function(t){Core.AjaxRequest({url:e.url+"/getOrder/"+t,type:"GET",showMsg:!1,callback:function(r){e.otherAmtdesc=r.otherAmtdesc,e.otherAmts=r.otherAmts,e.data=r,e.initCustomer(r.clientId,r.clientName),$("#editSO-editCustomerId").comboBox({source:[{name:r.clientName,id:r.clientId}],displayMember:"name",valueMember:"id",width:"91.45556%",height:33,checkboxes:!0}).val(t),e.initEdit(r);r.orderType;$("#editSO-attachment").fileuploader({filelist:r.fileInfoIds.toString(),orderId:e.saleRowdata.id,ownerId:e.saleRowdata.soOwnerId,ownerName:e.saleRowdata.userName,readonly:!0,orderType:e.saleRowdata.orderType,showImg:!1})},failure:function(e){Core.alert({message:e,callback:function(){$.closeTab()}})}})};this.initEdit=function(d){var a={};"N"!=d.goodsBinning?$("#editSO-box")[0].checked=!0:(a.totalCartons=!0,a.eachCartons=!0,$("#editSO-box").parents(".priseInfoFlag").hide()),$("#editSO-editCustomerId").jqxComboBox({disabled:!0}),$("#editSO-editCustomerId").val(d.clientId),$("#editSO-editCustomerId").find("input").val(d.clientName),e.customerId=$("#editSO-editCustomerId").val(),r=d.deliveryAddress;for(var o=void 0==d.ocrSaleOrderAddress?[]:d.ocrSaleOrderAddress,n=0;n<o.length;n++)e.addressNew.push(o[n]);e.cartonType=d.cartonType,d.productMeasFlag?($("#editSO-productMeasFlag")[0].checked=!0,"size"==d.cartonType||null==d.cartonType?(a.volume=!0,a.extent=!1,a.breadth=!1,a.altitude=!1):(a.volume=!1,a.extent=!0,a.breadth=!0,a.altitude=!0)):(a.extent=!0,a.breadth=!0,a.altitude=!0,a.volume=!0,$("#editSO-productMeasFlag").parents(".priseInfoFlag").hide()),d.printOfGoodsFlag?$("#editSO-boxflag")[0].checked=!0:a.printOfGoods=!0,d.productunitFlag&&(a.unitRate=!1),_global_settings.acOwner.yardsFlag&&(a.yards=!1,a.totalCartons=!0,a.eachCartons=!0),$("#editSO-boxflag").on("change",function(){$(this).is(":checked")?$("#editSaleOrder_grid").printOfGoodsFlag("show"):$("#editSaleOrder_grid").printOfGoodsFlag("hide")}),$("#editSO-orderAlreadyDeliver").val(money(d.alreadyDeliverAmt)),$("#editSO-orderNoReceive").val(money(d.nopaidAmt)),e.stop?(e.initStopDetails(d.salesOrderDetails,d,a),$("#editSO-editTax").jqxDropDownList({disabled:!0}),$("#editSO-editTaxLimit").attr("readonly","readonly"),$("#editSO-orderMoney").attr("readonly","readonly").val(money(d.totalAmt))):(e.initOrderDetails(d.ocrSaleOrderDetail,d.vatAmt,a),$("#editSO-orderMoney").val(money(d.totalAmt))),t=d.totalAmt-(void 0==d.vatAmt?0:d.vatAmt),$("#editSO-editTax").on("select",function(){0==$(this).val()?($("#editSOtaxLimit").css("display","none"),$("#editSO-editTaxLimit").val("")):($("#editSOtaxLimit").css("display",""),$("#editSO-editTaxLimit").val(money(t*(parseInt($(this).val())/100)))),$("#editSO-orderPartMoney").val(money(1*t+1*$("#editSO-editTaxLimit").val())),$("#editSO-orderMoney").val(money($("#editSO-orderPartMoney").val()-$("#editSO-preferMoney").val())),e.setOrderNoReceive(e.enterPriceInfo),i()}),$("#editSO-editTaxLimit").on("change keyup",function(){var r=""==$(this).val()?0:$(this).val();$("#editSO-orderPartMoney").val(money(1*t+1*r)),$("#editSO-orderMoney").val(money($("#editSO-orderPartMoney").val()-$("#editSO-preferMoney").val())),e.setOrderNoReceive(e.enterPriceInfo),i()}),$("#editSO-editTax").dropDownlist({source:{0:"0%",3:"3%",5:"5%",6:"6%",11:"11%",13:"13%",17:"17%"},width:"75%",height:35,selectedIndex:0}).val(d.vat),$("#editSO-editOrderNumber").val(d.orderNumber),0==d.otherAmt||void 0==d.otherAmt?$("#editSO-otherpay")[0].checked=!1:($("#editSO-otherpay")[0].checked=!0,$("#editSOshowOtherpay").css("display",""),$("#editSO-otherpayInput").val(money(d.otherAmt)));var s=null==d.orderDate?"":d.orderDate.substring(0,10);$("#editSO-time").datetimeinput({width:"90%",height:34,formatString:"yyyy-MM-dd",showTimeButton:!1}).val(s),$("#editSO-rectime").datetimeinput({width:"90%",height:34,formatString:"yyyy-MM-dd",showTimeButton:!1}).val(void 0==d.planDeliveryDate?"":d.planDeliveryDate.substring(0,10)),$("#editSO-sendTime").datetimeinput({width:"90%",height:34,formatString:"yyyy-MM-dd HH:mm",showTimeButton:!0,showCalendarButton:!0}).val(void 0==d.deliveryDate?"":d.deliveryDate.substring(0,16)),$("#editSO-orderMoney").val(money(d.totalAmt)),0!=d.vat&&($("#editSOtaxLimit").css("display",""),$("#editSO-editTaxLimit").val(money(d.vatAmt))),$("#editSO-orderMoney").val(money(d.totalAmt)),$("#editSO-preferMoney").val(money(d.cheapAmt)),$("#editSO-orderPartMoney").val(money(d.totalAmt+d.cheapAmt)),e.recRed=d.ocrSaleOrderBill,0==e.recRed.length||$("#editSO-receiveTable").css("display",""),e.initReceiveRed(e.recRed),$("#editSO-remarkPrint").val(d.remarkPrint);var l={inputId:"#editSO-otherpay",labelId:"#editOtherpay",showId:"#editSO-otherpayInput",otherDesc:void 0==e.otherAmtdesc?"":e.otherAmtdesc,res:void 0==e.otherAmtdesc?"":e.otherAmtdesc,ownerId:e.saleRowdata.soOwnerId,name:e.saleRowdata.userName,mgt:e};otherPay(l)},this.initCustomer=function(t){var r=t,i=e.saleRowdata.soOwnerId,d=e.saleRowdata.userName;Core.AjaxRequest({type:"GET",showMsg:!1,url:_global_settings.service.url+"/SimpleAC/"+(new Base64).encode("toocr/order/search/clientinfo/id/"+r+"/"+i+"/"+d),callback:function(t){var r=t;e.selectId=t.userInfo.id,$.each(r.userInfo.address,function(e,t){""==t.shortName?t.addressLabel=t.province+t.city+t.district+t.street:t.addressLabel="("+t.shortName+")"+t.province+t.city+t.district+t.street}),e.initReceiverAddress(r.userInfo.address)}})},this.initReceiverAddress=function(t){0!=e.addressNew.length&&(t=t.concat(e.addressNew)),$("#editSO-editReceiverAddress").comboBox({source:t,displayMember:"addressLabel",valueMember:"addressLabel",width:"91.45556%",height:33,checkboxes:!0}),setTimeout(function(){for(var e=r.split(","),t=0;t<e.length;t++)$("#editSO-editReceiverAddress").jqxComboBox("checkItem",e[t])},500)},this.initOrderDetails=function(r,d,a){getProductInUsePart(e.saleRowdata.soOwnerId,e.saleRowdata.userName,function(d){var o=d;$("#editSaleOrder_grid").easyGrid({columnSumEvent:function(){var r=$("#editSaleOrder_grid").jqxGrid("getcolumnaggregateddata","ysprice",["sum"]).sum,d=$("#editSaleOrder_grid").jqxGrid("getcolumnaggregateddata","dsprice",["sum"]).sum;$("#editSO-orderAlreadyDeliver").val(money(r+d));var a=$("#editSaleOrder_grid").jqxGrid("getcolumnaggregateddata","price3",["sum"]);t=a.sum;var o=$("#editSO-editTax").val(),n=money(t*o/100);0==o?($("#editSO-orderPartMoney").val(money(t)),$("#editSO-orderMoney").val(money($("#editSO-orderPartMoney").val()-$("#editSO-preferMoney").val())),e.setOrderNoReceive(e.enterPriceInfo)):($("#editSO-editTaxLimit").val(n),$("#editSO-orderPartMoney").val(money(1*n+1*t)),$("#editSO-orderMoney").val(money($("#editSO-orderPartMoney").val()-$("#editSO-preferMoney").val())),e.setOrderNoReceive(e.enterPriceInfo)),i()},toggerColumns:a,source:r,sourceType:"salePrice",productSourceName:o,order:e.data,ownerSettings:{soOwnerId:e.saleRowdata.soOwnerId,userName:e.saleRowdata.userName,elementId:null},gridSettings:{editable:!0,delBtn:!0}})})},this.initOcrOrderStatus=function(e){Core.AjaxRequest({type:"GET",url:_global_settings.service.url+"/overview/orderSalesLogs/getlist/"+e.uuid,showMsg:!1,callback:function(e){var t={localdata:e,datatype:"json"},r=new $.jqx.dataAdapter(t),i={source:r,rendergridrows:function(){return r.recordids},pageable:!1,width:"100%",height:"auto",enablehover:!1,columnsheight:45,columns:[{text:"更新人",dataField:"createBy",width:"15%"},{text:"备注",width:"70%",cellsrenderer:function(e,t,r,i,d,a){var o='<div class="agrid">',n="";switch(a.handleType){case"orderSubmitAgain":n=void 0==a.submitRemark?"":a.submitRemark;break;case"KFReject":n=void 0==a.rejectRemark?"":a.rejectRemark;break;case"checkSuccess":case"checkFailed":n=void 0==a.checkRemark?"":a.checkRemark;break;case"checkRefused":n=void 0==a.refusedRemark?"":a.refusedRemark;break;case"KHBackout":n=void 0==a.backRemark?"":a.backRemark;break;default:n=""}return o+=getCodeData(a.handleType),""!=n&&void 0!=n&&(o+="："),(o+=n)+"</div>"}},{text:"更新时间",dataField:"handleDate",width:"15%"}]};$("#viewOcrOrderStatusGrid").grid(i)},failure:function(e){var t=JSON.parse(e.responseText);Core.alert({message:t.errorMsg})}})},this.initStopDetails=function(e,r,d){$("#editSaleOrder_grid").easyGrid({columnSumEvent:function(){$("#editSaleOrder_grid").jqxGrid("getcolumnaggregateddata","price3",["sum"]);i()},toggerColumns:d,stop:!0,source:e,sourceType:"salePrice",gridSettings:{editable:!1,delBtn:!1}}),t=r.totalAmt-(void 0==r.vatAmt?0:r.vatAmt)},this.initReceiveRed=function(t){var r={setOrderNoReceive:e.setOrderNoReceive,enterPriceInfo:e.enterPriceInfo,type:"salesorderbill",data:t,orderMoney:$("#editSO-orderMoney"),orderReceive:$("#editSO-orderReceive"),orderNoReceive:$("#editSO-orderNoReceive"),orderOverReceive:$("#editSO-orderOverReceive"),grid:"editSaleOrder_grid"};$("#editSO-receiveTable").easytableExamplex(r)},this.initValidator=function(){$("#editSO-Form").jqxValidator({animationDuration:1,hintType:"label",rules:[{input:"#editSO-rectime",message:"不能小于销售日期",action:"keyup, change",rule:function(e,t){return""==e.val()||!(e.val()<$("#editSO-time").val())}},{input:"#editSO-sendTime",message:"不能小于销售日期",action:"keyup, change",rule:function(e,t){return""==e.val()||!(e.val()<$("#editSO-time").val())}}]})}},EditSaleOrderBindModle=function(e){var t=this,r=function(e){return $("#editSaleOrder_grid").getDataWash(e)},i=function(){return!($("#editSO-receiveRecordTbody").children().find(".s1r").length>0)},d=function(){var e=[],t=$("#editSO-receiveRecordTbody").children();return $.each(t,function(r){var i=t.eq(r).find(".receiveMoney").val();if(0!=i&&""!=i){var d={};d.cerateDate=t.eq(r).find(".time").val(),d.amount=i,d.payWay=t.eq(r).find(".receiveWay").val(),d.remark=t.eq(r).find(".remark").val(),e.push(d)}}),e};this.submitOrder=function(t,r){if(!r&&!i())return Core.alert({message:"编辑的收款金额不能为0！"}),!1;Core.AjaxRequest({url:e.url+"/updateOrder",type:"PUT",params:t,showWaiting:!0,successMsg:"操作成功",callback:function(e){setCloseAlertTimeOneSecond(),$("#ocrSubmitAgainWindow").jqxWindow("close"),$("#ocrSubmitAgainWindow").jqxWindow("destroy"),$.closeTab(),$("#userInformationGrid").jqxGrid("updatebounddata","cells")},failure:function(e){var t=JSON.parse(e.responseText);Core.alert({message:t.errorMsg})}})},this.initEditParam=function(t,i){var a={};a.id=e.data.id,a.submitRemark=t,a.clientName=$("#editSO-editCustomerId").find("input").val(),a.clientId=$("#editSO-editCustomerId").val(),a.address="";var o=$("#editSO-editReceiverAddress").jqxComboBox("getCheckedItems"),n="",s=e.addAddressObj;if(a.ocrSaleOrderAddress=[],$.each(o,function(e){n+=o[e].value+","}),n=n.substring(0,n.length-1),0!=s.length){for(var l=n.split(","),c=0;c<s.length;c++)for(var u=0;u<l.length;u++)s[c].addressLabel==l[u]&&a.ocrSaleOrderAddress.push(s[c]);0!=e.addressNew.length&&(a.ocrSaleOrderAddress=a.ocrSaleOrderAddress.concat(e.addressNew))}else 0!=e.addressNew.length&&(a.ocrSaleOrderAddress=e.addressNew);a.deliveryAddress=n,a.orderDate=$("#editSO-time").val(),a.deliveryDate=""==$("#editSO-sendTime").val()?"":$("#editSO-sendTime").val()+":00",a.planDeliveryDate=$("#editSO-rectime").val(),a.orderNumber=$("#editSO-editOrderNumber").val(),a.otherAmtdesc=e.otherAmtdesc,a.otherAmt=$("#editSO-otherpayInput").val(),$("#editSO-otherpay")[0].checked||(a.otherAmtdesc="",a.otherAmt=""),a.remarkPrint=$("#editSO-remarkPrint").val(),a.productMeasFlag=$("#editSO-productMeasFlag")[0].checked,a.printOfGoodsFlag=$("#editSO-boxflag")[0].checked,a.goodsBinning="N",$("#editSO-box")[0].checked&&(a.goodsBinning="Y"),a.simpleOrderId=e.saleRowdata.id,a.vat=$("#editSO-editTax").val(),a.vatAmt=$("#editSO-editTaxLimit").val(),a.totalAmt=$("#editSO-orderMoney").val(),a.cheapAmt=$("#editSO-preferMoney").val(),a.uuid=e.saleRowdata.uuid,a.discountFlag=_global_settings.acOwner.ownerAttr.discountFlag,a.yardsFlag=_global_settings.acOwner.yardsFlag,a.productunitFlag=_global_settings.acOwner.productunitFlag,a.customFormulaFlag=_global_settings.acOwner.ownerAttr.customFormulaFlag,a.productKgFlag=_global_settings.acOwner.productKgFlag,a.productKgFlag&&(a.weightUnit=_global_settings.acOwner.prodUnit[0].descr,a.weightWay=_global_settings.acOwner.prodUnit[0].weightWay),$("#editSO-productMeasFlag")[0].checked&&(a.cartonType=e.cartonType);var m=d();return a.ocrSaleOrderBill=[],$.each(m,function(e){var t={};t.createDate=m[e].createDate,t.amount=m[e].amount,t.payWay=m[e].payWay,t.remark=m[e].remark,a.ocrSaleOrderBill.push(t)}),a.ocrSaleOrderDetail=r(!i),a.fileInfoIds=[],$("#editSO-attachment").find(".item").each(function(e,t){var r=$(t).attr("data-id");void 0!==r&&a.fileInfoIds.push(r)}),a.fileInfoIds=a.fileInfoIds.toString(),a},this.bind=function(){$("#editSoRejectBtn").off("click").on("click",function(){setPara(),rejectOcrOrder(e.saleRowdata.uuid)}),$("#editSOAddressBtn").on("click",function(){if($("#editSOAddress").jqxValidator("validate")){var t={shortName:$("#editSOAddressTableSn").val(),province:$("#editSOAddressTableArs").find("select").eq(0).val(),city:$("#editSOAddressTableArs").find("select").eq(1).val(),district:$("#editSOAddressTableArs").find("select").eq(2).val(),street:$("#editSOAddressTableSt").val(),zipCode:$("#editSOAddressTableZc").val(),remark:$("#editSOAddressTableRm").val()},r=""==t.shortName?"":"("+t.shortName+")";t.addressLabel=r+t.province+t.city+t.district+t.street,e.addAddressObj.push(t),$("#editSOAddress").modal("hide"),$("#editSO-editReceiverAddress").jqxComboBox("addItem",{label:t.addressLabel}),$("#editSO-editReceiverAddress").jqxComboBox("checkItem",t.addressLabel)}}),$("#saveEditBtn").off("click").on("click",function(){setPara();var r=e.saleRowdata.orderType;["checkFailed","checkAgainFailed","checkRefused","orderSubmitAgain","checking","checkingAgain","orderSubmit","orderSubmitAgain"].indexOf(r)>-1?$("#ocrSubmitAgainWindow").jqxWindow("open",function(){$("#ocrSubmitAgainRemark").focus()}):"orderSubmit"==r&&timeOut(function(){getMsgForNullSpecId($("#editSaleOrder_grid").getDataWash(),t.submitOrder,t.initEditParam("",null))})}),$("#saveSubmitAgainSubmit").off("click").on("click",function(){var e=$("#ocrSubmitAgainRemark").val();if(""==e)return Core.alert({message:"提交理由不可为空"}),!1;timeOut(function(){getMsgForNullSpecId($("#editSaleOrder_grid").getDataWash(),t.submitOrder,t.initEditParam(e,null))})}),$("#editSO-productMeasFlag").on("change",function(){$(this).is(":checked")?$("#editSaleOrder_grid").productMeasFlag("show",e.cartonType):$("#editSaleOrder_grid").productMeasFlag("hide",e.cartonType)}),$("#editSO-box").on("change",function(){$(this).is(":checked")?$("#editSaleOrder_grid").boxSetting("show"):$("#editSaleOrder_grid").boxSetting("hide")})},this.unbindAll=function(){}};