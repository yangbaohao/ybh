var UseVou=function(){var e=this,o=_global_settings.service.url+"/coupon";this.id=null,this.initInput=function(){e.initWindows(),e.initPage(),e.initGrid(e.searchObj)},this.initWindows=function(){$("#useVouWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:360,height:"auto",minWidth:500,cancelButton:$("#cancelUseVouBtn"),initContent:function(){$("#editusevou-modules").jqxDropDownList({theme:currentTheme,source:ComboBoxSources.getRecords("productName"),searchMode:"contains",displayMember:"productName",valueMember:"productName",height:34,width:"100%",checkboxes:!0,placeHolder:""})}}).on({close:function(){setTimeout(function(){$("#editusevou-code").val(""),$("#editusevou-modules").jqxDropDownList("uncheckAll"),$("#editusevou-time").val("")},500)}})},this.initPage=function(){$("#useVou-show").css("display",""),$("#useVou-module").comboBox({source:ComboBoxSources.getRecords("productName"),searchMode:"contains",displayMember:"productName",width:"100%"}),$("#useVou-status").dropDownlist({source:{all:"请选择",N:"已使用",Y:"未使用"},height:34,width:"100%",selectedIndex:0}),$("#useVou-show").addClass("hiddendiv")},this.initGrid=function(){e.settings.source.data=e.searchObj;var o=Core.AcDataAdapter("useVouGrid",e.settings.source,{beforeLoadComplete:function(e){}},!1),i={source:o,rendergridrows:function(){return o.recordids},columns:[{text:"使用券编码",dataField:"couponCode",width:"17.5%"},{text:"免费模块",dataField:"accountProductName",width:"17.5%"},{text:"免费期间",dataField:"freeTime",width:"10%"},{text:"开始日期",width:"10%",cellsrenderer:function(e,o,i,t,u,a){var s='<div class="agrid">';return(s+=void 0==a.startTime?"":a.startTime.substring(0,10))+"</div>"}},{text:"到期日期",width:"10%",cellsrenderer:function(e,o,i,t,u,a){var s='<div class="agrid">';return(s+=void 0==a.endTime?"":a.endTime.substring(0,10))+"</div>"}},{text:"状态",dataField:"available",width:"10%",cellsrenderer:function(e,o,i,t,u,a){var s='<div class="agrid">';return(s+=1==a.available?"未使用":"已使用")+"</div>"}},{text:"使用用户名",dataField:"ownerName",width:"15%"},{text:"操作",width:"10%",cellsrenderer:function(e,o,i,t,u,a){var s='<div class="text-center">';return s+='<a class="hoverspan md-edit editUseVoucher" title="编辑"></a>',s+="</div>"}}],pagesize:20,columnsheight:45};$("#useVouGrid").grid(i),$("#useVouGrid").on("click",".editUseVoucher",function(){var o=$("#useVouGrid").jqxGrid("getselectedrowindex"),i=$("#useVouGrid").jqxGrid("getrowdata",o);if(!i.available)return Core.alert({message:"已经使用的使用券不可编辑！"}),!1;e.id=i.id,$("#useVouWin").jqxWindow("open",function(){var e=void 0==i.accountProductName?"":i.accountProductName.split(",");$("#editusevou-code").val(i.couponCode),$.each(e,function(o){$("#editusevou-modules").jqxDropDownList("checkItem",e[o])}),$("#editusevou-time").val(i.freeTime)})})},this.settings={source:{url:o+"/page",data:e.searchObj},grid:{element:"useVouGrid"},ajax:{url:o}},this.searchObj={"ex.couponCode":{value:[],action:"like"},"ex.accountProductName":{value:[],action:"like"},"ex.freeTime":{value:[],action:"eq"},"ex.available":{value:[],action:"eq"},"ex.ownerName":{value:[],action:"like"}},this.searchDataInfo=function(){$("#useVouGrid").jqxGrid("applyfilters"),$("#useVouGrid").jqxGrid("refreshfilterrow"),$("#useVouGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#useVouGrid").jqxGrid("updatebounddata","cells"),$("#useVouGrid").jqxGrid("clearselection"),$("#useVouGrid").jqxGrid("refreshdata")}},UseVouBindModle=function(e){var o=this,i=_global_settings.service.url+"/coupon/updateCoupon";this.search=function(){var o=$("#useVou-code").val(),i=$("#useVou-module").find("input").val(),t=$("#useVou-date").val(),u=$("#useVou-status").val(),a=$("#useVou-name").val();e.searchObj["ex.couponCode"].value=[],""!=o&&e.searchObj["ex.couponCode"].value.push(o),e.searchObj["ex.accountProductName"].value=[],""!=i&&e.searchObj["ex.accountProductName"].value.push(i),e.searchObj["ex.freeTime"].value=[],""!=t&&e.searchObj["ex.freeTime"].value.push(t),e.searchObj["ex.available"].value=[],"all"!=u&&e.searchObj["ex.available"].value.push(u),e.searchObj["ex.ownerName"].value=[],e.searchObj["ex.ownerName"].value.push(a),e.searchDataInfo()},this.bind=function(){$("#useVou-search").on("click",function(){$("#useVou-show").is(":hidden")?$("#useVou-show").slideDown("slow"):o.search()}),hiddenAclick(),$("#useVou-import").on("click",function(){var e={url:_global_settings.service.url+"/common/importCoupon/9/3"};$("#useVou-attachment").html(""),$("#useVou-modal").modal("show"),$("#useVou-attachment").fileuploader(e)}),$("#saveUseVouBtn").on("click",function(){var o={};o.id=e.id,o.freeTime=$("#editusevou-time").val(),o.products=[];var t=$("#editusevou-modules").jqxDropDownList("getCheckedItems");$.each(t,function(e){o.products.push(t[e].originalItem.id)}),Core.AjaxRequest({type:"PUT",url:i,params:o,async:!1,callback:function(){$("#useVouWin").jqxWindow("close"),$("#useVouGrid").jqxGrid("updatebounddata","cells")}})})},this.unbindAll=function(){$("#useVou-search").off("click"),$("#useVou-import").off("click"),$("#saveUseVouBtn").off("click")}};