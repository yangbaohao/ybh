var ViewCustMgt=function(){var e=this,t=_global_settings.service.url+"/potentialCustomers";this.id=null,this.initInput=function(){$("#viewCustTime").text($.pk.date.substring(0,10)),$("#viewCustZt").text($.pk.batchNum),e.initWindows(),e.initGrid(e.searchObj)},this.searchObj={batchNum:{value:[""+$.pk.batchNum],action:"eq"}},this.initWindows=function(){$("#viewCustMgtWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:460,height:"auto",minWidth:500,cancelButton:$("#viewCustMgtCancleBtn"),initContent:function(){}}).on({close:function(){$("#viewCustRemark").val("")}}),$("#mesEditCustWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:300,height:"auto",minWidth:500,cancelButton:$("#cancelMesEditCustBtn"),initContent:function(){}}).on("close",function(){setTimeout(function(){$("#meseditwin-editcust").val(""),$("#meseditwin-editphone").val("")},500)}),$("#mesCustSendWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:700,minHeight:300,height:"auto",minWidth:600,maxWidth:800,cancelButton:$("#cancelCustSendBtn"),initContent:function(){}}).on("close",function(){setTimeout(function(){$("#messendwin-code").val(""),$("#messendwin-zt").val(""),$("#messendwin-mes").val("")},500)})},this.initGrid=function(){var t=Core.AcDataAdapter("viewCustGrid",e.settings.source,{beforeLoadComplete:function(e){}},!1),i={source:t,rendergridrows:function(){return t.recordids},columns:[{text:"潜在客户",width:"15%",cellsrenderer:function(e,t,i,n,a,s){var d='<div class="agrid">';return(d+='<a class="hoverspan viewCustDetail">'+s.potentialName+"</a>")+"</div>"}},{text:"职位",dataField:"potentialPosition",width:"10%"},{text:"联系电话",dataField:"phone",width:"10%"},{text:"公司名称",dataField:"contact",width:"15%"},{text:"企业类型",dataField:"companyType",width:"10%"},{text:"地址区域",dataField:"address",width:"15%"},{text:"主营行业",dataField:"industry",width:"15%"},{text:"操作",width:"10%",cellsrenderer:function(e,t,i,n,a,s){var d='<div class="agrid text-center" style="padding-top:2px">';return d+='<a class="hoverspan md-add addRemark" title="增加备注"></a>',d+='<a class="hoverspan md-edit custEdit" title="编辑"></a>',(d+='<a class="hoverspan md-exit-to-app mesSend" title="发送"></a>')+"</div>"}}],pagesize:20,columnsheight:45};$("#viewCustGrid").grid(i),$("#viewCustGrid").on("click",".viewCustDetail",function(){var e=$("#viewCustGrid").jqxGrid("getselectedrowindex");if(e>=0){var t=$("#viewCustGrid").jqxGrid("getrowdata",e);$.addTab({title:"短信详情",isFrame:!1,url:"page/modules/buso/custDetail.html",pk:{custId:t.id},reload:!0})}}),$("#viewCustGrid").on("click",".addRemark",function(){var t=$("#viewCustGrid").jqxGrid("getselectedrowindex");if(t>=0){var i=$("#viewCustGrid").jqxGrid("getrowdata",t);e.id=i.id,$("#viewCustMgtWin").jqxWindow("open",function(){var e={localdata:i.trackList,datatype:"array"},t=new $.jqx.dataAdapter(e);$("#viewCustRemarkTbody").jqxGrid({source:t,width:"100%",height:160,pageable:!1,columns:[{text:"更新时间",dataField:"createDate",width:"50%"},{text:"备注",dataField:"comment",width:"50%"}]})})}}),$("#viewCustGrid").on("click",".custEdit",function(){var t=$("#viewCustGrid").jqxGrid("getselectedrowindex");if(t>=0){var i=$("#viewCustGrid").jqxGrid("getrowdata",t);e.id=i.id,$("#mesEditCustWin").jqxWindow("open",function(){$("#meseditwin-editcust").val(i.potentialName),$("#meseditwin-editphone").val(i.phone)})}}),$("#viewCustGrid").on("click",".mesSend",function(){var t=$("#viewCustGrid").jqxGrid("getselectedrowindex");if(t>=0){var i=$("#viewCustGrid").jqxGrid("getrowdata",t);e.id=i.id,$("#mesCustSendWin").jqxWindow("open",function(){Core.AjaxRequest({async:!1,url:_global_settings.service.url+"/salesagent/getcode/messagecode",type:"GET",dataType:"text",callback:function(e){$("#messendwin-code").val(e)},failure:function(){}})})}})},this.settings={source:{url:t+"/page",data:e.searchObj},grid:{element:"viewCustGrid"},ajax:{url:t}},this.searchDataInfo=function(){$("#viewCustGrid").jqxGrid("applyfilters"),$("#viewCustGrid").jqxGrid("refreshfilterrow"),$("#viewCustGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#viewCustGrid").jqxGrid("updatebounddata","cells"),$("#viewCustGrid").jqxGrid("clearselection"),$("#viewCustGrid").jqxGrid("refreshdata")}},ViewCustBindModle=function(e){var t=_global_settings.service.url+"/potentialCustomersTrack",i=_global_settings.service.url+"/potentialCustomers";this.bind=function(){$("#viewCustMgtSaveBtn").on("click",function(){if($("#viewCustRemark").val().length>100)return Core.alert({message:"短信内容100字以内"}),!1;var i=e.id;Core.AjaxRequest({url:t,async:!1,type:"POST",params:{comment:$("#viewCustRemark").val(),potentialCustomersId:i},callback:function(e){$("#viewCustMgtWin").jqxWindow("close");try{$("#viewCustGrid").jqxGrid("updatebounddata","cells")}catch(e){}},failure:function(e){}})}),$("#saveMesEditCustBtn").on("click",function(){var t=$("#meseditwin-editcust").val(),n=$("#meseditwin-editphone").val();Core.AjaxRequest({url:i+"/updateNameAndPhone",type:"PUT",async:!1,params:{id:e.id,potentialName:t,phone:n},callback:function(){$("#mesEditCustWin").jqxWindow("close"),$("#viewCustGrid").jqxGrid("updatebounddata","cells")},failure:function(){}})}),$("#saveCustSendBtn").on("click",function(){$("#saveCustSendBtn").attr("disabled",!0),setTimeout(function(){$("#saveCustSendBtn").removeAttr("disabled")},2e3);var t={};t.messageCode=$("#messendwin-code").val(),t.messageContent=$("#messendwin-mes").val(),t.messageTitle=$("#messendwin-zt").val(),t.potentialCustomersId=e.id,Core.AjaxRequest({type:"POST",url:i+"/sendmessageToPerson",async:!1,params:t,callback:function(){$("#mesCustSendWin").jqxWindow("close"),$("#viewCustGrid").jqxGrid("updatebounddata","cells")},failure:function(){}})})},this.unbindAll=function(){$("#viewCustMgtSaveBtn").off("click"),$("#saveMesEditCustBtn").off("click"),$("#saveCustSendBtn").off("click")}};