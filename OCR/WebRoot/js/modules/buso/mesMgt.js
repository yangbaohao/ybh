var MesMgt=function(){var e=this,t=_global_settings.service.url+"/shortmessage";this.message=null,this.initInput=function(){e.initPage(),e.initWindows(),e.initGrid(e.searchObj)},this.searchObj={sortdatafield:"createDate",messageCode:{value:[],action:"like"},messageTitle:{value:[],action:"like"},createBy:{value:[],action:"like"},createDate:{value:[],action:"between"},messageNumber:{value:[],action:"between"}},this.initPage=function(){$("#mes-show").css("display",""),$("#mes-time").dropDownlist({source:["请选择","最近一周","最近两周","最近三周","本月","本季度","本年"],theme:"energyblue",width:"100%",height:"34px",selectedIndex:0,dropDownHeight:150}),$("#mes-sTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#mes-eTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#mes-time").on("change",function(){setValueById("mes-time","mes-sTime","mes-eTime")}),$("#mes-show").addClass("hiddendiv")},this.initWindows=function(){$("#mesWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:700,minHeight:300,height:"auto",minWidth:600,maxWidth:800,cancelButton:$("#cancelMesBtn"),initContent:function(){}}).on("close",function(){setTimeout(function(){$("#meswin-zt").val(""),$("#meswin-mes").val("")},500)}),$("#mesEditWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:700,minHeight:300,height:"auto",minWidth:600,maxWidth:800,cancelButton:$("#cancelMesEditBtn"),initContent:function(){}}).on("close",function(){setTimeout(function(){$("#meswin-editcode").val(""),$("#meswin-editzt").val(""),$("#meswin-editmes").val("")},500)})},this.initGrid=function(){var t=Core.AcDataAdapter("mesMgtGrid",e.settings.source,{beforeLoadComplete:function(e){}},!1),s={source:t,rendergridrows:function(){return t.recordids},columns:[{text:"日期",width:"15%",cellsrenderer:function(e,t,s,i,a,n){return'<div class="agrid">'+n.createDate.substring(0,10)+"</div>"}},{text:"编号",dataField:"messageCode",width:"20%",cellsrenderer:function(e,t,s,i,a,n){var d='<div class="agrid">';return(d+='<a class="hoverspan viewMes">'+n.messageCode+"</a>")+"</div>"}},{text:"短信主题",dataField:"messageTitle",width:"20%"},{text:"发送用户数",dataField:"messageNumber",width:"15%"},{text:"写信人(姓名/用户名)",width:"15%",cellsrenderer:function(e,t,s,i,a,n){var d='<div class="agrid">';return"admin"==n.createBy?d+="系统管理员(admin)":void 0!=getSalesInfoByName(n.createBy)?d+=getSalesInfoByName(n.createBy).userInfo.name+"("+n.createBy+")":void 0!=getCustomerInfoByName(n.createBy)&&(d+=getCustomerInfoByName(n.createBy).name+"("+n.createBy+")"),d+"</div>"}},{text:"操作",width:"15%",cellsrenderer:function(e,t,s,i,a,n){var d='<div class="text-center">';return d+='<a class="hoverspan md-edit editMes" title="编辑"></a>',(d+='<a class="hoverspan md-exit-to-app sendMes" title="发送"></a>')+"</div>"}}],pagesize:20,columnsheight:45};$("#mesMgtGrid").grid(s),$("#mesMgtGrid").on("click",".editMes",function(){var t=$("#mesMgtGrid").jqxGrid("getselectedrowindex");if(t>=0){var s=$("#mesMgtGrid").jqxGrid("getrowdata",t);e.message=s,$("#mesEditWin").jqxWindow("open",function(){$("#meswin-editcode").val(s.messageCode),$("#meswin-editzt").val(s.messageTitle),$("#meswin-editmes").val(s.messageContent)})}}),$("#mesMgtGrid").on("click",".sendMes",function(){var e=$("#mesMgtGrid").jqxGrid("getselectedrowindex");if(e>=0){var t=$("#mesMgtGrid").jqxGrid("getrowdata",e);$.addTab({title:"发送短信",isFrame:!1,url:"page/modules/buso/mesSendMgt.html",pk:{id:t.id},reload:!0})}}),$("#mesMgtGrid").on("click",".viewMes",function(){var e=$("#mesMgtGrid").jqxGrid("getselectedrowindex");if(e>=0){var t=$("#mesMgtGrid").jqxGrid("getrowdata",e);$.addTab({title:"查看短信",isFrame:!1,url:"page/modules/buso/viewMes.html",pk:{mesId:t.id},reload:!0})}})},this.settings={source:{url:t+"/page",data:e.searchObj},grid:{element:"mesMgtGrid"},ajax:{url:t}},this.searchDataInfo=function(){$("#mesMgtGrid").jqxGrid("applyfilters"),$("#mesMgtGrid").jqxGrid("refreshfilterrow"),$("#mesMgtGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#mesMgtGrid").jqxGrid("updatebounddata","cells"),$("#mesMgtGrid").jqxGrid("clearselection"),$("#mesMgtGrid").jqxGrid("refreshdata")}},MesBindModle=function(e){var t=this,s=_global_settings.service.url+"/shortmessage";this.search=function(){var t=$("#mes-code").val(),s=$("#mes-batchNum").val(),i=$("#mes-person").val(),a=$("#mes-sTime").val(),n=$("#mes-eTime").val(),d=$("#mes-sc").val(),r=$("#mes-ec").val();e.searchObj.messageCode.value=[],""!=t&&e.searchObj.messageCode.value.push(t),e.searchObj.messageTitle.value=[],""!=s&&e.searchObj.messageTitle.value.push(s),e.searchObj.createBy.value=[],""!=i&&e.searchObj.createBy.value.push(i),e.searchObj.createDate.value=[],""!=a&&""!=n&&e.searchObj.createDate.value.push(a+" 00:00:00",n+" 23:59:59"),""!=a&&""===n&&e.searchObj.createDate.value.push(a+" 00:00:00",getNowFormatDate()+" 23:59:59"),""===a&&""!=n&&e.searchObj.createDate.value.push("2015-01-01 00:00:00",n+" 23:59:59"),e.searchObj.messageNumber.value=[],""!=d&&""!=r&&e.searchObj.messageNumber.value.push(d,r),e.searchDataInfo()},this.bind=function(){$("#mes-search").on("click",function(){$("#mes-show").is(":hidden")?$("#mes-show").slideDown("slow"):t.search()}),hiddenAclick(),$("#mes-add").on("click",function(){$("#mesWin").jqxWindow("open",function(){Core.AjaxRequest({async:!1,url:_global_settings.service.url+"/salesagent/getcode/messagecode",type:"GET",dataType:"text",callback:function(e){$("#meswin-code").val(e)},failure:function(){}})})}),$("#addMesSaveBtn").on("click",function(){var e={};e.sales={},"salesStaff"==_global_settings.owner.roleName&&(e.sales={id:_global_settings.owner.userid}),e.messageCode=$("#meswin-code").val(),e.messageContent=$("#meswin-mes").val(),e.messageTitle=$("#meswin-zt").val(),Core.AjaxRequest({type:"POST",url:s,params:e,async:!1,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#mesWin").jqxWindow("close"),$("#mesMgtGrid").jqxGrid("updatebounddata","cells")},failure:function(){}})}),$("#addMesSaveEditBtn").on("click",function(){delete e.message.uid,delete e.message.uniqueid,delete e.message.visibleindex,delete e.message.boundindex,e.message.messageTitle=$("#meswin-editzt").val(),e.message.messageContent=$("#meswin-editmes").val(),Core.AjaxRequest({type:"PUT",url:s,params:e.message,async:!1,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#mesEditWin").jqxWindow("close"),$("#mesMgtGrid").jqxGrid("updatebounddata","cells")},failure:function(){}})})},this.unbindAll=function(){$("#mes-search").off("click"),$("#mes-add").off("click"),$("#addMesSaveBtn").off("click"),$("#addMesSaveEditBtn").off("click")}};