var BusoMgt=function(){var e=this,t=_global_settings.service.url+"/potential",s=_global_settings.owner.roleName,o=null,a={},r=[];this.id=null,this.initInput=function(){e.initPage(),e.initWindows(),e.initSearch(),e.initGrid(e.searchObj)},this.distributeSource=function(t){$("#distributeBuso-tbody").off().on("click","tr",function(){$(this)[0]==$("#distributeBuso-tbody").find("tr").eq(-1)[0]&&e.addLine()}),$("#distributeSourceBuso-save").off().on("click",function(){if(e.compareRepeat())return Core.alert({message:"所选负责人不能重复！"}),!1;if(e.compareEmpty())return Core.alert({message:"所选负责人不能为空！"}),!1;if(t.sal=[],"Sys_Admin"==s)t.custom=[],$.each(a,function(e,s){for(var i=0;i<$(".distributeBuso-user").length;i++)if(null!=$(".distributeBuso-user").eq(i).val()){var o=$(".distributeBuso-user").eq(i).val(),r=o.substring(o.indexOf("(")+1,o.length-1);if(a[e].username==r){var n={};n.employeeCode=s.employeeCode,n.username=s.username,n.locked=s.locked,n.roles=s.roles,n.id=s.id,void 0!=getSalesInfoByName(r)&&t.sal.push(n),void 0!=getCustomerInfoByName(r)&&t.custom.push(n)}}});else{var i=ComboBoxSources.getRecords("salesInfo");$.each(i,function(e,s){for(var o=0;o<$(".distributeBuso-user").length;o++)if(null!=$(".distributeBuso-user").eq(o).val()){var a=$(".distributeBuso-user").eq(o).val(),r=a.substring(a.indexOf("(")+1,a.length-1);if(i[e].username==r){var n={};n.employeeCode=s.employeeCode,n.username=s.username,n.locked=s.locked,n.roles=s.roles,n.id=s.id,t.sal.push(n)}}})}delete t.boundindex,delete t.uid,delete t.uniqueid,delete t.visibleindex,Core.AjaxRequest({type:"PUT",async:!1,params:t,showMsg:!1,url:_global_settings.service.url+"/potential",callback:function(e){try{setCloseAlertTimeOneSecond(),$("#busoGrid").jqxGrid("updatebounddata","cells")}catch(e){}},failure:function(e){}})}),$("#distributeBuso-tbody").on("click",".del",function(e){e.stopPropagation();var t=$(this).parent().parent();$(this).parent().parent().index();$("#distributeBuso-tbody").find("tr").length>1&&Core.confirm({message:"确定要删除？",confirmCallback:function(){t.remove()}})}),$("#distributeSource-buso").modal("show"),e.setLineData(),0==$("#distributeBuso-tbody").children().length&&($("#distributeSource-buso").modal("show"),e.setLineData())},this.compareEmpty=function(){for(var e=!1,t=0;t<$(".distributeBuso-user").length;t++)if(""==$(".distributeBuso-user").val()){e=!0;break}return e},this.compareRepeat=function(){for(var e=!1,t=0;t<$(".distributeBuso-user").length;t++)for(var s=t+1;s<$(".distributeBuso-user").length;s++)if(""!=$(".distributeBuso-user").eq(t).val()){var i=$(".distributeBuso-user").eq(t).val(),o=$(".distributeBuso-user").eq(s).val(),a=i.substring(i.indexOf("(")+1,i.length-1),r=o.substring(o.indexOf("(")+1,o.length-1);if(a==r){e=!0;break}}return e},this.addLine=function(){var e=($("#distributeBuso-tbody").children().length,$('<tr><td  style="width:80%;"><div class="distributeBuso-user xiuZheng"></div></td><td><i class="md-cancel del"></i></td></tr>'));$("#distributeBuso-tbody").append(e),e.find(".distributeBuso-user").jqxComboBox({source:r,theme:currentTheme,searchMode:"containsignorecase",displayMember:"username",valueMember:"id",width:"100%",height:"34px",placeHolder:"请选择或输入"})},this.setLineData=function(){$("#distributeBuso-tbody").html("");var t=null;t="Sys_Admin"==s?3:0,Core.AjaxRequest({type:"GET",async:!1,dataType:"text",url:_global_settings.service.url+"/user/customerSales/"+t,callback:function(t){a=JSON.parse(t);for(var i=0;i<a.length;i++){var n=a[i].userInfo.name+"("+a[i].username+")";r.push(n)}"Sys_Admin"==s?(o.sal.length>0&&$.each(o.sal,function(e,t){var s=$('<tr><td><div class="distributeBuso-user xiuZheng" ></div></td><td style="width:2%"><i class="md-cancel del"></i></td></tr>');$("#distributeBuso-tbody").append(s),s.find(".distributeBuso-user").jqxComboBox({source:r,theme:currentTheme,displayMember:"username",width:"100%",height:"34px",searchMode:"containsignorecase",placeHolder:"请选择或输入"}),s.find(".distributeBuso-user").val(o.sal[e].userInfo.name+"("+o.sal[e].username+")")}),o.custom.length>0&&$.each(o.custom,function(e,t){var s=$('<tr><td><div class="distributeBuso-user xiuZheng" ></div></td><td style="width:2%"><i class="md-cancel del"></i></td></tr>');$("#distributeBuso-tbody").append(s),s.find(".distributeBuso-user").jqxComboBox({source:r,theme:currentTheme,displayMember:"username",valueMember:"id",width:"100%",height:"34px",searchMode:"containsignorecase",placeHolder:"请选择或输入"}),s.find(".distributeBuso-user").val(o.custom[e].userInfo.name+"("+o.custom[e].username+")")})):"customerService"==s||"customerManage"==s||"secondLevelCustomerManage"==s?o.custom.length>0&&$.each(o.custom,function(e,t){var s=$('<tr><td><div class="distributeBuso-user xiuZheng" ></div></td><td style="width:2%"><i class="md-cancel del"></i></td></tr>');$("#distributeBuso-tbody").append(s),s.find(".distributeBuso-user").jqxComboBox({source:r,theme:currentTheme,displayMember:"username",valueMember:"id",width:"100%",height:"34px",searchMode:"containsignorecase",placeHolder:"请选择或输入"}),s.find(".distributeBuso-user").eq(e).val(o.custom[e].id)}):"salesManage"!=s&&"secondLevelSalesManage"!=s&&"salesStaff"!=s||o.sal.length>0&&$.each(o.sal,function(t,s){var i=$('<tr><td><div class="distributeBuso-user xiuZheng" ></div></td><td style="width:2%"><i class="md-cancel del"></i></td></tr>');$("#distributeBuso-tbody").append(i),i.find(".distributeBuso-user").jqxComboBox({source:r,theme:currentTheme,displayMember:"username",valueMember:"id",width:"100%",height:"34px",searchMode:"containsignorecase",placeHolder:"请选择或输入"}),$.each(a,function(s,r){if(a[s].id==o.sal[t].id)i.find(".distributeBuso-user").eq(t).val(o.sal[t].userInfo.name+"("+o.sal[t].username+")");else{var n=e.getSales(o.sal[t].id).userInfo.name+"("+e.getSales(o.sal[t].id).username+")";i.find(".distributeBuso-user").val(n)}})})}})},this.initPage=function(){$("#buso-show").css("display",""),$("#buso-status").dropDownlist({source:{all:"请选择",notContact:"未联系",notSuccess:"未成功",success:"已成功"},width:"100%",height:34,selectedIndex:0,dropDownHeight:150}),$("#buso-time").dropDownlist({source:["请选择","最近一周","最近两周","最近三周","本月","本季度","本年"],theme:"energyblue",width:"100%",height:"34px",selectedIndex:0,dropDownHeight:150}),$("#buso-sTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#buso-eTime").datetimeinput({formatString:"yyyy-MM-dd",width:"100%",height:"34px"}),$("#buso-time").on("change",function(){setValueById("buso-time","buso-sTime","buso-eTime")}),$("#buso-head").comboBox({source:ComboBoxSources.getRecords("salesInfo_name"),searchMode:"contains",displayMember:"name_user",valueMember:"username",width:"100%"}),$("#buso-busi").comboBox({source:ComboBoxSources.getRecords("salesAgent_name"),searchMode:"contains",displayMember:"name_user",valueMember:"agentName",width:"100%"}),$("#buso-show").addClass("hiddendiv")},this.initWindows=function(){$("#busoMgtSelectWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:300,height:"auto",minWidth:700,cancelButton:$("#busoMgtSelectCancleBtn"),initContent:function(){}}).on({open:function(){$("#busoMgtSelectWin").find(".jqx-window-close-button-background-account").remove(),$("#busoMgtSelectWin").append('<a class="md-clear float-right closeBtn" style="color:white;position:absolute;top:4px;right:5px"><a>'),$("#busoMgtSelectWin").find(".closeBtn").on("click",function(e){var t=$("#busoGrid").jqxGrid("getselectedrowindex"),s=$("#busoGrid").jqxGrid("getrowdata",t);if(t>=0){var i=$("#busoGrid").jqxGrid("getrowid",t);$("#busoGrid").jqxGrid("updaterow",i,s),$("#busoGrid").jqxGrid("ensurerowvisible",t)}$("#busoMgtSelectWin").jqxWindow("close")})}})},this.getSales=function(e){for(var t=ComboBoxSources.getRecords("salesInfo"),s=0;s<t.length;s++)if(t[s].id==e)return t[s];if(!e)return""},this.initColumns=function(){var e=getCurrentInfo(),t=function(t){var s="";return"sys"==e?($.each(t.sal,function(e,t){s+=getSalesInfoById(t.id).name_user+"&nbsp"}),$.each(t.custom,function(e,t){s+=getCustomerInfoById(t.id).name_user+"&nbsp;"})):"sale"==e||"sales"==e||"agent"==e?$.each(t.sal,function(e,t){s+=getSalesInfoById(t.id).name_user+"&nbsp"}):$.each(t.custom,function(e,t){s+=getCustomerInfoById(t.id).name_user+"&nbsp;"}),s},s=[{text:"日期",width:"11.11%",cellsrenderer:function(e,t,s,i,o,a){var r='<div class="agrid">';return(r+=a.createDate.substring(0,10))+"</div>"}},{text:"潜在客户",dataField:"potentialName",width:"11.11%",cellsrenderer:function(e,t,s,i,o,a){var r='<div class="agrid">';return(r+='<a class="hoverspan viewBuso">'+a.potentialName+"</a>")+"</div>"}},{text:"联系电话",dataField:"phone",width:"11.11%"},{text:"公司名称",dataField:"contact",width:"11.11%"},{text:"预计成交日期",width:"11.11%",cellsrenderer:function(e,t,s,i,o,a){return'<div class="agrid">'+a.closingDate.substring(0,10)+"</div>"}},{text:"代理商(姓名/用户名)",width:"11.11%",hidden:!1,cellsrenderer:function(e,t,s,i,o,a){var r='<div class="agrid">';return(r+=void 0==a.salesAgent?"":a.salesAgent.userInfo.name+"("+a.salesAgent.agentName+")")+"</div>"}},{text:"(姓名/用户名)",width:"11.11%",cellsrenderer:function(e,s,i,o,a,r){return'<div class="agrid">'+t(r)+"</div>"}},{text:"状态",width:"11.11%",cellsrenderer:function(e,t,s,i,o,a){var r='<div class="p-2" style="height:100%">';return"success"==a.status?r+='<div class="agrid">已成功</div>':"notContact"==a.status?(r+='<select class="selectStatus" style="width:100%;height:100%">',r+='<option value="notContact">未联系</option>',r+='<option value="notSuccess">未成功</option>',r+='<option value="success">已成功</option></select>'):(r+='<select class="selectStatus" style="width:100%;height:100%">',r+='<option value="notSuccess">未成功</option>',r+='<option value="success">已成功</option></select>'),r+"</div>"}},{text:"操作",width:"11.11%",hidden:!1,cellsrenderer:function(t,s,i,o,a,r){var n='<div class="text-center">';return"sale"!=e&&(n+='<a class="hoverspan md-format-list-bulleted distributeSource"  title="分配员工"></a>'),(n+='<a class="hoverspan md-note-add addRemark" title="增加备注"></a>')+"</div>"}}],o="";if("sale"==e||"sales"==e||"sys"==e)o="sys"==e?"销售负责人/客服":"销售负责人";else{$("#buso-mgt").remove(),o="agent"==e?"销售负责人":"客服";for(i in s)s[i].width="14.27%",0==s[i].hidden&&(s[i].hidden=!0)}for(i in s)"(姓名/用户名)"==s[i].text&&(s[i].text=o+"(姓名/用户名)");return s},this.initGrid=function(){e.settings.source.data=e.searchObj;var t=Core.AcDataAdapter("busoGrid",e.settings.source,{beforeLoadComplete:function(e){}},!1),s={source:t,rendergridrows:function(){return t.recordids},columns:e.initColumns(),enablehover:!1,pagesize:20,columnsheight:45};$("#busoGrid").grid(s),$("#busoGrid").on("click",".distributeSource",function(){var t=$("#busoGrid").jqxGrid("getselectedrowindex");if(t>=0){var s=$("#busoGrid").jqxGrid("getrowdata",t);o=s}e.distributeSource(o)}),$("#busoGrid").on("click",".addRemark",function(){var t=$("#busoGrid").jqxGrid("getselectedrowindex");if(t>=0){var s=$("#busoGrid").jqxGrid("getrowdata",t);if(e.id=s.id,"success"==s.status)return Core.alert({message:"状态已成功，不能添加备注！"}),!1;addRemark(s.trackList,s.id,"potentialtrack")}}),$("#busoGrid").on("change",".selectStatus",function(){if("success"==$(this).val()&&$("#busoMgtSelectWin").jqxWindow("open",function(){var t=$("#busoGrid").jqxGrid("getselectedrowindex");if(t>=0){var s=$("#busoGrid").jqxGrid("getrowdata",t);$("#busoMgtSelecteUserName").val(""),$("#busoMgtSelecteName").val(s.potentialName),$("#busoMgtSelecteCompName").val(s.contact),e.id=s.id}}),"notSuccess"==$(this).val()){var t=$("#busoGrid").jqxGrid("getselectedrowindex"),s=$("#busoGrid").jqxGrid("getrowdata",t),i=_global_settings.service.url+"/potential",o={id:s.id.toString(),status:"notSuccess"};Core.confirm({bool:!0,message:"状态改为未成功，请确认？",confirmCallback:function(){Core.AjaxRequest({url:i+"/status",type:"PUT",async:!1,params:o,callback:function(e){try{$("#busoGrid").jqxGrid("updatebounddata","cells")}catch(e){}},failure:function(e){}})},cancelCallback:function(){if(t>=0){var e=$("#busoGrid").jqxGrid("getrowid",t);$("#busoGrid").jqxGrid("updaterow",e,s),$("#busoGrid").jqxGrid("ensurerowvisible",t)}}})}}),$("#busoGrid").on("click",".viewBuso",function(){var e=$("#busoGrid").jqxGrid("getselectedrowindex");if(e>=0){var t=$("#busoGrid").jqxGrid("getrowdata",e);$.addTab({title:"查看商机",isFrame:!1,url:"page/modules/buso/viewBuso.html",pk:{id:t.id},reload:!0})}})},this.settings={source:{url:t+"/page",data:e.searchObj,updaterow:function(e,t,s){s(!0)}},grid:{element:"busoGrid"},ajax:{url:t}},this.searchObj={},this.initSearch=function(){e.searchObj={sortdatafield:"t.createDate","t.createDate":{value:[],action:"between"},"t.potentialName":{value:[],action:"like"},"t.status":{value:[],action:"eq"},"s.username":{value:[],action:"like"},"t.salesAgent.agentName":{value:[],action:"like"}},"customerService"!=s&&"salesStaff"!=s||(e.searchObj["s.id"]={value:[""+_global_settings.owner.userid],action:"eq"})},this.searchDataInfo=function(){$("#busoGrid").jqxGrid("applyfilters"),$("#busoGrid").jqxGrid("refreshfilterrow"),$("#busoGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#busoGrid").jqxGrid("updatebounddata","cells"),$("#busoGrid").jqxGrid("clearselection"),$("#busoGrid").jqxGrid("refreshdata")}},BusoBindModle=function(e){var t=this;this.search=function(){var t=$("#buso-sTime").val(),s=$("#buso-eTime").val(),i=$("#buso-cust").val(),o=$("#buso-head").val(),a=$("#buso-busi").val(),r=$("#buso-status").val();e.searchObj["t.createDate"].value=[],""!=t&&""!=s&&e.searchObj["t.createDate"].value.push(t+" 00:00:00",s+" 23:59:59"),""!=t&&""===s&&(e.searchObj["t.createDate"].value.push(t+" 00:00:00"),e.searchObj["t.createDate"].action="ge"),""===t&&""!=s&&(e.searchObj["t.createDate"].value.push(s+" 23:59:59"),e.searchObj["t.createDate"].action="le"),e.searchObj["t.potentialName"].value=[],""!=i&&e.searchObj["t.potentialName"].value.push(i),e.searchObj["t.status"].value=[],"all"!=r&&e.searchObj["t.status"].value.push(r),e.searchObj["s.username"].value=[],""!=o&&e.searchObj["s.username"].value.push(o),e.searchObj["t.salesAgent.agentName"].value=[],""!=a&&e.searchObj["t.salesAgent.agentName"].value.push(a),e.searchDataInfo()},this.bind=function(){$("#buso-search").on("click",function(){$("#buso-show").is(":hidden")?$("#buso-show").slideDown("slow"):t.search()}),hiddenAclick(),$("#addbuso-btn").on("click",function(){$.addTab({title:"新增商机",url:"page/modules/buso/addBuso.html",reload:!0})}),$("#busoMgtSelectSaveBtn").off("click").on("click",function(){var t=_global_settings.service.url+"/potential";Core.AjaxRequest({url:t+"/status",type:"PUT",async:!1,params:{id:e.id,status:"success"},callback:function(e){$("#busoMgtSelectWin").jqxWindow("close");try{$("#busoGrid").jqxGrid("updatebounddata","cells")}catch(e){}},failure:function(e){}})}),$("#busoMgtSelectCancleBtn").on("click",function(){var e=$("#busoGrid").jqxGrid("getselectedrowindex");if(e>=0){var t=$("#busoGrid").jqxGrid("getrowid",e),s=$("#busoGrid").jqxGrid("getrowdata",e);$("#busoGrid").jqxGrid("updaterow",t,s),$("#busoGrid").jqxGrid("ensurerowvisible",e)}}),$("#buso-download").off("click").on("click",function(){"localhost"==getHostName()||"192.168.1.3:8090/SimpleBss/".indexOf(getHostName())>-1?window.open("/SimpleBss/template/shangji.xls"):window.open("/template/shangji.xls")}),$("#buso-import").off("click").on("click",function(){var e={url:_global_settings.service.url+"/common/import/Potential/"+_global_settings.owner.userid};$("#buso-attachment").html(""),$("#buso-modal").modal("show"),$("#buso-attachment").fileuploader(e)})},this.unbindAll=function(){$("#buso-search").off("click"),$("#addbuso-btn").off("click"),$("#busoMgtSaveBtn").off("click"),$("#distributeSourceBuso-save").off("click")}};