var SpMgt=function(){var e=this,t=_global_settings.service.url+"/user/search/userbuy/0/0/"+_global_settings.owner.roleName;this.debug=!1,this.data=$.pk.data,this.arr=[],this.initInput=function(){e.initPage(),e.initSearch(),e.initValidator(),e.initGrid(e.searchObj)},this.initPage=function(){$("#sendProd-save").attr("disabled",!0),$("#sendProd-show").addClass("hiddendiv"),$("#sendProd-time").dropDownlist({source:["请选择","最近一周","最近两周","最近三周","本月","本季度","本年"],width:"100%",height:34,selectedIndex:0}),$("#sendProd-type").dropDownlist({source:{GIVE:"赠送",OFFLINE:"线下支付"},width:"100%",height:34,selectedIndex:0}),$("#sendProd-sTime").datetimeinput({formatString:"yyyy-MM-dd",height:34,width:"100%"}),$("#sendProd-eTime").datetimeinput({formatString:"yyyy-MM-dd",height:34,width:"100%"}),$("#sendProd-stimes").datetimeinput({value:new Date,formatString:"yyyy-MM-dd",height:34,width:"100%"}),$("#sendProd-etimes").datetimeinput({formatString:"yyyy-MM-dd",height:34,width:"100%"}),$("#sendProd-time").on("change",function(){setValueById("sendProd-time","sendProd-sTime","sendProd-eTime")})},this.initGrid=function(){e.settings.source.data=e.searchObj;var t=Core.AcDataAdapter("sendProductGrid",e.settings.source,{beforeLoadComplete:function(e){}},e.debug),r={source:t,rendergridrows:function(e){return t.recordids},columns:[{text:"注册日期",editable:!1,width:"20%",cellsrenderer:function(e,t,r,d,i,n){return'<div style="padding-top:6px">'+n.createDate.substring(0,10)+"</div>"}},{text:"用户名",editable:!1,dataField:"username",width:"20%"},{text:"电话号码",editable:!1,dataField:"telephone",width:"20%"},{text:"公司名称",editable:!1,dataField:"name",width:"20%"},{text:"金额",dataField:"money",cellsalign:"right",cellsformat:"c2",width:"17.47%"}],selectionmode:"checkbox",pagesize:20,columnsheight:45,editable:!0,ready:function(){}};$("#sendProductGrid").grid(r),$("#sendProductGrid").on("rowselect",function(t){var r=$("#sendProductGrid").jqxGrid("getselectedrowindexes");e.arr=r,0!=e.arr.length?$("#sendProd-save").removeAttr("disabled"):$("#sendProd-save").attr("disabled",!0)}),$("#sendProductGrid").on("rowunselect",function(t){var r=$("#sendProductGrid").jqxGrid("getselectedrowindexes");e.arr=r,0!=e.arr.length?$("#sendProd-save").removeAttr("disabled"):$("#sendProd-save").attr("disabled",!0)})},this.settings={source:{url:t,data:e.searchObj},grid:{element:"sendProductGrid"},ajax:{url:t}},this.searchObj={},this.initSearch=function(){e.searchObj={"owner0.createDate":{value:[],action:"between"},"owner0.loginId":{value:["--1"],action:"like"},"owner0.regTelephone":{value:[],action:"like"}}},this.searchDataInfo=function(){$("#sendProductGrid").jqxGrid("applyfilters"),$("#sendProductGrid").jqxGrid("refreshfilterrow"),$("#sendProductGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#sendProductGrid").jqxGrid("updatebounddata","cells"),$("#sendProductGrid").jqxGrid("clearselection"),$("#sendProductGrid").jqxGrid("refreshdata")},this.initValidator=function(){$("#sendProductPage").jqxValidator({hintType:"label",animationDuration:1,rules:[{input:"#sendProd-etimes",message:"不能为空",action:"keyup, blur",rule:function(e,t){return""!=e.val()}},{input:"#sendProd-etimes",message:"必须大于开始日期",action:"keyup, blur",rule:function(e,t){return!(e.val()<=$("#sendProd-stimes").val())}}]})}},SpBindModle=function(e){var t=this,r=_global_settings.service.url+"/billingProductPermission/create";this.search=function(){var t=$("#sendProd-username").val(),r=$("#sendProd-phone").val(),d=$("#sendProd-sTime").val(),i=$("#sendProd-eTime").val();e.searchObj["owner0.loginId"].value=[],""!=t&&e.searchObj["owner0.loginId"].value.push(t),e.searchObj["owner0.createDate"].value=[],""!=d&&""!=i&&e.searchObj["owner0.createDate"].value.push(d,i),e.searchObj["owner0.regTelephone"].value=[],""!=r&&e.searchObj["owner0.regTelephone"].value.push(r),e.searchDataInfo()},this.bind=function(){$("#sendProd-search").on("click",function(){t.search()}),$("#sendProd-cancle").on("click",function(){$.closeTab()}),$("#sendProd-save").on("click",function(){var t=[],d=$("#sendProd-stimes").val(),i=$("#sendProd-etimes").val(),n=$("#sendProd-type").val(),a={};a.permission=e.data.permission,a.accountProduct={id:e.data.id},a.startDate=d+" 00:00:00",a.endDate=i+" 23:59:59",$.each(e.arr,function(r){var d=$("#sendProductGrid").jqxGrid("getrowdata",e.arr[r]);void 0!=d&&""!=d.ownerId&&t.push(d.ownerId)});var s=$("#sendProductGrid").jqxGrid("getselectedrowindexes"),o="";if("OFFLINE"===n)for(var c=0;c<s.length;c++){var l=$("#sendProductGrid").jqxGrid("getrowdata",s[c]).money;if(void 0==l&&"OFFLINE"===n)return Core.alert({message:"请填写选中行的金额"}),!1;o+=l+",",o=o.substring(0,o.length-1)}else o=-1;$("#sendProductPage").jqxValidator("validate")&&Core.confirm({message:"确认要给所选用户赠送"+e.data.productName+"吗？",confirmCallback:function(){Core.AjaxRequest({url:r+"/"+t+"/"+n+"/"+o,type:"POST",async:!1,params:a,showMsg:!1,callback:function(){setCloseAlertTimeOneSecond(),$("#sendProductGrid").jqxGrid("clearselection"),$("#sendProductGrid").jqxGrid("updatebounddata","cells")}})}})})},this.unbindAll=function(){$("#sendProd-search").off("click"),$("#sendProd-cancle").off("click"),$("#sendProd-save").off("click")}};