var ProdMgt=function(){var t=this,o=_global_settings.service.url+"/accountproduct";this.id=null,this.prod=null,this.initInput=function(){t.initProdPage(),t.initWindows(),t.initValidator(),t.initSearch(),t.initGrid(t.searchObj)},this.initValidator=function(){$("#fpAgentWin").jqxValidator({hintType:"label",animationDuration:1,rules:[{input:"#fpAgent-agent",message:"请选择",action:"keyup,blur",rule:function(t,o){return null!=t.jqxComboBox("getSelectedItem")}}]})},this.initProdPage=function(){$("#prod-show").css("display",""),$("#prod-module").comboBox({source:ComboBoxSources.getRecords("productName"),searchMode:"contains",displayMember:"productName",width:"100%"}),$("#prod-show").addClass("hiddendiv")},this.initWindows=function(){$("#addProdWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:400,height:"auto",minWidth:700,cancelButton:$("#cancelAddProdBtn"),initContent:function(){}}).on({close:function(){setTimeout(function(){$("#addprod-number").val(""),$("#addprod-module").val(""),$("#addprod-price").val(""),$("#addprod-int").val("")},30)}}),$("#viewProdWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:620,height:"auto",minWidth:800,width:"700",cancelButton:$("#cancelViewProdBtn"),initContent:function(){}}),$("#editProdWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:570,height:"auto",minWidth:800,width:800,cancelButton:$("#cancelEditProdBtn"),initContent:function(){}}),$("#disableProdWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:340,height:"auto",minWidth:500,cancelButton:$("#cancelDisableProdBtn"),initContent:function(){$("#disableProd-yn").jqxDropDownList({source:{false:"否",true:"是"},width:"100%",height:34,selectedIndex:0})}}).on("close",function(){setTimeout(function(){$("#disableProd-yn").jqxDropDownList({selectedIndex:0})},500)}),$("#fpAgentWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1e3,minHeight:280,height:"auto",minWidth:500,cancelButton:$("#cancelFpAgentBtn"),initContent:function(){$("#fpAgent-agent").comboBox({source:ComboBoxSources.getRecords("salesAgent_name"),displayMember:"name_user",valueMember:"id",width:"100%"})}}).on({close:function(){$("#fpAgent-time").val("")}})},this.initGrid=function(){t.settings.source.data=t.searchObj;var o=Core.AcDataAdapter("prodGrid",t.settings.source,{beforeLoadComplete:function(t){}},!1),e={source:o,rendergridrows:function(){return o.recordids},columns:[{text:"日期",width:"10%",cellsrenderer:function(t,o,e,i,d,r){var n='<div class="agrid">';return n+=r.createDate.substring(0,10)+"</div>"}},{text:"图片",width:"10%",cellsrenderer:function(t,o,e,i,d,r){var n="";if(void 0!=r.productPhoto&&""!=r.productPhoto&&(n=ctx+"/CXF/rs/common/file/"+r.productPhoto),""!=n){n="<img width='28' height='28' src='"+n+"'>";var a="<div style='background: white;text-align:center;margin: 0px;'>"+n+"</div>"}return a}},{text:"产品模块",width:"10%",cellsrenderer:function(t,o,e,i,d,r){var n='<div class="agrid">';return n+='<a class="hoverspan viewProd" title="查看产品">'+r.productName+"</a>",n+="</div>"}},{text:"产品简介",dataField:"description",width:"20%",cellsrenderer:function(t,o,e,i,d,r){var n='<div class="agrid">';return n+=r.description.replace("<br>","")+"</div>"}},{text:"产品价格",dataField:"priceAmt",cellsalign:"right",cellsformat:"c2",width:"11%"},{text:"本月购买金额",dataField:"mounthAmt",cellsalign:"right",cellsformat:"c2",width:"11%"},{text:"累计购买金额",dataField:"totalAmt",cellsalign:"right",cellsformat:"c2",width:"11%"},{text:"是否禁用",width:"6%",cellsrenderer:function(t,o,e,i,d,r){return'<div class="agrid">'+getCodeData(r.status)+"</div>"}},{text:"操作",width:"11%",cellsrenderer:function(t,o,e,i,d,r){var n='<div class="text-center">';return n+='<a class="hoverspan md-format-list-bulleted fpAgent"></a>',n+='<a class="hoverspan md-view-agenda viewSendProd" title="查看赠送详情"></a>',n+='<a class="hoverspan md-label sendProd" title="赠送"></a>',n+='<a class="hoverspan md-error disableBtn" title="禁用"></a>',n+="</div>"}}],pagesize:20,columnsheight:45};$("#prodGrid").grid(e),$("#prodGrid").on("click",".fpAgent",function(){var o=$("#prodGrid").jqxGrid("getselectedrowindex"),e=$("#prodGrid").jqxGrid("getrowdata",o);t.prod=e,$("#fpAgentWin").jqxWindow("open")}),$("#prodGrid").on("click",".viewSendProd",function(){var t=$("#prodGrid").jqxGrid("getselectedrowindex"),o=$("#prodGrid").jqxGrid("getrowdata",t);$.addTab({title:"赠送详情",isFrame:!1,url:"page/modules/prod/viewSendProd.html",pk:{id:o.id},reload:!0})}),$("#prodGrid").on("click",".sendProd",function(){var t=$("#prodGrid").jqxGrid("getselectedrowindex"),o=$("#prodGrid").jqxGrid("getrowdata",t);$.addTab({title:"赠送产品",isFrame:!1,url:"page/modules/prod/sendProd.html",pk:{data:o},reload:!0})}),$("#prodGrid").on("click",".disableBtn",function(){var o=$("#prodGrid").jqxGrid("getselectedrowindex"),e=$("#prodGrid").jqxGrid("getrowdata",o);t.id=e.id,$("#disableProdWin").jqxWindow("open",function(){$("#disableProd-code").val(e.productCode),$("#disableProd-module").val(e.productName)})}),$("#prodGrid").on("click",".viewProd",function(){$("#viewProdWin").jqxWindow("open",function(){var o=_global_settings.service.url+"/accountproduct/",e=$("#prodGrid").jqxGrid("getselectedrowindex");if(e>=0){var i=$("#prodGrid").jqxGrid("getrowdata",e);Core.AjaxRequest({url:o+i.id,type:"GET",async:!1,showMsg:!1,callback:function(o){t.id=o.id,t.prod=o,void 0==o.productPhoto||""==o.productPhoto?$("#viewprod-photo").attr("src","images/common/photo_icon2.png"):$("#viewprod-photo").attr("src",ctx+"/CXF/rs/common/file/"+o.productPhoto),$("#viewprod-number").val(o.productCode),$("#viewprod-module").val(o.productName).attr("disabled",!0),$("#viewprod-price").val(o.priceAmt),$("#viewprod-unit").val(getCodeData(o.companyType)),$("#viewprod-int").val(o.description)},failure:function(t){}})}})})},this.settings={source:{url:o+"/page",data:t.searchObj},grid:{element:"prodGrid"},ajax:{url:o}},this.searchObj={},this.initSearch=function(){t.searchObj={productName:{value:[],action:"like"},priceAmt:{value:[],action:"between"}}},this.searchDataInfo=function(){$("#prodGrid").jqxGrid("applyfilters"),$("#prodGrid").jqxGrid("refreshfilterrow"),$("#prodGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#prodGrid").jqxGrid("updatebounddata","cells"),$("#prodGrid").jqxGrid("clearselection"),$("#prodGrid").jqxGrid("refreshdata")}},ProdBindModle=function(t){var o=this;this.search=function(){var o=$("#prod-module").val(),e=$("#prod-sp").val(),i=$("#prod-ep").val();t.searchObj.productName.value=[],""!=o&&t.searchObj.productName.value.push(o),t.searchObj.priceAmt.value=[],""!=e&&""!=i&&t.searchObj.priceAmt.value.push(e,i),t.searchDataInfo()},this.saveParam=function(t){var o=_global_settings.service.url+"/accountproduct";Core.AjaxRequest({url:o,type:"POST",params:t,callback:function(t){$("#addProdWin").jqxWindow("close");try{$("#prodGrid").jqxGrid("updatebounddata","cells"),ComboBoxSources.load("productName",!0)}catch(t){}}})},this.initParam=function(){var t={};return t.productCode=$("#addprod-number").val(),t.productName=$("#addprod-module").val(),t.priceAmt=$("#addprod-price").val(),t.companyType=$("#addprod-unit").val(),t.description=$("#addprod-int").val(),t.productPhoto=$("#addprod-form").find(".file0").data("id"),t},this.saveEditParam=function(t){var o=_global_settings.service.url+"/accountproduct";Core.AjaxRequest({url:o,type:"PUT",params:t,callback:function(t){$("#editProdWin").jqxWindow("close");try{$("#prodGrid").jqxGrid("updatebounddata","cells"),ComboBoxSources.load("productName",!0)}catch(t){}}})},this.initEditParam=function(){var o={};return o.id=t.id,o.productCode=$("#editprod-number").val(),o.productName=$("#editprod-module").val(),o.priceAmt=$("#editprod-price").val(),o.companyType=$("#editprod-unit").val(),o.description=$("#editprod-int").val(),o.productPhoto=$("#editprod-form").find(".file0").data("id"),o},this.bind=function(){function e(t){var o=null;return void 0!=window.createObjectURL?o=window.createObjectURL(t):void 0!=window.URL?o=window.URL.createObjectURL(t):void 0!=window.webkitURL&&(o=window.webkitURL.createObjectURL(t)),o}this.uploadImage=function(t,o){if(!i(t))return!1;var e=ctx+"/CXF/rs/common/file/-1",d=new FormData(o[0]);return $.ajax({type:"POST",url:e,data:d,async:!1,cache:!1,contentType:!1,processData:!1,success:function(o){t.data("id",o.id)},error:function(t,o,e){}}),!0};var i=function(t){var o=t.val();if(""==o)return Core.alert({message:"请选择上传图片！"}),void t.parents("form").find("img").attr("src","images/common/photo_icon2.png");var e=o.substr(o.lastIndexOf(".")+1).toLowerCase();return"jpg"==e||"jpeg"==e||"gif"==e||"png"==e||"bmp"==e||"JPG"==e||(Core.alert({message:"请选择图片文件！"}),!1)};$("#prod-search").on("click",function(){$("#prod-show").is(":hidden")?$("#prod-show").slideDown("slow"):o.search()}),hiddenAclick(),$("#addprod-btn").on("click",function(){$("#addProdWin").jqxWindow("open",function(){$("#addprod-photo").off("click").on("click",function(){$("#addProdForm").find(".file0").trigger("click")}),$("#addProdForm").on("change",".file0",function(){var t=$(this),i=e(this.files[0]);o.uploadImage(t,t.parents("form"))&&timeOut(function(){$("#addprod-photo").attr("src",i)})})})}),$("#editprod-btn").off("click").on("click",function(){$("#viewProdWin").jqxWindow("close"),$("#editProdWin").jqxWindow("open",function(){var i=$("#prodGrid").jqxGrid("getselectedrowindex");if(i>=0){var d=$("#prodGrid").jqxGrid("getrowdata",i);t.id=d.id}void 0==t.prod.productPhoto||""==t.prod.productPhoto?$("#editprod-photo").attr("src","images/common/photo_icon2.png"):($("#editprod-photo").attr("src",ctx+"/CXF/rs/common/file/"+t.prod.productPhoto),$("#editprod-form").find(".file0").data("id",t.prod.productPhoto)),$("#editprod-number").val(t.prod.productCode),$("#editprod-module").val(t.prod.productName),$("#editprod-price").val(t.prod.priceAmt),$("#editprod-unit").val(t.prod.companyType),$("#editprod-int").val(t.prod.description),$("#editprod-photo").off("click").on("click",function(){"images/common/photo_icon2.png"==$(this).attr("src")&&$("#editProdForm").find(".file0").off("click").trigger("click")}),$("#editProdForm").off("change",".file0").on("change",".file0",function(){var t=$(this),i=e(this.files[0]);o.uploadImage(t,t.parents("form"))&&timeOut(function(){$("#editprod-photo").attr("src",i)})}),$("#editProdForm").find(".close-lab").off("click").on("click",function(){"images/common/photo_icon2.png"!=$("#editprod-photo").attr("src")&&Core.confirm({message:"确定要删除？",confirmCallback:function(){$("#editprod-photo").attr("src","images/common/photo_icon2.png"),$("#editprod-form").find(".file0").data("id",""),$("#editprod-form").find(".file0").val("")}})})})}),$("#addProdSubmitBtn").on("click",function(){o.saveParam(o.initParam())}),$("#editProdSubmitBtn").on("click",function(){o.saveEditParam(o.initEditParam())}),$("#disableProdBtn").on("click",function(){var o=_global_settings.service.url+"/accountproduct",e="true"==$("#disableProd-yn").val(),i={id:t.id,status:e};Core.AjaxRequest({url:o+"/status",async:!1,params:i,type:"PUT",callback:function(){$("#disableProdWin").jqxWindow("close"),$("#prodGrid").jqxGrid("updatebounddata","cells")},failure:function(){}})}),$("#fpAgentSaveBtn").on("click",function(){if($("#fpAgentWin").jqxValidator("validate")){var o={},e=_global_settings.service.url+"/agentcoupon";o.accountProductList=[{id:t.prod.id}],o.salesAgent={id:$("#fpAgent-agent").val()},o.mouth=$("#fpAgent-time").val(),Core.AjaxRequest({url:e,type:"POST",params:o,callback:function(){$("#fpAgentWin").jqxWindow("close"),$("#prodGrid").jqxGrid("updatebounddata","cells")}})}})},this.unbindAll=function(){$("#prod-search").off("click"),$("#addprod-btn").off("click"),$("#disableProdBtn").off("click"),$("#addProdSubmitBtn").off("click"),$("#editProdSubmitBtn").off("click"),$("#fpAgentSaveBtn").off("click")}};