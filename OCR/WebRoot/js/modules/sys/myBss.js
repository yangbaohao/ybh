var MyBssMgt=function(){var e=this,t=null;this.url=_global_settings.service.url;var t=null;this.searchObj={},this.init=function(){e.initGrid(),e.initEvent(),e.bindModel(),$("#myBssName").text(_global_settings.owner.companyname),$("#myBssBar").find("span").eq(0).css("color","orange")};var s=function(e){null!=e&&("regSaler"==e?($("#myBssMatchGrid").css("display","block"),$("#productInformaticaGrid").css("display","none"),$("#myBssMatchCustGrid").css("display","none")):"acDisacount"==e?($("#myBssMatchGrid").css("display","none"),$("#productInformaticaGrid").css("display","block"),$("#myBssMatchCustGrid").css("display","none")):"regCustomers"==e&&($("#myBssMatchGrid").css("display","none"),$("#productInformaticaGrid").css("display","none"),$("#myBssMatchCustGrid").css("display","block")))};s(),this.initGrid=function(){e.settings.source.data=e.searchObj;var t=Core.AcDataAdapter("productInformaticaGrid",e.settings.source,{beforeLoadComplete:function(e){}},e.debug),s={source:t,pageable:!1,autorowheight:!0,autoheight:!0,rendergridrows:function(){return t.recordids},columns:[{text:"产品模块",width:"15%",cellsrenderer:function(e,t,s,o,i,a){var r='<div class="agrid"  style="position: relative; top:50%; margin-top:-10px; text-align: center;text-overflow: ellipsis;overflow: hidden;">';return r+=a.productName,r+="</div>"}},{text:"产品编号",dataField:"productCode",width:"10%"},{text:"产品简介",dataField:"description",width:"40%"},{text:"产品价格/月",dataField:"priceAmt",cellsalign:"right",cellsformat:"c2",width:"12%"},{text:"月份/折扣率",width:"13%",cellsrenderer:function(e,t,s,o,i,a){var r='<div class="agrid" style="text-align:right;">';return $.each(a.priceStrategy,function(e,t){r+=a.priceStrategy[e].timeNum+"/"+a.priceStrategy[e].totalAmt+"<br />"}),r+="</div>"}},{text:"操作",width:"10%",cellsrenderer:function(e,t,s,o,i,a){var r='<div class="agrid"  style="text-align:center">';return r+='<a class="hoverspan md-format-list-bulleted fpDisacount"></a>',r+="</div>"}}],pagesize:20,columnsheight:45};$("#productInformaticaGrid").grid(s)},this.settings={source:{url:e.url+"/accountproduct/page",data:e.searchObj},grid:{element:"productInformaticaGrid"},ajax:{url:e.url}},this.searchObj={},this.initSearch=function(){e.searchObj={}},this.searchDataInfo=function(){$("#productInformaticaGrid").jqxGrid("applyfilters"),$("#productInformaticaGrid").jqxGrid("refreshfilterrow"),$("#productInformaticaGrid").jqxGrid("clearselection")},this.refreshDataInfo=function(){$("#productInformaticaGrid").jqxGrid("updatebounddata","cells"),$("#productInformaticaGrid").jqxGrid("clearselection"),$("#productInformaticaGrid").jqxGrid("refreshdata")},this.initEvent=function(){$("#myBssBar").on("click","span",function(){$("#myBssBar").find("span").css("color",""),$(this).css({color:"orange"}),s($(this).attr("data-id"))})},this.setLine=function(){if(t.priceStrategy.length>0)for(var e=0;e<t.priceStrategy.length;e++){var s=t.priceStrategy[e].id,o=$('<tr style="border-bottom: solid 1px #ccc;" data-id = '+s+'><td><span>秒账折扣时长</span><button class="spanbg">-</button><input type="text" value="1" class="acDiscountMonth"><button class="spanbg">+</button><span>个月 ，折扣为</span><input type="text" value="0.1" class="acDiscountResult" style="margin-left:5px;"></td><td style="border-top:solid 1px #ccc; margin-top:-1px;"><i class="md-cancel del" title="删除"></i></td></tr>');$("#acDiscount-tbody").append(o),$("#acDiscount-tbody").off("click"),$("#acDiscount-tbody").find("tr>td:last-child").css("display","none"),o.find(".acDiscountMonth").val(void 0==t.priceStrategy[e].timeNum?"1":t.priceStrategy[e].timeNum),o.find(".acDiscountResult").val(void 0==t.priceStrategy[e].totalAmt?"0.2":t.priceStrategy[e].totalAmt),o.find(".acDiscountMonth").attr("disabled",!0),o.find(".acDiscountResult").attr("disabled",!0),o.find(".spanbg").attr("disabled",!0),$("#editAcDiscount").css("display","block"),$("#addAcDiscount").css("display","none")}else $("#saveAcDiscount").css("display","none"),$("#editAcDiscount").css("display","none"),$("#addAcDiscount").css("display","block")},this.addLine=function(){var t=($("#acDiscount-tbody").children().length,$('<tr style="border-bottom: solid 1px #ccc;"><td><span>秒账折扣时长</span><button class="spanbg">-</button><input type="text" value="1"  class="acDiscountMonth"><button class="spanbg">+</button><span>个月 ，折扣为</span><input type="text" value="0.1" class="acDiscountResult" style="margin-left:5px;"></td><td style="border-top:none;"><i class="md-cancel del" title="删除"></i></td></tr>'));$("#acDiscount-tbody").append(t),e.changeTimeNum(),e.removeLine(),$("#acDiscount-tbody").off("click"),$("#acDiscount-tbody").on("click","tr",function(){$(this)[0]==$("#acDiscount-tbody").find("tr").eq(-1)[0]&&e.addLine()})},this.changeTimeNum=function(){$(".spanbg").off("click"),$(".spanbg").on("click",function(e){var t=$(this),s=parseInt(t.parent().find(".acDiscountMonth").val());"-"==t.text()&&s>1&&t.parent().find(".acDiscountMonth").val(s-1),"+"==t.text()&&s<12&&t.parent().find(".acDiscountMonth").val(s+1)})},this.removeLine=function(){$("#acDiscount-tbody").find("tr>td:last-child").off("click"),$("#acDiscount-tbody").find("tr>td:last-child").on("click",function(e){e.stopPropagation();var s=$(this).parent(),o=($(this).parent().index(),null);if($("#acDiscount-tbody").find("tr").length>1)if(t.priceStrategy.length>0)for(var i=0;i<$("#acDiscount-tbody").find("tr").length;i++){if(void 0!=s.attr("data-id")){o=s.attr("data-id"),Core.confirm({message:"确定要删除？",confirmCallback:function(){Core.AjaxRequest({url:_global_settings.service.url+"/pricestrategy/"+o,type:"DELETE",dataType:"text",showMsg:!1,callback:function(e){s.remove()},failure:function(e){}})}});break}Core.confirm({message:"确定要删除？",confirmCallback:function(){s.remove()}});break}else Core.confirm({message:"确定要删除？",confirmCallback:function(){s.remove()}})})},this.bindModel=function(){$("#addAcDiscount").off().on("click",function(){e.addLine(),$("#saveAcDiscount").css("display","block"),$("#editAcDiscount").css("display","none"),$("#addAcDiscount").css("display","none")}),$("#editAcDiscount").off("click").on("click",function(){$("#acDiscount-tbody").off().on("click","tr",function(){$(this)[0]==$("#acDiscount-tbody").find("tr").eq(-1)[0]&&e.addLine()}),e.changeTimeNum(),e.removeLine(),$("#acDiscount-tbody").find("tr>td:last-child").css("display","block"),$(this).css("display","none"),$("#saveAcDiscount").css("display","block"),$(".spanbg").removeAttr("disabled"),$(".acDiscountMonth").removeAttr("disabled"),$(".acDiscountResult").removeAttr("disabled")}),$("#productInformaticaGrid").on("click",".fpDisacount",function(){var s=$("#productInformaticaGrid").jqxGrid("getselectedrowindex"),o=$("#productInformaticaGrid").jqxGrid("getrowdata",s);t=o,$("#myBss_Grid").modal("show"),$("#acDiscount-tbody").html(""),e.setLine()}),$("#saveAcDiscount").off("click").on("click",function(){for(var s=$("#acDiscount-tbody").find("tr"),o=0;o<s.length;o++){var i={};if(i.timeNum=$(".acDiscountMonth").eq(o).val(),i.totalAmt=$(".acDiscountResult").eq(o).val(),i.accountProduct={id:t.id,productCode:t.productCode,productName:t.productName,description:t.description,permission:t.permission,priceAmt:t.priceAmt},$(".acDiscountResult").eq(o).val()>1||$(".acDiscountResult").eq(o).val()<0){Core.alert({message:"请检查输入格式是否正确！"});break}void 0!=$("#acDiscount-tbody").find("tr").eq(o).attr("data-id")?(i.id=$("#acDiscount-tbody").find("tr").eq(o).attr("data-id"),""!=$(".acDiscountResult").eq(o).val()&&Core.AjaxRequest({type:"PUT",async:!1,params:i,url:_global_settings.service.url+"/pricestrategy",showMsg:!1,callback:function(t){setCloseAlertTimeOneSecond(),$("#acDiscount-tbody").html(""),e.setLine(),$("#saveAcDiscount").css("display","none"),$("#editAcDiscount").css("display","block"),$("#myBss_Grid").modal("hide"),$("#productInformaticaGrid").jqxGrid("updatebounddata","cells")},failure:function(e){}})):""!=$(".acDiscountResult").eq(o).val()&&""!=$(".acDiscountMonth").eq(o).val()&&Core.AjaxRequest({type:"PUT",async:!1,params:i,url:_global_settings.service.url+"/pricestrategy",callback:function(t){$("#acDiscount-tbody").html(""),e.setLine(),$("#saveAcDiscount").css("display","none"),$("#editAcDiscount").css("display","block"),$("#myBss_Grid").modal("hide"),$("#productInformaticaGrid").jqxGrid("updatebounddata","cells")},failure:function(e){}})}})}},MatchSalers=function(){var e=this,t=null,s=null,o=[],i=null,a=null;e.url=_global_settings.service.url,this.init=function(){e.setLineData(),e.initPages(),e.initValidators()},this.initPages=function(){$("#doMoreSalersWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1400,minHeight:600,height:"600",minWidth:600,cancelButton:$("#doMoreSalers-cancel"),initContent:function(){}}).on({close:function(){setTimeout(function(){$("#doMoreSalersTbody").jqxGrid("clearselection")},500)}})},this.setLineData=function(){Core.AjaxRequest({type:"GET",async:!1,dataType:"text",url:_global_settings.service.url+"/user/customerOrSales/sales",callback:function(e){s=JSON.parse(e);for(var t=0;t<s.length;t++){var i=s[t].userInfo.name+"("+s[t].username+")";o.push(i)}}}),Core.AjaxRequest({type:"GET",async:!1,dataType:"text",url:_global_settings.service.url+"/usersaler/sales",callback:function(s){if(t=JSON.parse(s),t.length>0)for(var i=0;i<t.length;i++){var a=t[i].id,r=$('<tr style="border-bottom: solid 1px #ccc;" data-id = '+a+'><td class="col-md-4"><div class="row"><div class="form-horizontal"><div class="form-group"><label  class="control-label col-sm-4 p-r-0">负责人</label><div class="col-sm-8 p-r-0"><div class="distributeSaler"></div></div></div></div></div></td><td class="col-md-4"><div class="row"><div class="form-horizontal"><div class="form-group"><label class="control-label col-sm-4 p-r-0">分配比例</label><div class="col-sm-8 p-r-0"><input type="text" class="form-control distributeProportion" /></div></div></div></div></td><td class="col-md-1"><i style="float:right;" class="md-format-list-bulleted tel" title="手机号码"></i></td><td class="col-md-1"><i style="float:right;" class="md-cancel del" title="删除"></i></td></tr>');$("#matchSalers-tbody").append(r),r.find(".distributeSaler").jqxComboBox({source:o,theme:currentTheme,displayMember:"username",valueMember:"id",width:"100%",height:"34px",searchMode:"containsignorecase"}),r.find(".distributeSaler").val(getSalesInfoByName(t[i].name).userInfo.name+"("+t[i].name+")"),r.find(".distributeProportion").val(void 0==t[i].proportion?"1":t[i].proportion),e.realTelephone(),$("#matchSalers-tbody").off("click"),$("#matchSalers-tbody").find("tr>td>.tel").css("display","block"),$("#matchSalers-tbody").find("tr>td:last-child>.del").css("display","none"),r.find(".distributeSaler").jqxComboBox({disabled:!0}),r.find(".distributeProportion").attr("disabled",!0),$("#editMatchSalers").css("display","block"),$("#addMatchSalers").css("display","none")}else $("#saveMatchSalers").css("display","none"),$("#editMatchSalers").css("display","none"),$("#addMatchSalers").css("display","block"),$("#cancelMatchSalers").css("display","none")}})},this.addLines=function(){var t=($("#matchSalers-tbody").children().length,$('<tr style="border-bottom: solid 1px #ccc;"><td class="col-md-4"><div class="row"><div class="form-horizontal"><div class="form-group"><label class="control-label col-sm-4 p-r-0">负责人</label><div class="col-sm-8 p-r-0"><div class="distributeSaler"></div></div></div></div></div></td><td class="col-md-4"><div class="row"><div class="form-horizontal"><div class="form-group"><label class="control-label col-sm-4 p-r-0">分配比例</label><div class="col-sm-8 p-r-0"><input type="text" class="form-control distributeProportion" value="1"/></div></div></div></div></td><td class="col-md-1"><i style="float:right;" class="md-format-list-bulleted tel" title="手机号码"></i></td><td class="col-md-1"><i style="float:right;" class="md-cancel del" title="删除"></i></td></tr>'));$("#matchSalers-tbody").append(t),$("#matchSalers-tbody").find("tr>td>.tel").css("display","none"),t.find(".distributeSaler").jqxComboBox({source:o,theme:currentTheme,displayMember:"username",valueMember:"id",width:"100%",height:"34px",searchMode:"containsignorecase",placeHolder:"请选择或输入"}),e.removeLines(),$("#matchSalers-tbody").off("click"),$("#matchSalers-tbody").on("click","tr",function(){$(this)[0]==$("#matchSalers-tbody").find("tr").eq(-1)[0]&&e.addLines()})},this.compareRepeat=function(){for(var e=!1,t=0;t<$(".distributeSaler").length;t++)for(var s=t+1;s<$(".distributeSaler").length;s++)if(""!=$(".distributeSaler").eq(t).val()){var o=$(".distributeSaler").eq(t).val(),i=$(".distributeSaler").eq(s).val(),a=o.substring(o.indexOf("(")+1,o.length-1),r=i.substring(i.indexOf("(")+1,i.length-1);if(a==r){e=!0;break}}return e},$("#addMatchSalers").off().on("click",function(){e.addLines(),$("#saveMatchSalers").css("display","block"),$("#editMatchSalers").css("display","none"),$("#addMatchSalers").css("display","none")}),$("#editMatchSalers").off("click").on("click",function(){$("#matchSalers-tbody").off().on("click","tr",function(){$(this)[0]==$("#matchSalers-tbody").find("tr").eq(-1)[0]&&e.addLines()}),e.removeLines(),$("#matchSalers-tbody").find("tr>td>.tel").css("display","none"),$("#matchSalers-tbody").find("tr>td:last-child>.del").css("display","block"),$(this).css("display","none"),$("#saveMatchSalers").css("display","block"),$(".distributeProportion").attr("disabled",!1),$(".distributeSaler").jqxComboBox({disabled:!1})}),this.removeLines=function(){$("#matchSalers-tbody").find("tr>td:last-child").off("click"),$("#matchSalers-tbody").find("tr>td:last-child").on("click",function(e){e.stopPropagation();var t=$(this).parent();$(this).parent().index();$("#matchSalers-tbody").find("tr").length>1&&Core.confirm({message:"确定要删除？",confirmCallback:function(){t.remove()}})})},this.initValidators=function(){for(var e=!1,t=/^\d+$/,s=$("#matchSalers-tbody").find(".distributeProportion"),o=0;o<s.length;o++)if(!t.test(s.eq(o).val())){e=!0;break}return e},this.realTelephone=function(){$("#matchSalers-tbody").find("tr>td>.tel").off("click"),$("#matchSalers-tbody").find("tr>td>.tel").on("click",function(e){e.stopPropagation();var t=$(this).parent().parent().index(),s=$(".distributeSaler").eq(t).val(),o=$(".distributeSaler").eq(t).val().substring(s.indexOf("(")+1,s.length-1);void 0!=getSalesInfoByName(o)&&""!=getSalesInfoByName(o)?a=getSalesInfoByName(o).employeeCode:void 0!=getCustomerInfoByName(o)&&""!=getCustomerInfoByName(o)&&(a=getCustomerInfoByName(o).employeeCode),Core.AjaxRequest({type:"GET",async:!1,dataType:"text",url:_global_settings.service.url+"/user/distributionEmployeeCode",callback:function(e){i=JSON.parse(e),$("#doMoreSalersWin").jqxWindow("open",function(){var e={localdata:i,datatype:"json"},t=new $.jqx.dataAdapter(e);$("#doMoreSalersTbody").jqxGrid({source:t,width:"100%",height:430,pageable:!1,selectionmode:"checkbox",columns:[{text:"销售或客服负责人",width:"48%",cellsrenderer:function(e,t,s,o,i,a){var r='<div class="agrid">';return(r+=a.username)+"</div>"}},{text:"电话号码",width:"48%",cellsrenderer:function(e,t,s,o,i,a){var r='<div class="agrid">';return(r+=a.userInfo.telephone)+"</div>"}}]}),$.each(i,function(e,t){i[e].distributionEmployeeCode==a&&$("#doMoreSalersTbody").jqxGrid("selectrow",e)})})}})}),$("#doMoreSalers-save").off("click").on("click",function(){var e=[],t=$("#doMoreSalersTbody").jqxGrid("getselectedrowindexes");if(void 0==i||""==i||null==i)Core.alert({message:"暂无负责人可操作！"});else if(0==t.length)Core.alert({message:"所选负责人不能为空！"});else if(t.length>0){$("#doMoreSalersTbody").jqxGrid("getselectedrowindexes");$.each(t,function(s,o){var a={};a.id=i[t[s]].id,e.push(a)}),Core.AjaxRequest({url:_global_settings.service.url+"/user/savepartner/sales/"+a,type:"POST",params:e,async:!1,showMsg:!1,callback:function(e){try{setCloseAlertTimeOneSecond(),$("#doMoreSalersWin").jqxWindow("close"),$("#doMoreSalersTbody").jqxGrid("clearselection")}catch(e){}},failure:function(e){}})}})},$("#saveMatchSalers").off("click").on("click",function(){for(var t=[],s=0;s<$("#matchSalers-tbody").find("tr").length;s++){var o={};if(""==$(".distributeProportion").eq(s).val()){Core.alert({message:"请检查分配比例格式！"});break}if(e.compareRepeat())return Core.alert({message:"所选负责人不能重复！"}),!1;if(e.initValidators())return Core.alert({message:"分配比例只能是大于或等于0的数字"}),!1;if((""!=$(".distributeSaler").eq(s).val()&&""!=$(".distributeProportion").eq(s).val()||0!=$(".distributeProportion").eq(s).val())&&""!=$(".distributeSaler").eq(s).val()){var i=$(".distributeSaler").eq(s).find("input").val(),a=i.substring(i.indexOf("(")+1,i.length-1);void 0!=getSalesInfoByName(i)?(o.name=i,o.employeeCode=getSalesInfoByName(i).employeeCode,o.userId=getSalesInfoByName(i).id):void 0!=getSalesInfoByName(a)?(o.name=a,o.employeeCode=getSalesInfoByName(a).employeeCode,o.userId=getSalesInfoByName(a).id):void 0!=getCustomerInfoByName(i)?(o.name=i,o.employeeCode=getCustomer(i).employeeCode,o.userId=getCustomer(i).id):void 0!=getCustomerInfoByName(a)?(o.name=a,o.employeeCode=getCustomer(a).employeeCode,o.userId=getCustomer(a).id):Core.alert({message:"所选负责人有误！"}),o.proportion=$(".distributeProportion").eq(s).val(),o.type="sales",t.push(o)}}Core.AjaxRequest({type:"POST",async:!1,params:t,url:_global_settings.service.url+"/usersaler/sales",showMsg:!1,callback:function(t){setCloseAlertTimeOneSecond(),$("#matchSalers-tbody").html(""),e.setLineData(),$("#saveMatchSalers").css("display","none"),$("#editMatchSalers").css("display","block")},failure:function(e){}})})},MatchCustomers=function(){var e=this,t=null,s=null,o=[],i=null,a=null;e.url=_global_settings.service.url,this.init=function(){e.setLineDataByCust(),e.initPages(),e.initValidator()},this.initPages=function(){$("#doMoreCustomersWin").jqxWindow({theme:currentTheme,isModal:!0,autoOpen:!1,maxHeight:1400,minHeight:600,height:"600",minWidth:600,cancelButton:$("#doMoreCustomers-cancel"),initContent:function(){}}).on({close:function(){setTimeout(function(){$("#doMoreCustomersTbody").jqxGrid("clearselection")},500)}})},this.setLineDataByCust=function(){Core.AjaxRequest({type:"GET",async:!1,dataType:"text",url:_global_settings.service.url+"/user/customerOrSales/customer",callback:function(e){s=JSON.parse(e);for(var t=0;t<s.length;t++){var i=s[t].userInfo.name+"("+s[t].username+")";o.push(i)}}}),Core.AjaxRequest({type:"GET",async:!1,dataType:"text",url:_global_settings.service.url+"/usersaler/customer",callback:function(s){if(t=JSON.parse(s),t.length>0)for(var i=0;i<t.length;i++){var a=t[i].id,r=$('<tr style="border-bottom: solid 1px #ccc;" data-id = '+a+'><td class="col-md-4"><div class="row"><div class="form-horizontal"><div class="form-group"><label  class="control-label col-sm-4 p-r-0">负责人</label><div class="col-sm-8 p-r-0"><div class="distributeCustomer"></div></div></div></div></div></td><td class="col-md-4"><div class="row"><div class="form-horizontal"><div class="form-group"><label class="control-label col-sm-4 p-r-0">分配比例</label><div class="col-sm-8 p-r-0"><input type="text" class="form-control distributeProportionCust" /></div></div></div></div></td><td class="col-md-1"><i style="float:right;" class="md-format-list-bulleted tel" title="手机号码"></i></td><td class="col-md-1"><i style="float:right;" class="md-cancel del" title="删除"></i></td></tr>');$("#matchCustomers-tbody").append(r),r.find(".distributeCustomer").jqxComboBox({source:o,theme:currentTheme,displayMember:"username",width:"100%",height:"34px",searchMode:"containsignorecase"}),r.find(".distributeCustomer").val(getCustomerInfoByName(t[i].name).name+"("+t[i].name+")"),r.find(".distributeProportionCust").val(void 0==t[i].proportion?"1":t[i].proportion),e.realTelephone(),$("#matchCustomers-tbody").off("click"),$("#matchCustomers-tbody").find("tr>td>.tel").css("display","block"),$("#matchCustomers-tbody").find("tr>td:last-child>.del").css("display","none"),r.find(".distributeCustomer").jqxComboBox({disabled:!0}),r.find(".distributeProportionCust").attr("disabled",!0),$("#editMatchCustomers").css("display","block"),$("#addMatchCustomers").css("display","none"),$("#saveMatchCustomers").css("display","none"),$("#cancelMatchCustomers").css("display","none")}else $("#saveMatchCustomers").css("display","none"),$("#editMatchCustomers").css("display","none"),$("#addMatchCustomers").css("display","block"),$("#cancelMatchCustomers").css("display","none")}})},this.addLinesByCust=function(){var t=($("#matchCustomers-tbody").children().length,$('<tr style="border-bottom: solid 1px #ccc;"><td class="col-md-4"><div class="row"><div class="form-horizontal"><div class="form-group"><label class="control-label col-sm-4 p-r-0">负责人</label><div class="col-sm-8 p-r-0"><div class="distributeCustomer"></div></div></div></div></div></td><td class="col-md-4"><div class="row"><div class="form-horizontal"><div class="form-group"><label class="control-label col-sm-4 p-r-0">分配比例</label><div class="col-sm-8 p-r-0"><input type="text" class="form-control distributeProportionCust" value="1"/></div></div></div></div></td><td class="col-md-1"><i style="float:right;" class="md-format-list-bulleted tel" title="手机号码"></i></td><td class="col-md-1"><i style="float:right;" class="md-cancel del" title="删除"></i></td></tr>'));$("#matchCustomers-tbody").append(t),$("#matchCustomers-tbody").find("tr>td>.tel").css("display","none"),t.find(".distributeCustomer").jqxComboBox({source:o,theme:currentTheme,displayMember:"username",width:"100%",height:"34px",searchMode:"containsignorecase",placeHolder:"请选择或输入"}),e.removeLines(),$("#matchCustomers-tbody").off("click"),$("#matchCustomers-tbody").on("click","tr",function(){$(this)[0]==$("#matchCustomers-tbody").find("tr").eq(-1)[0]&&e.addLinesByCust()})},this.compareRepeat=function(){for(var e=!1,t=0;t<$(".distributeCustomer").length;t++)for(var s=t+1;s<$(".distributeCustomer").length;s++)if(""!=$(".distributeCustomer").eq(t).val()){var o=$(".distributeCustomer").eq(t).val(),i=$(".distributeCustomer").eq(s).val(),a=o.substring(o.indexOf("(")+1,o.length-1),r=i.substring(i.indexOf("(")+1,i.length-1);if(r==a){e=!0;break}}return e},$("#addMatchCustomers").off().on("click",function(){e.addLinesByCust(),$("#saveMatchCustomers").css("display","block"),$("#editMatchCustomers").css("display","none"),$("#cancelMatchCustomers").css("display","none"),$("#addMatchCustomers").css("display","none")}),$("#editMatchCustomers").off("click").on("click",function(){$("#matchCustomers-tbody").off().on("click","tr",function(){$(this)[0]==$("#matchCustomers-tbody").find("tr").eq(-1)[0]&&e.addLinesByCust()}),e.removeLines(),$("#matchCustomers-tbody").find("tr>td>.tel").css("display","none"),$("#matchCustomers-tbody").find("tr>td:last-child>.del").css("display","block"),$(this).css("display","none"),$("#saveMatchCustomers").css("display","block"),$(".distributeProportionCust").attr("disabled",!1),$(".distributeCustomer").jqxComboBox({disabled:!1})}),this.removeLines=function(){$("#matchCustomers-tbody").find("tr>td:last-child").off("click"),$("#matchCustomers-tbody").find("tr>td:last-child").on("click",function(e){e.stopPropagation();var t=$(this).parent();$(this).parent().index();$("#matchCustomers-tbody").find("tr").length>1&&Core.confirm({message:"确定要删除？",confirmCallback:function(){t.remove()}})})},this.initValidator=function(){for(var e=!1,t=/^\d+$/,s=$("#matchCustomers-tbody").find(".distributeProportionCust"),o=0;o<s.length;o++)if(!t.test(s.eq(o).val())){e=!0;break}return e},this.realTelephone=function(){$("#matchCustomers-tbody").find("tr>td>.tel").on("click",function(e){e.stopPropagation();var t=$(this).parent().parent().index(),s=$(".distributeCustomer").eq(t).val(),o=$(".distributeCustomer").eq(t).val().substring(s.indexOf("(")+1,s.length-1);void 0!=getSalesInfoByName(o)&&""!=getSalesInfoByName(o)?a=getSalesInfoByName(o).employeeCode:void 0!=getCustomerInfoByName(o)&&""!=getCustomerInfoByName(o)&&(a=getCustomerInfoByName(o).employeeCode),Core.AjaxRequest({type:"GET",async:!1,dataType:"text",url:_global_settings.service.url+"/user/distributionEmployeeCode",callback:function(e){i=JSON.parse(e),$("#doMoreCustomersWin").jqxWindow("open",function(){var e={localdata:i,datatype:"json"},t=new $.jqx.dataAdapter(e);$("#doMoreCustomersTbody").jqxGrid({source:t,width:"100%",height:430,pageable:!1,selectionmode:"checkbox",columns:[{text:"销售或客服负责人",width:"48%",cellsrenderer:function(e,t,s,o,i,a){var r='<div class="agrid">';return(r+=a.username)+"</div>"}},{text:"电话号码",width:"50%",cellsrenderer:function(e,t,s,o,i,a){var r='<div class="agrid">';return(r+=a.userInfo.telephone)+"</div>"}}]}),$.each(i,function(e,t){i[e].distributionCustomerEmployeeCode==a&&$("#doMoreCustomersTbody").jqxGrid("selectrow",e)})})}})}),$("#doMoreCustomers-save").off("click").on("click",function(){var e=[],t=$("#doMoreCustomersTbody").jqxGrid("getselectedrowindexes");if(void 0==i||""==i||null==i)Core.alert({message:"暂无负责人可操作！"});else if(0==t.length)Core.alert({message:"所选负责人不能为空！"});else if(t.length>0){$("#doMoreCustomersTbody").jqxGrid("getselectedrowindexes");$.each(t,function(s,o){var a={};a.id=i[t[s]].id,e.push(a)}),Core.AjaxRequest({url:_global_settings.service.url+"/user/savepartner/customer/"+a,type:"POST",params:e,async:!1,showMsg:!1,callback:function(e){try{setCloseAlertTimeOneSecond(),$("#doMoreCustomersWin").jqxWindow("close"),$("#doMoreCustomersTbody").jqxGrid("clearselection")}catch(e){}},failure:function(e){}})}})},$("#saveMatchCustomers").off("click").on("click",function(){for(var t=[],s=0;s<$("#matchCustomers-tbody").find("tr").length;s++){var o={};if(""==$(".distributeProportionCust").eq(s).val()){Core.alert({message:"请检查分配比例格式！"});break}if(e.compareRepeat())return Core.alert({message:"所选负责人不能重复！"}),!1;if(e.initValidator())return Core.alert({message:"分配比例只能是大于或等于0的数字"}),!1;if((""!=$(".distributeCustomer").eq(s).val()&&""!=$(".distributeProportionCust").eq(s).val()||0!=$(".distributeProportionCust").eq(s).val())&&""!=$(".distributeCustomer").eq(s).val()){var i=$(".distributeCustomer").eq(s).find("input").val(),a=i.substring(i.indexOf("(")+1,i.length-1);void 0!=getSalesInfoByName(i)?(o.name=i,o.employeeCode=getSalesInfoByName(i).employeeCode,o.userId=getSalesInfoByName(i).id):void 0!=getSalesInfoByName(a)?(o.name=a,o.employeeCode=getSalesInfoByName(a).employeeCode,o.userId=getSalesInfoByName(a).id):void 0!=getCustomerInfoByName(i)?(o.name=i,o.employeeCode=getCustomerInfoByName(i).employeeCode,o.userId=getCustomerInfoByName(i).id):void 0!=getCustomerInfoByName(a)?(o.name=a,o.employeeCode=getCustomerInfoByName(a).employeeCode,o.userId=getCustomerInfoByName(a).id):Core.alert({message:"所选负责人有误！"}),o.proportion=$(".distributeProportionCust").eq(s).val(),o.type="customer",t.push(o)}}Core.AjaxRequest({type:"POST",async:!1,params:t,url:_global_settings.service.url+"/usersaler/customer",showMsg:!1,callback:function(t){setCloseAlertTimeOneSecond(),$("#matchCustomers-tbody").html(""),e.setLineDataByCust(),$("#saveMatchCustomers").css("display","none"),$("#addMatchCustomers").css("display","none"),$("#cancelMatchCustomers").css("display","none"),$("#editMatchCustomers").css("display","block")},failure:function(e){}})})},getSales=function(e){for(var t=ComboBoxSources.getRecords("salesInfo"),s=0;s<t.length;s++)if(t[s].id==e)return t[s];if(!e)return""},getCustomer=function(e){for(var t=ComboBoxSources.getRecords("custService"),s=0;s<t.length;s++)if(t[s].id==e)return t[s];if(!e)return""};