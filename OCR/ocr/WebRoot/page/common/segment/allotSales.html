<meta charset="UTF-8">
<div id="allotSales_modal" class="modal fade in" tabindex="-1" role="dialog" aria-labelledby="full-width-modalLabel" aria-hidden="true" style="display: none;">
	<div class="modal-dialog ">
		<div class="modal-content">
			<!--模态框头部-->
			<div class="modal-header">
				<div class="quotation-nav">
					<div class="row">
						<div class="quotation-nav-left" style="">
							<b style="margin-left: 20px;">分配信息</b>
						</div>
						<div class="quotation-nav-right">
							<button type="button" class="close-modal btn-success"
								data-dismiss="modal" aria-hidden="true">
								<i class="glyphicon glyphicon-remove" style="padding: 0;"></i>
							</button>
						</div>
					</div>
				</div>
			</div>
			<!--模态框body-->
			<div class="modal-body">
				<input type="text" id="allotSales_data" class="hide"/>
				<input type="text" id="allotSales_user" class="hide"/>
				<input type="text" id="allotSales_ownerId" class="hide"/>
				<div class="row container">
					<div class="col-sm-12">
						<div class="row">
							<div class="form-horizontal">
								<div class="form-group">
									<label class="control-label col-sm-4">销售负责人</label>
									<div class="col-sm-5">
										<div id="allotSales_sale"></div>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="form-horizontal">
								<div class="form-group">
									<label class="control-label col-sm-4">客服</label>
									<div class="col-sm-5">
										<div id="allotSales_customer"></div>
									</div>
								</div>
							</div>
						</div>
						<div class="row allot hide">
							<div class="form-horizontal">
								<div class="form-group">
									<label class="control-label col-sm-4">代理商</label>
									<div class="col-sm-5">
										<div id="allotSales_agent"></div>
									</div>
								</div>
							</div>
						</div>
						<div class="row allot hide">
							<div class="form-horizontal">
								<div class="form-group">
									<label class="control-label col-sm-4">用户类型</label>
									<div class="col-sm-5">
										<div id="allotSales_type"></div>
									</div>
								</div>
							</div>
						</div>
						<div class="row allot">
							<div class="form-horizontal">
								<div class="form-group">
									<label class="control-label col-sm-4">是否高级代理</label>
									<div class="col-sm-5">
										<div id="allotSales_senior"></div>
									</div>
								</div>
							</div>
						</div>
						<div class="row allot">
							<div class="form-horizontal">
								<div class="form-group">
									<label class="control-label col-sm-4">佣金系数</label>
									<div class="col-sm-5">
										<input type="text" class="form-control" id="allotSale_rate"/>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="form-horizontal">
								<div class="form-group">
									<label class="control-label col-sm-4">用户名</label>
									<div class="col-sm-5">
										<input type="text" class="form-control" id="allotSale_name" readonly/>
									</div>
								</div>
							</div>
						</div>
						<div class="row allot hide">
							<div class="form-horizontal">
								<div class="form-group">
									<label class="control-label col-sm-4">公司名称</label>
									<div class="col-sm-5">
										<input type="text" class="form-control" id="allotSale_compname" readonly/>
									</div>
								</div>
							</div>
						</div>
						<div class="row" style="padding-bottom: 5px; padding-left: 10%;">
							<div class="form-horizontal">
								<div class="form-group">
									<div class="col-sm-1"></div>
									<div class="col-sm-9"></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--模态框脚页-->
			<div class="modal-footer" style="padding: 20px;">
				<button type="button" class="btn btn-success" data-dismiss="modal">取消</button>
				<button type="button" class="btn btn-success" data-dismiss="modal" id='saveAllotSaleBtn'>保存</button>
			</div>
		</div>
	</div>
</div>
<script>
	$('#allotSales_modal').jqxValidator({
		animationDuration: 1,
		hintType: 'label',
	       rules: [			
			{ input: '#allotSales_sale', message: "请选择", action: 'keyup, blur', 
				rule: function(input,commit){
					if(input.val()=='') return true;
					if(input.jqxComboBox('getSelectedItem')==null) return false;
					return true;
				} 
			},
			{ input: '#allotSales_customer', message: "请选择", action: 'keyup, blur',
				rule: function(input,commit){
					if(input.val()=='') return true;
					if(input.jqxComboBox('getSelectedItem')==null) return false;
					return true;
				}
			},
		]
	});
	
	//点击保存分配
	$('#saveAllotSaleBtn').off('click').on('click',function(){
		if(!$('#allotSales_modal').jqxValidator('validate')){
			return false;
		}	
		
		var user=$('#allotSales_user').val();
		
		//代理商分配信息
		if(user==''){
			var data=$('#allotSales_data').data('data');
			delete data.clientInfo;
			delete data.boundindex;
			delete data.uid;
			delete data.uniqueid;
			delete data.visibleindex;
			
			data.sales={id:$('#allotSales_sale').val()};
			data.customer={id:$('#allotSales_customer').val()};
			data.rate=$('#allotSale_rate').val();
			data.senior=$('#allotSales_senior').val();
			
			/* console.log(data);
			return false; */
			Core.AjaxRequest({
				url:_global_settings.service.url+'/salesagent/0',
				type:'PUT',
				params:data,
				async:false,
				callback:function(){
					try{
						$('#agentGrid').jqxGrid('updatebounddata','cells');	
					}catch(e){}
				}
			});
		}else{ //用户分配信息
			var url = _global_settings.service.url+'/user/owner';
			
			var obj={};
				obj.id = $('#allotSales_ownerId').val();
				obj.salesType = $('#allotSales_type').val();
			
			if($('#allotSales_agent').val()!=''){
				obj.agent={id:$('#allotSales_agent').val()};	
			}
			
			if($('#allotSales_sale').val()!=''){
				obj.sales={id:$('#allotSales_sale').val()};
			}
			
			var custId = 0;
			if($('#allotSales_customer').val()!=''){
				custId = $('#allotSales_customer').val();
			}
			
			Core.AjaxRequest({
				type:'PUT',
				url:url+'/'+custId,
				async:false,
				params:obj,
				callback:function(res){
					try{
						$('#userMgtGrid').jqxGrid('updatebounddata','cells');
					}catch(e){
					}
				},
				failure:function(e){
				}
			});
		}
	});
</script>